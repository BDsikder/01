<!DOCTYPE html>
<html lang="bn" class="notranslate">
<head>
  <meta charset="UTF-8">
  <meta name="google" content="notranslate">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BISNU IoT ডিভাইস কন্ট্রোল প্যানেল</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@300;400;500;600;700&family=Exo+2:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* ================================================================
       BISNU IoT - NEON TEAL CYBERPUNK THEME v3.0
       সম্পূর্ণ নতুন ডিজাইন এবং থিম
    ================================================================ */

    /* --- CSS ভ্যারিয়েবল --- */
    :root {
      --primary-color: #0a0e1a;
      --secondary-color: #00d4ff;
      --accent-color: #ff2d5b;
      --light-color: #e0f7ff;
      --dark-color: #050810;
      --success-color: #00ff9d;
      --warning-color: #ffb700;
      --info-color: #00d4ff;
      --energy-color: #c84bff;
      --voltage-color: #ff8c00;
      --current-color: #00ff9d;
      --power-color: #00d4ff;
      --background-btn-color: #c84bff;
      --sort-lock-color: #c84bff;
      --card-bg: rgba(6, 14, 30, 0.78);
      --card-border: rgba(0, 212, 255, 0.15);
      --nav-bg: rgba(4, 8, 20, 0.88);
      --login-bg: rgba(4, 10, 24, 0.97);
      --text-color: #c8e6f5;
      --text-dim: rgba(180, 220, 240, 0.55);

      /* Temp Card Variables */
      --temp-card-bg: #060e1e;
      --temp-circle-bg: #0d1e3a;
      --temp-c-color: #00d4ff;
      --temp-f-color: #ff8c00;
    }

    /* --- লাইট থিম ভ্যারিয়েবল --- */
    .light-theme {
      --primary-color: #e8f4ff;
      --secondary-color: #0090bb;
      --accent-color: #d41540;
      --light-color: #f0faff;
      --dark-color: #ffffff;
      --success-color: #007a4d;
      --warning-color: #c78500;
      --info-color: #0090bb;
      --energy-color: #7c2ab0;
      --voltage-color: #c05800;
      --current-color: #007a4d;
      --power-color: #0090bb;
      --card-bg: rgba(220, 240, 255, 0.78);
      --card-border: rgba(0, 144, 187, 0.22);
      --text-color: #0a1828;
      --text-dim: rgba(10, 24, 40, 0.6);
      --nav-bg: rgba(200, 230, 250, 0.88);
      --login-bg: rgba(240, 248, 255, 0.97);

      --temp-card-bg: #e8f4ff;
      --temp-circle-bg: #c8e4f8;
    }

    /* --- বডি বেস স্টাইল --- */
    * { box-sizing: border-box; }

    body {
      font-family: 'Exo 2', 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      color: var(--text-color);
      transition: background-color 0.5s ease;
      overflow-x: hidden;
      background-color: #020609;
    }

    /* সাইবারপাঙ্ক স্ক্যানলাইন ইফেক্ট */
    body::after {
      content: '';
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
      z-index: 9998;
      background: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 2px,
        rgba(0, 0, 0, 0.03) 2px,
        rgba(0, 0, 0, 0.03) 4px
      );
    }

    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0;
      height: 100%; width: 100%;
      z-index: -1;
      background-size: cover;
      background-position: center;
      transition: background-image 1s ease-in-out, opacity 1s ease-in-out;
      background-color: #020609;
    }

    @keyframes cyberpunkBg {
      0%   { background-position: 0% 50%; }
      50%  { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    body.bg-0::before {
      background:
        radial-gradient(ellipse at 15% 85%, rgba(0, 80, 120, 0.4) 0%, transparent 50%),
        radial-gradient(ellipse at 85% 15%, rgba(100, 0, 150, 0.35) 0%, transparent 50%),
        radial-gradient(ellipse at 50% 50%, rgba(0, 20, 50, 0.9) 0%, transparent 80%),
        linear-gradient(135deg, #010308, #030812, #040d18, #020a14);
      background-size: 400% 400%;
      animation: cyberpunkBg 18s ease infinite;
    }

    body.bg-1::before  { background-image: url('1background image.jpg'); }
    body.bg-2::before  { background-image: url('2background image.jpg'); }
    body.bg-3::before  { background-image: url('3background image.jpg'); }
    body.bg-4::before  { background-image: url('4background image.jpg'); }
    body.bg-5::before  { background-image: url('5background image.jpg'); }
    body.bg-6::before  { background-image: url('6background image.jpg'); }
    body.bg-7::before  { background-image: url('7background image.jpg'); }
    body.bg-8::before  { background-image: url('8background image.jpg'); }
    body.bg-9::before  { background-image: url('9background image.jpg'); }
    body.bg-10::before { background-image: url('10background image.jpg'); }

    .app-loading-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(17, 24, 39, 0.95);
        backdrop-filter: blur(5px);
        z-index: 2000;
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        animation: fadeIn 0.3s ease-in-out;
    }

    .loading-spinner {
        width: 60px;
        height: 60px;
        border: 5px solid rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        border-top-color: var(--secondary-color);
        animation: spin 1s ease-in-out infinite;
        margin-bottom: 20px;
    }

    .loading-text {
        font-size: 1.5rem;
        color: var(--text-color);
        font-weight: 600;
        animation: pulse 1.5s infinite;
    }

    /* --- লগইন স্ক্রিনের স্টাইল --- */
    .login-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      flex-direction: column;
      overflow: hidden;
      background-color: #111827;
    }
    
    .login-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: url('Login image.jpg');
      background-size: cover;
      background-position: center;
      filter: blur(5px) brightness(0.6);
      z-index: -1;
    }
    
    .login-particles {
      position: absolute;
      width: 100%;
      height: 100%;
      z-index: -1;
    }
    
    .particle {
      position: absolute;
      background: rgba(255, 255, 255, 0.5);
      border-radius: 50%;
      animation: float 15s infinite linear;
    }
    
    @keyframes float {
      0% { transform: translateY(0) rotate(0deg); opacity: 1; }
      100% { transform: translateY(-1000px) rotate(720deg); opacity: 0; }
    }
    
    .login-logo-container {
      position: relative;
      width: 180px;
      height: 180px;
      margin-bottom: 30px;
      perspective: 1000px;
    }
    .login-logo {
      width: 100%;
      height: 100%;
      object-fit: contain;
      animation: 20000ms linear -221.503ms infinite normal none running rotate, 0s ease-in-out infinite normal none running pulse;
      filter: drop-shadow(0 0 15px rgba(52, 152, 219, 0.7));
    }
    
    .login-logo-ring {
      position: absolute;
      top: -10px; left: -10px; right: -10px; bottom: -10px;
      border: 5px solid transparent;
      border-top-color: var(--secondary-color);
      border-radius: 50%;
      animation: spin 3s linear infinite;
      z-index: -1;
    }
    .login-logo-ring:nth-child(2) {
      border-top-color: var(--accent-color);
      animation-duration: 4s;
      animation-direction: reverse;
    }
    .login-logo-ring:nth-child(3) {
      border-top-color: var(--success-color);
      animation-duration: 5s;
    }
    
    @keyframes rotate-logo { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

    .login-box, .registration-box {
      font-weight: 200;
      position: relative;
      width: 520px;
      padding: 4px;
      border-radius: 22px;
      box-shadow: 4px 7px 20px 1px rgb(0 0 0);
      animation: fadeIn 0.8s ease-in-out, slideUp 0.8s ease-in-out;
      overflow: hidden;
      background: #00000000;
      backdrop-filter: blur(15px);
      display: none;
    }
    
    .login-container .form-active {
        display: block;
    }

    .login-box::before, .registration-box::before {
      content: '';
      position: absolute;
      top: -60%;
      left: -50%;
      width: 200%;
      height: 260%;
      z-index: 1;
      background: conic-gradient(from 180deg at 50% 50%, #ff00d4, #0000ff, #00ffff, #00ff00, #ffff00, #ff8c00, #ff0000, #ff00d4);
      animation: rotate-rgb 3s linear infinite;
    }

    .login-box-inner {
      background: rgb(0 0 0);
      border-radius: 18px;
      padding: 1.5rem;
      position: relative;
      z-index: 2;
      text-align: center;
    }
    
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    @keyframes slideUp { from { transform: translateY(50px); } to { transform: translateY(0); } }
    @keyframes slideIn { from { transform: translateX(100%); } to { translateX(0); } }
    @keyframes rotate-rgb { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    
    .login-box h2, .registration-box h2 {
      margin-top: 0;
      margin-bottom: 1.5rem;
      color: var(--text-color);
      font-weight: 600;
      font-size: 1.8rem;
      text-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    .input-group { margin-bottom: 1.5rem; position: relative; }
    .input-group input {
      width: 88%;
      padding: 15px 20px;
      border: 1.1px solid rgb(2 0 255);
      border-radius: 50px;
      background: rgba(0, 0, 0, 0.2);
      color: var(--text-color);
      font-size: 16px;
      transition: all 0.3s ease;
    }
    .input-group input:focus {
      outline: none;
      background: rgba(255, 255, 255, 0.15);
      border-left: 3px solid #ff0000;
      box-shadow: 3px 3px 10px rgb(255 0 0 / 88%);
    }
    
    .action-btn {
      background: linear-gradient(135deg, var(--secondary-color) 0%, var(--primary-color) 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 50px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s ease;
      width: 100%;
      box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
      position: relative;
      overflow: hidden;
    }
    .action-btn:hover {
      transform: translateY(-5px) scale(1.02);
      box-shadow: 0 10px 25px rgba(223, 0, 0, 0.6);
    }
    .action-btn:active { transform: translateY(0) scale(1); }
    
    .error-message {
      color: var(--accent-color);
      margin-top: 1rem;
      font-size: 14px;
      height: 20px;
      text-shadow: 0 0 5px var(--accent-color);
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      20%, 60% { transform: translateX(-5px); }
      40%, 80% { transform: translateX(5px); }
    }
    
    .shake-animation { animation: shake 0.5s ease-in-out; }
    
    .form-switcher { margin-top: 1.5rem; font-size: 14px; color: var(--text-color); }
    .form-switcher a { color: var(--secondary-color); text-decoration: none; font-weight: 600; cursor: pointer; }
    .form-switcher a:hover { text-decoration: underline; }

    /* --- মূল অ্যাপ্লিকেশন স্টাইল --- */
    #app { display: none; max-width: 1400px; margin: 0 auto; padding: 20px; }
    
    .dashboard-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 2rem;
      padding: 1rem;
      background: var(--card-bg);
      border-radius: 15px;
      border: 1px solid rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
      animation: fadeIn 1s ease-in-out;
    }
    
    .app-logo-container { position: relative; width: 100px; height: 100px; margin-bottom: 15px; }
    .app-logo {
      width: 100%;
      height: 100%;
      object-fit: contain;
      animation: 20000ms linear -221.503ms infinite normal none running rotate, 0s ease-in-out infinite normal none running pulse;
      filter: drop-shadow(0 0 15px rgba(52, 152, 219, 0.7));
    }
    .app-logo-ring {
      position: absolute;
      top: -5px; left: -5px; right: -5px; bottom: -5px;
      border: 3px solid transparent;
      border-top-color: var(--secondary-color);
      border-radius: 50%;
      animation: spin 3s linear infinite;
    }
    .app-logo-ring:nth-child(2) { border-top-color: var(--accent-color); animation-duration: 4s; animation-direction: reverse; }
    .app-logo-ring:nth-child(3) { border-top-color: var(--success-color); animation-duration: 5s; }

    @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    .dashboard-title {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text-color);
      text-align: center;
      text-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    .header-controls { display: flex; gap: 15px; align-items: center; margin-top: 15px; }
    
    .pro-btn {
      color: rgb(0, 0, 0);
      border: none;
      padding: 10px 22px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      border: 1px solid rgba(255,255,255,0.1);
    }
    .pro-btn:hover {
      transform: translateY(-3px) scale(1.03);
      box-shadow: 0 7px 20px rgba(0,0,0,0.3);
    }
    .pro-btn:active { transform: translateY(0) scale(1); }
    .pro-btn:disabled {
      background: #555;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .logout-btn { background: linear-gradient(135deg, #e74c3c, #c0392b); }
    .background-btn { background: linear-gradient(135deg, var(--background-btn-color), #6c3483); }
    .notification-btn { background: linear-gradient(135deg, #f39c12, #d35400); }
    .sort-lock-btn { background: linear-gradient(135deg, var(--sort-lock-color), #6c3483); }
    .btn-on { background: linear-gradient(135deg, #2ecc71, #27ae60); }
    .btn-off { background: linear-gradient(135deg, #e74c3c, #c0392b); }
    .btn-warning { background: linear-gradient(135deg, #f39c12, #e67e22); }
    .btn-info { background: linear-gradient(135deg, #1abc9c, #16a085); }
    .timer-btn { background: linear-gradient(135deg, var(--info-color), #2980b9); }
    .modal-btn.cancel-btn { background: linear-gradient(135deg, #e74c3c, #c0392b); }
    .modal-btn.confirm-btn { background: linear-gradient(135deg, #2ecc71, #27ae60); }
    .edit-btn { background: linear-gradient(135deg, #3498db, #2980b9); } /* New edit button style */
    
    .theme-toggle {
      position: relative;
      width: 70px;
      height: 34px;
      border-radius: 17px;
      cursor: pointer;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: inset 0 2px 5px rgba(0,0,0,0.3);
    }
    .theme-toggle input { display: none; }
    .theme-slider { position: absolute; top: 0; left: 0; right: 0; bottom: 0; transition: all 0.4s ease; }
    .theme-slider:before {
      content: "";
      position: absolute;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: white;
      top: 3px;
      left: 3px;
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .theme-toggle input:checked + .theme-slider:before { transform: translateX(36px); background: #2c3e50; }
    .theme-icon { position: absolute; font-size: 16px; top: 50%; transform: translateY(-50%); transition: opacity 0.3s ease; }
    .sun-icon { left: 9px; opacity: 1; }
    .moon-icon { right: 9px; opacity: 1; }
    .theme-toggle input:checked ~ .sun-icon { opacity: 0; }
    .theme-toggle input:not(:checked) ~ .moon-icon { opacity: 0; }

    .nav-tabs {
      display: flex;
      background: var(--nav-bg);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      overflow-x: auto;
      margin-bottom: 2rem;
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
      border: 1px solid rgba(255, 255, 255, 0.18);
      padding: 5px;
    }
    
    .nav-tabs::-webkit-scrollbar { height: 8px; }
    .nav-tabs::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 10px; }
    .nav-tabs::-webkit-scrollbar-thumb { background: var(--secondary-color); border-radius: 10px; }
    .nav-tabs::-webkit-scrollbar-thumb:hover { background: #3cb0fd; }
    
    .nav-tab {
      flex: 1 0 auto;
      text-align: center;
      padding: 12px 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      border-radius: 10px;
      color: var(--text-color);
      white-space: nowrap;
      border: 2px solid transparent;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .nav-tab:hover { background: rgba(255, 255, 255, 0.1); }
    .nav-tab.active {
      background: var(--secondary-color);
      box-shadow: 0 0 15px rgba(52, 152, 219, 0.5);
      color: white;
      transform: scale(1.05);
    }

    .sortable-ghost { opacity: 0.4; background-color: var(--secondary-color); }
    .nav-tabs.tabs-unlocked .nav-tab:hover { cursor: grab; }
    .nav-tabs.tabs-unlocked .nav-tab:active { cursor: grabbing; }
    
    .device-page { display: none; animation: fadeIn 0.7s ease; }
    .device-page.active { display: block; }
    
    .device-card, .energy-card, .chart-container, .log-container, .notes-container, .control-section, .advanced-graph-container, .automation-container {
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
      border: 1px solid rgba(255, 255, 255, 0.18);
      transition: all 0.4s ease;
      margin-bottom: 25px;
      will-change: transform;
      backface-visibility: hidden;
      transform: translateZ(0);
    }
    .device-card:hover, .energy-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5);
    }
    
    .device-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .card-header { padding-bottom: 10px; border-bottom: 1px solid rgba(255, 255, 255, 0.2); }
    .card-value { font-size: 1.8rem; }
    .card-footer { display: flex; justify-content: space-around; margin-top: 15px; }
    .card-btn { padding: 8px 15px; font-size: 13px; }
    
    .card-title-container { display: flex; align-items: center; gap: 15px; }
    .card-actions { display: flex; gap: 10px; }
    .card-actions i { cursor: pointer; opacity: 0.6; font-size: 0.9rem; transition: all 0.2s ease-in-out; }
    .card-actions i:hover { opacity: 1; transform: scale(1.15); }
    .fa-pencil-alt:hover { color: var(--secondary-color); }
    .fa-trash-alt:hover { color: var(--accent-color); }
    
    .device-status-summary {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 30px;
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
      border: 1px solid rgba(255, 255, 255, 0.18);
    }
    
    .status-count { font-size: 1.8rem; }

    .section-title, .note-title, .control-section-title {
      font-size: 1.6rem;
      margin-bottom: 20px;
      padding-bottom: 10px;
      color: var(--secondary-color);
      border-bottom: 2px solid var(--secondary-color);
      text-shadow: 0 0 8px rgba(52, 152, 219, 0.5);
    }
    
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
    }
    .path-config-icon {
      font-size: 1.1rem;
      cursor: pointer;
      opacity: 0.7;
      transition: all 0.3s ease;
      padding: 5px;
    }
    .path-config-icon:hover {
      opacity: 1;
      transform: rotate(90deg) scale(1.1);
      color: var(--secondary-color);
    }
    .path-configured {
      border: 2px solid var(--success-color) !important;
      box-shadow: 0 0 15px rgba(46, 204, 113, 0.5);
    }
    
    #path-selector-popover {
      position: absolute;
      display: none;
      flex-direction: column;
      gap: 10px;
      background: var(--card-bg);
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      border: 1px solid rgba(255,255,255,0.2);
      backdrop-filter: blur(15px);
      z-index: 1001;
      width: 300px;
    }
    
    #path-selector-popover h4 {
      margin: 0 0 10px 0;
      color: var(--secondary-color);
      font-size: 1rem;
      border-bottom: 1px solid var(--secondary-color);
      padding-bottom: 5px;
    }
    
    #path-segments-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    #path-segments-container select {
      width: 100%;
      padding: 8px;
      border-radius: 5px;
      background: rgba(0,0,0,0.3);
      color: var(--text-color);
      border: 1px solid rgba(255,255,255,0.2);
    }

    #path-selector-popover .pro-btn {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
    }


    /* --- অ্যানালিটিক্স সেকশন --- */
    .analytics-section { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
    
    /* --- এনার্জি মনিটরিং স্টাইল --- */
    .energy-metrics { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .energy-card { border-top: 4px solid var(--secondary-color); }

    /* --- ৩ডি টগল সুইচের উন্নত স্টাইল --- */
    .toggle-switch-container {
      display: flex;
      flex-direction: column;
      background: rgb(0 0 0 / 31%);
      padding: 20px;
      border-radius: 15px;
      border-left: 5px solid #ff00005c;
      transition: all 0.3s ease;
      box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.4);
      position: relative;
      will-change: transform;
      backface-visibility: hidden;
      transform: translateZ(0);
    }
    .toggle-switch-container:hover {
      background: rgba(0,0,0,0.4);
      border-left-color: var(--secondary-color);
      transform: translateY(-5px);
      box-shadow: 0 8px 15px rgba(0,0,0,0.3), inset 0 2px 8px rgba(0,0,0,0.4);
    }
    .toggle-switch-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 25px; }

    .manual-override-indicator {
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 1.2rem;
        color: var(--warning-color);
        cursor: help;
    }
    .toggle-switch-container.manual-override {
        border-left-color: var(--warning-color);
    }

    .timer-status {
      font-size: 0.8rem;
      color: #aaeec4;
      text-shadow: 0 0 5px #106300;
      font-weight: 500;
      text-align: center;
      padding: 5px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 5px;
      min-height: 20px;
    }
    
    /* NEW: LINKED RULE INDICATOR */
    .linked-rule-indicator {
        color: #f39c12;
        cursor: pointer;
        margin-left: 8px;
        position: relative;
        display: inline-block;
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }
    .linked-rule-indicator:hover {
        color: #fff;
        transform: scale(1.2);
    }
    .linked-rule-dropdown {
        display: none;
        position: absolute;
        bottom: 130%; /* Icon er opore dekhabe */
        left: 50%;
        transform: translateX(-50%); /* Majhkhan borabor thakbe */
        background: rgba(13, 29, 47, 0.98); /* Solid color */
        color: #fff;
        padding: 10px;
        border-radius: 8px;
        font-size: 0.85rem;
        width: max-content;
        max-width: 280px;
        z-index: 9999;
        border: 1px solid #f39c12;
        box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        text-align: left;
        white-space: normal;
    }
    .linked-rule-dropdown::after {
        content: " ";
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: #f39c12 transparent transparent transparent;
    }
    .linked-rule-dropdown.show { display: block; }
    .linked-rule-dropdown div {
        padding: 5px 0;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .linked-rule-dropdown div:last-child { border-bottom: none; }


    /* --- মোডাল বক্সের উন্নত ডিজাইন --- */
    .password-modal-container {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(10px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 3000;
      animation: fadeIn 0.4s ease-in-out;
    }
    .password-modal-box, .timer-modal-box, .scene-modal-box {
      background: rgb(30 28 28 / 58%);
      backdrop-filter: blur(15px);
      padding: 30px 40px;
      border-radius: 20px;
      width: 450px;
      box-shadow: 0px 0 16px 2px rgb(219 19 255);
      border: 3px solid rgb(169 20 20);
      text-align: center;
      border-top: 5px solid #3a2e70;
      animation: slideUp 0.5s cubic-bezier(0.165, 0.84, 0.44, 1);
    }
    .timer-modal-box { border-top-color: #b90000; width: 480px; }
    
    .password-input-group input {
      width: 92%;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(0,0,0,0.3);
      color: var(--text-color);
      font-size: 1rem;
      transition: all 0.3s ease;
    }
    .password-modal-buttons { gap: 20px; }
    .modal-btn { flex: 1; padding: 12px 20px; }
    
    /* --- অটোমেশন পেইজের স্টাইল --- */
    .automation-grid { display: grid; grid-template-columns: 1fr; gap: 30px; }
    @media (min-width: 1200px) { .automation-grid { grid-template-columns: 1fr 1.5fr; } }
    
    #page12 .automation-grid {
        grid-template-columns: 1fr;
    }

    .rule-builder-card { background: var(--card-bg); padding: 25px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.1); }
    .rule-builder-form { display: flex; flex-direction: column; gap: 20px; }
    .rule-condition-box, .rule-action-box {
      background: rgba(0,0,0,0.25);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .rule-part {
      font-size: 1.5rem;
      font-weight: 700;
      padding-bottom: 10px;
      margin-bottom: 10px;
      border-bottom: 2px solid;
      text-shadow: 0 0 8px;
    }
    .rule-part.if-part { color: var(--success-color); border-bottom-color: var(--success-color); }
    .rule-part.then-part { color: var(--info-color); border-bottom-color: var(--info-color); }
    .form-group { display: flex; flex-direction: column; gap: 8px; }
    .form-group label { font-weight: 600; opacity: 0.9; font-size: 1.1rem; }
    .form-group select, .form-group input, .form-group textarea {
      padding: 12px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(0,0,0,0.3);
      color: var(--text-color);
      font-size: 1rem;
      width: 95%;
      font-family: 'Titillium Web', sans-serif;
    }
    .form-group select:focus, .form-group input:focus, .form-group textarea:focus {
      outline: none;
      border-color: var(--secondary-color);
      box-shadow: 0 0 10px rgba(52, 152, 219, 0.5);
    }
    .form-group textarea { resize: vertical; min-height: 80px; }
    .notification-toggle-group {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
    }
    .rule-list { display: flex; flex-direction: column; gap: 15px; max-height: 600px; overflow-y: auto; padding-right: 10px; }
    .rule-card {
      background: rgba(0,0,0,0.2);
      border-radius: 10px;
      padding: 15px;
      border-left: 5px solid var(--info-color);
      transition: all 0.3s ease;
    }
    .rule-card.disabled { border-left-color: var(--accent-color); opacity: 0.7; }
    .rule-card:hover { transform: translateX(5px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
    .rule-description { font-weight: 500; margin-bottom: 15px; line-height: 1.6; }
    .rule-actions { display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap;}
    .rule-btn { padding: 8px 15px; font-size: 14px; }
    .delete-btn { background: linear-gradient(179deg, #fdfdfc, #dd0000); }
    .toggle-rule-btn.enabled { background: linear-gradient(135deg, #f39c12, #e67e22); }
    .toggle-rule-btn.disabled { background: linear-gradient(135deg, #2ecc71, #27ae60); }
    
    .logic-equation-builder {
      display: flex;
      align-items: stretch;
      gap: 20px;
      background: rgba(0,0,0,0.25);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      padding: 25px;
      flex-direction: row; 
      overflow-x: auto;
    }
    .logic-column { display: flex; flex-direction: column; gap: 20px; min-width: 250px; }
    .logic-inputs-column { flex: 3; }
    .logic-gate-column {
      flex: 1.5;
      justify-content: center;
      align-items: center;
      border-left: 1px dashed rgba(255,255,255,0.3);
      border-right: 1px dashed rgba(255,255,255,0.3);
      padding: 0 25px;
    }
    .logic-output-column { flex: 2; justify-content: flex-start; }
    .logic-gate-column .gate-selector select { font-size: 1.5rem; padding: 15px; font-weight: 700; text-align: center; width: 100%; }
    .logic-gate-column .gate-selector label { font-size: 1.2rem; font-weight: 600; margin-bottom: 10px; text-align: center; display: block; }
    
    .logic-input-group, .logic-output-group {
      display: flex;
      flex-wrap: wrap;
      align-items: flex-end;
      gap: 10px;
      padding: 10px;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
    }
    .logic-input-group .form-group, .logic-output-group .form-group {
        flex: 1;
        margin: 0;
        min-width: 100px;
    }
    .logic-input-group .form-group label, .logic-output-group .form-group label {
      font-size: 0.85rem;
      opacity: 0.8;
      margin-bottom: 4px;
      white-space: nowrap;
    }
    .logic-input-group .form-group select, .logic-output-group .form-group select {
      width: 100%;
      padding: 8px;
      font-size: 0.9rem;
    }
    .logic-input-group .delete-icon, .logic-output-group .delete-icon {
        font-size: 1.1rem;
        margin-left: 5px;
        align-self: center;
        padding-bottom: 12px;
        color: var(--accent-color);
        cursor: pointer;
    }

    #logic-inputs-list, #logic-outputs-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .add-logic-input-btn {
      width: 100%;
      padding: 10px;
      font-size: 0.9rem;
    }

    @media (max-width: 992px) {
      .logic-equation-builder { flex-direction: column; }
      .logic-gate-column { border: none; border-top: 1px dashed rgba(255,255,255,0.3); border-bottom: 1px dashed rgba(255,255,255,0.3); padding: 25px 0; margin: 10px 0; }
    }


    /* --- ইন্টেলিজেন্স ইনসাইটস স্টাইল --- */
    .intelligence-section {
      margin-top: 30px;
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 20px;
      border-top: 4px solid var(--warning-color);
    }
    .intelligence-title { font-size: 1.4rem; margin-bottom: 15px; color: var(--warning-color); text-shadow: 0 0 8px rgba(243, 156, 18, 0.5); }
    #anomaly-alert { color: var(--text-color); font-size: 1rem; line-height: 1.6; }
    .alert-message {
      background: rgba(243, 156, 18, 0.2);
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid var(--warning-color);
    }
    
    .toast-container { 
        position: fixed; 
        bottom: 20px; 
        right: 20px; 
        z-index: 5000; 
        display: flex; 
        flex-direction: column; 
        gap: 10px;
        pointer-events: none;
    }
    .toast-message {
      padding: 15px 20px;
      border-radius: 10px;
      color: white;
      font-weight: 600;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      gap: 10px;
      opacity: 0;
      transform: translateX(100%);
      animation: slideInToast 0.5s forwards, fadeOutToast 0.5s 4.5s forwards;
      pointer-events: auto;
    }
    .toast-message.info { background: linear-gradient(135deg, var(--info-color), #12826a); }
    .toast-message.success { background: linear-gradient(135deg, var(--success-color), #208953); }
    .toast-message.error { background: linear-gradient(135deg, var(--accent-color), #a02d20); }
    .toast-message.warning { background: linear-gradient(135deg, var(--warning-color), #e67e22); }

    @keyframes slideInToast { to { opacity: 1; transform: translateX(0); } }
    @keyframes fadeOutToast { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(100%); } }
    
    .audit-log-container {
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
      border: 1px solid rgba(255, 255, 255, 0.18);
    }
    .audit-log-list { max-height: 70vh; overflow-y: auto; padding-right: 15px; display: flex; flex-direction: column; gap: 15px; }
    .audit-log-item {
      background: rgba(0, 0, 0, 0.25);
      border-radius: 10px;
      padding: 20px;
      border-left: 6px solid var(--info-color);
      display: flex;
      flex-direction: column;
      gap: 10px;
      transition: all 0.3s ease;
    }
    .audit-log-item:hover { transform: translateX(5px); box-shadow: 0 5px 20px rgba(0,0,0,0.2); background: rgba(0, 0, 0, 0.4); }
    .audit-log-item.system-log { border-left-color: var(--warning-color); }
    .audit-log-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .audit-log-user { font-weight: 700; color: var(--secondary-color); font-size: 1.1rem; }
    .audit-log-user-system { color: var(--warning-color); }
    .audit-log-timestamp { font-size: 0.9rem; opacity: 0.8; }
    .audit-log-action { font-size: 1rem; line-height: 1.6; color: var(--text-color); }
    
    .status-dashboard-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; }
    .status-card {
      background: var(--card-bg);
      border-radius: 15px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
      text-align: center;
      border-top: 4px solid var(--info-color);
      transition: all 0.3s ease;
    }
    .status-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
    .status-card-title { font-size: 1.2rem; font-weight: 600; display: flex; align-items: center; gap: 10px; color: var(--text-color); }
    .status-card-value { font-size: 1.6rem; font-weight: 700; }
    .status-indicator { width: 15px; height: 15px; border-radius: 50%; background-color: #7f8c8d; box-shadow: 0 0 8px #7f8c8d; }
    .status-indicator.connected { background-color: var(--success-color); box-shadow: 0 0 10px var(--success-color); }
    .status-indicator.disconnected { background-color: var(--accent-color); box-shadow: 0 0 10px var(--accent-color); }
    .ram-progress-bar { width: 100%; height: 20px; background-color: rgba(0,0,0,0.3); border-radius: 10px; overflow: hidden; }
    .ram-progress-fill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--info-color), var(--success-color)); border-radius: 10px; transition: width 0.5s ease; }

    .scene-buttons { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }
    .scene-item-container {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(0,0,0,0.2);
      padding: 5px 10px;
      border-radius: 10px;
      transition: all 0.3s ease;
    }
    .scene-item-container:hover { background: rgba(0,0,0,0.4); }
    .scene-item-container .scene-btn { flex-grow: 1; background: linear-gradient(135deg, #8e44ad, #9b59b6); font-size: 1rem; margin: 0; box-shadow: none; }
    .scene-item-container .delete-scene-icon { color: var(--text-color); opacity: 0.6; cursor: pointer; transition: all 0.3s ease; }
    .scene-item-container .delete-scene-icon:hover { opacity: 1; color: var(--accent-color); transform: scale(1.2); }

    .create-scene-btn { background: linear-gradient(135deg, #16a085, #1abc9c); }
    .scene-modal-box { border-top-color: #8e44ad; }
    .scene-relay-list { max-height: 250px; overflow-y: auto; text-align: left; margin: 20px 0; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; }
    .scene-relay-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0 10px 15px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .scene-relay-item:last-child { border-bottom: none; }
    .scene-device-header {
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--secondary-color);
      background: rgba(0,0,0,0.3);
      padding: 8px 15px;
      margin-top: 15px;
      border-radius: 5px;
      border-left: 3px solid var(--secondary-color);
    }
    .scene-device-header:first-of-type { margin-top: 0; }
    .scene-action-select { background: rgba(0,0,0,0.4); color: var(--text-color); border: 1px solid rgba(255,255,255,0.2); padding: 5px; border-radius: 5px; }

    .edit-relay-name-icon { margin-left: 10px; cursor: pointer; opacity: 0.6; transition: all 0.3s ease; }
    .edit-relay-name-icon:hover { opacity: 1; color: var(--secondary-color); transform: scale(1.2); }
    
    .add-new-btn-container { margin-top: 30px; padding: 20px; background: var(--card-bg); border-radius: 15px; text-align: center; }
    .add-relay-btn { margin-top: 15px; width: 100%; padding: 12px; font-size: 1rem; background: linear-gradient(135deg, #16a085, #1abc9c); }
    
    .control-section-title { display: flex; justify-content: space-between; align-items: center; }
    .delete-icon { margin-left: 15px; cursor: pointer; opacity: 0.6; transition: all 0.3s ease; font-size: 1.2rem; }
    .delete-icon:hover { opacity: 1; color: var(--accent-color); transform: scale(1.2); }

    #add-new-page-btn { border: 2px dashed var(--secondary-color); }
    .nav-tab .page-actions { margin-left: 10px; display: inline-flex; gap: 8px; }
    .nav-tab .page-actions i { opacity: 0.7; transition: all 0.2s ease-in-out; }
    .nav-tab:hover .page-actions i { opacity: 1; }
    .nav-tab .page-actions i:hover { transform: scale(1.2); color: var(--warning-color); }
    .nav-tab .page-actions .fa-trash-alt:hover { color: var(--accent-color); }
    .page-editor-content { display: flex; flex-direction: column; gap: 15px; }
    .page-editor-group h4 { color: var(--secondary-color); border-bottom: 1px solid var(--secondary-color); padding-bottom: 5px; margin-bottom: 10px; }
    .page-editor-group label { display: block; padding: 8px; border-radius: 5px; transition: background-color 0.2s; }
    .page-editor-group label:hover { background-color: rgba(255,255,255,0.1); }
    .page-editor-group input[type="checkbox"] { margin-right: 10px; }
    .dynamic-page-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 25px; }
    .dynamic-page-grid > * { width: 100%; }
    
    /* --- NEW TEMPERATURE MONITOR STYLES (v20.3.7) --- */
    .temperature-page-grid { 
        display: grid; 
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
        gap: 20px; 
    }
    
    .temp-sensor-card {
        background-color: var(--temp-card-bg);
        border-radius: 12px;
        padding: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        display: flex;
        flex-direction: column;
        gap: 15px;
        border: 1px solid rgba(255,255,255,0.05);
        transition: transform 0.2s;
        will-change: transform;
        backface-visibility: hidden;
        transform: translateZ(0);
    }

    .temp-sensor-card:hover {
        transform: translateY(-3px);
    }

    .temp-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        padding-bottom: 10px;
    }

    .temp-sensor-name {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--text-color);
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .temp-sensor-name i {
        color: var(--info-color);
    }

    /* ★★★ CLICKABLE GAUGE CONTAINER ★★★ */
    .temp-gauges-container {
        display: flex;
        justify-content: space-around;
        align-items: center;
        cursor: pointer; /* Hand cursor */
        padding: 10px;
        border-radius: 8px;
        transition: background-color 0.2s;
    }

    .temp-gauges-container:hover {
        background-color: rgba(255,255,255,0.05);
    }

    .circular-progress {
        width: 100px;
        height: 100px;
        position: relative;
    }

    .circular-progress svg {
        width: 100%;
        height: 100%;
        transform: rotate(-90deg);
    }

    .circular-progress circle {
        fill: none;
        stroke-width: 8;
        stroke-linecap: round;
    }

    .progress-bg {
        stroke: var(--temp-circle-bg);
    }

    .progress-bar {
        stroke-dasharray: 226; /* 2 * PI * 36 */
        stroke-dashoffset: 226;
        transition: stroke-dashoffset 1s ease-out;
    }

    .progress-bar.celsius { stroke: var(--temp-c-color); }
    .progress-bar.fahrenheit { stroke: var(--temp-f-color); }

    .gauge-value-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
    }

    .val-main {
        font-size: 1.2rem;
        font-weight: 700;
        display: block;
    }

    .val-unit {
        font-size: 0.8rem;
        opacity: 0.7;
    }

    .gauge-label {
        text-align: center;
        font-size: 0.7rem;
        margin-top: 5px;
        font-weight: 600;
        letter-spacing: 1px;
        opacity: 0.6;
        color: var(--secondary-color);
    }

    .temp-mini-graph {
        height: 60px;
        width: 100%;
        background: rgba(0,0,0,0.2);
        border-radius: 8px;
        overflow: hidden;
        position: relative;
    }
    
    .temp-mini-graph canvas {
        width: 100% !important;
        height: 100% !important;
    }

    @media (max-width: 1200px) { .temperature-group-grid { grid-template-columns: 1fr; } }

    /* মিডিয়া কোয়েরি */
    @media (max-width: 1024px) { .analytics-section, .energy-graphs, .dynamic-page-grid { grid-template-columns: 1fr; } }
    @media (max-width: 768px) {
      .login-box, .registration-box { width: 90%; padding: 4px; }
      .login-box-inner { padding: 1.5rem; }
      .nav-tabs { flex-direction: row; }
      .device-cards, .energy-metrics { grid-template-columns: 1fr 1fr; }
      .device-status-summary { grid-template-columns: 1fr 1fr; gap: 20px; }
      .dashboard-header { flex-direction: column; gap: 15px; align-items: center; }
      .header-controls { width: auto; flex-wrap: wrap; justify-content: center; }
      .password-modal-box, .timer-modal-box { width: 70%; padding: 17px; }
      .temperature-group-grid, .temperature-section { grid-template-columns: 1fr; }
    }
    @media (max-width: 480px) { .device-cards, .energy-metrics, .toggle-switch-grid, .device-status-summary { grid-template-columns: 1fr; } .login-box h2, .registration-box h2 { font-size: 1.5rem; } }
      
    /* অন্যান্য স্টাইল */
    .login-footer { margin-top: 20px; font-size: 14px; opacity: 0.7; color: var(--text-color); animation: fadeIn 2s ease-in-out; }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .card-title { font-size: 1rem; font-weight: 500; color: var(--text-color); }
    .card-status { padding: 4px 8px; border-radius: 20px; font-size: 11px; font-weight: 600; color: white; }
    .status-active { background: var(--success-color); }
    .status-inactive { background: var(--accent-color); }
    .status-warning { background: var(--warning-color); }
    .card-value { margin: 10px 0; text-align: center; color: var(--text-color); }
    .status-item { text-align: center; }
    .status-label { font-size: 0.9rem; opacity: 0.8; color: var(--text-color); }
    .log-list { max-height: 300px; overflow-y: auto; }
    .log-item { padding: 8px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.05); font-size: 0.9rem; }
    .log-time { color: var(--secondary-color); font-size: 0.8rem; }
    .log-message { margin-top: 3px; }
    .log-warning { color: var(--warning-color); }
    .log-error { color: var(--accent-color); }
    .log-success { color: var(--success-color); }
    .log-info { color: var(--secondary-color); }
    .energy-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 10px; color: var(--text-color); display: flex; align-items: center; }
    .energy-value { font-size: 1.8rem; font-weight: 700; margin: 10px 0; color: var(--text-color); }
    .energy-unit { font-size: 1rem; opacity: 0.8; margin-left: 5px; }
    .voltage-card { border-top-color: var(--voltage-color); }
    .current-card { border-top-color: var(--current-color); }
    .power-card { border-top-color: var(--power-color); }
    .energy-card-main { border-top-color: var(--energy-color); }
    .frequency-card { border-top-color: var(--info-color); }
    .power-factor-card { border-top-color: var(--warning-color); }
    .active-power-card { border-top-color: var(--success-color); }
    .reactive-power-card { border-top-color: var(--accent-color); }
    .units-card { border-top-color: var(--info-color); }
    .cost-card { border-top-color: var(--success-color); }
    .timestamp-card { border-top-color: var(--warning-color); }
    .energy-graphs { display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 20px; margin-top: 30px; }
    .graph-title { font-size: 1.2rem; margin-bottom: 15px; color: var(--text-color); }
    .time-selection { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .time-btn { padding: 8px 15px; border: none; border-radius: 5px; background: var(--secondary-color); color: white; cursor: pointer; transition: all 0.3s ease; font-size: 14px; }
    .time-btn:hover { background: var(--primary-color); transform: translateY(-2px); }
    .time-btn.active { background: var(--success-color); box-shadow: 0 0 0 2px var(--light-color); }
    .metric-selection { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px; }
    .metric-card { background: var(--card-bg); border-radius: 8px; padding: 15px; cursor: pointer; transition: all 0.3s ease; border-left: 4px solid transparent; box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1); }
    .metric-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); }
    .metric-card.selected { border-left-color: var(--secondary-color); background: rgba(52, 152, 219, 0.2); }
    .metric-title { font-weight: 600; margin-bottom: 5px; display: flex; align-items: center; gap: 8px; }
    .metric-icon { font-size: 1.2rem; }
    .metric-description { font-size: 0.8rem; opacity: 0.8; }
    .graph-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .graph-controls { display: flex; align-items: center; gap: 10px; }
    .graph-btn { padding: 5px 10px; border: none; border-radius: 4px; background: var(--secondary-color); color: white; cursor: pointer; font-size: 12px; transition: all 0.3s ease; }
    .graph-btn:hover { background: var(--primary-color); }
    .no-data-message { text-align: center; padding: 20px; color: var(--text-color); opacity: 0.7; }
    .note-subtitle { font-size: 1.2rem; margin: 20px 0 10px; color: var(--secondary-color); }
    .note-paragraph { margin-bottom: 15px; line-height: 1.6; text-align: justify; }
    .note-letter { background: rgba(52, 152, 219, 0.2); border-left: 4px solid var(--secondary-color); padding: 15px; margin: 15px 0; border-radius: 0 5px 5px 0; }
    .note-letter-title { font-weight: 600; margin-bottom: 8px; color: var(--secondary-color); }
    .note-letter-content { line-height: 1.5; }
    .note-images { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin: 25px 0; }
    .note-image { border-radius: 8px; overflow: hidden; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); transition: transform 0.3s ease; cursor: pointer; }
    .note-image:hover { transform: scale(1.02); }
    .note-image img { width: 100%; height: auto; display: block; }
    .note-image-caption { background: rgba(0, 0, 0, 0.7); color: white; padding: 8px; text-align: center; font-size: 0.9rem; }
    .image-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9); z-index: 2000; overflow: auto; animation: fadeIn 0.3s; }
    .modal-content { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; padding: 20px; }
    .modal-image { max-width: 200%; max-height: 80vh; object-fit: contain; animation: zoomIn 0.3s; }
    .modal-caption { color: white; text-align: center; margin-top: 15px; font-size: 1.2rem; }
    .close-modal { position: absolute; top: 20px; right: 30px; color: white; font-size: 35px; font-weight: bold; cursor: pointer; transition: 0.3s; }
    .close-modal:hover { color: var(--secondary-color); }
    @keyframes zoomIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .toggle-switch-header { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 10px; }
    .toggle-switch-label { font-size: 1.1rem; font-weight: 600; color: var(--text-color); display: flex; align-items: center; }
    .device-time-info { font-size: 0.8rem; opacity: 0.8; text-align: right; }
    .device-time-info span { display: block; }
    .device-time-info .fa-calendar-alt { color: var(--secondary-color); margin-right: 5px; }
    .device-time-info .fa-clock { color: var(--info-color); margin-right: 5px; }
    .toggle-switch-body { width: 100%; margin-bottom: 15px; min-height: 20px; }
    .toggle-switch-footer { display: flex; justify-content: space-between; align-items: center; width: 100%; }
    .toggle-switch { position: relative; display: inline-block; width: 70px; height: 38px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 38px; box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.5), 0 1px 1px rgba(255, 255, 255, 0.1); }
    .slider:before { position: absolute; content: ""; height: 30px; width: 30px; left: 4px; bottom: 4px; background: linear-gradient(to bottom, #fdfdfd, #c1c1c1); transition: .4s cubic-bezier(0.68, -0.55, 0.27, 1.55); border-radius: 50%; box-shadow: 0 5px 10px rgba(0, 0, 0, 0.4), inset 0 1px 1px rgba(255, 255, 255, 0.7); }
    .slider:after { content: 'OFF'; color: #aaa; position: absolute; right: 10px; top: 50%; transform: translateY(-50%); font-size: 12px; font-weight: bold; transition: all 0.4s ease; }
    input:checked+.slider { background: linear-gradient(to right, #28a745, #2ecc71); box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.3); }
    input:focus+.slider { box-shadow: 0 0 2px var(--success-color); }
    input:checked+.slider:before { transform: translateX(32px); }
    input:checked+.slider:after { content: 'ON'; color: white; left: 15px; right: auto; }
    input:active+.slider:before { transform: scale(0.9); }
    input:checked:active+.slider:before { transform: translateX(32px) scale(0.9); }
    .password-modal-box h3 { color: var(--text-color); font-size: 1.6rem; margin-top: 0; margin-bottom: 10px; font-weight: 600; }
    .password-modal-box p { color: var(--text-color); opacity: 0.8; margin-bottom: 25px; }
    .password-input-group { position: relative; margin-bottom: 20px; }
    .password-input-group input:focus { outline: none; border-color: var(--secondary-color); box-shadow: 0 0 15px rgba(52, 152, 219, 0.5); }
    .password-error-message { color: var(--accent-color); height: 20px; font-size: 0.9rem; margin-bottom: 10px; }
    .password-modal-buttons { display: flex; justify-content: space-between; }
    .timer-modal-box h3 { font-size: 1.8rem; color: var(--text-color); margin-bottom: 20px; text-align: center; }
    .timer-form { display: flex; flex-direction: column; gap: 18px; margin-bottom: 20px; }
    .timer-row { display: flex; justify-content: space-between; align-items: center; background: rgba(0, 0, 0, 0.15); padding: 10px 15px; border-radius: 8px; }
    .timer-row label { font-weight: 500; font-size: 1rem; }
    #timer-enabled-btn.enabled { background-color: var(--success-color); }
    #timer-enabled-btn.disabled { background-color: var(--accent-color); }
    .timer-time-input, .timer-select { background-color: rgba(0, 0, 0, 0.3); color: var(--text-color); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 5px; padding: 8px; font-size: 1rem; width: 180px; }
    .timer-note { font-size: 0.9rem; text-align: center; opacity: 0.8; margin-bottom: 15px; }
    .modal-btn { flex: .90; padding: 12px 20px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 5px 4px 6px 4px rgba(0, 0, 0, 0.3); }
    
    /* --- NEW: Note Editing Styles --- */
    .note-block { position: relative; transition: all 0.3s ease; }
    .note-block:hover .note-controls { opacity: 1; }
    .note-controls {
      position: absolute;
      top: 5px; right: 5px;
      display: flex; gap: 5px;
      opacity: 0;
      transition: opacity 0.3s ease;
      background: rgba(0,0,0,0.6);
      padding: 5px;
      border-radius: 5px;
      z-index: 10;
    }
    .note-controls i {
      color: white; cursor: pointer; font-size: 0.9rem; padding: 5px;
      transition: color 0.2s;
    }
    .note-controls i:hover { color: var(--secondary-color); }
    .note-controls i.fa-trash-alt:hover { color: var(--accent-color); }
    
    /* Floating Add Button for Notes */
    .add-note-btn-container {
        text-align: center; margin: 20px 0;
    }
    .add-note-btn {
        background: linear-gradient(135deg, #16a085, #1abc9c);
        color: white; padding: 10px 20px; border-radius: 50px;
        border: none; cursor: pointer; font-weight: 600;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }

    /* ================================================================
       থিম ওভাররাইড - নতুন ভিজ্যুয়াল স্টাইল
    ================================================================ */

    /* --- ফন্ট ওভাররাইড --- */
    .dashboard-title, .section-title, .note-title, .control-section-title,
    .password-modal-box h3, .timer-modal-box h3, .scene-modal-box h3,
    .login-box h2, .registration-box h2, .loading-text,
    .status-count, .energy-value, .control-value, .temp-value-c,
    .rule-part, .insight-title, .graph-title, .temp-name, .temp-sensor-name,
    .status-card-title, .status-card-value {
      font-family: 'Rajdhani', sans-serif;
    }

    body, input, select, textarea, button, .pro-btn, .nav-tab,
    .form-group label, .rule-description, .timer-row label {
      font-family: 'Exo 2', 'Segoe UI', sans-serif;
    }

    /* --- ড্যাশবোর্ড হেডার গ্লো টপ বর্ডার --- */
    .dashboard-header {
      position: relative;
      overflow: hidden;
      border: 1px solid var(--card-border) !important;
      background: var(--card-bg) !important;
      backdrop-filter: blur(20px);
    }
    .dashboard-header::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--secondary-color), var(--success-color), var(--secondary-color), transparent);
      z-index: 1;
    }

    .dashboard-title {
      letter-spacing: 3px;
      text-transform: uppercase;
      text-shadow: 0 0 25px rgba(0, 212, 255, 0.45), 0 0 60px rgba(0, 212, 255, 0.15);
    }

    /* --- নেভ ট্যাব গ্লো ইফেক্ট --- */
    .nav-tab.active {
      color: var(--secondary-color) !important;
      border: 1px solid var(--secondary-color) !important;
      background: rgba(0, 212, 255, 0.1) !important;
      box-shadow: 0 0 15px rgba(0, 212, 255, 0.2) !important;
    }
    .nav-tab {
      border: 1px solid transparent !important;
      transition: all 0.25s ease !important;
      border-radius: 6px !important;
    }
    .nav-tab:hover {
      color: var(--secondary-color) !important;
      border-color: rgba(0, 212, 255, 0.3) !important;
      background: rgba(0, 212, 255, 0.07) !important;
    }

    /* --- সেকশন টাইটেল আপগ্রেড --- */
    .section-title, .note-title, .control-section-title {
      letter-spacing: 2px;
      text-transform: uppercase;
      border-bottom: 1px solid rgba(0, 212, 255, 0.2) !important;
      text-shadow: 0 0 15px rgba(0, 212, 255, 0.35);
    }

    /* --- কার্ড গ্লাস ইফেক্ট --- */
    .device-card, .energy-card, .rule-builder-card, .automation-container,
    .chart-container, .log-container, .intelligence-section,
    .control-panel, .system-status-card, .temp-sensor-card {
      background: var(--card-bg) !important;
      backdrop-filter: blur(16px) !important;
      border: 1px solid var(--card-border) !important;
      box-shadow: 0 4px 24px rgba(0,0,0,0.35) !important;
    }
    .device-card:hover, .energy-card:hover, .temp-sensor-card:hover {
      border-color: rgba(0, 212, 255, 0.4) !important;
      box-shadow: 0 8px 30px rgba(0, 212, 255, 0.12) !important;
      transform: translateY(-4px) !important;
    }

    /* --- প্রো বাটন নিওন স্টাইল --- */
    .pro-btn {
      background: rgba(0, 212, 255, 0.07) !important;
      border: 1px solid rgba(0, 212, 255, 0.25) !important;
      color: var(--text-color) !important;
      border-radius: 7px !important;
      transition: all 0.25s ease !important;
    }
    .pro-btn:hover {
      border-color: var(--secondary-color) !important;
      box-shadow: 0 0 15px rgba(0, 212, 255, 0.3) !important;
      transform: translateY(-1px) !important;
      background: rgba(0, 212, 255, 0.13) !important;
    }
    .btn-on {
      border-color: var(--success-color) !important;
      color: var(--success-color) !important;
      background: rgba(0, 255, 157, 0.07) !important;
    }
    .btn-on:hover { box-shadow: 0 0 18px rgba(0, 255, 157, 0.4) !important; }
    .btn-off {
      border-color: var(--accent-color) !important;
      color: var(--accent-color) !important;
      background: rgba(255, 45, 91, 0.07) !important;
    }
    .btn-off:hover { box-shadow: 0 0 18px rgba(255, 45, 91, 0.4) !important; }
    .btn-info, .confirm-btn {
      border-color: var(--secondary-color) !important;
      color: var(--secondary-color) !important;
      background: rgba(0, 212, 255, 0.09) !important;
    }
    .confirm-btn:hover { box-shadow: 0 0 18px rgba(0, 212, 255, 0.4) !important; }
    .cancel-btn {
      border-color: rgba(255, 45, 91, 0.5) !important;
      color: var(--accent-color) !important;
      background: rgba(255, 45, 91, 0.06) !important;
    }
    .cancel-btn:hover { box-shadow: 0 0 15px rgba(255, 45, 91, 0.35) !important; }
    .logout-btn {
      border-color: rgba(255, 45, 91, 0.5) !important;
      color: var(--accent-color) !important;
      background: rgba(255, 45, 91, 0.08) !important;
    }
    .background-btn, .sort-lock-btn {
      border-color: rgba(200, 75, 255, 0.4) !important;
      color: var(--energy-color) !important;
      background: rgba(200, 75, 255, 0.07) !important;
    }
    .notification-btn {
      border-color: rgba(255, 183, 0, 0.4) !important;
      color: var(--warning-color) !important;
      background: rgba(255, 183, 0, 0.07) !important;
    }
    .btn-warning {
      border-color: rgba(255, 183, 0, 0.4) !important;
      color: var(--warning-color) !important;
      background: rgba(255, 183, 0, 0.07) !important;
    }
    .delete-btn {
      border-color: var(--accent-color) !important;
      color: var(--accent-color) !important;
      background: rgba(255, 45, 91, 0.07) !important;
    }
    .delete-btn:hover { box-shadow: 0 0 15px rgba(255, 45, 91, 0.35) !important; }
    .edit-btn {
      border-color: rgba(255, 183, 0, 0.4) !important;
      color: var(--warning-color) !important;
      background: rgba(255, 183, 0, 0.07) !important;
    }
    .toggle-rule-btn.enabled  { border-color: rgba(255,183,0,0.4) !important; color: var(--warning-color) !important; background: rgba(255,183,0,0.07) !important; }
    .toggle-rule-btn.disabled { border-color: var(--success-color) !important; color: var(--success-color) !important; background: rgba(0,255,157,0.07) !important; }

    /* --- লগইন বক্স নিওন বর্ডার --- */
    .login-box::before, .registration-box::before {
      background: conic-gradient(from 0deg, #00d4ff, #c84bff, #ff2d5b, #00ff9d, #ffb700, #00d4ff) !important;
      animation: spinBorder 4s linear infinite !important;
    }
    @keyframes spinBorder { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .login-box-inner {
      background: rgba(3, 8, 20, 0.97) !important;
      backdrop-filter: blur(20px) !important;
    }
    .login-box h2, .registration-box h2 {
      color: #ffffff !important;
      letter-spacing: 2px;
      text-transform: uppercase;
      text-shadow: 0 0 20px rgba(0, 212, 255, 0.5) !important;
    }
    .input-group input {
      border: 1px solid rgba(0, 212, 255, 0.2) !important;
      background: rgba(0, 212, 255, 0.04) !important;
      border-radius: 8px !important;
    }
    .input-group input:focus {
      border-color: var(--secondary-color) !important;
      box-shadow: 0 0 18px rgba(0, 212, 255, 0.3), inset 0 0 8px rgba(0, 212, 255, 0.04) !important;
      background: rgba(0, 212, 255, 0.08) !important;
    }
    .action-btn {
      background: rgba(0, 212, 255, 0.1) !important;
      color: var(--secondary-color) !important;
      border: 1px solid var(--secondary-color) !important;
      border-radius: 8px !important;
      font-weight: 700 !important;
      letter-spacing: 2px !important;
      text-transform: uppercase !important;
      box-shadow: 0 0 18px rgba(0, 212, 255, 0.2) !important;
    }
    .action-btn:hover {
      background: rgba(0, 212, 255, 0.18) !important;
      box-shadow: 0 0 28px rgba(0, 212, 255, 0.5) !important;
      transform: translateY(-2px) !important;
    }

    /* --- মোডাল নিওন বর্ডার --- */
    .password-modal-box, .timer-modal-box {
      background: rgba(3, 8, 20, 0.98) !important;
      backdrop-filter: blur(20px) !important;
      border: 1px solid rgba(0, 212, 255, 0.18) !important;
      border-top: 3px solid var(--secondary-color) !important;
      box-shadow: 0 0 50px rgba(0, 212, 255, 0.08), 0 25px 50px rgba(0,0,0,0.65) !important;
    }
    .timer-modal-box { border-top-color: var(--warning-color) !important; }
    .scene-modal-box {
      background: rgba(3, 8, 20, 0.98) !important;
      backdrop-filter: blur(20px) !important;
      border: 1px solid rgba(200, 75, 255, 0.2) !important;
      border-top: 3px solid var(--energy-color) !important;
      box-shadow: 0 0 50px rgba(200, 75, 255, 0.08), 0 25px 50px rgba(0,0,0,0.65) !important;
    }
    .password-modal-box h3 {
      color: var(--secondary-color) !important;
      letter-spacing: 2px;
      text-transform: uppercase;
      text-shadow: 0 0 15px rgba(0,212,255,0.4);
    }
    .timer-modal-box h3 {
      color: var(--warning-color) !important;
      letter-spacing: 2px;
    }
    .scene-modal-box h3 {
      color: var(--energy-color) !important;
      text-shadow: 0 0 15px rgba(200,75,255,0.4);
    }
    .password-input-group input {
      background: rgba(0, 212, 255, 0.04) !important;
      border: 1px solid rgba(0, 212, 255, 0.18) !important;
    }
    .password-input-group input:focus {
      border-color: var(--secondary-color) !important;
      box-shadow: 0 0 14px rgba(0, 212, 255, 0.3) !important;
    }

    /* --- টগল সুইচ নিওন --- */
    .slider {
      background: rgba(255, 45, 91, 0.12) !important;
      border: 1px solid rgba(255, 45, 91, 0.4) !important;
    }
    .slider:before {
      background: var(--accent-color) !important;
      box-shadow: 0 0 8px rgba(255, 45, 91, 0.6) !important;
    }
    .slider:after { color: rgba(255,45,91,0.8) !important; }
    input:checked + .slider {
      background: rgba(0, 255, 157, 0.1) !important;
      border-color: rgba(0, 255, 157, 0.5) !important;
    }
    input:checked + .slider:before {
      background: var(--success-color) !important;
      box-shadow: 0 0 14px rgba(0, 255, 157, 0.65) !important;
    }
    input:checked + .slider:after { color: var(--success-color) !important; }

    /* --- টোস্ট নোটিফিকেশন --- */
    .toast-success { background: rgba(0, 255, 157, 0.1) !important; border: 1px solid var(--success-color) !important; color: var(--success-color) !important; box-shadow: 0 0 20px rgba(0,255,157,0.2) !important; }
    .toast-error   { background: rgba(255, 45, 91, 0.1) !important; border: 1px solid var(--accent-color) !important; color: var(--accent-color) !important; box-shadow: 0 0 20px rgba(255,45,91,0.2) !important; }
    .toast-warning { background: rgba(255, 183, 0, 0.1) !important; border: 1px solid var(--warning-color) !important; color: var(--warning-color) !important; box-shadow: 0 0 20px rgba(255,183,0,0.2) !important; }
    .toast-info    { background: rgba(0, 212, 255, 0.1) !important; border: 1px solid var(--secondary-color) !important; color: var(--secondary-color) !important; box-shadow: 0 0 20px rgba(0,212,255,0.2) !important; }

    /* --- লোডিং স্ক্রিন --- */
    .app-loading-screen { background: rgba(2, 6, 16, 0.98) !important; }
    .loading-spinner {
      border-color: rgba(0, 212, 255, 0.1) !important;
      border-top-color: var(--secondary-color) !important;
      border-right-color: var(--success-color) !important;
      box-shadow: 0 0 20px rgba(0, 212, 255, 0.4) !important;
    }
    .loading-text {
      color: var(--secondary-color) !important;
      letter-spacing: 4px;
      text-transform: uppercase;
      text-shadow: 0 0 15px rgba(0,212,255,0.5);
    }

    /* --- লগইন কন্টেইনার --- */
    .login-container::after {
      content: '';
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-image:
        linear-gradient(rgba(0, 212, 255, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 212, 255, 0.03) 1px, transparent 1px);
      background-size: 40px 40px;
      z-index: 0;
      pointer-events: none;
    }

    /* --- লগইন লোগো --- */
    .login-logo {
      filter: drop-shadow(0 0 20px rgba(0, 212, 255, 0.75)) !important;
    }
    .app-logo {
      filter: drop-shadow(0 0 14px rgba(0, 212, 255, 0.65)) !important;
    }
    .login-logo-ring:nth-child(2), .app-logo-ring { border-top-color: var(--secondary-color) !important; }
    .login-logo-ring:nth-child(3), .app-logo-ring:nth-child(2) { border-top-color: var(--accent-color) !important; }
    .login-logo-ring:nth-child(4), .app-logo-ring:nth-child(3) { border-top-color: var(--success-color) !important; }

    /* --- স্ট্যাটাস কাউন্ট নিওন --- */
    .status-count {
      color: var(--secondary-color) !important;
      text-shadow: 0 0 12px rgba(0, 212, 255, 0.5) !important;
    }

    /* --- টগল কন্টেইনার --- */
    .toggle-switch-container {
      background: rgba(3, 8, 20, 0.65) !important;
      border: 1px solid var(--card-border) !important;
      border-left: 3px solid rgba(255, 45, 91, 0.35) !important;
    }
    .toggle-switch-container:hover {
      background: rgba(0, 212, 255, 0.04) !important;
      border-left-color: var(--secondary-color) !important;
      box-shadow: 0 6px 22px rgba(0, 212, 255, 0.1) !important;
    }

    /* --- রুল কার্ড --- */
    .rule-card {
      background: rgba(0, 212, 255, 0.03) !important;
      border: 1px solid rgba(0, 212, 255, 0.1) !important;
      border-left: 3px solid var(--secondary-color) !important;
    }
    .rule-card.disabled { border-left-color: var(--accent-color) !important; }
    .rule-card:hover { box-shadow: 0 0 15px rgba(0,212,255,0.1) !important; }

    /* --- টাইম বাটন --- */
    .time-btn.active {
      border-color: var(--success-color) !important;
      color: var(--success-color) !important;
      background: rgba(0, 255, 157, 0.1) !important;
      box-shadow: 0 0 10px rgba(0,255,157,0.25) !important;
    }

    /* --- মেট্রিক কার্ড --- */
    .metric-card.selected {
      border-left-color: var(--secondary-color) !important;
      background: rgba(0, 212, 255, 0.08) !important;
    }

    /* --- সার্কুলার প্রোগ্রেস (তাপমাত্রা) --- */
    .circular-progress .progress-bar.celsius { stroke: var(--temp-c-color) !important; filter: drop-shadow(0 0 4px rgba(0,212,255,0.6)); }
    .circular-progress .progress-bar.fahrenheit { stroke: var(--temp-f-color) !important; filter: drop-shadow(0 0 4px rgba(255,140,0,0.6)); }
    .val-main { color: var(--secondary-color) !important; text-shadow: 0 0 10px rgba(0,212,255,0.5) !important; }

    /* --- অডিট লগ --- */
    .audit-log-container {
      background: var(--card-bg) !important;
      backdrop-filter: blur(16px) !important;
      border: 1px solid var(--card-border) !important;
    }
    .audit-log-item { border-bottom-color: rgba(0, 212, 255, 0.06) !important; }
    .audit-log-timestamp { color: var(--secondary-color) !important; }

    /* --- সিস্টেম স্ট্যাটাস --- */
    .status-card {
      background: var(--card-bg) !important;
      border: 1px solid var(--card-border) !important;
      backdrop-filter: blur(15px) !important;
    }
    .status-active   { color: var(--success-color) !important; }
    .status-inactive { color: var(--accent-color) !important; }
    .status-warning  { color: var(--warning-color) !important; }
    .status-indicator.online  { background: var(--success-color) !important; box-shadow: 0 0 8px var(--success-color) !important; }
    .status-indicator.offline { background: var(--accent-color) !important; box-shadow: 0 0 8px var(--accent-color) !important; }

    /* --- স্ক্রলবার --- */
    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
    ::-webkit-scrollbar-thumb { background: rgba(0, 212, 255, 0.3); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--secondary-color); }

    /* --- সর্টেবল ঘোস্ট --- */
    .sortable-ghost {
      opacity: 0.3 !important;
      background: rgba(0, 212, 255, 0.08) !important;
      border: 1px dashed var(--secondary-color) !important;
    }

    /* --- এনার্জি ভ্যালু নিওন --- */
    .energy-value { text-shadow: 0 0 10px rgba(0, 212, 255, 0.3); }

    /* --- path config popover --- */
    #path-selector-popover {
      background: rgba(3, 8, 20, 0.98) !important;
      border: 1px solid rgba(0, 212, 255, 0.2) !important;
      box-shadow: 0 15px 40px rgba(0,0,0,0.6), 0 0 0 1px rgba(0,212,255,0.1) !important;
    }
    #path-selector-popover select {
      background: rgba(0, 212, 255, 0.04) !important;
      border: 1px solid rgba(0, 212, 255, 0.15) !important;
      color: var(--text-color) !important;
    }

    /* --- অ্যাড নিউ বাটন --- */
    .add-relay-btn, .card-btn {
      background: rgba(0, 212, 255, 0.07) !important;
      border: 1px solid rgba(0, 212, 255, 0.25) !important;
      color: var(--secondary-color) !important;
    }
    .add-relay-btn:hover, .card-btn:hover {
      box-shadow: 0 0 15px rgba(0, 212, 255, 0.3) !important;
    }

    /* --- ফর্ম গ্রুপ সিলেক্ট --- */
    .form-group select, .form-group input, .form-group textarea,
    .timer-time-input, .timer-select {
      background: rgba(0, 212, 255, 0.04) !important;
      border: 1px solid rgba(0, 212, 255, 0.15) !important;
      color: var(--text-color) !important;
    }
    .form-group select:focus, .form-group input:focus, .form-group textarea:focus {
      border-color: var(--secondary-color) !important;
      box-shadow: 0 0 10px rgba(0, 212, 255, 0.25) !important;
    }

    /* --- রেসপন্সিভ --- */
    @media (max-width: 768px) {
      .dashboard-title { font-size: 1.3rem; letter-spacing: 1.5px; }
      .pro-btn { padding: 7px 12px; font-size: 0.8rem; }
      #app { padding: 10px; }
    }

  </style>
</head>
<body class="bg-0">

<div id="global-loader" class="app-loading-screen">
    <div class="loading-spinner"></div>
    <div class="loading-text">সিস্টেম লোড হচ্ছে...</div>
</div>

<div class="login-container" id="login-screen">
  <div class="login-particles" id="particles"></div>
  <div class="login-logo-container">
    <img src="Bisnu.png" class="login-logo" alt="BISNU IoT Logo">
    <div class="login-logo-ring"></div>
    <div class="login-logo-ring"></div>
    <div class="login-logo-ring"></div>
  </div>
  
  <div class="login-box form-active" id="login-box">
    <div class="login-box-inner">
      <h2>BISNU IoT কন্ট্রোল প্যানেল</h2>
      <div class="input-group"> <input type="email" id="email" placeholder="ইমেল লিখুন" autocomplete="email"> </div>
      <div class="input-group"> <input type="password" id="password" placeholder="পাসওয়ার্ড লিখুন" autocomplete="current-password"> </div>
      <button class="action-btn" onclick="loginWithFirebase()">লগইন করুন</button>
      <div class="error-message" id="login-error"></div>
      <div class="form-switcher"> আপনার কোনো একাউন্ট নেই? <a onclick="openRegistrationSecurityModal()">রেজিস্টার করুন</a> </div>
    </div>
  </div>

  <div class="registration-box" id="registration-box">
    <div class="login-box-inner">
      <h2>নতুন একাউন্ট তৈরি করুন</h2>
      <div class="input-group"> <input type="text" id="register-username" placeholder="ব্যবহারকারীর নাম" autocomplete="username"> </div>
      <div class="input-group"> <input type="email" id="register-email" placeholder="ইমেল লিখুন" autocomplete="email"> </div>
      <div class="input-group"> <input type="password" id="register-password" placeholder="পাসওয়ার্ড লিখুন" autocomplete="new-password"> </div>
      <div class="input-group"> <input type="password" id="confirm-password" placeholder="পাসওয়ার্ড নিশ্চিত করুন" autocomplete="new-password"> </div>
      <button class="action-btn" onclick="registerWithFirebase()">রেজিস্টার করুন</button>
      <div class="error-message" id="register-error"></div>
      <div class="form-switcher"> ইতিমধ্যে একাউন্ট আছে? <a onclick="toggleForms()">লগইন করুন</a> </div>
    </div>
  </div>
</div>

<div id="app">
  <header class="dashboard-header">
    <div class="app-logo-container">
      <img src="Bisnu.png" class="app-logo" alt="BISNU IoT Logo">
      <div class="app-logo-ring"></div>
      <div class="app-logo-ring"></div>
      <div class="app-logo-ring"></div>
    </div>
    <h1 class="dashboard-title">IoT ডিভাইস মনিটরিং সিস্টেম</h1>
    <div class="header-controls">
      <label class="theme-toggle">
        <input type="checkbox" id="theme-toggle">
        <span class="theme-slider"></span>
        <span class="theme-icon sun-icon">☀️</span>
        <span class="theme-icon moon-icon">🌙</span>
      </label>
      <button id="toggle-sort-btn" class="pro-btn sort-lock-btn" onclick="toggleTabSorting()"> <i class="fas fa-lock"></i> সাজানো লক করুন </button>
      <button id="notification-btn" class="pro-btn notification-btn" onclick="toggleNotificationSound()">🔔 সাউন্ড অন আছে</button>
      <button class="pro-btn background-btn" onclick="changeBackground()">🖼️ ব্যাকগ্রাউন্ড</button>
      <button class="pro-btn logout-btn" onclick="logout()">লগআউট</button>
    </div>
  </header>
  
  <nav class="nav-tabs" id="nav-tabs-container">
    <div class="nav-tab" onclick="showPage('page1')" data-tab-id="page1"><i class="fas fa-server"></i> ডিভাইস ১</div>
    <div class="nav-tab" onclick="showPage('page2')" data-tab-id="page2"><i class="fas fa-server"></i> ডিভাইস ২</div>
    <div class="nav-tab" onclick="showPage('page3')" data-tab-id="page3"><i class="fas fa-server"></i> ডিভাইস ৩</div>
    <div class="nav-tab" onclick="showPage('page4')" data-tab-id="page4"><i class="fas fa-server"></i> ডিভাইস ৪</div>
    <div class="nav-tab" onclick="showPage('page5')" data-tab-id="page5"><i class="fas fa-bolt"></i> এনার্জি মনিটর</div>
    <div class="nav-tab" onclick="showPage('page6')" data-tab-id="page6"><i class="fas fa-chart-line"></i> এডভান্সড গ্রাফ</div>
    <div class="nav-tab" onclick="showPage('page7')" data-tab-id="page7"><i class="fas fa-file-alt"></i> Diagram Note File</div>
    <div class="nav-tab" onclick="showPage('page8')" data-tab-id="page8"><i class="fas fa-sliders-h"></i> কন্ট্রোল প্যানেল</div>
    <div class="nav-tab" onclick="showPage('page9')" data-tab-id="page9"><i class="fas fa-robot"></i> অটোমেশন ও অ্যালার্ট</div>
    <div class="nav-tab" onclick="showPage('page10')" data-tab-id="page10"><i class="fas fa-history"></i> অডিট লগ</div>
    <div class="nav-tab" onclick="showPage('page11')" data-tab-id="page11"><i class="fas fa-info-circle"></i> সিস্টেম স্ট্যাটাস</div>
    <div class="nav-tab" onclick="showPage('page12')" data-tab-id="page12"><i class="fas fa-project-diagram"></i> লজিক গেট ইন্টারলক</div>
    <div class="nav-tab" onclick="showPage('page13')" data-tab-id="page13"><i class="fas fa-thermometer-half"></i> তাপমাত্রা মনিটর</div>
    <div class="nav-tab" id="add-new-page-btn" onclick="openAddPageModal()" data-tab-id="add-new-page-btn"> <i class="fas fa-plus"></i> নতুন পেজ </div>
  </nav>

  <!-- Device Pages (1-4) -->
  <main id="page1" class="device-page" data-component-id="device1_data">
    <section class="device-status-summary" id="device1-summary">
      <div class="status-item"><div class="status-count" id="d1-active-count">0</div><div class="status-label">এক্টিভ</div></div>
      <div class="status-item"><div class="status-count" id="d1-inactive-count">0</div><div class="status-label">ইনএক্টিভ</div></div>
      <div class="status-item"><div class="status-count" id="d1-warning-count">0</div><div class="status-label">সতর্কতা</div></div>
      <div class="status-item"><div class="status-count" id="d1-total-count">0</div><div class="status-label">মোট লোড</div></div>
    </section>
    <section class="device-cards" id="device1-cards-container"></section>
    <div class="add-new-btn-container"><button class="pro-btn btn-info" onclick="addNewLoadToDevice('device1')" style="width: 100%; padding: 12px; font-size: 1rem;"><i class="fas fa-plus-circle"></i> নতুন লোড যোগ করুন</button></div>
    <section class="analytics-section">
      <div class="chart-container">
        <div class="section-header"><h3 class="section-title">ডিভাইস ১ স্ট্যাটাস গ্রাফ</h3><i class="fas fa-cog path-config-icon" title="Path Configuration" onclick="openPathSelector('device1_data', event)"></i></div>
        <canvas id="device1-chart"></canvas>
      </div>
      <div class="log-container"> <h3 class="section-title">ডিভাইস ১ লগ</h3> <div class="log-list" id="device1-logs"></div> </div>
    </section>
  </main>

  <main id="page2" class="device-page" data-component-id="device2_data">
    <section class="device-status-summary" id="device2-summary">
      <div class="status-item"><div class="status-count" id="d2-active-count">0</div><div class="status-label">এক্টিভ</div></div>
      <div class="status-item"><div class="status-count" id="d2-inactive-count">0</div><div class="status-label">ইনএক্টিভ</div></div>
      <div class="status-item"><div class="status-count" id="d2-warning-count">0</div><div class="status-label">সতর্কতা</div></div>
      <div class="status-item"><div class="status-count" id="d2-total-count">0</div><div class="status-label">মোট লোড</div></div>
    </section>
    <section class="device-cards" id="device2-cards-container"></section>
    <div class="add-new-btn-container"><button class="pro-btn btn-info" onclick="addNewLoadToDevice('device2')" style="width: 100%; padding: 12px; font-size: 1rem;"><i class="fas fa-plus-circle"></i> নতুন লোড যোগ করুন</button></div>
    <section class="analytics-section">
      <div class="chart-container">
        <div class="section-header"><h3 class="section-title">ডিভাইস ২ স্ট্যাটাস গ্রাফ</h3><i class="fas fa-cog path-config-icon" title="Path Configuration" onclick="openPathSelector('device2_data', event)"></i></div>
        <canvas id="device2-chart"></canvas>
      </div>
      <div class="log-container"><h3 class="section-title">ডিভাইস ২ লগ</h3><div class="log-list" id="device2-logs"></div></div>
    </section>
  </main>

  <main id="page3" class="device-page" data-component-id="device3_data">
    <section class="device-status-summary" id="device3-summary">
      <div class="status-item"><div class="status-count" id="d3-active-count">0</div><div class="status-label">এক্টিভ</div></div>
      <div class="status-item"><div class="status-count" id="d3-inactive-count">0</div><div class="status-label">ইনএক্টিভ</div></div>
      <div class="status-item"><div class="status-count" id="d3-warning-count">0</div><div class="status-label">সতর্কতা</div></div>
      <div class="status-item"><div class="status-count" id="d3-total-count">0</div><div class="status-label">মোট লোড</div></div>
    </section>
    <section class="device-cards" id="device3-cards-container"></section>
    <div class="add-new-btn-container"><button class="pro-btn btn-info" onclick="addNewLoadToDevice('device3')" style="width: 100%; padding: 12px; font-size: 1rem;"><i class="fas fa-plus-circle"></i> নতুন লোড যোগ করুন</button></div>
    <section class="analytics-section">
      <div class="chart-container">
        <div class="section-header"><h3 class="section-title">ডিভাইস ৩ স্ট্যাটাস গ্রাফ</h3><i class="fas fa-cog path-config-icon" title="Path Configuration" onclick="openPathSelector('device3_data', event)"></i></div>
        <canvas id="device3-chart"></canvas>
      </div>
      <div class="log-container"><h3 class="section-title">ডিভাইস ৩ লগ</h3><div class="log-list" id="device3-logs"></div></div>
    </section>
  </main>
  
  <main id="page4" class="device-page" data-component-id="device4_data">
    <section class="device-status-summary" id="device4-summary">
      <div class="status-item"><div class="status-count" id="d4-active-count">0</div><div class="status-label">এক্টিভ</div></div>
      <div class="status-item"><div class="status-count" id="d4-inactive-count">0</div><div class="status-label">ইনএক্টিভ</div></div>
      <div class="status-item"><div class="status-count" id="d4-warning-count">0</div><div class="status-label">সতর্কতা</div></div>
      <div class="status-item"><div class="status-count" id="d4-total-count">0</div><div class="status-label">মোট লোড</div></div>
    </section>
    <section class="device-cards" id="device4-cards-container"></section>
    <div class="add-new-btn-container"><button class="pro-btn btn-info" onclick="addNewLoadToDevice('device4')" style="width: 100%; padding: 12px; font-size: 1rem;"><i class="fas fa-plus-circle"></i> নতুন লোড যোগ করুন</button></div>
    <section class="analytics-section">
      <div class="chart-container">
        <div class="section-header"><h3 class="section-title">ডিভাইস ৪ স্ট্যাটাস গ্রাফ</h3><i class="fas fa-cog path-config-icon" title="Path Configuration" onclick="openPathSelector('device4_data', event)"></i></div>
        <canvas id="device4-chart"></canvas>
      </div>
      <div class="log-container"><h3 class="section-title">ডিভাইস ৪ লগ</h3><div class="log-list" id="device4-logs"></div></div>
    </section>
  </main>
  
  <main id="page5" class="device-page" data-component-id="energymonitoring_root">
    <section class="energy-metrics">
      <div class="energy-card voltage-card"><div class="energy-title">⚡ ভোল্টেজ</div><div class="energy-value" id="voltage-value">-- <span class="energy-unit">V</span></div></div>
      <div class="energy-card current-card"><div class="energy-title">🔌 কারেন্ট</div><div class="energy-value" id="current-value">-- <span class="energy-unit">A</span></div></div>
      <div class="energy-card power-card"><div class="energy-title">💡 পাওয়ার</div><div class="energy-value" id="power-value">-- <span class="energy-unit">W</span></div></div>
      <div class="energy-card energy-card-main"><div class="energy-title">🔋 এনার্জি</div><div class="energy-value" id="energy-value">-- <span class="energy-unit">kWh</span></div></div>
      <div class="energy-card frequency-card"><div class="energy-title">⏱️ ফ্রিকোয়েন্সি</div><div class="energy-value" id="frequency-value">-- <span class="energy-unit">Hz</span></div></div>
      <div class="energy-card power-factor-card"><div class="energy-title">📊 পাওয়ার ফ্যাক্টর</div><div class="energy-value" id="power-factor-value">-- <span class="energy-unit"></span></div></div>
      <div class="energy-card active-power-card"><div class="energy-title">🔆 অ্যাক্টিভ পাওয়ার</div><div class="energy-value" id="active-power-value">-- <span class="energy-unit">W</span></div></div>
      <div class="energy-card reactive-power-card"><div class="energy-title">🌀 রিঅ্যাক্টিভ পাওয়ার</div><div class="energy-value" id="reactive-power-value">-- <span class="energy-unit">VAR</span></div></div>
      <div class="energy-card units-card"><div class="energy-title">✔️ ব্যবহৃত ইউনিট</div><div class="energy-value" id="units-value">-- <span class="energy-unit">Units</span></div></div>
      <div class="energy-card cost-card"><div class="energy-title">💰 দৈনিক খরচ</div><div class="energy-value" id="daily-cost-value">-- <span class="energy-unit">BDT</span></div></div>
      <div class="energy-card timestamp-card"><div class="energy-title">🕒 টাইমস্ট্যাম্প</div><div class="energy-value" id="timestamp-value" style="font-size: 1.2rem; font-weight: 500;">--</div></div>
    </section>
    <section class="intelligence-section">
      <div class="section-header"><h3 class="intelligence-title">🧠 ইন্টেলিজেন্স ইনসাইটস</h3><i class="fas fa-cog path-config-icon" title="Path Configuration" onclick="openPathSelector('energymonitoring_root', event)"></i></div>
      <div id="anomaly-alert"><p>সিস্টেম স্বাভাবিকভাবে চলছে। কোনো অস্বাভাবিকতা শনাক্ত হয়নি।</p></div>
    </section>
    <section class="energy-graphs">
      <div class="graph-container"><h3 class="graph-title">ভোল্টেজ ট্রেন্ড</h3><canvas id="voltage-chart"></canvas></div>
      <div class="graph-container"><h3 class="graph-title">কারেন্ট ট্রেন্ড</h3><canvas id="current-chart"></canvas></div>
      <div class="graph-container"><h3 class="graph-title">পাওয়ার ট্রেন্ড</h3><canvas id="power-chart"></canvas></div>
      <div class="graph-container"><h3 class="graph-title">এনার্জি কনজাম্পশন</h3><canvas id="energy-chart"></canvas></div>
    </section>
  </main>

  <main id="page6" class="device-page" data-component-id="energymonitoring_history">
    <div class="time-selection">
      <button class="time-btn active" onclick="changeTimeRange(30)">৩০ মিনিট</button>
      <button class="time-btn" onclick="changeTimeRange(60)">১ ঘন্টা</button>
      <button class="time-btn" onclick="changeTimeRange(180)">৩ ঘন্টা</button>
      <button class="time-btn" onclick="changeTimeRange(360)">৬ ঘন্টা</button>
      <button class="time-btn" onclick="changeTimeRange(720)">১২ ঘন্টা</button>
    </div>
    <div class="metric-selection">
      <div class="metric-card selected" onclick="selectMetric('voltage')"><div class="metric-title"><span class="metric-icon">⚡</span> ভোল্টেজ</div><div class="metric-description">ভোল্টেজের পরিবর্তন পর্যবেক্ষণ করুন</div></div>
      <div class="metric-card" onclick="selectMetric('current')"><div class="metric-title"><span class="metric-icon">🔌</span> কারেন্ট</div><div class="metric-description">কারেন্টের প্রবাহ বিশ্লেষণ করুন</div></div>
      <div class="metric-card" onclick="selectMetric('power')"><div class="metric-title"><span class="metric-icon">💡</span> পাওয়ার</div><div class="metric-description">পাওয়ার ব্যবহারের ট্রেন্ড দেখুন</div></div>
      <div class="metric-card" onclick="selectMetric('energy')"><div class="metric-title"><span class="metric-icon">🔋</span> এনার্জি</div><div class="metric-description">এনার্জি খরচের হিসাব দেখুন</div></div>
      <div class="metric-card" onclick="selectMetric('frequency')"><div class="metric-title"><span class="metric-icon">⏱️</span> ফ্রিকোয়েন্সি</div><div class="metric-description">ফ্রিকোয়েন্সির স্থিতিশীলতা পরীক্ষা করুন</div></div>
      <!-- Updated metric selection to use snake_case keys for graph data access -->
      <div class="metric-card" onclick="selectMetric('power_factor')"><div class="metric-title"><span class="metric-icon">📊</span> পাওয়ার ফ্যাক্টর</div><div class="metric-description">পাওয়ার ফ্যাক্টরের মান বিশ্লেষণ করুন</div></div>
      <div class="metric-card" onclick="selectMetric('active_power')"><div class="metric-title"><span class="metric-icon">🔆</span> অ্যাক্টিভ পাওয়ার</div><div class="metric-description">রিয়েল পাওয়ার ব্যবহার দেখুন</div></div>
      <div class="metric-card" onclick="selectMetric('reactive_power')"><div class="metric-title"><span class="metric-icon">🌀</span> রিঅ্যাক্টিভ পাওয়ার</div><div class="metric-description">রিঅ্যাক্টিভ পাওয়ার ট্রেন্ড</div></div>
    </div>
    <section class="advanced-graph-container">
      <div class="graph-header">
        <h3 class="graph-title" id="advanced-graph-title">ভোল্টেজ ট্রেন্ড (৩০ মিনিট)</h3>
        <div class="graph-controls">
          <button class="graph-btn" onclick="downloadGraphData()">ডাটা ডাউনলোড</button>
          <button class="graph-btn" onclick="printGraph()">প্রিন্ট</button>
          <i class="fas fa-cog path-config-icon" title="Path Configuration" onclick="openPathSelector('energymonitoring_history', event)"></i>
        </div>
      </div>
      <canvas id="advanced-energy-chart"></canvas>
      <div class="no-data-message" id="no-data-message" style="display: none;">নির্বাচিত সময় রেঞ্জে কোনো ডাটা পাওয়া যায়নি</div>
    </section>
  </main>
  
  <!-- Diagram Note File Page (UPDATED TO BE DYNAMIC) -->
  <main id="page7" class="device-page" data-component-id="diagram_notes">
    <section class="notes-container">
      <div class="section-header">
        <h2 class="note-title">Diagram Note File</h2>
        <i class="fas fa-cog path-config-icon" title="Path Configuration" onclick="openPathSelector('diagram_notes', event)"></i>
      </div>
      
      <!-- Dynamic Content Container -->
      <div id="notes-dynamic-container">
        <!-- Content will be injected here via JavaScript -->
      </div>

      <!-- Add New Note Button -->
      <div class="add-note-btn-container">
        <button class="add-note-btn" onclick="openAddNoteModal()">
            <i class="fas fa-plus"></i> নতুন নোট বা সেকশন যোগ করুন
        </button>
      </div>
    </section>
  </main>

  <main id="page8" class="device-page">
    <section class="control-section" id="page-component-scenes" data-component-id="scenes">
      <div class="section-header"><h2 class="control-section-title">দৃশ্য (Scenes)</h2><i class="fas fa-cog path-config-icon" title="Path Configuration" onclick="openPathSelector('scenes', event)"></i></div>
      <div class="scene-buttons" id="scene-buttons-container"><button class="pro-btn create-scene-btn" onclick="openSceneModal()"><i class="fas fa-plus"></i> নতুন দৃশ্য তৈরি করুন</button></div>
    </section>
    <div id="control-panel-container"></div>
    <div class="add-new-btn-container"><button class="pro-btn btn-info" onclick="addNewDevice()" style="width: 100%; padding: 15px; font-size: 1.2rem;"><i class="fas fa-plus-circle"></i> নতুন ডিভাইস যোগ করুন</button></div>
  </main>

  <main id="page9" class="device-page" data-component-id="automation_rules">
    <div class="automation-grid">
      <div class="automation-container">
        <div class="section-header"><h2 class="section-title">নতুন অটোমেশন বা অ্যালার্ট তৈরি করুন</h2><i class="fas fa-cog path-config-icon" title="Path Configuration" onclick="openPathSelector('automation_rules', event)"></i></div>
        <div class="rule-builder-card">
          <form class="rule-builder-form" onsubmit="saveAutomationRule(event)" id="automation-rule-form">
            <div class="form-group"><label for="rule-name">রুলের নাম</label><input type="text" id="rule-name" placeholder="যেমন: সন্ধ্যায় লাইট অন" required></div>
            <div class="rule-condition-box">
              <div class="rule-part if-part">IF (যদি)</div>
              <div class="form-group"><label for="trigger-source">ট্রিগারের উৎস</label><select id="trigger-source" onchange="updateTriggerOptions()"><option value="energy">এনার্জি মনিটর</option><option value="time">সময়</option><option value="device">অন্য ডিভাইস</option></select></div>
              <div id="trigger-options-container"></div>
            </div>
            <div class="rule-action-box">
              <div class="rule-part then-part">THEN (তবে)</div>
              <div class="form-group"><label for="action-device">ডিভাইস</label><select id="action-device"></select></div>
              <div class="form-group"><label for="action-relay">রিলে/লোড</label><select id="action-relay"></select></div>
              <div class="form-group"><label for="action-state">অ্যাকশন</label><select id="action-state"><option value="true">ON করুন</option><option value="false">OFF করুন</option></select></div>
            </div>
            <div class="notification-toggle-group"><input type="checkbox" id="send-notification-checkbox" style="width: auto;"><label for="send-notification-checkbox">এর সাথে একটি নোটিফিকেশন পাঠান</label></div>
            <div class="form-group" id="notification-message-group" style="display: none;"><label for="notification-message">নোটিফিকেশন বার্তা</label><textarea id="notification-message" placeholder="আপনার কাস্টম বার্তা এখানে লিখুন..."></textarea></div>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button type="submit" class="pro-btn btn-on" style="flex: 1;">💾 রুল সংরক্ষণ করুন</button>
                <button type="button" class="pro-btn cancel-btn" onclick="cancelEditAutomation()" style="display: none;" id="cancel-automation-edit-btn">বাতিল</button>
            </div>
          </form>
        </div>
      </div>
      <div class="automation-container">
        <h2 class="section-title">সক্রিয় অটোমেশন ও অ্যালার্ট সমূহ</h2>
        <div class="rule-list" id="automation-rule-list"><p>কোনো অটোমেশন রুল এখনো তৈরি করা হয়নি।</p></div>
      </div>
    </div>
  </main>

  <main id="page10" class="device-page">
    <section class="audit-log-container" id="page-component-audit-log" data-component-id="audit_log">
      <div class="section-header">
        <h2 class="section-title">সম্পূর্ণ কার্যকলাপের লগ</h2>
        <div style="display: flex; gap: 10px; align-items: center;">
             <button class="pro-btn delete-btn" onclick="confirmDeleteAllLogs()" style="padding: 8px 15px; font-size: 0.9rem;">
                <i class="fas fa-trash"></i> Delete All
             </button>
             <i class="fas fa-cog path-config-icon" title="Path Configuration" onclick="openPathSelector('audit_log', event)"></i>
        </div>
      </div>
      <div class="audit-log-list" id="audit-log-list"><p>কোনো কার্যকলাপের লগ পাওয়া যায়নি...</p></div>
    </section>
  </main>

  <main id="page11" class="device-page">
    <section class="status-dashboard" id="page-component-system-status" data-component-id="system_status">
      <div class="section-header"><h2 class="section-title">সিস্টেম ডায়াগনস্টিক্স ড্যাশবোর্ড</h2><i class="fas fa-cog path-config-icon" title="Path Configuration" onclick="openPathSelector('system_status', event)"></i></div>
      <div class="status-dashboard-grid">
        <div class="status-card"><div class="status-card-title"><i class="fas fa-wifi"></i> WiFi কানেকশন</div><div class="status-card-value" id="status-wifi">অজানা</div><div class="status-indicator" id="indicator-wifi"></div></div>
        <div class="status-card"><div class="status-card-title"><i class="fas fa-cloud"></i> Firebase কানেকশন</div><div class="status-card-value" id="status-firebase">অজানা</div><div class="status-indicator" id="indicator-firebase"></div></div>
        <div class="status-card"><div class="status-card-title"><i class="fas fa-microchip"></i> Mega কানেকশন</div><div class="status-card-value" id="status-mega">অজানা</div><div class="status-indicator" id="indicator-mega"></div></div>
        <div class="status-card"><div class="status-card-title"><i class="fas fa-power-off"></i> সিস্টেম আপটাইম</div><div class="status-card-value" id="status-uptime">--</div></div>
        <div class="status-card"><div class="status-card-title"><i class="fas fa-sd-card"></i> SD কার্ড স্ট্যাটাস</div><div class="status-card-value" id="status-sd-card">অজানা</div><div class="status-indicator" id="indicator-sd-card"></div></div>
        <div class="status-card"><div class="status-card-title"><i class="fas fa-memory"></i> র‍্যাম ব্যবহার</div><div class="status-card-value" id="status-ram-usage">--%</div><div class="ram-progress-bar"><div class="ram-progress-fill" id="ram-progress-fill"></div></div></div>
      </div>
    </section>
  </main>

  <main id="page12" class="device-page" data-component-id="logic_gate_rules">
    <div class="automation-grid">
        <div class="automation-container">
            <div class="section-header"><h2 class="section-title">নতুন লজিক গেট রুল তৈরি করুন</h2><i class="fas fa-cog path-config-icon" title="Path Configuration" onclick="openPathSelector('logic_gate_rules', event)"></i></div>
            <div class="rule-builder-card">
                <form class="rule-builder-form" onsubmit="saveLogicGateRule(event)" id="logic-gate-form">
                    <div class="form-group"><label for="logic-rule-name">রুলের নাম</label><input type="text" id="logic-rule-name" placeholder="যেমন: পাম্প সেফটি ইন্টারলক" required></div>
                    <div class="logic-equation-builder">
                        <div class="logic-column logic-inputs-column">
                            <div class="rule-part if-part">ইনপুট</div>
                            <div id="logic-inputs-list"></div>
                            <button type="button" class="pro-btn btn-info add-logic-input-btn" onclick="addLogicInput()"><i class="fas fa-plus"></i> নতুন ইনপুট যোগ করুন</button>
                        </div>
                        <div class="logic-column logic-gate-column">
                            <div class="form-group gate-selector">
                                <label for="logic-gate-type">লজিক গেট</label>
                                <select id="logic-gate-type"><option value="AND">AND</option><option value="OR">OR</option><option value="NAND">NAND</option><option value="NOR">NOR</option><option value="XOR">XOR</option><option value="XNOR">XNOR</option></select>
                            </div>
                        </div>
                        <div class="logic-column logic-output-column">
                            <div class="rule-part then-part">আউটপুট</div>
                            <div id="logic-outputs-list"></div>
                            <button type="button" class="pro-btn btn-info add-logic-input-btn" onclick="addLogicOutput()"><i class="fas fa-plus"></i> নতুন আউটপুট যোগ করুন</button>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button type="submit" class="pro-btn btn-on" style="flex: 1;">💾 রুল সংরক্ষণ করুন</button>
                        <button type="button" class="pro-btn cancel-btn" onclick="cancelEditLogicGate()" style="display: none;" id="cancel-logic-edit-btn">বাতিল</button>
                    </div>
                </form>
            </div>
        </div>
        <div class="automation-container">
            <h2 class="section-title">সক্রিয় ইন্টারলক রুল সমূহ</h2>
            <div class="rule-list" id="logic-gate-rule-list"><p>কোনো ইন্টারলক রুল এখনো তৈরি করা হয়নি।</p></div>
        </div>
    </div>
  </main>

  <main id="page13" class="device-page" data-component-id="temperature_data">
    <div class="section-header"><h2 class="section-title">তাপমাত্রা মনিটরিং ড্যাশবোর্ড</h2><i class="fas fa-cog path-config-icon" title="Path Configuration" onclick="openPathSelector('temperature_data', event)"></i></div>
    <div class="temperature-page-grid" id="temperature-sensors-container"></div>
    <div class="add-new-btn-container"><button class="pro-btn btn-info" onclick="addNewTemperatureSensor()" style="width: 100%; padding: 12px; font-size: 1rem;"><i class="fas fa-plus-circle"></i> নতুন সেন্সর যোগ করুন</button></div>
  </main>

  <div id="dynamic-pages-container"></div>
</div>

<div class="toast-container" id="toast-container"></div>

<div id="imageModal" class="image-modal">
  <span class="close-modal" onclick="closeImageModal()">&times;</span>
  <div class="modal-content"><img id="modalImage" class="modal-image" src="" alt=""><div id="modalCaption" class="modal-caption"></div></div>
</div>

<div id="tempHistoryModal" class="password-modal-container">
    <div class="scene-modal-box" style="width: 90%; max-width: 800px; border-top-color: var(--warning-color);">
        <h3 id="temp-history-title">তাপমাত্রার ইতিহাস</h3>
        <div style="height: 400px; width: 100%;">
            <canvas id="largeTempChart"></canvas>
        </div>
        <div class="password-modal-buttons" style="margin-top: 20px;">
            <button class="pro-btn modal-btn cancel-btn" onclick="closeTempHistoryModal()">বন্ধ করুন</button>
        </div>
    </div>
</div>

<div id="relayPasswordModal" class="password-modal-container">
  <div class="password-modal-box"><h3>অপারেশন নিশ্চিত করুন</h3><p>এই রিলেটি অপারেট করতে দয়া করে পাসওয়ার্ড দিন।</p><div class="password-input-group"><input type="password" id="relayPasswordInput" placeholder="অপারেটিং পাসওয়ার্ড" autocomplete="off"></div><div class="password-error-message" id="relayPasswordError"></div><div class="password-modal-buttons"><button class="pro-btn modal-btn cancel-btn" onclick="cancelRelayOperation()">বাতিল</button><button class="pro-btn modal-btn confirm-btn" onclick="verifyAndOperateRelay()">নিশ্চিত করুন</button></div></div>
</div>

<div id="actionPasswordModal" class="password-modal-container">
  <div class="password-modal-box"><h3 id="action-modal-title">অ্যাকশন নিশ্চিত করুন</h3><p id="action-modal-description">এই কাজটি সম্পন্ন করতে আপনার অপারেটিং পাসওয়ার্ড দিন।</p><div class="password-input-group"><input type="password" id="actionPasswordInput" placeholder="অপারেটিং পাসওয়ার্ড" autocomplete="off"></div><div class="password-error-message" id="actionPasswordError"></div><div class="password-modal-buttons"><button class="pro-btn modal-btn cancel-btn" onclick="cancelAction()">বাতিল</button><button class="pro-btn modal-btn confirm-btn" onclick="verifyAndExecuteAction()">নিশ্চিত করুন</button></div></div>
</div>

<div id="registrationSecurityModal" class="password-modal-container">
  <div class="password-modal-box">
    <h3>অ্যাডমিন ভেরিফিকেশন</h3>
    <p>নতুন একাউন্ট তৈরি করতে অ্যাডমিন পাসওয়ার্ড দিন।</p>
    <div class="password-input-group"><input type="password" id="regSecurityInput" placeholder="পাসওয়ার্ড লিখুন" autocomplete="off"></div>
    <div class="password-error-message" id="regSecurityError"></div>
    <div class="password-modal-buttons">
      <button class="pro-btn modal-btn cancel-btn" onclick="closeRegistrationSecurityModal()">বাতিল</button>
      <button class="pro-btn modal-btn confirm-btn" onclick="checkRegistrationSecurity()">নিশ্চিত করুন</button>
    </div>
  </div>
</div>

<div id="timerModal" class="password-modal-container">
  <div class="timer-modal-box"><h3 id="timer-modal-title">টাইমার সেটিংস</h3><div class="timer-form"><div class="timer-row"><label>টাইমার স্ট্যাটাস</label><button id="timer-enabled-btn" class="modal-btn disabled" onclick="toggleTimerEnabled()">নিষ্ক্রিয়</button></div><div class="timer-row"><label for="timer-online-time">অনলাইন হওয়ার সময়</label><input type="time" id="timer-online-time" class="timer-time-input" step="1"></div><div class="timer-row"><label for="timer-offline-time">অফলাইন হওয়ার সময়</label><input type="time" id="timer-offline-time" class="timer-time-input" step="1"></div><div class="timer-row" style="display:none;"><label for="timer-relay-select">কোন রিলে কন্ট্রোল হবে?</label><select id="timer-relay-select" class="timer-select"></select></div></div><p class="timer-note">পরিবর্তনগুলো সংরক্ষণ করতে আপনার অপারেটিং পাসওয়ার্ড প্রয়োজন হবে।</p><div class="password-input-group"><input type="password" id="timerPasswordInput" placeholder="অপারেটিং পাসওয়ার্ড" autocomplete="off"></div><div class="password-error-message" id="timerPasswordError"></div><div class="password-modal-buttons"><button class="pro-btn modal-btn cancel-btn" onclick="closeTimerModal()">বাতিল</button><button class="pro-btn modal-btn confirm-btn" onclick="saveTimerSettings()">সংরক্ষণ করুন</button></div></div>
</div>

<div id="sceneModal" class="password-modal-container">
  <div class="scene-modal-box"><h3>নতুন দৃশ্য তৈরি করুন</h3><div class="form-group" style="text-align: left;"><label for="scene-name">দৃশ্যের নাম</label><input type="text" id="scene-name" placeholder="যেমন: গুড নাইট" style="width: 100%;"></div><div class="scene-relay-list" id="scene-relay-list-container"></div><div class="password-error-message" id="scene-error-message"></div><div class="password-modal-buttons"><button class="pro-btn modal-btn cancel-btn" onclick="closeSceneModal()">বাতিল</button><button class="pro-btn modal-btn confirm-btn" onclick="saveScene()">সংরক্ষণ করুন</button></div></div>
</div>

<div id="addPageModal" class="password-modal-container">
  <div class="password-modal-box"><h3>নতুন কাস্টম পেজ তৈরি করুন</h3><p>আপনার নতুন ড্যাশবোর্ড পেজের জন্য একটি নাম এবং অপারেটিং পাসওয়ার্ড দিন।</p><div class="form-group" style="text-align: left; margin-bottom: 1.5rem;"><label for="new-page-name">পেজের নাম</label><input type="text" id="new-page-name" placeholder="যেমন: আমার কন্ট্রোল রুম" style="width: 100%;"></div><div class="password-input-group"><input type="password" id="addPagePasswordInput" placeholder="অপারেটিং পাসওয়ার্ড" autocomplete="off" style="width: 100%;"></div><div class="password-error-message" id="add-page-error"></div><div class="password-modal-buttons"><button class="pro-btn modal-btn cancel-btn" onclick="closeAddPageModal()">বাতিল</button><button class="pro-btn modal-btn confirm-btn" onclick="saveNewPage()">সংরক্ষণ করুন</button></div></div>
</div>

<div id="pageEditorModal" class="password-modal-container">
  <div class="scene-modal-box" style="width: 80%; max-width: 900px; border-top-color: var(--info-color);"><h3 id="page-editor-title">পেজ কন্টেন্ট এডিট করুন</h3><div id="page-editor-content" style="max-height: 60vh; overflow-y: auto; text-align: left; padding: 15px;"></div><div class="password-modal-buttons" style="margin-top: 20px;"><button class="pro-btn modal-btn cancel-btn" onclick="closePageEditorModal()">বাতিল</button><button class="pro-btn modal-btn confirm-btn" onclick="savePageComponents()">পেজ সংরক্ষণ করুন</button></div></div>
</div>

<!-- NEW: Note Editor Modal -->
<div id="noteEditorModal" class="password-modal-container">
  <div class="scene-modal-box" style="width: 500px; border-top-color: var(--secondary-color);">
    <h3 id="note-modal-title">নোট তৈরি করুন</h3>
    
    <div class="form-group">
      <label for="note-type">নোটের ধরণ</label>
      <select id="note-type">
        <option value="text">সাধারণ টেক্সট (প্যারাগ্রাফ)</option>
        <option value="note_box">নোট বক্স</option>
        <option value="list">লিস্ট (বুলেট পয়েন্ট)</option>
        <option value="image">ইমেজ (ছবি)</option>
      </select>
    </div>

    <div class="form-group" id="note-title-group">
      <label for="note-title-input">শিরোনাম (Title)</label>
      <input type="text" id="note-title-input" placeholder="শিরোনাম লিখুন...">
    </div>

    <div class="form-group" id="note-content-group">
      <label for="note-content-input">বিষয়বস্তু (Content)</label>
      <textarea id="note-content-input" placeholder="এখানে লিখুন... (লিস্টের ক্ষেত্রে প্রতি লাইনে একটি আইটেম)" style="min-height: 100px;"></textarea>
    </div>
    
    <div class="form-group" id="note-image-group" style="display: none;">
        <label for="note-image-url">ছবির লিঙ্ক (URL)</label>
        <input type="text" id="note-image-url" placeholder="https://example.com/image.jpg">
        <label for="note-image-caption" style="margin-top: 10px;">ক্যাপশন</label>
        <input type="text" id="note-image-caption" placeholder="ছবির ক্যাপশন">
    </div>

    <div class="password-modal-buttons" style="margin-top: 20px;">
      <button class="pro-btn modal-btn cancel-btn" onclick="closeNoteModal()">বাতিল</button>
      <button class="pro-btn modal-btn confirm-btn" onclick="saveNote()">সংরক্ষণ করুন</button>
    </div>
  </div>
</div>

<div id="path-selector-popover">
  <h4>Path Configuration</h4>
  <div id="path-segments-container"></div>
  <button class="pro-btn confirm-btn" onclick="savePathMapping()">সংরক্ষণ করুন</button>
  <button class="pro-btn cancel-btn" onclick="closePathSelector()">বাতিল</button>
</div>

<audio id="notification-sound" preload="auto">
  <source src="notification.mp3" type="audio/mpeg">
  আপনার ব্রাউজার অডিও সমর্থন করে না।
</audio>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-messaging-compat.js"></script>

<script>
// Firebase কনফিগারেশন
const firebaseConfig = {
  apiKey: "AIzaSyATDfnefdyPAzBNKZY4VM5ja8K2-63PC-U",
  authDomain: "home-server-346b6.firebaseapp.com",
  databaseURL: "https://home-server-346b6-default-rtdb.firebaseio.com",
  projectId: "home-server-346b6",
  storageBucket: "home-server-346b6.appspot.com",
  messagingSenderId: "531234227336",
  appId: "1:531234227336:web:f57f700dd6baaed4358b3d",
  measurementId: "G-QDWVP34FSX"
};

// Firebase ইনিশিয়ালাইজ করুন
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const auth = firebase.auth();
const messaging = firebase.messaging();

const correctOperatingPassword = "000";

// --- গ্লোবাল ভ্যারিয়েবল এবং ডিফল্ট পাথ ---
let databaseStructure = {};
let pathMappings = {};
let activeListeners = [];
let logicOverrides = {}; 
let previousDeviceStates = {}; 
let isNotificationMuted = localStorage.getItem('isNotificationMuted') === 'true';
let currentTempData = {};
let tempSensorHistory = {}; 
let largeTempChartInstance = null;
let currentNotes = {}; // Stores fetched notes
let editingNoteId = null; // Stores ID of note being edited

const defaultPaths = {
    devices_root: 'devices',
    device1_data: 'devices/device1',
    device2_data: 'devices/device2',
    device3_data: 'devices/device3',
    device4_data: 'devices/device4',
    temperature_data: 'devices', 
    device_metadata: 'device_metadata',
    energymonitoring_root: 'energymonitoring',
    energymonitoring_history: 'energyHistory',
    timers: 'timers',
    automation_rules: 'automationRules',
    logic_gate_rules: 'logicGateRules',
    logic_gate_overrides: 'logic_gate_overrides',
    audit_log: 'auditLog',
    device_activity_log: 'deviceActivityLog',
    system_status: 'system_status/device1',
    scenes: 'scenes',
    custom_pages: 'custom_pages',
    diagram_notes: 'diagram_notes' // NEW PATH
};

let editingAutomationRuleId = null;
let editingLogicRuleId = null;

// --- Helper Functions ---
function logAuditEvent(action, actor = null) {
    const user = auth.currentUser;
    if (user || actor) {
        const userEmail = actor ? actor : user.email;
        const logEntry = { user: userEmail, action: action, timestamp: firebase.database.ServerValue.TIMESTAMP };
        const logPath = getPathFor('audit_log');
        if (logPath) database.ref(logPath).push(logEntry);
    }
}

function toggleForms() {
    const loginBox = document.getElementById('login-box');
    const registrationBox = document.getElementById('registration-box');
    document.getElementById('login-error').innerText = '';
    document.getElementById('register-error').innerText = '';
    loginBox.classList.toggle('form-active');
    registrationBox.classList.toggle('form-active');
}

function openRegistrationSecurityModal() {
    document.getElementById('registrationSecurityModal').style.display = 'flex';
    document.getElementById('regSecurityInput').value = '';
    document.getElementById('regSecurityInput').focus();
    document.getElementById('regSecurityError').innerText = '';
}

function closeRegistrationSecurityModal() {
    document.getElementById('registrationSecurityModal').style.display = 'none';
}

function checkRegistrationSecurity() {
    const input = document.getElementById('regSecurityInput').value;
    if (input === '00$') {
        closeRegistrationSecurityModal();
        toggleForms();
    } else {
        document.getElementById('regSecurityError').innerText = '❌ ভুল পাসওয়ার্ড!';
        const box = document.querySelector('#registrationSecurityModal .password-modal-box');
        box.classList.add('shake-animation');
        setTimeout(() => box.classList.remove('shake-animation'), 500);
    }
}

function loginWithFirebase() {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    const errorDiv = document.getElementById("login-error");
    const loginBox = document.getElementById("login-box");

    if (!email || !password) {
        errorDiv.innerText = "❌ দয়া করে ইমেল এবং পাসওয়ার্ড দিন।";
        loginBox.classList.add('shake-animation');
        setTimeout(() => loginBox.classList.remove('shake-animation'), 500);
        return;
    }
    
    errorDiv.innerText = "";

    auth.signInWithEmailAndPassword(email, password)
        .then(async (userCredential) => {
            logAuditEvent("সিস্টেমে সফলভাবে লগইন করেছেন।");
            const notificationSound = document.getElementById('notification-sound');
            if (notificationSound && !isNotificationMuted) { 
                notificationSound.muted = true;
                notificationSound.play().then(() => {
                    notificationSound.pause();
                    notificationSound.currentTime = 0;
                    notificationSound.muted = false;
                }).catch(e => console.error("Audio unlock failed", e));
            }

            document.getElementById('global-loader').style.display = 'flex';

            const loginContainer = document.getElementById("login-screen");
            const appContainer = document.getElementById("app");
            loginContainer.style.animation = "fadeOut 0.5s ease forwards";
            
            await loadPathMappings();
            await fetchDatabaseSchema();
            
            setTimeout(() => {
                document.getElementById('global-loader').style.display = 'none';
                loginContainer.style.display = "none";
                appContainer.style.display = "block";
                appContainer.style.animation = "fadeIn 0.5s ease forwards";
                setupFirebaseListeners();
                initializeCharts();
                loadThemePreference();
                loadBackgroundPreference();
                loadSoundPreference();
                initEnergyCharts();
                initAdvancedEnergyChart();
                setInterval(() => {
                  updateAllTimerDisplays();
                  processTimerExecution();
                }, 1000);
                setInterval(updateAllDateTimeDisplays, 1000);
                updateTriggerOptions();
                initializeNotifications();
                initLogicGateInputs();
            }, 500);
        })
        .catch((error) => {
            errorDiv.innerText = error.code === 'auth/user-disabled' ? "❌ আপনার একাউন্টটি ব্লক করা হয়েছে।" : "❌ ইমেল বা পাসওয়ার্ড সঠিক নয়।";
            loginBox.classList.add('shake-animation');
            setTimeout(() => loginBox.classList.remove('shake-animation'), 500);
        });
}

function registerWithFirebase() {
    const username = document.getElementById("register-username").value;
    const email = document.getElementById("register-email").value;
    const password = document.getElementById("register-password").value;
    const confirmPassword = document.getElementById("confirm-password").value;
    const errorDiv = document.getElementById("register-error");
    const registrationBox = document.getElementById("registration-box");

    if (!username || !email || !password || !confirmPassword) {
        errorDiv.innerText = "❌ অনুগ্রহ করে সবকটি ফিল্ড পূরণ করুন।";
    } else if (password !== confirmPassword) {
        errorDiv.innerText = "❌ পাসওয়ার্ড দুটি মেলেনি।";
    } else if (password.length < 6) {
        errorDiv.innerText = "❌ পাসওয়ার্ড অন্তত ৬ অক্ষরের হতে হবে।";
    } else {
        errorDiv.innerText = "";
        auth.createUserWithEmailAndPassword(email, password)
            .then((userCredential) => {
                const user = userCredential.user;
                user.updateProfile({ displayName: username });
                database.ref('users/' + user.uid).set({ username: username, email: email, createdAt: firebase.database.ServerValue.TIMESTAMP });
                showToast('রেজিস্ট্রেশন সফল হয়েছে! এখন লগইন করুন।', 'success');
                toggleForms();
            })
            .catch((error) => {
                if (error.code === 'auth/email-already-in-use') errorDiv.innerText = "❌ এই ইমেলটি ইতিমধ্যে ব্যবহৃত হচ্ছে।";
                else if (error.code === 'auth/weak-password') errorDiv.innerText = "❌ পাসওয়ার্ডটি যথেষ্ট শক্তিশালী নয়।";
                else errorDiv.innerText = "❌ রেজিস্ট্রেশনে একটি সমস্যা হয়েছে।";
            });
    }
    if (errorDiv.innerText) {
        registrationBox.classList.add('shake-animation');
        setTimeout(() => registrationBox.classList.remove('shake-animation'), 500);
    }
}

function logout() {
    logAuditEvent("সিস্টেম থেকে লগআউট করেছেন।");
    auth.signOut().then(() => {
        document.getElementById("app").style.animation = "fadeOut 0.5s ease forwards";
        setTimeout(() => window.location.reload(), 500);
    }).catch(error => console.error("লগআউট করার সময় ত্রুটি:", error));
}

function getPathFor(componentId) { return pathMappings[componentId] || defaultPaths[componentId]; }

async function loadPathMappings() {
    const user = auth.currentUser;
    if (!user) { pathMappings = {}; return; }
    const snapshot = await database.ref(`ui_path_mappings/${user.uid}`).once('value');
    pathMappings = snapshot.val() || {};
    applyUiHighlights();
}

async function fetchDatabaseSchema() {
    try {
        const snapshot = await database.ref('/').once('value');
        databaseStructure = snapshot.val() || {};
    } catch (error) {
        console.error("Error fetching Firebase schema:", error);
        showToast("Firebase schema পড়তে সমস্যা হয়েছে।", "error");
    }
}

function applyUiHighlights() {
    document.querySelectorAll('[data-component-id]').forEach(el => {
        const componentId = el.dataset.componentId;
        if (pathMappings[componentId] && pathMappings[componentId] !== defaultPaths[componentId]) {
            el.classList.add('path-configured');
        } else {
            el.classList.remove('path-configured');
        }
    });
}

function openPathSelector(componentId, event) {
    event.stopPropagation();
    const popover = document.getElementById('path-selector-popover');
    popover.dataset.componentId = componentId;
    const currentPath = getPathFor(componentId);
    const pathSegments = currentPath ? currentPath.split('/') : [];
    rebuildPathSelectors(pathSegments);
    const iconRect = event.target.getBoundingClientRect();
    popover.style.display = 'flex';
    popover.style.left = `${iconRect.left - popover.offsetWidth}px`;
    popover.style.top = `${iconRect.bottom + window.scrollY}px`;
}

function rebuildPathSelectors(currentSegments = []) {
    const container = document.getElementById('path-segments-container');
    container.innerHTML = '';
    let currentLevelObject = databaseStructure;

    for (let i = 0; i < currentSegments.length; i++) {
        const segment = currentSegments[i];
        if (typeof currentLevelObject !== 'object' || currentLevelObject === null) break;
        const select = document.createElement('select');
        select.dataset.level = i;
        Object.keys(currentLevelObject).forEach(key => {
            const option = document.createElement('option');
            option.value = key; option.textContent = key;
            if (key === segment) option.selected = true;
            select.appendChild(option);
        });
        select.addEventListener('change', (e) => {
            const level = parseInt(e.target.dataset.level);
            const newSegments = [];
            container.querySelectorAll('select').forEach(s => { if(parseInt(s.dataset.level) <= level) newSegments.push(s.value); });
            rebuildPathSelectors(newSegments);
        });
        container.appendChild(select);
        currentLevelObject = currentLevelObject[segment];
    }
    
    if (typeof currentLevelObject === 'object' && currentLevelObject !== null && Object.keys(currentLevelObject).length > 0) {
        const select = document.createElement('select');
        select.dataset.level = currentSegments.length;
        const firstOption = document.createElement('option');
        firstOption.value = ""; firstOption.textContent = "একটি নির্বাচন করুন..."; select.appendChild(firstOption);
        Object.keys(currentLevelObject).forEach(key => { const option = document.createElement('option'); option.value = key; option.textContent = key; select.appendChild(option); });
        select.addEventListener('change', (e) => {
            const level = parseInt(e.target.dataset.level);
            const newSegments = [];
            container.querySelectorAll('select').forEach(s => { if(parseInt(s.dataset.level) < level) newSegments.push(s.value); });
            if (e.target.value) newSegments.push(e.target.value);
            rebuildPathSelectors(newSegments);
        });
        container.appendChild(select);
    }
}

function closePathSelector() { document.getElementById('path-selector-popover').style.display = 'none'; }

async function savePathMapping() {
    const user = auth.currentUser;
    if (!user) return showToast("এই সুবিধাটি শুধুমাত্র লগইন করা ব্যবহারকারীদের জন্য।", "error");
    const popover = document.getElementById('path-selector-popover');
    const componentId = popover.dataset.componentId;
    const segments = [];
    document.getElementById('path-segments-container').querySelectorAll('select').forEach(select => { if (select.value) segments.push(select.value); });
    const finalPath = segments.join('/');
    await database.ref(`ui_path_mappings/${user.uid}/${componentId}`).set(finalPath);
    showToast("Path সফলভাবে সংরক্ষণ করা হয়েছে!", "success");
    closePathSelector();
    await loadPathMappings();
    setupFirebaseListeners();
}

document.addEventListener('click', function(event) {
    const popover = document.getElementById('path-selector-popover');
    if (popover.style.display === 'flex' && !popover.contains(event.target) && !event.target.classList.contains('path-config-icon')) closePathSelector();
});

  const deviceCharts = {};
  let energyCharts = {};
  let advancedEnergyChart = null;
  let sensorHistoricalCharts = {};
  let selectedMetric = 'voltage';
  let selectedTimeRange = 30;
  let historicalData = {};
  let relayOperationContext = null;
  let timerOperationContext = null;
  let allTimersData = {};
  let currentBackgroundIndex = 0;
  const totalBackgrounds = 11;
  let currentEnergyData = {};
  let currentDeviceStates = {};
  let automationRules = {};
  let logicGateRules = {};
  let relayNames = {};
  let deviceMetadata = {};
  let currentPageToEdit = null;
  let actionToConfirmCallback = null;
  let tabSortable = null;
  let isSortingLocked = true;

  function openImageModal(src, cap) { document.getElementById('imageModal').style.display = "flex"; document.getElementById('modalImage').src = src; document.getElementById('modalCaption').innerHTML = cap; }
  function closeImageModal() { document.getElementById('imageModal').style.display = "none"; }
  window.onclick = e => { if (e.target === document.getElementById('imageModal')) closeImageModal(); };
  function createParticles() { const cont = document.getElementById('particles'); if(cont.children.length > 0) return; for (let i=0; i<30; i++) { const p = document.createElement('div'); p.className = 'particle'; const size = Math.random()*10+5; p.style.width=`${size}px`; p.style.height=`${size}px`; p.style.left=`${Math.random()*100}%`; p.style.top=`${Math.random()*100}%`; p.style.animationDelay=`${Math.random()*15}s`; p.style.animationDuration=`${Math.random()*10+10}s`; p.style.opacity=Math.random()*0.5+0.1; cont.appendChild(p); } }
  
  function showPage(pageId) {
    document.querySelectorAll('.nav-tabs .nav-tab').forEach(t => t.classList.remove('active'));
    const activeTab = document.querySelector(`.nav-tab[data-tab-id="${pageId}"]`);
    if(activeTab) activeTab.classList.add('active');
    document.querySelectorAll('.device-page').forEach(p => p.classList.remove('active'));
    const activePage = document.getElementById(pageId);
    if(activePage) activePage.classList.add('active');
    if(pageId === 'page6' && advancedEnergyChart) updateAdvancedChart();
  }
  
  function controlRelay(device, relay, element) {
      const state = element.checked;
      const deviceRootPath = getPathFor('devices_root');
      const path = `${deviceRootPath}/${device}`;
      const overridePath = `${getPathFor('logic_gate_overrides')}/${device}/${relay}`;
      database.ref(overridePath).set(firebase.database.ServerValue.TIMESTAMP);
      database.ref(path).update({ [relay]: state });
      const name = (relayNames[device]?.[relay]) || relay;
      const msg = `${device} এর ${name} ${state ? 'চালু' : 'বন্ধ'} করা হয়েছে (ম্যানুয়াল)`;
      addLogEntry(device, msg, state ? 'success' : 'error');
      logAuditEvent(`ডিভাইস ${device.replace('device','')} এর '${name}' ${state ? 'চালু' : 'বন্ধ'} করেছেন (ম্যানুয়াল ওভাররাইড)।`);
  }

  function controlDevice(device, load, state) {
      const stateText = state === 1 ? 'চালু' : (state === 2 ? 'সতর্কতা মোডে' : 'বন্ধ');
      const path = getPathFor(`${device}_data`);
      if(!path) return showToast(`Error: Path for ${device} is not configured!`, 'error');
      const overridePath = `${getPathFor('logic_gate_overrides')}/${device}/${load}`;
      database.ref(overridePath).set(firebase.database.ServerValue.TIMESTAMP);
      database.ref(path).update({ [load]: state });
      addLogEntry(device, `${device} এর ${load} ${stateText} করা হয়েছে (ম্যানুয়াল)`, state === 1 ? 'success' : state === 2 ? 'warning' : 'error');
      logAuditEvent(`ডিভাইস ${device.replace('device','')} এর '${load}' ${stateText} সেট করেছেন (ম্যানুয়াল ওভাররাইড)।`);
  }
  
  function clearManualOverride(device, relay) {
      const overridePath = `${getPathFor('logic_gate_overrides')}/${device}/${relay}`;
      database.ref(overridePath).remove().then(() => {
          showToast(`'${relay}' এর জন্য অটোমেশন আবার চালু করা হয়েছে।`, 'success');
          logAuditEvent(`'${relay}' এর ম্যানুয়াল ওভাররাইড বাতিল করেছেন। অটোমেশন সক্রিয়।`);
      });
  }

  function addLogEntry(device, message, type) {
    const logId = `device${device.replace('device','')}-logs`;
    const logEl = document.getElementById(logId);
    if (!logEl) return;
    const item = document.createElement('div');
    item.className = 'log-item';
    item.innerHTML = `<div class="log-time">${new Date().toLocaleString('bn-BD')}</div><div class="log-message log-${type}">${message}</div>`;
    logEl.insertBefore(item, logEl.firstChild);
    if(logEl.children.length > 50) logEl.removeChild(logEl.lastChild);
  }

  function initializeCharts() {
    for(let i = 1; i <= 4; i++) {
      const ctx = document.getElementById(`device${i}-chart`).getContext('2d');
      if (deviceCharts[`device${i}`]) deviceCharts[`device${i}`].destroy();
      deviceCharts[`device${i}`] = new Chart(ctx, { type: 'doughnut', data: { labels: ['এক্টিভ', 'সতর্কতা', 'ইনএক্টিভ'], datasets: [{ data: [0, 0, 16], backgroundColor: ['rgba(46,204,113,0.8)','rgba(243,156,18,0.8)','rgba(231,76,60,0.8)'], borderColor: 'rgba(255,255,255,0.1)', borderWidth: 2 }] }, options: { responsive: true } });
    }
  }
  
  function updateSingleDevicePage(deviceId, deviceData) {
      const deviceNum = deviceId.replace('device', '');
      const container = document.getElementById(`${deviceId}-cards-container`);
      if (!container) return;
      if (deviceData) {
          const loadKeys = Object.keys(deviceData).filter(k => k.startsWith('Load')).sort((a, b) => parseInt(a.replace('Load', '')) - parseInt(b.replace('Load', '')));
          let html = '';
          let active = 0, inactive = 0, warning = 0, total = loadKeys.length;
          loadKeys.forEach(loadId => {
              const state = deviceData[loadId];
              const name = (relayNames[deviceId]?.[loadId]) || `লোড ${loadId.replace('Load', '')}`;
              let statusText = 'ইনএক্টিভ', statusClass = 'status-inactive', valueText = 'OFF';
              if (state === 1 || state === true) { statusText = 'এক্টিভ'; statusClass = 'status-active'; valueText = 'ON'; active++; }
              else if (state === 2) { statusText = 'সতর্কতা'; statusClass = 'status-warning'; valueText = 'WARNING'; warning++; }
              else { inactive++; }
              const linkedRules = getLinkedRules(deviceId, loadId);
              let linkIconHtml = '';
              if (linkedRules.length > 0) {
                  const linksList = linkedRules.map(r => `<div>• ${r}</div>`).join('');
                  linkIconHtml = `<span class="linked-rule-indicator" onclick="toggleLinkDropdown(this, event)" title="এই লোডটি অটোমেশন বা লজিক গেটের সাথে যুক্ত"><i class="fas fa-link"></i><div class="linked-rule-dropdown">${linksList}</div></span>`;
              }
              html += `<div class="device-card"><div class="card-header"><div class="card-title-container"><span class="card-title">${name} ${linkIconHtml}</span><div class="card-actions"><i class="fas fa-pencil-alt" title="নাম পরিবর্তন করুন" onclick="editRelayName('${deviceId}', '${loadId}')"></i><i class="fas fa-trash-alt" title="এই লোডটি মুছুন" onclick="deleteRelay('${deviceId}', '${loadId}')"></i></div></div><span class="card-status ${statusClass}">${statusText}</span></div><div class="card-value">${valueText}</div><div class="card-footer"><button class="pro-btn card-btn btn-on" onclick="controlDevice('${deviceId}', '${loadId}', 1)">ON</button><button class="pro-btn card-btn btn-warning" onclick="controlDevice('${deviceId}', '${loadId}', 2)">WARN</button><button class="pro-btn card-btn btn-off" onclick="controlDevice('${deviceId}', '${loadId}', 0)">OFF</button></div></div>`;
          });
          if (container.innerHTML !== html) container.innerHTML = html;
          document.getElementById(`d${deviceNum}-active-count`).textContent = active;
          document.getElementById(`d${deviceNum}-inactive-count`).textContent = inactive;
          document.getElementById(`d${deviceNum}-warning-count`).textContent = warning;
          document.getElementById(`d${deviceNum}-total-count`).textContent = total;
          if (deviceCharts[deviceId]) { deviceCharts[deviceId].data.datasets[0].data = [active, warning, inactive]; deviceCharts[deviceId].update(); }
      }
  }

  function toggleTheme() {
    const isLight = document.getElementById('theme-toggle').checked;
    document.body.classList.toggle('light-theme', isLight);
    localStorage.setItem('theme', isLight ? 'light' : 'dark');
    Chart.defaults.color = isLight ? '#2c3e50' : '#FFFFFF';
    Chart.defaults.borderColor = isLight ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)';
    Object.values({...deviceCharts, ...energyCharts, advancedEnergyChart, ...sensorHistoricalCharts}).forEach(c => c?.update());
  }

  function loadThemePreference() {
    const theme = localStorage.getItem('theme') || 'dark';
    document.getElementById('theme-toggle').checked = (theme === 'light');
    toggleTheme();
    document.getElementById('theme-toggle').addEventListener('change', toggleTheme);
  }
  
  function applyBackground(index) { document.body.className = `bg-${index}`; currentBackgroundIndex = index; }
  function changeBackground() { const newIndex = (currentBackgroundIndex + 1) % totalBackgrounds; applyBackground(newIndex); localStorage.setItem('backgroundIndex', newIndex); }
  function loadBackgroundPreference() { applyBackground(parseInt(localStorage.getItem('backgroundIndex') || 0)); }

  function getChartOptions() { return { responsive: true }; }
  function initEnergyCharts() {
    ['voltage-chart', 'current-chart', 'power-chart', 'energy-chart'].forEach(id => { const chart = Chart.getChart(id); if (chart) chart.destroy(); });
    energyCharts.voltageChart = new Chart('voltage-chart', { type: 'line', data: { datasets: [{ label: 'ভোল্টেজ (V)', data: [], borderColor: 'rgba(230,126,34,1)', backgroundColor: 'rgba(230,126,34,0.2)', fill: true, tension: 0.4 }] }, options: getChartOptions() });
    energyCharts.currentChart = new Chart('current-chart', { type: 'line', data: { datasets: [{ label: 'কারেন্ট (A)', data: [], borderColor: 'rgba(26,188,156,1)', backgroundColor: 'rgba(26,188,156,0.2)', fill: true, tension: 0.4 }] }, options: getChartOptions() });
    energyCharts.powerChart = new Chart('power-chart', { type: 'line', data: { datasets: [{ label: 'পাওয়ার (W)', data: [], borderColor: 'rgba(52,152,219,1)', backgroundColor: 'rgba(52,152,219,0.2)', fill: true, tension: 0.4 }] }, options: getChartOptions() });
    energyCharts.energyChart = new Chart('energy-chart', { type: 'bar', data: { labels: ['সকাল', 'দুপুর', 'বিকাল', 'রাত'], datasets: [{ label: 'এনার্জি (kWh)', data: [0,0,0,0], backgroundColor: 'rgba(155,89,182,0.7)' }] }, options: getChartOptions() });
  }
  
  function updateEnergyData(data) {
    currentEnergyData = data;
    const setHTML = (id, val, unit) => document.getElementById(id).innerHTML = (data[val] !== undefined && data[val] !== null) ? data[val] + ` <span class="energy-unit">${unit}</span>` : `-- <span class="energy-unit">${unit}</span>`;
    
    // Updated mapping based on Firebase snake_case keys
    setHTML('voltage-value', 'voltage', 'V');
    setHTML('current-value', 'current', 'A'); 
    setHTML('power-value', 'power', 'W');
    setHTML('energy-value', 'energy', 'kWh'); 
    setHTML('frequency-value', 'frequency', 'Hz'); 
    setHTML('active-power-value', 'active_power', 'W'); 
    setHTML('reactive-power-value', 'reactive_power', 'VAR'); 
    setHTML('daily-cost-value', 'cost', 'BDT');
    setHTML('units-value', 'units', 'Units'); 
    
    document.getElementById('power-factor-value').textContent = (data.power_factor !== undefined) ? data.power_factor : '--'; 
    
    // Fix for Timestamp (Handling String vs Number)
    let timeDisplay = '--';
    if (data.timestamp) {
        if (typeof data.timestamp === 'string') {
            timeDisplay = data.timestamp; // Use directly if it's "15:04:37"
        } else if (typeof data.timestamp === 'number') {
            timeDisplay = new Date(data.timestamp * 1000).toLocaleString('bn-BD');
        }
    }
    document.getElementById('timestamp-value').textContent = timeDisplay;
    
    const updateChart = (chart, value) => { if(!value || !chart) return; chart.data.labels.push(''); if(chart.data.labels.length>12) chart.data.labels.shift(); chart.data.datasets[0].data.push(value); if(chart.data.datasets[0].data.length>12) chart.data.datasets[0].data.shift(); chart.update(); };
    updateChart(energyCharts.voltageChart, data.voltage); updateChart(energyCharts.currentChart, data.current); updateChart(energyCharts.powerChart, data.power);
    const ts = new Date().getTime(); 
    historicalData = { ...data, ...historicalData };
    if(!historicalData[ts]) historicalData[ts] = data;
    if(document.getElementById('page6').classList.contains('active')) updateAdvancedChart();
    checkForAnomalies(data.power);
  }
  
  function promptForRelayPassword(device, relay, element) { element.checked = !element.checked; relayOperationContext = { device, relay, element, targetState: !element.checked }; document.getElementById('relayPasswordModal').style.display = 'flex'; document.getElementById('relayPasswordInput').focus(); document.getElementById('relayPasswordError').innerText = ''; }
  function verifyAndOperateRelay() { if(document.getElementById('relayPasswordInput').value === correctOperatingPassword) { if(relayOperationContext) { const { device, relay, element, targetState } = relayOperationContext; element.checked = targetState; controlRelay(device, relay, element); closeRelayModal(); } } else { document.getElementById('relayPasswordError').innerText = '❌ ভুল পাসওয়ার্ড!'; } document.getElementById('relayPasswordInput').value = ''; }
  function cancelRelayOperation() { closeRelayModal(); }
  function closeRelayModal() { document.getElementById('relayPasswordModal').style.display = 'none'; document.getElementById('relayPasswordInput').value = ''; relayOperationContext = null; }
  
  function promptForActionPassword(title, desc, cb) { document.getElementById('action-modal-title').textContent = title; document.getElementById('action-modal-description').textContent = desc; actionToConfirmCallback = cb; document.getElementById('actionPasswordModal').style.display = 'flex'; document.getElementById('actionPasswordInput').focus(); document.getElementById('actionPasswordError').textContent = ''; }
  function verifyAndExecuteAction() { if(document.getElementById('actionPasswordInput').value === correctOperatingPassword) { if (typeof actionToConfirmCallback === 'function') actionToConfirmCallback(); cancelAction(); } else { document.getElementById('actionPasswordError').textContent = '❌ ভুল অপারেটিং পাসওয়ার্ড!'; } document.getElementById('actionPasswordInput').value = ''; }
  function cancelAction() { document.getElementById('actionPasswordModal').style.display = 'none'; document.getElementById('actionPasswordInput').value = ''; actionToConfirmCallback = null; }

  function updateAllTimerDisplays() { 
      for(const key in allTimersData) { 
          const data = allTimersData[key]; 
          const el = document.getElementById(`timer-status-${data.device}-${data.relay}`); 
          if(el) {
              el.innerHTML = data.enabled ? 
              `টাইমার সক্রিয়। ${calculateCountdown(data.online, data.offline).nextState} ${calculateCountdown(data.online, data.offline).timeLeft} পর।` 
              : 'টাইমার নিষ্ক্রিয় আছে।'; 
          }
      } 
  }
  
  function processTimerExecution() {
      const now = new Date();
      const currentTimeString = now.toLocaleTimeString('en-GB', { hour12: false });
      for(const key in allTimersData) {
          const t = allTimersData[key];
          if(!t.enabled) continue;
          if(t.online === currentTimeString) {
              const deviceRootPath = getPathFor('devices_root');
              database.ref(`${deviceRootPath}/${t.device}`).update({ [t.relay]: true });
          }
          if(t.offline === currentTimeString) {
              const deviceRootPath = getPathFor('devices_root');
              database.ref(`${deviceRootPath}/${t.device}`).update({ [t.relay]: false });
          }
      }
  }

  function calculateCountdown(on, off) { const now=new Date(), onT=new Date(now.toDateString()+' '+on), offT=new Date(now.toDateString()+' '+off); let next, state; if(onT<offT){ if(now>=onT && now<offT){next=offT; state='অফ হবে';} else {next=now<onT?onT:new Date(onT.getTime()+864e5); state='অন হবে';} } else { if(now>=offT && now<onT){next=onT; state='অন হবে';} else {next=now<offT?offT:new Date(offT.getTime()+864e5); state='অফ হবে';} } const d=next-now, h=Math.floor(d/36e5), m=Math.floor(d%36e5/6e4), s=Math.floor(d%6e4/1e3); return {timeLeft:`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`, nextState:state}; }
  function openTimerModal(dev, rel) { const key=`${dev}-${rel}`; timerOperationContext=key; const data=allTimersData[key]||{}; const name=(relayNames[dev]?.[rel])||`${dev}-${rel}`; document.getElementById('timer-modal-title').textContent=`${name} - টাইমার সেটিংস`; document.getElementById('timer-online-time').value=data.online||'00:00:00'; document.getElementById('timer-offline-time').value=data.offline||'00:00:00'; updateEnabledButton(document.getElementById('timer-enabled-btn'), !!data.enabled); document.getElementById('timerModal').style.display='flex'; }
  function updateEnabledButton(btn, isEn) { btn.textContent=isEn?'সক্রিয়':'নিষ্ক্রিয়'; btn.classList.toggle('enabled',isEn); btn.classList.toggle('disabled',!isEn); }
  function toggleTimerEnabled() { const btn=document.getElementById('timer-enabled-btn'); updateEnabledButton(btn, !btn.classList.contains('enabled')); }
  function closeTimerModal() { document.getElementById('timerModal').style.display='none'; document.getElementById('timerPasswordInput').value=''; document.getElementById('timerPasswordError').textContent=''; timerOperationContext=null; }
  function saveTimerSettings() { if(document.getElementById('timerPasswordInput').value!==correctOperatingPassword) { document.getElementById('timerPasswordError').textContent='❌ ভুল অপারেটিং পাসওয়ার্ড!'; return; } if(timerOperationContext) { const [dev,rel]=timerOperationContext.split('-'), en=document.getElementById('timer-enabled-btn').classList.contains('enabled'), onT=document.getElementById('timer-online-time').value, offT=document.getElementById('timer-offline-time').value; const updates={enabled:en, online:onT, offline:offT, device:dev, relay:rel}; database.ref(`${getPathFor('timers')}/${timerOperationContext}`).set(updates).then(()=>{ logAuditEvent(`'${timerOperationContext}' এর জন্য টাইমার সেটিংস পরিবর্তন করেছেন।`); closeTimerModal(); }); } }

  function initAdvancedEnergyChart(){if(advancedEnergyChart)advancedEnergyChart.destroy();advancedEnergyChart=new Chart('advanced-energy-chart',{type:'line',data:{datasets:[{label:'ভোল্টেজ (V)',data:[],borderColor:'rgba(230,126,34,1)',backgroundColor:'rgba(230,126,34,0.2)',fill:true,tension:0.4}]},options:getChartOptions()});}
  function changeTimeRange(mins){selectedTimeRange=mins;document.querySelectorAll('.time-btn').forEach(b=>b.classList.remove('active'));event.target.classList.add('active');updateAdvancedChart();}
  
  // FIX: Updated selectMetric and getMetricName to handle snake_case keys correctly
  function selectMetric(metric){
      selectedMetric=metric;
      document.querySelectorAll('.metric-card').forEach(c=>c.classList.remove('selected'));
      event.target.closest('.metric-card').classList.add('selected');
      updateAdvancedChart();
  }
  
  function getMetricName(m){
      const names = {
          voltage:'ভোল্টেজ', current:'কারেন্ট', power:'পাওয়ার', energy:'এনার্জি',
          frequency:'ফ্রিকোয়েন্সি', power_factor:'পাওয়ার ফ্যাক্টর', 
          active_power:'অ্যাক্টিভ পাওয়ার', reactive_power:'রিঅ্যাক্টিভ পাওয়ার'
      };
      return names[m]||m;
  }
  
  function getTimeRangeText(m){return m<60?`${m} মিনিট`:`${Math.floor(m/60)} ঘন্টা`;}
  
  function updateAdvancedChart(){
      if(!advancedEnergyChart)return;
      const now=new Date().getTime(),cutoff=now-(selectedTimeRange*60*1000);
      const timestamps=Object.keys(historicalData).filter(ts=>parseInt(ts)>=cutoff).sort();
      const labels=timestamps.map(ts=>new Date(parseInt(ts)).toLocaleTimeString('bn-BD'));
      // Using snake_case keys based on selectedMetric
      const data=timestamps.map(ts=>historicalData[ts]?.[selectedMetric]);
      
      document.getElementById('advanced-graph-title').textContent=`${getMetricName(selectedMetric)} ট্রেন্ড (${getTimeRangeText(selectedTimeRange)})`;
      advancedEnergyChart.data.labels=labels;
      advancedEnergyChart.data.datasets[0].data=data;
      advancedEnergyChart.data.datasets[0].label=`${getMetricName(selectedMetric)} (${getUnit(selectedMetric)})`;
      advancedEnergyChart.update();
      document.getElementById('no-data-message').style.display=data.length===0?'block':'none';
  }
  
  function getUnit(m){
      const units = {
          voltage:'V', current:'A', power:'W', energy:'kWh', 
          frequency:'Hz', power_factor:'', active_power:'W', reactive_power:'VAR'
      };
      return units[m]||'';
  }
  
  function downloadGraphData(){
      let csv="data:text/csv;charset=utf-8,সময়,ভোল্টেজ (V),কারেন্ট (A),পাওয়ার (W),এনার্জি (kWh),ফ্রিকোয়েন্সি (Hz),পাওয়ার ফ্যাক্টর,অ্যাক্টিভ পাওয়ার (W),রিঅ্যাক্টিভ পাওয়ার (VAR)\n";
      Object.keys(historicalData).sort().forEach(ts=>{
          const d=historicalData[ts];
          // Updated to use snake_case keys for CSV export
          csv+=[new Date(parseInt(ts)).toLocaleString(),d.voltage||'',d.current||'',d.power||'',d.energy||'',d.frequency||'',d.power_factor||'',d.active_power||'',d.reactive_power||''].join(",")+"\n";
      });
      const link=document.createElement("a");
      link.href=encodeURI(csv);
      link.download=`energy_data_${new Date().toLocaleDateString()}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
  }
  
  function printGraph(){const canvas=document.getElementById('advanced-energy-chart'),win=window.open('','Print');win.document.write(`<h1>${document.getElementById('advanced-graph-title').textContent}</h1><img src="${canvas.toDataURL()}"/>`);win.document.close();win.focus();setTimeout(()=>{win.print();win.close();},500);}
  function showToast(msg,type='info'){
      if (!isNotificationMuted) {
          const sound=document.getElementById('notification-sound');
          sound.currentTime=0;
          sound.play().catch(e=>console.log("Audio couldn't play:",e));
      }
      const cont=document.getElementById('toast-container'),toast=document.createElement('div');toast.className=`toast-message ${type}`;toast.innerHTML=`${type==='success'?'✅':type==='error'?'❌':type==='warning'?'🔇':'ℹ️'} ${msg}`;cont.appendChild(toast);setTimeout(()=>toast.remove(),5000);
  }
  function displayNotification(title,body){if('Notification' in window&&Notification.permission==='granted'){navigator.serviceWorker.ready.then(reg=>reg.showNotification(title,{body:body,icon:'Bisnu.png',badge:'Bisnu.png'}));}}
  function initializeNotifications(){messaging.onMessage(payload=>showToast(payload.notification.body,'info'));}
  async function requestNotificationPermission(){const btn=document.getElementById('notification-btn');try{await messaging.requestPermission();const token=await messaging.getToken();const user=auth.currentUser;if(user){database.ref(`fcmTokens/${user.uid}`).set({token:token});showToast('নোটিফিকেশন সফলভাবে চালু হয়েছে!','success');}}catch(err){showToast('নোটিফিkeশনের অনুমতি দেওয়া হয়নি।','error');}}
  
  function toggleNotificationSound() {
      isNotificationMuted = !isNotificationMuted;
      localStorage.setItem('isNotificationMuted', isNotificationMuted);
      loadSoundPreference();
      showToast(isNotificationMuted ? 'নোটিফিকেশন সাউন্ড বন্ধ করা হয়েছে।' : 'নোটিফিকেশন সাউন্ড চালু করা হয়েছে।', isNotificationMuted ? 'warning' : 'success');
  }

  function loadSoundPreference() {
      const btn = document.getElementById('notification-btn');
      if (isNotificationMuted) {
          btn.innerHTML = '<i class="fas fa-bell-slash"></i> সাউন্ড মিউট করা';
          btn.classList.remove('notification-btn');
          btn.classList.add('btn-off');
      } else {
          btn.innerHTML = '🔔 সাউন্ড অন আছে';
          btn.classList.remove('btn-off');
          btn.classList.add('notification-btn');
      }
  }

  function checkForAnomalies(power){const alertDiv=document.getElementById('anomaly-alert');if(power>5000){const msg=`অস্বাভাবিকভাবে উচ্চ পাওয়ার (${power.toFixed(0)} W) ব্যবহার শনাক্ত হয়েছে।`;alertDiv.innerHTML=`<div class="alert-message"><strong>সতর্কতা!</strong> ${msg}</div>`;triggerNotification("উচ্চ পাওয়ার ব্যবহার!",msg);}else{alertDiv.innerHTML=`<p>সিস্টেম স্বাভাবিকভাবে চলছে। কোনো অস্বাভাবিকতা শনাক্ত হয়নি।</p>`;}}
  function populateRelayDropdown(devSelect,relSelect){const selDevId=devSelect.value,currRelVal=relSelect.value;relSelect.innerHTML='';if(selDevId&&currentDeviceStates[selDevId]){const relays=Object.keys(currentDeviceStates[selDevId]).filter(k=>k.startsWith('relay')||k.startsWith('Load')).sort((a,b)=>{const numA=parseInt(a.match(/\d+/));const numB=parseInt(b.match(/\d+/));return numA-numB;});relays.forEach(relId=>{const name=(relayNames[selDevId]?.[relId])||relId;const opt=document.createElement('option');opt.value=relId;opt.textContent=name;relSelect.appendChild(opt);});if(relays.includes(currRelVal))relSelect.value=currRelVal;}}
  
  function updateAutomationFormOptions(){
      const devs=currentDeviceStates?Object.keys(currentDeviceStates).sort((a,b)=>parseInt(a.replace('device',''))-parseInt(b.replace('device',''))):[],actDevSelect=document.getElementById('action-device');
      if(!actDevSelect)return;
      const currActDev=actDevSelect.value;
      actDevSelect.innerHTML='';
      devs.forEach(devId=>{const opt=document.createElement('option');opt.value=devId;opt.textContent=devId.replace('device','ডিভাইস ');actDevSelect.appendChild(opt);});
      if(devs.includes(currActDev))actDevSelect.value=currActDev;
      populateRelayDropdown(actDevSelect,document.getElementById('action-relay'));
      const src = document.getElementById('trigger-source').value;
      if (src === 'device') {
          if (document.activeElement.tagName !== 'SELECT') {
             updateTriggerOptions();
          }
      }
  }

  function updateTriggerOptions(){const src=document.getElementById('trigger-source').value,cont=document.getElementById('trigger-options-container'),devs=currentDeviceStates?Object.keys(currentDeviceStates).sort((a,b)=>parseInt(a.replace('device',''))-parseInt(b.replace('device',''))):[];let html='';if(src==='energy')html=`<div class="form-group"><label for="trigger-metric">ম্যাট্রিক</label><select id="trigger-metric"><option value="power">পাওয়ার (W)</option><option value="voltage">ভোল্টেজ (V)</option><option value="current">কারেন্ট (A)</option></select></div><div class="form-group"><label for="trigger-condition">শর্ত</label><select id="trigger-condition"><option value=">">এর বেশি হলে</option><option value="<">এর কম হলে</option><option value="==">এর সমান হলে</option></select></div><div class="form-group"><label for="trigger-value">মান</label><input type="number" id="trigger-value" required></div>`;else if(src==='time')html=`<div class="form-group"><label for="trigger-value">নির্দিষ্ট সময়</label><input type="time" id="trigger-value" required></div>`;else if(src==='device')html=`<div class="form-group"><label for="trigger-device">ডিভাইস</label><select id="trigger-device" onchange="populateRelayDropdown(this, document.getElementById('trigger-relay'))">${devs.map(id=>`<option value="${id}">${id.replace('device','ডিভাইস ')}</option>`).join('')}</select></div><div class="form-group"><label for="trigger-relay">রিলে/লোড</label><select id="trigger-relay"></select></div><div class="form-group"><label for="trigger-condition">অবস্থা</label><select id="trigger-condition"><option value="true">ON হলে</option><option value="false">OFF হলে</option></select></div>`;cont.innerHTML=html;if(src==='device'&&devs.length>0)populateRelayDropdown(document.getElementById('trigger-device'),document.getElementById('trigger-relay'));}
  document.getElementById('send-notification-checkbox').addEventListener('change',function(){document.getElementById('notification-message-group').style.display=this.checked?'flex':'none';});
  
  function saveAutomationRule(e){
      e.preventDefault();
      const ruleName=document.getElementById('rule-name').value;
      if(!ruleName)return showToast("রুলের একটি নাম দিন।","error");
      const isEdit = editingAutomationRuleId !== null;
      const actionTitle = isEdit ? `'${ruleName}' আপডেট করুন` : `'${ruleName}' সংরক্ষণ করুন`;
      const actionDesc = isEdit ? `আপনি কি '${ruleName}' রুলটি আপডেট করতে চান?` : `আপনি কি '${ruleName}' রুলটি সংরক্ষণ করতে চান?`;
      promptForActionPassword(actionTitle, actionDesc, ()=>{
          const sendNotif=document.getElementById('send-notification-checkbox').checked;
          const rule={
              name:ruleName,
              triggerSource:document.getElementById('trigger-source').value,
              actionDevice:document.getElementById('action-device').value,
              actionRelay:document.getElementById('action-relay').value,
              actionState:document.getElementById('action-state').value==='true',
              sendNotification:sendNotif,
              notificationMessage:sendNotif?document.getElementById('notification-message').value:'',
              isEnabled:true,
              lastFired:0
          };
          if(rule.triggerSource==='energy'){
              rule.triggerMetric=document.getElementById('trigger-metric').value;
              rule.triggerCondition=document.getElementById('trigger-condition').value;
              rule.triggerValue=parseFloat(document.getElementById('trigger-value').value);
          }else if(rule.triggerSource==='time') {
              rule.triggerValue=document.getElementById('trigger-value').value;
          }else if(rule.triggerSource==='device'){
              rule.triggerDevice=document.getElementById('trigger-device').value;
              rule.triggerRelay=document.getElementById('trigger-relay').value;
              rule.triggerState=document.getElementById('trigger-condition').value==='true';
          }
          if (isEdit) {
             database.ref(`${getPathFor('automation_rules')}/${editingAutomationRuleId}`).update(rule)
             .then(()=>{ showToast('অটোমেশন রুল সফলভাবে আপডেট হয়েছে!','success'); logAuditEvent(`অটোমেশন রুল '${rule.name}' আপডেট করেছেন।`); cancelEditAutomation(); });
          } else {
             database.ref(getPathFor('automation_rules')).push(rule)
             .then(()=>{ showToast('অটোমেশন রুল সফলভাবে সংরক্ষিত হয়েছে!','success'); logAuditEvent(`নতুন অটোমেশন রুল '${rule.name}' তৈরি করেছেন।`); cancelEditAutomation(); });
          }
      });
  }

  function editAutomationRule(id) {
      const rule = automationRules[id];
      if (!rule) return;
      editingAutomationRuleId = id;
      document.getElementById('rule-name').value = rule.name;
      document.getElementById('trigger-source').value = rule.triggerSource;
      updateTriggerOptions(); 
      setTimeout(() => {
          if(rule.triggerSource==='energy'){
              document.getElementById('trigger-metric').value = rule.triggerMetric;
              document.getElementById('trigger-condition').value = rule.triggerCondition;
              document.getElementById('trigger-value').value = rule.triggerValue;
          }else if(rule.triggerSource==='time') {
              document.getElementById('trigger-value').value = rule.triggerValue;
          }else if(rule.triggerSource==='device'){
              document.getElementById('trigger-device').value = rule.triggerDevice;
              populateRelayDropdown(document.getElementById('trigger-device'),document.getElementById('trigger-relay'));
              document.getElementById('trigger-relay').value = rule.triggerRelay;
              document.getElementById('trigger-condition').value = rule.triggerState ? 'true' : 'false';
          }
      }, 100); 
      document.getElementById('action-device').value = rule.actionDevice;
      populateRelayDropdown(document.getElementById('action-device'), document.getElementById('action-relay'));
      document.getElementById('action-relay').value = rule.actionRelay;
      document.getElementById('action-state').value = rule.actionState ? 'true' : 'false';
      document.getElementById('send-notification-checkbox').checked = rule.sendNotification;
      document.getElementById('notification-message-group').style.display = rule.sendNotification ? 'flex' : 'none';
      document.getElementById('notification-message').value = rule.notificationMessage || '';
      const submitBtn = document.querySelector('#automation-rule-form button[type="submit"]');
      submitBtn.textContent = '🔄 আপডেট করুন';
      document.getElementById('cancel-automation-edit-btn').style.display = 'block';
      document.querySelector('.automation-grid').scrollIntoView({behavior: 'smooth'});
  }

  function cancelEditAutomation() {
      editingAutomationRuleId = null;
      document.getElementById('automation-rule-form').reset();
      document.getElementById('notification-message-group').style.display='none';
      updateTriggerOptions(); 
      const submitBtn = document.querySelector('#automation-rule-form button[type="submit"]');
      submitBtn.textContent = '💾 রুল সংরক্ষণ করুন';
      document.getElementById('cancel-automation-edit-btn').style.display = 'none';
  }

  function toggleRule(id){const rule=automationRules[id],newState=!rule.isEnabled;database.ref(`${getPathFor('automation_rules')}/${id}/isEnabled`).set(newState).then(()=>logAuditEvent(`'${rule.name}' রুলটি ${newState?'সক্রিয়':'নিষ্ক্রিয়'} করেছেন।`));}
  function deleteRule(id){const name=automationRules[id].name;promptForActionPassword('রুল মুছুন',`আপনি কি সত্যিই "${name}" রুলটি মুছে ফেলতে চান?`,()=>database.ref(`${getPathFor('automation_rules')}/${id}`).remove().then(()=>logAuditEvent(`'${name}' রুলটি মুছে ফেলেছেন।`)));}
  function triggerNotification(title,body){showToast(body,'info');displayNotification(title,body);}
  
  function checkAutomationRules(src, data) {
    const now = new Date();
    const currTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
    const nowTs = now.getTime();
    for (const id in automationRules) {
        const rule = automationRules[id];
        if (!rule.isEnabled || (nowTs - (rule.lastFired || 0) < 5000)) continue;
        if (logicOverrides[rule.actionDevice] && logicOverrides[rule.actionDevice][rule.actionRelay]) continue;
        let trigger = false;
        if (src === 'energy' && rule.triggerSource === 'energy') {
            const val = parseFloat(data[rule.triggerMetric]);
            const targetVal = parseFloat(rule.triggerValue);
            if (!isNaN(val)) {
                if (rule.triggerCondition === '>' && val > targetVal) trigger = true;
                if (rule.triggerCondition === '<' && val < targetVal) trigger = true;
                if (rule.triggerCondition === '==' && val == targetVal) trigger = true;
            }
        }
        if (src === 'time' && rule.triggerSource === 'time' && rule.triggerValue === currTime) trigger = true;
        if (src === 'device' && rule.triggerSource === 'device') {
            if (data.deviceId === rule.triggerDevice) {
                 const currentState = data.states[rule.triggerRelay];
                 if (String(currentState) === String(rule.triggerState)) trigger = true;
            }
        }
        if (trigger) {
            database.ref(`${getPathFor('devices_root')}/${rule.actionDevice}`).update({ [rule.actionRelay]: rule.actionState });
            if (rule.sendNotification && rule.notificationMessage) triggerNotification(`"${rule.name}" কার্যকর হয়েছে`, rule.notificationMessage);
            database.ref(`${getPathFor('automation_rules')}/${id}/lastFired`).set(nowTs);
            const logMsg = `অটোমেশন "${rule.name}" অনুযায়ী ${rule.actionDevice} এর ${rule.actionRelay} ${rule.actionState ? 'ON' : 'OFF'} করা হয়েছে।`;
            addLogEntry(rule.actionDevice, logMsg, 'info');
            logAuditEvent(logMsg, "সিস্টেম অটোমেশন");
        }
    }
  }

  setInterval(()=>checkAutomationRules('time',{}),60000);
  
  function editRelayName(dev,rel){const currName=(relayNames[dev]?.[rel])||rel;const newName=prompt(`'${currName}' এর জন্য নতুন নাম দিন:`,currName);if(newName&&newName.trim()!=="")database.ref(`${getPathFor('device_metadata')}/${dev}/relay_names/${rel}`).set(newName).then(()=>logAuditEvent(`'${currName}' রিলের নাম পরিবর্তন করে '${newName}' রেখেছেন।`));}
  function executeScene(id,actions,name){promptForActionPassword(`'${name}' দৃশ্যটি চালান`,`আপনি কি সত্যিই "${name}" দৃশ্যটি কার্যকর করতে চান?`,()=>{const updates={};if(Array.isArray(actions))actions.forEach(a=>updates[`${getPathFor('devices_root')}/${a.device}/${a.relay}`]=a.state);if(Object.keys(updates).length===0)return showToast("এই দৃশ্যে কোনো অ্যাকশন সেট করা নেই।","warning");database.ref().update(updates).then(()=>logAuditEvent(`"${name}" দৃশ্যটি কার্যকর করেছেন।`));});}
  function openSceneModal(){const cont=document.getElementById('scene-relay-list-container');let html='';const sortedDevs=Object.keys(currentDeviceStates).sort((a,b)=>parseInt(a.replace('device',''))-parseInt(b.replace('device','')));sortedDevs.forEach(devId=>{html+=`<div class="scene-device-header">${devId.replace('device','ডিভাইস ')}</div>`;const relays=Object.keys(currentDeviceStates[devId]).filter(k=>k.startsWith('relay')||k.startsWith('Load')).sort((a,b)=>parseInt(a.match(/\d+/))-parseInt(b.match(/\d+/)));relays.forEach(relId=>{const name=(relayNames[devId]?.[relId])||relId;html+=`<div class="scene-relay-item"><span>${name}</span><select class="scene-action-select" data-device="${devId}" data-relay="${relId}"><option value="ignore">কোনো পরিবর্তন নয়</option><option value="true">ON করুন</option><option value="false">OFF করুন</option></select></div>`;});});cont.innerHTML=html;document.getElementById('sceneModal').style.display='flex';}
  function closeSceneModal(){document.getElementById('sceneModal').style.display='none';document.getElementById('scene-name').value='';document.getElementById('scene-error-message').textContent='';}
  async function saveScene(){const name=document.getElementById('scene-name').value;if(!name||name.trim()==='')return showToast('দৃশ্যের একটি নাম দিন।','error');const actions=[];document.querySelectorAll('.scene-action-select').forEach(sel=>{if(sel.value!=='ignore')actions.push({device:sel.dataset.device,relay:sel.dataset.relay,state:sel.value==='true'});});if(actions.length===0)return showToast('অন্তত একটি রিলের জন্য অ্যাকশন নির্বাচন করুন।','error');await database.ref(getPathFor('scenes')).push({name:name,actions:actions});logAuditEvent(`নতুন দৃশ্য '${name}' তৈরি করেছেন।`);closeSceneModal();}
  function deleteScene(id,name){promptForActionPassword('দৃশ্য মুছুন',`আপনি কি "${name}" দৃশ্যটি স্থায়ীভাবে মুছে ফেলতে চান?`,()=>database.ref(`${getPathFor('scenes')}/${id}`).remove().then(()=>logAuditEvent(`দৃশ্য '${name}' মুছে ফেলেছেন।`)));}
  function updateAllDateTimeDisplays(){const now=new Date(),date=now.toLocaleDateString('en-GB').replace(/\//g,'-'),time=now.toLocaleTimeString('en-GB');document.querySelectorAll('[id^="date-"]').forEach(el=>el.innerHTML=`<i class="fas fa-calendar-alt"></i> ${date}`);document.querySelectorAll('[id^="time-"]').forEach(el=>el.innerHTML=`<i class="fas fa-clock"></i> ${time}`);}
  
  function getLinkedRules(deviceId, relayId) {
      const links = [];
      for (const id in automationRules) {
          const rule = automationRules[id];
          if (rule.actionDevice === deviceId && rule.actionRelay === relayId && rule.isEnabled) links.push(`অটোমেশন: ${rule.name}`);
      }
      for (const id in logicGateRules) {
          const rule = logicGateRules[id];
          const outputs = rule.outputs || (rule.output ? [rule.output] : []);
          outputs.forEach(out => {
              if (out.device === deviceId && out.relay === relayId && rule.isEnabled) links.push(`লজিক গেট: ${rule.name}`);
          });
      }
      return links;
  }
  
  function isTargetOfActiveLogicRule(deviceId, relayId) {
      for (const id in logicGateRules) {
          const rule = logicGateRules[id];
          if(rule.isEnabled) {
             const outputs = rule.outputs || (rule.output ? [rule.output] : []);
             if (outputs.some(out => out.device === deviceId && out.relay === relayId)) return true;
          }
      }
      return false;
  }
  
  function toggleLinkDropdown(element, event) {
      event.stopPropagation();
      const dropdown = element.querySelector('.linked-rule-dropdown');
      const allDropdowns = document.querySelectorAll('.linked-rule-dropdown');
      allDropdowns.forEach(d => { if(d !== dropdown) d.classList.remove('show'); });
      dropdown.classList.toggle('show');
  }

  function renderControlPanel(devsData, relNames) {
      const cont = document.getElementById('control-panel-container');
      if (!cont) return;
      const sortedDevs = Object.keys(devsData).sort((a, b) => {
          const nA = parseInt(a.replace('device', '')), nB = parseInt(b.replace('device', ''));
          if (!isNaN(nA) && !isNaN(nB)) return nA - nB;
          return a.localeCompare(b);
      });
      sortedDevs.forEach(devId => {
          if (devId.startsWith('temperature')) return;
          let section = document.getElementById(`section-${devId}`);
          if (!section) {
              section = document.createElement('section');
              section.id = `section-${devId}`;
              section.className = 'control-section';
              section.dataset.componentId = `${devId}_data`;
              section.innerHTML = `
                  <div class="section-header">
                      <h2 class="control-section-title"><span id="title-${devId}">${(deviceMetadata[devId]?.name) || devId.replace('device', 'ডিভাইস ')} কন্ট্রোল</span></h2>
                      <div><button class="pro-btn delete-btn" onclick="deleteDevice('${devId}')" style="padding: 6px 12px; font-size: 0.8rem; margin-right: 10px;"><i class="fas fa-trash-alt"></i> Delete</button><i class="fas fa-cog path-config-icon" onclick="openPathSelector('${devId}_data', event)"></i></div>
                  </div>
                  <div class="toggle-switch-grid" id="grid-${devId}"></div>
                  <button class="pro-btn add-relay-btn" onclick="addNewRelay('${devId}')"><i class="fas fa-plus"></i> এই ডিভাইসে নতুন রিলে যোগ করুন</button>
              `;
              cont.appendChild(section);
          } else {
              const titleEl = document.getElementById(`title-${devId}`);
              const newName = (deviceMetadata[devId]?.name) || devId.replace('device', 'ডিভাইস ');
              if (titleEl && titleEl.textContent !== `${newName} কন্ট্রোল`) titleEl.textContent = `${newName} কন্ট্রোল`;
          }
          const grid = document.getElementById(`grid-${devId}`);
          const relays = devsData[devId];
          const sortedRels = Object.keys(relays).filter(k => k.startsWith('relay')).sort((a, b) => parseInt(a.replace('relay', '')) - parseInt(b.replace('relay', '')));
          sortedRels.forEach(relId => {
              const cardId = `card-${devId}-${relId}`;
              let card = document.getElementById(cardId);
              const state = relays[relId];
              const name = (relNames[devId]?.[relId]) || relId.replace('relay', 'রিলে ');
              const isOverridden = logicOverrides[devId] && logicOverrides[devId][relId];
              const linkedRules = getLinkedRules(devId, relId);
              let linkIconHtml = '';
              if (linkedRules.length > 0) {
                  const linksList = linkedRules.map(r => `<div>• ${r}</div>`).join('');
                  linkIconHtml = `<span class="linked-rule-indicator" onclick="toggleLinkDropdown(this, event)" title="লিঙ্কড রুলস"><i class="fas fa-link"></i><div class="linked-rule-dropdown">${linksList}</div></span>`;
              }
              if (!card) {
                  card = document.createElement('div');
                  card.className = `toggle-switch-container ${isOverridden ? 'manual-override' : ''}`;
                  card.id = cardId;
                  card.innerHTML = `
                      <div class="toggle-switch-header">
                          <span class="toggle-switch-label"><span class="relay-name-text">${name}</span><span class="link-icon-container">${linkIconHtml}</span><i class="fas fa-pencil-alt edit-relay-name-icon" onclick="editRelayName('${devId}','${relId}')"></i><i class="fas fa-trash-alt delete-icon" onclick="deleteRelay('${devId}','${relId}')"></i></span>
                          <div class="device-time-info"><span id="date-${devId}-${relId}"></span><span id="time-${devId}-${relId}"></span></div>
                      </div>
                      <div class="toggle-switch-body"><div class="timer-status" id="timer-status-${devId}-${relId}"></div></div>
                      <div class="toggle-switch-footer"><button class="pro-btn timer-btn" onclick="openTimerModal('${devId}','${relId}')">⏲️ টাইমার</button><label class="toggle-switch"><input type="checkbox" id="check-${devId}-${relId}" onchange="promptForRelayPassword('${devId}','${relId}',this)" ${state ? 'checked' : ''}><span class="slider"></span></label></div>
                      <i class="fas fa-hand-paper manual-override-indicator" id="override-${devId}-${relId}" style="display: ${isOverridden ? 'block' : 'none'};" onclick="clearManualOverride('${devId}', '${relId}')"></i>
                  `;
                  grid.appendChild(card);
              } else {
                  const checkbox = document.getElementById(`check-${devId}-${relId}`);
                  if (checkbox && checkbox.checked !== state) checkbox.checked = state;
                  const nameText = card.querySelector('.relay-name-text');
                  if (nameText && nameText.textContent !== name) nameText.textContent = name;
                  const linkContainer = card.querySelector('.link-icon-container');
                  if (linkContainer && linkContainer.innerHTML !== linkIconHtml) linkContainer.innerHTML = linkIconHtml;
                  const overrideIcon = document.getElementById(`override-${devId}-${relId}`);
                  if (isOverridden) { card.classList.add('manual-override'); if(overrideIcon) overrideIcon.style.display = 'block'; } else { card.classList.remove('manual-override'); if(overrideIcon) overrideIcon.style.display = 'none'; }
              }
          });
          Array.from(grid.children).forEach(child => {
              const childRelayId = child.id.split('-')[2];
              if (!relays.hasOwnProperty(childRelayId)) child.remove();
          });
      });
      updateAllTimerDisplays();
      updateAllDateTimeDisplays();
      applyUiHighlights();
  }
  
  document.addEventListener('click', function(event) {
      if (!event.target.closest('.linked-rule-indicator')) {
          document.querySelectorAll('.linked-rule-dropdown.show').forEach(d => d.classList.remove('show'));
      }
  });

  function deleteDevice(devId){promptForActionPassword('ডিভাইস মুছুন',`আপনি কি সত্যিই '${devId}' এবং এর সমস্ত রিলে মুছে ফেলতে চান?`,()=>{const updates={};updates[`${getPathFor('devices_root')}/${devId}`]=null;updates[`${getPathFor('device_metadata')}/${devId}`]=null;database.ref(getPathFor('timers')).orderByKey().startAt(devId).endAt(devId+'\uf8ff').once('value',snap=>{const timers=snap.val();if(timers)for(const key in timers)updates[`${getPathFor('timers')}/${key}`]=null;database.ref().update(updates).then(()=>logAuditEvent(`ডিভাইস '${devId}' মুছে ফেলেছেন।`));});});}
  function deleteRelay(devId,relId){const name=(relayNames[devId]?.[relId])||relId;promptForActionPassword('রিলে/লোড মুছুন',`আপনি কি সত্যিই '${name}' রিলে/লোডটি '${devId}' থেকে মুছে ফেলতে চান?`,()=>{const updates={};updates[`${getPathFor('devices_root')}/${devId}/${relId}`]=null;updates[`${getPathFor('device_metadata')}/${devId}/relay_names/${relId}`]=null;updates[`${getPathFor('timers')}/${devId}-${relId}`]=null;database.ref().update(updates).then(()=>logAuditEvent(`'${devId}' থেকে '${name}' মুছে ফেলেছেন।`));});}
  function addNewDevice(){const name=prompt("নতুন ডিভাইসের নাম দিন (যেমন: device5):");if(name&&name.trim()!==""){const devId=name.trim();if(currentDeviceStates[devId])return alert("এই নামের ডিভাইস আগে থেকেই আছে!");promptForActionPassword('নতুন ডিভাইস যোগ করুন',`আপনি কি '${devId}' নামে নতুন ডিভাইস যোগ করতে চান?`,()=>{const updates={};updates[`${getPathFor('devices_root')}/${devId}/relay1`]=false;updates[`${getPathFor('device_metadata')}/${devId}/relay_names/relay1`]="রিলে ১";updates[`${getPathFor('devices_root')}/${devId}/Load1`]=0;updates[`${getPathFor('device_metadata')}/${devId}/relay_names/Load1`]="লোড ১";database.ref().update(updates).then(()=>logAuditEvent(`নতুন ডিভাইস '${devId}' যোগ করেছেন।`));});}}
  function addNewRelay(devId){promptForActionPassword('নতুন রিলে যোগ করুন',`আপনি কি '${devId}' ডিভাইসে একটি নতুন রিলে যোগ করতে চান?`,()=>{const devData=currentDeviceStates[devId]||{};let maxNum=0;Object.keys(devData).forEach(k=>{if(k.startsWith('relay')){const num=parseInt(k.replace('relay',''));if(num>maxNum)maxNum=num;}});const newId=`relay${maxNum+1}`,newName=`রিলে ${maxNum+1}`;const updates={};updates[`${getPathFor('devices_root')}/${devId}/${newId}`]=false;updates[`${getPathFor('device_metadata')}/${devId}/relay_names/${newId}`]=newName;database.ref().update(updates).then(()=>logAuditEvent(`'${devId}' ডিভাইসে নতুন রিলে '${newName}' যোগ করেছেন।`));});}
  function addNewLoadToDevice(devId){promptForActionPassword('নতুন লোড যোগ করুন',`আপনি কি '${devId}' ডিভাইসে একটি নতুন লোড যোগ করতে চান?`,()=>{const devData=currentDeviceStates[devId]||{};let maxNum=0;Object.keys(devData).forEach(k=>{if(k.startsWith('Load')){const num=parseInt(k.replace('Load',''));if(!isNaN(num)&&num>maxNum)maxNum=num;}});const newNum=maxNum+1,newId=`Load${newNum}`,newName=`লোড ${newNum}`;const updates={};updates[`${getPathFor('devices_root')}/${devId}/${newId}`]=0;updates[`${getPathFor('device_metadata')}/${devId}/relay_names/${newId}`]=newName;database.ref().update(updates).then(()=>logAuditEvent(`'${devId}' ডিভাইসে নতুন লোড '${newName}' যোগ করেছেন।`));});}
  function toggleTabSorting(){isSortingLocked=!isSortingLocked;const btn=document.getElementById('toggle-sort-btn'),icon=btn.querySelector('i'),cont=document.getElementById('nav-tabs-container');if(isSortingLocked){icon.className='fas fa-lock';btn.childNodes[1].nodeValue=' সাজানো লক করুন';cont.classList.remove('tabs-unlocked');}else{icon.className='fas fa-lock-open';btn.childNodes[1].nodeValue=' সাজানো আনলক করুন';cont.classList.add('tabs-unlocked');}if(tabSortable)tabSortable.option('disabled',isSortingLocked);}
  function initTabSorting(){if(tabSortable)tabSortable.destroy();const cont=document.getElementById('nav-tabs-container');tabSortable=new Sortable(cont,{animation:150,ghostClass:'sortable-ghost',disabled:isSortingLocked,onEnd:saveTabOrder});}
  function saveTabOrder(){const order=Array.from(document.getElementById('nav-tabs-container').children).map(t=>t.dataset.tabId).filter(id=>id);const user=auth.currentUser;if(user&&order.length>0)database.ref(`ui_settings/${user.uid}/tabOrder`).set(order);}
  function loadAndApplyTabOrder(){const user=auth.currentUser,cont=document.getElementById('nav-tabs-container');const applyDefault=()=>{initTabSorting();const firstTab=cont.querySelector('.nav-tab');if(firstTab&&firstTab.dataset.tabId)showPage(firstTab.dataset.tabId);};if(!user)return applyDefault();database.ref(`ui_settings/${user.uid}/tabOrder`).once('value',snap=>{const order=snap.val();if(order&&Array.isArray(order)){const tabs={};Array.from(cont.children).forEach(t=>{if(t.dataset.tabId)tabs[t.dataset.tabId]=t;});order.forEach(id=>{if(tabs[id]){cont.appendChild(tabs[id]);delete tabs[id];}});for(const id in tabs)cont.appendChild(tabs[id]);}applyDefault();});}
  function renderTemperatureSensors(sensorsData,metadata){const cont=document.getElementById('temperature-sensors-container');if(!cont)return;cont.innerHTML='';const sortedIds=Object.keys(sensorsData||{}).sort((a,b)=>parseInt(a.replace('temperature',''))-parseInt(b.replace('temperature','')));if(sortedIds.length===0)return cont.innerHTML=`<p style="grid-column:1/-1;text-align:center;opacity:0.7;">কোনো তাপমাত্রা সেন্সর যোগ করা হয়নি।</p>`;sortedIds.forEach(id=>{const values=sensorsData[id],meta=metadata[id]||{name:id},cVal=values.celsius_value||0,fVal=values.fahrenheit_value||0;const cPercent=Math.min(Math.max((cVal-(-10))/(50-(-10)),0),1);const fPercent=Math.min(Math.max((fVal-20)/(140-20),0),1);const cOffset=226-(226*cPercent);const fOffset=226-(226*fPercent);const card=document.createElement('div');card.className='temp-sensor-card';card.innerHTML=`<div class="temp-card-header"><div class="temp-sensor-name"><i class="fas fa-microchip"></i> ${meta.name}</div><div class="card-actions"><i class="fas fa-pencil-alt" onclick="editTemperatureSensorName('${id}')"></i><i class="fas fa-trash-alt" onclick="deleteTemperatureSensor('${id}','${meta.name}')"></i></div></div><div class="temp-gauges-container" onclick="openTempHistoryModal('${id}','${meta.name}')" title="বিস্তারিত গ্রাফ দেখতে ক্লিক করুন"><div class="circular-progress"><svg><circle cx="50" cy="50" r="36" class="progress-bg"></circle><circle cx="50" cy="50" r="36" class="progress-bar celsius" id="gauge-c-${id}" style="stroke-dashoffset: ${cOffset};"></circle></svg><div class="gauge-value-text"><span class="val-main" id="val-c-${id}">${cVal.toFixed(1)}</span><span class="val-unit">°C</span></div><div class="gauge-label">CELSIUS</div></div><div class="circular-progress"><svg><circle cx="50" cy="50" r="36" class="progress-bg"></circle><circle cx="50" cy="50" r="36" class="progress-bar fahrenheit" id="gauge-f-${id}" style="stroke-dashoffset: ${fOffset};"></circle></svg><div class="gauge-value-text"><span class="val-main" id="val-f-${id}">${fVal.toFixed(1)}</span><span class="val-unit">°F</span></div><div class="gauge-label">FAHRENHEIT</div></div></div><div class="temp-mini-graph"><canvas id="mini-chart-${id}"></canvas></div>`;cont.appendChild(card);setTimeout(()=>initSensorHistoricalChart(id),0);});}
  function updateAllGauges(data){if(!data)return;for(const id in data){const vals=data[id],cVal=vals.celsius_value||0,fVal=vals.fahrenheit_value||0;const cText=document.getElementById(`val-c-${id}`),fText=document.getElementById(`val-f-${id}`);if(cText)cText.textContent=cVal.toFixed(1);if(fText)fText.textContent=fVal.toFixed(1);const cCircle=document.getElementById(`gauge-c-${id}`),fCircle=document.getElementById(`gauge-f-${id}`);if(cCircle){const cPercent=Math.min(Math.max((cVal-(-10))/(50-(-10)),0),1);cCircle.style.strokeDashoffset=226-(226*cPercent);}if(fCircle){const fPercent=Math.min(Math.max((fVal-20)/(140-20),0),1);fCircle.style.strokeDashoffset=226-(226*fPercent);}}}
  function addNewTemperatureSensor(){const name=prompt("নতুন সেন্সর গ্রুপের নাম দিন:");if(!name||name.trim()==='')return;promptForActionPassword('নতুন সেন্সর গ্রুপ যোগ করুন',`আপনি কি '${name}' নামে একটি নতুন সেন্সর গ্রুপ যোগ করতে চান?`,()=>{database.ref(getPathFor('devices_root')).once('value',snap=>{const devs=snap.val()||{};let maxNum=0;Object.keys(devs).forEach(k=>{if(k.startsWith('temperature')){const num=parseInt(k.replace('temperature',''),10);if(!isNaN(num)&&num>maxNum)maxNum=num;}});const newId=`temperature${maxNum+1}`;const updates={};updates[`${getPathFor('devices_root')}/${newId}/celsius_value`]=0;updates[`${getPathFor('devices_root')}/${newId}/fahrenheit_value`]=32;updates[`${getPathFor('device_metadata')}/${newId}/name`]=name.trim();database.ref().update(updates).then(()=>logAuditEvent(`নতুন তাপমাত্রা সেন্সর গ্রুপ '${name.trim()}' যোগ করেছেন।`));});});}
  function editTemperatureSensorName(id){const currentName=(deviceMetadata[id]&&deviceMetadata[id].name)||id;const newName=prompt("সেন্সরের নতুন নাম দিন:",currentName);if(newName&&newName.trim()!==""){const path=`${getPathFor('device_metadata')}/${id}/name`;database.ref(path).set(newName.trim()).then(()=>{showToast("সেন্সরের নাম সফলভাবে পরিবর্তন করা হয়েছে!","success");logAuditEvent(`তাপমাত্রা সেন্সর '${id}' এর নাম পরিবর্তন করে '${newName.trim()}' রাখা হয়েছে।`);}).catch((error)=>{console.error("Error updating name:",error);showToast("নাম পরিবর্তন করতে সমস্যা হয়েছে।","error");});}}
  function deleteTemperatureSensor(id,name){promptForActionPassword('সেন্সর গ্রুপ মুছুন',`আপনি কি সত্যিই '${name}' সেন্সর গ্রুপটি মুছে ফেলতে চান?`,()=>{const updates={};updates[`${getPathFor('devices_root')}/${id}`]=null;updates[`${getPathFor('device_metadata')}/${id}`]=null;database.ref().update(updates).then(()=>logAuditEvent(`তাপমাত্রা সেন্সর গ্রুপ '${name}' মুছে ফেলেছেন।`));});}
  function initSensorHistoricalChart(id){const canvas=document.getElementById(`mini-chart-${id}`);if(!canvas)return;if(sensorHistoricalCharts[id])sensorHistoricalCharts[id].destroy();const ctx=canvas.getContext('2d');const gradient=ctx.createLinearGradient(0,0,0,60);gradient.addColorStop(0,'rgba(46, 204, 113, 0.5)');gradient.addColorStop(1,'rgba(46, 204, 113, 0.0)');sensorHistoricalCharts[id]=new Chart(ctx,{type:'line',data:{labels:[],datasets:[{data:[],borderColor:'#2ecc71',backgroundColor:gradient,borderWidth:2,pointRadius:1,pointBackgroundColor:'#fff',fill:true,tension:0.4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{enabled:false}},scales:{x:{display:false},y:{display:true,position:'right',ticks:{color:'#9ca3af',font:{size:9},maxTicksLimit:3},grid:{color:'rgba(255,255,255,0.05)',drawBorder:false}}},layout:{padding:{left:0,right:5,top:5,bottom:0}},animation:{duration:800}}});}
  function updateLiveDataOnSensorChart(id,vals){const chart=sensorHistoricalCharts[id];const label=new Date().toLocaleTimeString('bn-BD');if(chart&&vals.celsius_value!==undefined){chart.data.labels.push(label);chart.data.datasets[0].data.push(vals.celsius_value);if(chart.data.labels.length>20){chart.data.labels.shift();chart.data.datasets[0].data.shift();}chart.update();}if(!tempSensorHistory[id]){tempSensorHistory[id]={labels:[],c:[],f:[]};}tempSensorHistory[id].labels.push(label);tempSensorHistory[id].c.push(vals.celsius_value);tempSensorHistory[id].f.push(vals.fahrenheit_value);if(tempSensorHistory[id].labels.length>50){tempSensorHistory[id].labels.shift();tempSensorHistory[id].c.shift();tempSensorHistory[id].f.shift();}if(largeTempChartInstance&&document.getElementById('tempHistoryModal').style.display==='flex'){}}
  function openTempHistoryModal(id,name){const modal=document.getElementById('tempHistoryModal');document.getElementById('temp-history-title').innerHTML=`<i class="fas fa-history"></i> ${name} - বিস্তারিত ইতিহাস`;modal.style.display='flex';const ctx=document.getElementById('largeTempChart').getContext('2d');if(largeTempChartInstance){largeTempChartInstance.destroy();}const history=tempSensorHistory[id]||{labels:[],c:[],f:[]};largeTempChartInstance=new Chart(ctx,{type:'line',data:{labels:history.labels,datasets:[{label:'সেলসিয়াস (°C)',data:history.c,borderColor:'#3b82f6',backgroundColor:'rgba(59, 130, 246, 0.1)',yAxisID:'y-c',tension:0.3,fill:true},{label:'ফারেনহাইট (°F)',data:history.f,borderColor:'#f97316',backgroundColor:'rgba(249, 115, 22, 0.1)',yAxisID:'y-f',tension:0.3,fill:true}]},options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false,},scales:{'y-c':{type:'linear',display:true,position:'left',title:{display:true,text:'Celsius (°C)',color:'#3b82f6'},grid:{color:'rgba(255,255,255,0.1)'}},'y-f':{type:'linear',display:true,position:'right',title:{display:true,text:'Fahrenheit (°F)',color:'#f97316'},grid:{drawOnChartArea:false}},x:{ticks:{color:'#9ca3af'},grid:{display:false}}},plugins:{legend:{labels:{color:'#fff'}},tooltip:{backgroundColor:'rgba(0,0,0,0.8)',titleColor:'#fff',bodyColor:'#fff'}}}});}
  function closeTempHistoryModal(){document.getElementById('tempHistoryModal').style.display='none';}
  function confirmDeleteAllLogs(){promptForActionPassword('সমস্ত লগ মুছে ফেলুন','আপনি কি নিশ্চিত যে আপনি অডিট লগের সমস্ত ইতিহাস মুছে ফেলতে চান? এটি ফিরিয়ে আনা যাবে না।',()=>{const logPath=getPathFor('audit_log');database.ref(logPath).remove().then(()=>{showToast('সমস্ত অডিট লগ সফলভাবে মুছে ফেলা হয়েছে!','success');logAuditEvent('অডিট লগের সমস্ত ইতিহাস মুছে ফেলা হয়েছে।');}).catch(error=>{showToast('লগ মুছতে সমস্যা হয়েছে: '+error.message,'error');});});}

  // --- NEW: DYNAMIC NOTES LOGIC ---
  function renderNotes(data) {
      const container = document.getElementById('notes-dynamic-container');
      container.innerHTML = '';
      
      const sortedKeys = Object.keys(data || {}).sort((a,b) => (data[a].order || 0) - (data[b].order || 0));
      
      sortedKeys.forEach(key => {
          const note = data[key];
          const div = document.createElement('div');
          div.className = 'note-block';
          div.dataset.id = key;
          
          let contentHtml = '';
          
          // Controls (Edit/Delete)
          const controls = `<div class="note-controls">
              <i class="fas fa-pencil-alt" onclick="editNote('${key}')" title="এডিট করুন"></i>
              <i class="fas fa-trash-alt" onclick="deleteNote('${key}')" title="মুছে ফেলুন"></i>
          </div>`;

          switch(note.type) {
              case 'text':
                  contentHtml = `<p class="note-paragraph">${note.content}</p>`;
                  break;
              case 'note_box':
                  contentHtml = `<div class="note-letter">
                      <div class="note-letter-title">${note.title || 'নোট'}</div>
                      <div class="note-letter-content">${note.content}</div>
                  </div>`;
                  break;
              case 'list':
                  const listItems = note.content.split('\n').map(item => `<li>${item}</li>`).join('');
                  contentHtml = `<h3 class="note-subtitle">${note.title}</h3><ul style="padding-left: 20px; line-height: 1.6;">${listItems}</ul>`;
                  break;
              case 'image':
                  contentHtml = `<div class="note-images">
                      <div class="note-image" onclick="openImageModal('${note.url}', '${note.caption}')">
                          <img src="${note.url}" alt="${note.caption}">
                          <div class="note-image-caption">${note.caption}</div>
                      </div>
                  </div>`;
                  break;
          }
          
          div.innerHTML = controls + contentHtml;
          container.appendChild(div);
      });
  }

  function openAddNoteModal() {
      editingNoteId = null;
      document.getElementById('note-modal-title').textContent = 'নতুন নোট যোগ করুন';
      document.getElementById('note-type').value = 'text';
      document.getElementById('note-title-input').value = '';
      document.getElementById('note-content-input').value = '';
      document.getElementById('note-image-url').value = '';
      document.getElementById('note-image-caption').value = '';
      handleNoteTypeChange();
      document.getElementById('noteEditorModal').style.display = 'flex';
  }

  function editNote(id) {
      editingNoteId = id;
      const note = currentNotes[id];
      if(!note) return;
      
      document.getElementById('note-modal-title').textContent = 'নোট এডিট করুন';
      document.getElementById('note-type').value = note.type;
      document.getElementById('note-title-input').value = note.title || '';
      document.getElementById('note-content-input').value = note.content || '';
      if(note.type === 'image') {
          document.getElementById('note-image-url').value = note.url || '';
          document.getElementById('note-image-caption').value = note.caption || '';
      }
      handleNoteTypeChange();
      document.getElementById('noteEditorModal').style.display = 'flex';
  }

  function saveNote() {
      const type = document.getElementById('note-type').value;
      const title = document.getElementById('note-title-input').value;
      const content = document.getElementById('note-content-input').value;
      
      const noteData = { type, title, content, order: Date.now() }; // Simple ordering by timestamp
      
      if(type === 'image') {
          noteData.url = document.getElementById('note-image-url').value;
          noteData.caption = document.getElementById('note-image-caption').value;
      }

      if(editingNoteId) {
          // Update
          database.ref(`${getPathFor('diagram_notes')}/${editingNoteId}`).update(noteData)
              .then(() => { closeNoteModal(); showToast('নোট আপডেট হয়েছে', 'success'); });
      } else {
          // Create
          database.ref(getPathFor('diagram_notes')).push(noteData)
              .then(() => { closeNoteModal(); showToast('নোট যোগ করা হয়েছে', 'success'); });
      }
  }

  function deleteNote(id) {
      promptForActionPassword('নোট মুছুন', 'আপনি কি নিশ্চিত এই নোটটি মুছে ফেলতে চান?', () => {
          database.ref(`${getPathFor('diagram_notes')}/${id}`).remove()
              .then(() => showToast('নোট মুছে ফেলা হয়েছে', 'success'));
      });
  }

  function closeNoteModal() {
      document.getElementById('noteEditorModal').style.display = 'none';
  }

  function handleNoteTypeChange() {
      const type = document.getElementById('note-type').value;
      const contentGroup = document.getElementById('note-content-group');
      const imageGroup = document.getElementById('note-image-group');
      const titleGroup = document.getElementById('note-title-group');

      if(type === 'image') {
          contentGroup.style.display = 'none';
          imageGroup.style.display = 'block';
          titleGroup.style.display = 'none';
      } else if (type === 'text') {
          contentGroup.style.display = 'block';
          imageGroup.style.display = 'none';
          titleGroup.style.display = 'none'; // Paragraph usually doesn't need title
      } else {
          contentGroup.style.display = 'block';
          imageGroup.style.display = 'none';
          titleGroup.style.display = 'block';
      }
  }
  
  document.getElementById('note-type').addEventListener('change', handleNoteTypeChange);

  // Initialize Default Data if Firebase is empty (One-time setup for user)
  function initializeDefaultNotes(existingData) {
      if(existingData && Object.keys(existingData).length > 0) return; // Already has data
      
      const defaults = [
          { type: 'text', content: 'এই পৃষ্ঠাটি আমাদের প্রকল্পের জন্য গুরুত্বপূর্ণ নোট এবং ডকুমেন্টেশন সংরক্ষণ করতে ব্যবহৃত হবে। এখানে আপনি প্রকল্পের বিভিন্ন ডায়াগ্রাম, নোট এবং গুরুত্বপূর্ণ তথ্য পাবেন যা প্রকল্পের উন্নয়ন এবং রক্ষণাবেক্ষণের জন্য প্রয়োজনীয়।', order: 1 },
          { type: 'note_box', title: 'গুরুত্বপূর্ণ নোট #1', content: 'প্রকল্পের সার্কিট ডায়াগ্রামটি নিচে দেওয়া হয়েছে। দয়া করে নিশ্চিত করুন যে সমস্ত সংযোগ সঠিকভাবে করা হয়েছে এবং প্রতিটি কম্পোনেন্ট সঠিকভাবে স্থাপন করা হয়েছে। সার্কিট ডায়াগ্রামে কোন পরিবর্তন প্রয়োজন হলে দয়া করে টিম লিডারকে জানান।', order: 2 },
          { type: 'image', url: 'electrical-single-line-diagram-4.jpg', caption: 'প্রকল্পের সার্কিট ডায়াগ্রাম', order: 3 },
          { type: 'image', url: '6005990.jpg', caption: 'সিস্টেম ফ্লো চার্ট', order: 4 },
          { type: 'list', title: 'প্রকল্পের মূল বৈশিষ্ট্য', content: 'রিয়েল-টাইম ডিভাইস মনিটরিং\nএনার্জি কনজাম্পশন ট্র্যাকিং\nরিমোট কন্ট্রোল সক্ষমতা\nডেটা ভিজুয়ালাইজেশন\nমাল্টি-ডিভাইস সাপোর্ট', order: 5 },
          { type: 'note_box', title: 'গুরুত্বপূর্ণ নোট #2', content: 'সিস্টেম আপডেটের সময় নিচের সতর্কতাগুলো মেনে চলুন:\n- আপডেট করার আগে ব্যাকআপ নিন\n- প্রোডাকশন সিস্টেমে সরাসরি আপডেট করবেন না\n- পরিবর্তন করার আগে টিমের সাথে আলোচনা করুন\n- সমস্ত পরিবর্তন ডকুমেন্ট করুন', order: 6 },
          { type: 'list', title: 'সিস্টেম আর্কিটেকচার', content: 'IoT ডিভাইস - ডাটা কালেকশন এবং একচুয়েশন\nক্লাউড সার্ভার - ডাটা প্রসেসিং এবং স্টোরেজ\nওয়েব ইন্টারফেস - ইউজার ইন্টারঅ্যাকশন', order: 7 },
          { type: 'image', url: 'https://i.ibb.co/5KJZ0Lm/system-architecture.jpg', caption: 'সিস্টেম আর্কিটেকচার ডায়াগ্রাম', order: 8 },
          { type: 'list', title: 'ভবিষ্যতের উন্নয়ন পরিকল্পনা', content: 'মোবাইল অ্যাপ্লিকেশন সংযোজন\nAI-ভিত্তিক এনার্জি অপ্টিমাইজেশন\nমাল্টি-ইউজার সাপোর্ট\nঅ্যাডভান্সড রিপোর্টিং সিস্টেম\nথার্ড-পার্টি ইন্টিগ্রেশন', order: 9 }
      ];
      
      const updates = {};
      defaults.forEach(note => {
          const newKey = database.ref(getPathFor('diagram_notes')).push().key;
          updates[`${getPathFor('diagram_notes')}/${newKey}`] = note;
      });
      database.ref().update(updates);
  }

  function detachAllListeners() {
      activeListeners.forEach(({ ref, eventType, callback }) => ref.off(eventType, callback));
      activeListeners = [];
  }
  
  function setupFirebaseListeners() {
    detachAllListeners();

    const addListener = (path, eventType, callback) => {
        if (!path) return;
        const ref = database.ref(path);
        ref.on(eventType, callback, (error) => {
            console.error(`Listener error on path: ${path}`, error);
            showToast(`Error reading path: ${path}`, 'error');
        });
        activeListeners.push({ ref, eventType, callback });
    };

    const componentConfig = {
        device1_data: (snapshot) => updateSingleDevicePage('device1', snapshot.val()),
        device2_data: (snapshot) => updateSingleDevicePage('device2', snapshot.val()),
        device3_data: (snapshot) => updateSingleDevicePage('device3', snapshot.val()),
        device4_data: (snapshot) => updateSingleDevicePage('device4', snapshot.val()),
        
        devices_root: (snapshot) => {
            previousDeviceStates = currentDeviceStates;
            const allDevices = snapshot.val() || {};
            const regularDevices = Object.keys(allDevices).filter(key => !key.startsWith('temperature')).reduce((obj, key) => ({ ...obj, [key]: allDevices[key] }), {});
            currentDeviceStates = regularDevices;
            renderControlPanel(regularDevices, relayNames);
            updateAutomationFormOptions();
            populateLogicGateSelectors();
            evaluateLogicGateRules();
            Object.keys(regularDevices).forEach(deviceId => {
                checkAutomationRules('device', {
                    deviceId: deviceId,
                    states: regularDevices[deviceId]
                });
            });
        },
        
        temperature_data: (snapshot) => {
            const allDevices = snapshot.val() || {};
            const temps = Object.keys(allDevices).filter(key => key.startsWith('temperature')).reduce((obj, key) => ({ ...obj, [key]: allDevices[key] }), {});
            currentTempData = temps;
            const container = document.getElementById('temperature-sensors-container');
            const isContainerEmpty = container && container.children.length === 0;
            const isSensorListChanged = JSON.stringify(Object.keys(sensorHistoricalCharts).sort()) !== JSON.stringify(Object.keys(temps).sort());
            if (isSensorListChanged || isContainerEmpty) {
                renderTemperatureSensors(temps, deviceMetadata);
            }
            updateAllGauges(temps);
            for (const id in temps) updateLiveDataOnSensorChart(id, temps[id]);
        },
        
        device_metadata: (snapshot) => {
            deviceMetadata = snapshot.val() || {};
            relayNames = {};
            for (const devId in deviceMetadata) {
                if (deviceMetadata[devId].relay_names) relayNames[devId] = deviceMetadata[devId].relay_names;
            }
            if (Object.keys(currentDeviceStates).length > 0) renderControlPanel(currentDeviceStates, relayNames);
            if (Object.keys(currentTempData).length > 0) renderTemperatureSensors(currentTempData, deviceMetadata);
        },
        
        energymonitoring_root: (snapshot) => {
            const data = snapshot.val();
            if (data) {
                updateEnergyData(data);
                checkAutomationRules('energy', data); 
            }
        },
        
        energymonitoring_history: (snapshot) => { 
            if(snapshot.val()) { 
                historicalData = { ...snapshot.val(), ...historicalData };
                if (document.getElementById('page6').classList.contains('active')) updateAdvancedChart(); 
            }
        },
        timers: (snapshot) => { allTimersData = snapshot.val() || {}; updateAllTimerDisplays(); },
        
        automation_rules: (snapshot) => {
            automationRules = snapshot.val() || {};
            const cont = document.getElementById('automation-rule-list');
            if(!cont) return; cont.innerHTML = Object.keys(automationRules).length === 0 ? '<p>কোনো অটোমেশন রুল তৈরি করা হয়নি।</p>' : '';
            for (const id in automationRules) {
                const r = automationRules[id];
                const card = document.createElement('div'); card.className = `rule-card ${r.isEnabled ? '' : 'disabled'}`;
                let desc = `<strong>${r.name}:</strong> `;
                if (r.triggerSource === 'energy') desc += `যদি <strong>${r.triggerMetric}</strong> এর মান <strong>${r.triggerCondition} ${r.triggerValue}</strong> হয়, `;
                else if (r.triggerSource === 'time') desc += `যদি সময় <strong>${r.triggerValue}</strong> হয়, `;
                else if (r.triggerSource === 'device') desc += `যদি <strong>${r.triggerDevice.replace('device', 'ডিভাইস ')}</strong> এর <strong>'${(relayNames[r.triggerDevice]?.[r.triggerRelay]) || r.triggerRelay}'</strong> <strong>${r.triggerState ? 'ON' : 'OFF'}</strong> হয়, `;
                desc += `তবে <strong>${r.actionDevice.replace('device', 'ডিভাইস ')}</strong> এর <strong>'${(relayNames[r.actionDevice]?.[r.actionRelay]) || r.actionRelay}'</strong> কে <strong>${r.actionState ? 'ON' : 'OFF'}</strong> করুন।`;
                if (r.sendNotification) desc += ` এবং একটি নোটিফিকেশন পাঠান।`;
                card.innerHTML = `<div class="rule-description">${desc}</div><div class="rule-actions"><button class="pro-btn rule-btn toggle-rule-btn ${r.isEnabled ? 'enabled' : 'disabled'}" onclick="toggleRule('${id}')">${r.isEnabled ? 'নিষ্ক্রিয়' : 'সক্রিয়'} করুন</button><button class="pro-btn rule-btn edit-btn" onclick="editAutomationRule('${id}')">এডিট</button><button class="pro-btn rule-btn delete-btn" onclick="deleteRule('${id}')">ডিলিট</button></div>`;
                cont.appendChild(card);
            }
            if(currentDeviceStates && Object.keys(currentDeviceStates).length > 0) renderControlPanel(currentDeviceStates, relayNames);
            ['device1', 'device2', 'device3', 'device4'].forEach(devId => {
                 if(document.getElementById(`page${devId.replace('device','')}`).classList.contains('active')) updateSingleDevicePage(devId, currentDeviceStates[devId]);
            });
        },
        
        logic_gate_rules: (snapshot) => { 
            logicGateRules = snapshot.val() || {}; 
            renderLogicGateRules();
            evaluateLogicGateRules(); 
            if(currentDeviceStates && Object.keys(currentDeviceStates).length > 0) renderControlPanel(currentDeviceStates, relayNames);
            ['device1', 'device2', 'device3', 'device4'].forEach(devId => {
                 if(document.getElementById(`page${devId.replace('device','')}`).classList.contains('active')) updateSingleDevicePage(devId, currentDeviceStates[devId]);
            });
        },
        
        logic_gate_overrides: (snapshot) => { logicOverrides = snapshot.val() || {}; },
        system_status: (snapshot) => {
            const d = snapshot.val(); if (!d) return;
            const updateStatus = (elemId, val, textConn, textDisc, indId) => {
                document.getElementById(elemId).textContent = val ? textConn : textDisc;
                document.getElementById(indId).className = `status-indicator ${val ? 'connected' : 'disconnected'}`;
            };
            updateStatus('status-wifi', d.wifi, 'কানেক্টেড', 'ডিসকানেক্টেড', 'indicator-wifi'); updateStatus('status-firebase', d.firebase, 'কানেক্টেড', 'ডিসকানেক্টেড', 'indicator-firebase'); updateStatus('status-mega', d.mega, 'কানেক্টেড', 'ডিসকানেক্টেড', 'indicator-mega'); updateStatus('status-sd-card', d.sd_card, 'উপস্থিত', 'অনুপস্থিত', 'indicator-sd-card');
            document.getElementById('status-uptime').textContent = d.uptime || '--';
            const ram = d.ram_usage || 0; document.getElementById('status-ram-usage').textContent = `${ram}%`; document.getElementById('ram-progress-fill').style.width = `${ram}%`;
        },
        scenes: (snapshot) => {
            const scenes = snapshot.val() || {}, cont = document.getElementById('scene-buttons-container'); if (!cont) return;
            cont.innerHTML = '<button class="pro-btn create-scene-btn" onclick="openSceneModal()"><i class="fas fa-plus"></i> নতুন দৃশ্য তৈরি করুন</button>';
            for (const id in scenes) {
                const s = scenes[id], item = document.createElement('div'); item.className = 'scene-item-container';
                item.innerHTML = `<button class="pro-btn scene-btn" onclick="executeScene('${id}', JSON.parse(decodeURIComponent('${encodeURIComponent(JSON.stringify(s.actions))}')), '${s.name}')">${s.name}</button><i class="fas fa-trash-alt delete-scene-icon" onclick="deleteScene('${id}', '${s.name}')"></i>`;
                cont.insertBefore(item, cont.querySelector('.create-scene-btn'));
            }
        },
        custom_pages: (snapshot) => { renderCustomPagesFromFirebase(snapshot.val() || {}); loadAndApplyTabOrder(); },
        
        // NEW LISTENER for Diagram Notes
        diagram_notes: (snapshot) => {
            const notes = snapshot.val();
            currentNotes = notes || {};
            if(!notes) {
                initializeDefaultNotes(notes);
            } else {
                renderNotes(notes);
            }
        }
    };
    
    Object.keys(componentConfig).forEach(componentId => {
        addListener(getPathFor(componentId), 'value', componentConfig[componentId]);
    });
    
    loadAuditLog();
}


  function loadAuditLog() {
    const logList=document.getElementById('audit-log-list');
    let allLogs=[],userLoaded=false,devLoaded=false;
    const render=()=>{if(!userLoaded||!devLoaded)return;allLogs.sort((a,b)=>b.timestamp-a.timestamp);logList.innerHTML='';if(allLogs.length===0)return logList.innerHTML='<p>কোনো লগ পাওয়া যায়নি...</p>';allLogs.forEach(l=>{const isSys=l.user==='সিস্টেম অটোমেশন'||l.source==='device'||l.user==='সিস্টেম (লজিক গেট)',item=document.createElement('div');item.className=`audit-log-item ${isSys?'system-log':''}`;const time=new Date(l.timestamp).toLocaleString('bn-BD');item.innerHTML=`<div class="audit-log-header"><span class="audit-log-user ${isSys?'audit-log-user-system':''}"><i class="fas ${isSys?'fa-cogs':'fa-user'}"></i> ${l.source==='device'?'ডিভাইস অ্যাক্টিভিটি':l.user}</span><span class="audit-log-timestamp">🕒 ${time}</span></div><div class="audit-log-action">${l.source==='device'?l.message:l.action}</div>`;logList.appendChild(item);});};
    database.ref(getPathFor('audit_log')).limitToLast(100).on('value', snap=>{allLogs=allLogs.filter(l=>l.source!=='user').concat(Object.values(snap.val()||{}).map(l=>({...l,source:'user'})));userLoaded=true;render();});
    database.ref(getPathFor('device_activity_log')).limitToLast(100).on('value', snap=>{allLogs=allLogs.filter(l=>l.source!=='device').concat(Object.values(snap.val()||{}).map(l=>({...l,source:'device'})));devLoaded=true;render();});
  }
  
  // Custom page functions...
  function openAddPageModal(){document.getElementById('addPageModal').style.display='flex';document.getElementById('new-page-name').focus();}
  function closeAddPageModal(){document.getElementById('addPageModal').style.display='none';document.getElementById('new-page-name').value='';document.getElementById('addPagePasswordInput').value='';document.getElementById('add-page-error').textContent='';}
  function saveNewPage(){const name=document.getElementById('new-page-name').value.trim(),pass=document.getElementById('addPagePasswordInput').value,err=document.getElementById('add-page-error');if(!name||!pass)return err.textContent='নাম এবং পাসওয়ার্ড দিন।';if(pass===correctOperatingPassword){const ref=database.ref(getPathFor('custom_pages')).push({name:name,components:[]});logAuditEvent(`নতুন কাস্টম পেজ '${name}' তৈরি করেছেন।`);closeAddPageModal();openPageEditorModal(ref.key,name,new Event('click'));}else{err.textContent='❌ ভুল অপারেটিং পাসওয়ার্ড!';}}
  function openPageEditorModal(id,name,e){if(e)e.stopPropagation();currentPageToEdit=id;document.getElementById('page-editor-title').textContent=`'${name}' পেজটি এডিট করুন`;database.ref(`${getPathFor('custom_pages')}/${id}/components`).once('value',snap=>{document.getElementById('page-editor-content').innerHTML=generateComponentSelectorHTML(snap.val()||[]);document.getElementById('pageEditorModal').style.display='flex';});}
  function closePageEditorModal(){document.getElementById('pageEditorModal').style.display='none';currentPageToEdit=null;}
  function generateComponentSelectorHTML(currComps=[]){let html='';const isChecked=comp=>currComps.some(c=>JSON.stringify(c)===JSON.stringify(comp));for(let i=1;i<=4;i++){const devId=`device${i}`;html+=`<div class="page-editor-group"><h4>ডিভাইস ${i}</h4><label><input type="checkbox" data-component='${JSON.stringify({type:'device_cards',deviceId:devId})}' ${isChecked({type:'device_cards',deviceId:devId})?'checked':''}> কন্ট্রোল কার্ড</label><label><input type="checkbox" data-component='${JSON.stringify({type:'device_summary',deviceId:devId})}' ${isChecked({type:'device_summary',deviceId:devId})?'checked':''}> স্ট্যাটাস সামারি</label></div>`;}html+=`<div class="page-editor-group"><h4>অন্যান্য</h4><label><input type="checkbox" data-component='${JSON.stringify({type:'control_panel'})}' ${isChecked({type:'control_panel'})?'checked':''}> কন্ট্রোল প্যানেল</label><label><input type="checkbox" data-component='${JSON.stringify({type:'scenes'})}' ${isChecked({type:'scenes'})?'checked':''}> দৃশ্য (Scenes)</label><label><input type="checkbox" data-component='${JSON.stringify({type:'system_status'})}' ${isChecked({type:'system_status'})?'checked':''}> সিস্টেম স্ট্যাটাস</label></div>`;return html;}
  function savePageComponents(){if(!currentPageToEdit)return;const comps=[];document.querySelectorAll('#pageEditorModal input:checked').forEach(cb=>comps.push(JSON.parse(cb.dataset.component)));database.ref(`${getPathFor('custom_pages')}/${currentPageToEdit}/components`).set(comps).then(()=>closePageEditorModal());}
  function deleteCustomPage(id,name,e){e.stopPropagation();promptForActionPassword('পেজ মুছুন',`আপনি কি সত্যিই '${name}' পেজটি মুছে ফেলতে চান?`,()=>database.ref(`${getPathFor('custom_pages')}/${id}`).remove().then(()=>showPage('page1'))); }
  function renderCustomPagesFromFirebase(pagesData){const navCont=document.getElementById('nav-tabs-container'),pagesCont=document.getElementById('dynamic-pages-container');document.querySelectorAll('.custom-page-tab, .custom-page').forEach(el=>el.remove());for(const id in pagesData){const page=pagesData[id],navTab=document.createElement('div');navTab.className='nav-tab custom-page-tab';navTab.onclick=()=>showPage(`custom_page_${id}`);navTab.dataset.tabId=`custom_page_${id}`;navTab.innerHTML=`<span>${page.name}</span><span class="page-actions"><i class="fas fa-pencil-alt" onclick="openPageEditorModal('${id}','${page.name}',event)"></i><i class="fas fa-trash-alt" onclick="deleteCustomPage('${id}','${page.name}',event)"></i></span>`;navCont.insertBefore(navTab,document.getElementById('add-new-page-btn'));const pageCont=document.createElement('main');pageCont.id=`custom_page_${id}`;pageCont.className='device-page custom-page';renderDynamicPageContent(pageCont,page.components||[]);pagesCont.appendChild(pageCont);}}
  function renderDynamicPageContent(cont,comps){cont.innerHTML=`<div class="dynamic-page-grid"></div>`;const grid=cont.querySelector('.dynamic-page-grid');comps.forEach(c=>{let el;switch(c.type){case'device_cards':el=document.querySelector(`#page${c.deviceId.replace('device','')} .device-cards`);break;case'device_summary':el=document.getElementById(`${c.deviceId}-summary`);break;case'control_panel':el=document.getElementById('page8');break;case'scenes':el=document.getElementById('page-component-scenes');break;case'system_status':el=document.getElementById('page-component-system-status');break;}if(el){const clone=el.cloneNode(true);clone.querySelectorAll('canvas').forEach(can=>{can.id=`clone_${can.id}_${cont.id}`;});grid.appendChild(clone);}});}

    let logicInputCount = 0;
    let logicOutputCount = 0;

    function initLogicGateInputs() {
        document.getElementById('logic-inputs-list').innerHTML = '';
        logicInputCount = 0;
        addLogicInput();
        addLogicInput();
        document.getElementById('logic-outputs-list').innerHTML = '';
        logicOutputCount = 0;
        addLogicOutput();
        populateLogicGateSelectors();
    }

    function addLogicInput() {
        logicInputCount++;
        const container = document.getElementById('logic-inputs-list');
        const inputGroup = document.createElement('div');
        inputGroup.className = 'logic-input-group';
        inputGroup.id = `logic-input-group-${logicInputCount}`;
        inputGroup.innerHTML = `
            <div class="form-group"><label>ইনপুট ${logicInputCount} ডিভাইস</label><select class="logic-input-device"></select></div>
            <div class="form-group"><label>ইনপুট ${logicInputCount} রিলে</label><select class="logic-input-relay"></select></div>
            <div class="form-group"><label>অবস্থা</label><select class="logic-input-state"><option value="true">ON</option><option value="false">OFF</option></select></div>
            <i class="fas fa-trash-alt delete-icon" onclick="removeLogicInput('logic-input-group-${logicInputCount}')"></i>
        `;
        container.appendChild(inputGroup);
        populateNewInputSelectors(inputGroup);
    }
    
    function addLogicOutput() {
        logicOutputCount++;
        const container = document.getElementById('logic-outputs-list');
        const outputGroup = document.createElement('div');
        outputGroup.className = 'logic-output-group';
        outputGroup.id = `logic-output-group-${logicOutputCount}`;
        outputGroup.innerHTML = `
            <div class="form-group"><label>আউটপুট ডিভাইস</label><select class="logic-output-device"></select></div>
            <div class="form-group"><label>আউটপুট রিলে</label><select class="logic-output-relay"></select></div>
            <div class="form-group"><label>অ্যাকশন</label><select class="logic-output-state"><option value="true">ON করুন</option><option value="false">OFF করুন</option></select></div>
            <i class="fas fa-trash-alt delete-icon" onclick="removeLogicOutput('logic-output-group-${logicOutputCount}')"></i>
        `;
        container.appendChild(outputGroup);
        populateNewOutputSelectors(outputGroup);
    }

    function removeLogicInput(groupId) {
        const container = document.getElementById('logic-inputs-list');
        if (container.children.length <= 2) { showToast("কমপক্ষে দুটি ইনপুট প্রয়োজন।", "warning"); return; }
        document.getElementById(groupId)?.remove();
    }
    
    function removeLogicOutput(groupId) {
        const container = document.getElementById('logic-outputs-list');
        if (container.children.length <= 1) { showToast("কমপক্ষে একটি আউটপুট প্রয়োজন।", "warning"); return; }
        document.getElementById(groupId)?.remove();
    }
    
    function populateNewInputSelectors(inputGroup) {
        const deviceSelect = inputGroup.querySelector('.logic-input-device');
        const relaySelect = inputGroup.querySelector('.logic-input-relay');
        const sortedDeviceIds = Object.keys(currentDeviceStates).sort((a, b) => parseInt(a.replace('device', '')) - parseInt(b.replace('device', '')));
        deviceSelect.innerHTML = sortedDeviceIds.map(id => `<option value="${id}">${(deviceMetadata[id]?.name) || id.replace('device', 'ডিভাইস ')}</option>`).join('');
        const updateRelays = () => {
            relaySelect.innerHTML = '';
            const selectedDeviceId = deviceSelect.value;
            if (currentDeviceStates[selectedDeviceId]) {
                const relays = Object.keys(currentDeviceStates[selectedDeviceId]).filter(key => key.startsWith('relay') || key.startsWith('Load')).sort((a,b) => parseInt(a.match(/\d+/)) - parseInt(b.match(/\d+/)));
                relays.forEach(relayId => { relaySelect.innerHTML += `<option value="${relayId}">${(relayNames[selectedDeviceId]?.[relayId]) || relayId}</option>`; });
            }
        };
        deviceSelect.onchange = updateRelays;
        updateRelays();
    }
    
    function populateNewOutputSelectors(outputGroup) {
        const deviceSelect = outputGroup.querySelector('.logic-output-device');
        const relaySelect = outputGroup.querySelector('.logic-output-relay');
        const sortedDeviceIds = Object.keys(currentDeviceStates).sort((a, b) => parseInt(a.replace('device', '')) - parseInt(b.replace('device', '')));
        deviceSelect.innerHTML = sortedDeviceIds.map(id => `<option value="${id}">${(deviceMetadata[id]?.name) || id.replace('device', 'ডিভাইস ')}</option>`).join('');
        const updateRelays = () => {
            relaySelect.innerHTML = '';
            const selectedDeviceId = deviceSelect.value;
            if (currentDeviceStates[selectedDeviceId]) {
                const relays = Object.keys(currentDeviceStates[selectedDeviceId]).filter(key => key.startsWith('relay') || key.startsWith('Load')).sort((a,b) => parseInt(a.match(/\d+/)) - parseInt(b.match(/\d+/)));
                relays.forEach(relayId => { relaySelect.innerHTML += `<option value="${relayId}">${(relayNames[selectedDeviceId]?.[relayId]) || relayId}</option>`; });
            }
        };
        deviceSelect.onchange = updateRelays;
        updateRelays();
    }

    function populateLogicGateSelectors() {
        document.querySelectorAll('.logic-input-group').forEach(group => populateNewInputSelectors(group));
        document.querySelectorAll('.logic-output-group').forEach(group => populateNewOutputSelectors(group));
    }
  
    function saveLogicGateRule(event) {
        event.preventDefault();
        const ruleName = document.getElementById('logic-rule-name').value;
        const inputs = [];
        document.querySelectorAll('.logic-input-group').forEach(group => {
            const dev = group.querySelector('.logic-input-device').value;
            const rel = group.querySelector('.logic-input-relay').value;
            const state = group.querySelector('.logic-input-state').value === 'true';
            if(dev && rel) inputs.push({ device: dev, relay: rel, state: state });
        });
        const gateType = document.getElementById('logic-gate-type').value;
        const outputs = [];
        document.querySelectorAll('.logic-output-group').forEach(group => {
            const dev = group.querySelector('.logic-output-device').value;
            const rel = group.querySelector('.logic-output-relay').value;
            const state = group.querySelector('.logic-output-state').value === 'true';
            if(dev && rel) outputs.push({ device: dev, relay: rel, state: state });
        });
        if (!ruleName || inputs.length < 2 || outputs.length < 1) { return showToast("অনুগ্রহ করে সমস্ত ফিল্ড পূরণ করুন।", "error"); }
        for(let output of outputs) {
            if (inputs.some(inp => inp.device === output.device && inp.relay === output.relay)) return showToast(`আউটপুট রিলে (${output.relay}) ইনপুট রিলের সমান হতে পারে না।`, "error");
        }
        const rule = { name: ruleName, inputs: inputs, gate: gateType, outputs: outputs, isEnabled: true };
        const isEdit = editingLogicRuleId !== null;
        const actionTitle = isEdit ? 'রুল আপডেট করুন' : 'রুল সংরক্ষণ করুন';
        const actionDesc = isEdit ? `আপনি কি "${ruleName}" রুলটি আপডেট করতে চান?` : `আপনি কি "${ruleName}" রুলটি সংরক্ষণ করতে চান?`;
        promptForActionPassword(actionTitle, actionDesc, () => {
            if (isEdit) {
                database.ref(`${getPathFor('logic_gate_rules')}/${editingLogicRuleId}`).update(rule)
                .then(() => { showToast('লজিক গেট রুল সফলভাবে আপডেট হয়েছে!', 'success'); logAuditEvent(`লজিক গেট রুল '${rule.name}' আপডেট করেছেন।`); cancelEditLogicGate(); });
            } else {
                database.ref(getPathFor('logic_gate_rules')).push(rule)
                .then(() => { showToast('লজিক গেট রুল সফলভাবে সংরক্ষিত হয়েছে!', 'success'); logAuditEvent(`নতুন লজিক গেট রুল '${rule.name}' তৈরি করেছেন।`); cancelEditLogicGate(); });
            }
        });
    }

    function editLogicGateRule(id) {
        const rule = logicGateRules[id];
        if (!rule) return;
        editingLogicRuleId = id;
        document.getElementById('logic-rule-name').value = rule.name;
        document.getElementById('logic-inputs-list').innerHTML = '';
        logicInputCount = 0;
        rule.inputs.forEach((input, index) => {
            addLogicInput();
            const inputGroups = document.querySelectorAll('.logic-input-group');
            const group = inputGroups[inputGroups.length - 1];
            group.querySelector('.logic-input-device').value = input.device;
            const deviceSelect = group.querySelector('.logic-input-device');
            deviceSelect.dispatchEvent(new Event('change'));
            setTimeout(() => {
                 group.querySelector('.logic-input-relay').value = input.relay;
                 group.querySelector('.logic-input-state').value = input.state ? 'true' : 'false';
            }, 50);
        });
        document.getElementById('logic-gate-type').value = rule.gate;
        document.getElementById('logic-outputs-list').innerHTML = '';
        logicOutputCount = 0;
        const ruleOutputs = rule.outputs || (rule.output ? [rule.output] : []);
        ruleOutputs.forEach((output, index) => {
            addLogicOutput();
            const outputGroups = document.querySelectorAll('.logic-output-group');
            const group = outputGroups[outputGroups.length - 1];
            group.querySelector('.logic-output-device').value = output.device;
            const deviceSelect = group.querySelector('.logic-output-device');
            deviceSelect.dispatchEvent(new Event('change'));
            setTimeout(() => {
                 group.querySelector('.logic-output-relay').value = output.relay;
                 group.querySelector('.logic-output-state').value = output.state ? 'true' : 'false';
            }, 50);
        });
        const submitBtn = document.querySelector('#logic-gate-form button[type="submit"]');
        submitBtn.textContent = '🔄 আপডেট করুন';
        document.getElementById('cancel-logic-edit-btn').style.display = 'block';
        document.querySelector('.logic-equation-builder').scrollIntoView({behavior: 'smooth'});
    }

    function cancelEditLogicGate() {
        editingLogicRuleId = null;
        document.getElementById('logic-gate-form').reset();
        initLogicGateInputs();
        const submitBtn = document.querySelector('#logic-gate-form button[type="submit"]');
        submitBtn.textContent = '💾 রুল সংরক্ষণ করুন';
        document.getElementById('cancel-logic-edit-btn').style.display = 'none';
    }

    function renderLogicGateRules() {
        const listContainer = document.getElementById('logic-gate-rule-list');
        if (!listContainer) return;
        listContainer.innerHTML = Object.keys(logicGateRules).length === 0 ? '<p>কোনো ইন্টারলক রুল এখনো তৈরি করা হয়নি।</p>' : '';
        for (const ruleId in logicGateRules) {
            const rule = logicGateRules[ruleId];
            if (!rule.inputs) continue;
            const getRelayName = (device, relay) => (relayNames[device]?.[relay]) || relay;
            const inputsStr = rule.inputs.map(inp => `<strong>${getRelayName(inp.device, inp.relay)} IS ${inp.state ? 'ON' : 'OFF'}</strong>`).join(` ${rule.gate} `);
            const ruleOutputs = rule.outputs || (rule.output ? [rule.output] : []);
            const outputsStr = ruleOutputs.map(out => `SET <strong>${getRelayName(out.device, out.relay)}</strong> TO <strong>${out.state ? 'ON' : 'OFF'}</strong>`).join(' AND ');
            const description = `<strong>${rule.name}:</strong> IF (${inputsStr}) THEN ${outputsStr}`;
            const card = document.createElement('div');
            card.className = `rule-card ${rule.isEnabled ? '' : 'disabled'}`;
            card.innerHTML = `<div class="rule-description">${description}</div><div class="rule-actions"><button class="pro-btn rule-btn toggle-rule-btn ${rule.isEnabled ? 'enabled' : 'disabled'}" onclick="toggleLogicGateRule('${ruleId}')">${rule.isEnabled ? 'নিষ্ক্রিয় করুন' : 'সক্রিয় করুন'}</button><button class="pro-btn rule-btn edit-btn" onclick="editLogicGateRule('${ruleId}')">এডিট</button><button class="pro-btn rule-btn delete-btn" onclick="deleteLogicGateRule('${ruleId}')">ডিলিট</button></div>`;
            listContainer.appendChild(card);
        }
    }

    function toggleLogicGateRule(id) { const newState = !logicGateRules[id].isEnabled; database.ref(`${getPathFor('logic_gate_rules')}/${id}/isEnabled`).set(newState); }
    function deleteLogicGateRule(id) { const name = logicGateRules[id].name; promptForActionPassword('লজিক গেট রুল মুছুন', `আপনি কি "${name}" রুলটি মুছে ফেলতে চান?`, () => database.ref(`${getPathFor('logic_gate_rules')}/${id}`).remove()); }

    function evaluateLogicGateRules() {
        const updates = {};
        const overridesToRemove = {};
        for (const ruleId in logicGateRules) {
            const rule = logicGateRules[ruleId];
            if (!rule.isEnabled || !rule.inputs || rule.inputs.length < 2) continue;
            const inputStates = rule.inputs.map(inp => {
                const deviceData = currentDeviceStates[inp.device];
                const relayState = deviceData ? deviceData[inp.relay] : false;
                return (!!relayState) === inp.state;
            });
            let logicResult = false;
            switch (rule.gate) {
                case 'AND': logicResult = inputStates.every(s => s); break;
                case 'OR':  logicResult = inputStates.some(s => s); break;
                case 'NAND':logicResult = !inputStates.every(s => s); break;
                case 'NOR': logicResult = !inputStates.some(s => s); break;
                case 'XOR': logicResult = inputStates.filter(s => s).length % 2 !== 0; break;
                case 'XNOR':logicResult = inputStates.filter(s => s).length % 2 === 0; break;
            }
            const outputs = rule.outputs || (rule.output ? [rule.output] : []);
            outputs.forEach(output => {
                const { device: outDevice, relay: outRelay, state: outState } = output;
                if (logicOverrides[outDevice] && logicOverrides[outDevice][outRelay]) return; 
                const targetState = logicResult ? outState : !outState;
                const currentStateOut = !!currentDeviceStates[outDevice]?.[outRelay];
                if (targetState !== currentStateOut) {
                    const path = `${getPathFor('devices_root')}/${outDevice}/${outRelay}`;
                    updates[path] = targetState;
                }
            });
        }
        if (logicOverrides) {
            for (const devId in logicOverrides) {
                for (const relId in logicOverrides[devId]) {
                    if (!isTargetOfActiveLogicRule(devId, relId)) overridesToRemove[`logic_gate_overrides/${devId}/${relId}`] = null;
                }
            }
        }
        if (Object.keys(updates).length > 0) database.ref().update(updates);
        if (Object.keys(overridesToRemove).length > 0) database.ref().update(overridesToRemove);
    }

  // Event Listeners
  function handleLoginKeyPress(e){if(e.key==="Enter"){if(document.getElementById('login-box').style.display!=='none')loginWithFirebase();else registerWithFirebase();}}
  ['email','password','register-username','register-email','register-password','confirm-password'].forEach(id=>document.getElementById(id).addEventListener("keypress",handleLoginKeyPress));
  document.getElementById("relayPasswordInput").addEventListener("keypress",e=>{if(e.key==="Enter")verifyAndOperateRelay();});
  document.getElementById("timerPasswordInput").addEventListener("keypress",e=>{if(e.key==="Enter")saveTimerSettings();});
  document.getElementById("actionPasswordInput").addEventListener("keypress",e=>{if(e.key==="Enter")verifyAndExecuteAction();});
  document.getElementById("addPagePasswordInput").addEventListener("keypress",e=>{if(e.key==="Enter")saveNewPage();});
  document.getElementById("regSecurityInput").addEventListener("keypress",e=>{if(e.key==="Enter")checkRegistrationSecurity();});
  document.getElementById('action-device').addEventListener('change',()=>populateRelayDropdown(document.getElementById('action-device'), document.getElementById('action-relay')));
  
  const navContainer = document.getElementById('nav-tabs-container');
  navContainer.addEventListener('wheel', (evt) => {
    evt.preventDefault();
    navContainer.scrollLeft += evt.deltaY;
  });

  window.onload = function() { createParticles(); };
</script>
</body>
</html>
