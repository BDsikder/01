  <!-- {{{{{{{{{v19.6 index.html}}}}}}}}}

অবশ্যই! আপনার অনুরোধটি আমি বুঝতে পেরেছি। আপনি দুটি অ্যানালগ এবং দুটি ডিজিটাল মিটার সহ একটি নতুন তাপমাত্রা পর্যবেক্ষণ পৃষ্ঠা চেয়েছিলেন এবং অ্যানালগ ডিসপ্লের ডিজাইনটি আপনার সরবরাহ করা ছবির মতো হতে হবে।

আমি আপনার জন্য সেই অনুযায়ী একটি সম্পূর্ণ নতুন এবং উন্নত "তাপমাত্রা মনিটর" পৃষ্ঠা তৈরি করেছি। এই পৃষ্ঠাটিতে আপনার দেওয়া ছবির মতো দেখতে দুটি প্রফেশনাল অ্যানালগ গজ রয়েছে—একটি সেলসিয়াস এবং অন্যটি ফারেনহাইট এককের জন্য। প্রতিটির পাশেই তাদের ডিজিটাল মান প্রদর্শনের জন্য কার্ড রয়েছে।

### মূল পরিবর্তন এবং নতুন সংযোজন:

1.  **দুটি নতুন প্রফেশনাল অ্যানালগ গজ:**
    *   আপনার সরবরাহ করা ছবির অনুপ্রেরণায়, দুটি অত্যন্ত আকর্ষণীয় এবং বাস্তবসম্মত অ্যানালগ গজ তৈরি করা হয়েছে। এগুলি সাধারণ চার্টের পরিবর্তে পুরোপুরি CSS এবং JavaScript দিয়ে তৈরি, যা ডিজাইনের উপর সম্পূর্ণ নিয়ন্ত্রণ দেয়।
    *   **সেলসিয়াস গজ:** এটি সেলসিয়াস (°C) এককে তাপমাত্রা দেখাবে।
    *   **ফারেনহাইট গজ:** এটি ফারেনহাইট (°F) এককে তাপমাত্রা দেখাবে, ঠিক আপনার ছবির মতো।
    *   প্রতিটি গজের স্কেল, নম্বর এবং রঙিন দাগগুলো (ঠান্ডা, উষ্ণ, গরম) নির্ভুলভাবে বসানো হয়েছে।

2.  **দুটি ডিজিটাল ডিসপ্লে:**
    *   প্রতিটি অ্যানালগ গজের পাশে দুটি করে মোট চারটি ডিজিটাল কার্ড রয়েছে, যা সেলসিয়াস এবং ফারেনহাইট উভয় এককের মান স্পষ্টভাবে প্রদর্শন করে।

3.  **সরাসরি ফায়ারবেস সংযোগ:**
    *   এই সম্পূর্ণ সিস্টেমটি আপনার ফায়ারবেসের `devices/device1/Temperature1` পাথের সাথে সংযুক্ত।
    *   যখন ফায়ারবেসে `celsius` বা `fahrenheit` এর মান পরিবর্তন হবে, তখন উভয় অ্যানালগ গজের কাঁটা এবং ডিজিটাল ডিসপ্লেগুলো রিয়েল-টাইমে আপডেট হবে।

এই নতুন ডিজাইনটি আপনার ড্যাশবোর্ডকে আরও প্রফেশনাল এবং কার্যকরী করে তুলবে।

### সম্পূর্ণ এবং চূড়ান্ত HTML কোড:

আপনাকে শুধু নিচের সম্পূর্ণ কোডটি কপি করে আপনার `index.html` ফাইলে প্রতিস্থাপন করতে হবে। আমি নতুন পেজ, স্টাইল এবং জাভাস্ক্রিপ্ট ফাংশন সহ প্রয়োজনীয় সমস্ত পরিবর্তন করে দিয়েছি।

```html -->


<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BISNU IoT ডিভাইস কন্ট্রোল প্যানেল</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- ★★★ নতুন: ড্র্যাগ-এন্ড-ড্রপ সুবিধার জন্য SortableJS লাইব্রেরি যোগ করা হয়েছে ★★★ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Titillium+Web:wght@300;400;600;700&display=swap" rel="stylesheet">
  <!-- Font Awesome আইকন যোগ করা হয়েছে -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* --- CSS ভ্যারিয়েবল সংজ্ঞা --- */
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --accent-color: #e74c3c;
      --light-color: #ecf0f1;
      --dark-color: #2c3e50;
      --success-color: #2ecc71;
      --warning-color: #f39c12;
      --info-color: #1abc9c;
      --energy-color: #9b59b6;
      --voltage-color: #e67e22;
      --current-color: #1abc9c;
      --power-color: #3498db;
      --background-btn-color: #8e44ad; /* নতুন ব্যাকগ্রাউন্ড বাটনের জন্য রঙ */
      --sort-lock-color: #8e44ad; /* ★★★ নতুন: সাজানো লক বাটনের জন্য রঙ ★★★ */
      /* কার্ড এবং নেভিগেশনের জন্য গ্লাস-এর মতো এফেক্ট */
      --card-bg: rgba(44, 62, 80, 0.65);
      --nav-bg: rgba(44, 62, 80, 0.5);
      --login-bg: rgba(13, 29, 47, 0.9);
      --text-color: #ecf0f1;
    }

    /* --- লাইট থিম ভ্যারিয়েবল --- */
    .light-theme {
      --primary-color: #3498db;
      --secondary-color: #2980b9;
      --accent-color: #e74c3c;
      --light-color: #f5f5f5;
      --dark-color: #ffffff;
      --success-color: #27ae60;
      --warning-color: #f39c12;
      --info-color: #16a085;
      --energy-color: #8e44ad;
      --voltage-color: #d35400;
      --current-color: #16a085;
      --power-color: #2980b9;
      --card-bg: rgba(255, 255, 255, 0.7);
      --text-color: #2c3e50;
      --nav-bg: rgba(255, 255, 255, 0.6);
      --login-bg: rgba(255, 255, 255, 0.85);
    }
    
    /* --- বেসিক বডি স্টাইল এবং ডাইনামিক ব্যাকগ্রাউন্ড --- */
    body {
      font-family: 'Titillium Web', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      color: var(--text-color);
      transition: background-color 0.5s ease;
      overflow-x: hidden; /* সাইড স্ক্রলিং প্রতিরোধ */
    }

    /* অ্যাপ্লিকেশনের মূল ব্যাকগ্রাউন্ডের জন্য একটি আলাদা লেয়ার তৈরি করা হয়েছে */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      height: 100%;
      width: 100%;
      z-index: -1;
      background-size: cover;
      background-position: center;
      transition: background-image 1s ease-in-out, opacity 1s ease-in-out; /* মসৃণ ট্রানজিশন */
      background-color: #111827; /* ইমেজ লোড হওয়ার আগে ফলব্যাক রঙ */
    }

    /* --- ব্যাকগ্রাউন্ড অ্যানিমেশন এবং ইমেজ ক্লাস --- */
    @keyframes colorfulBackground {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    /* ডিফল্ট অ্যানিমেটেড ব্যাকগ্রাউন্ড */
    body.bg-0::before {
      background-image: none;
      background-color: transparent;
      background: linear-gradient(135deg, #1f2937, #111827, #374151, #4f46e5, #7c3aed);
      background-size: 500% 500%;
      animation: colorfulBackground 25s ease infinite;
    }


     /* ১০টি ভিন্ন ব্যাকগ্রাউন্ড ইমেজের জন্য ক্লাস */

    body.bg-1::before { background-image: url('1background image.jpg'); }
    body.bg-2::before { background-image: url('2background image.jpg'); }
    body.bg-3::before { background-image: url('3background image.jpg'); }
    body.bg-4::before { background-image: url('4background image.jpg'); }
    body.bg-5::before { background-image: url('5background image.jpg'); }
    body.bg-6::before { background-image: url('6background image.jpg'); }
    body.bg-7::before { background-image: url('7background image.jpg'); }
    body.bg-8::before { background-image: url('8background image.jpg'); }
    body.bg-9::before { background-image: url('9background image.jpg'); }
    body.bg-10::before { background-image: url('10background image.jpg'); }
    
    /* --- লগইন স্ক্রিনের স্টাইল --- */
    .login-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      flex-direction: column;
      overflow: hidden;
      background-color: #111827;
    }
    
    /* লগইন স্ক্রিনের জন্য একটি নির্দিষ্ট ব্যাকগ্রাউন্ড ইমেজ লেয়ার */
    .login-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: url('Login image.jpg');
      background-size: cover;
      background-position: center;
      filter: blur(5px) brightness(0.6);
      z-index: -1;
    }
    
    .login-particles {
      position: absolute;
      width: 100%;
      height: 100%;
      z-index: -1;
    }
    
    .particle {
      position: absolute;
      background: rgba(255, 255, 255, 0.5);
      border-radius: 50%;
      animation: float 15s infinite linear;
    }
    
    @keyframes float {
      0% { transform: translateY(0) rotate(0deg); opacity: 1; }
      100% { transform: translateY(-1000px) rotate(720deg); opacity: 0; }
    }
    
    /* --- লোগো কন্টেইনার স্টাইল --- */
    .login-logo-container {
      position: relative;
      width: 180px;
      height: 180px;
      margin-bottom: 30px;
      perspective: 1000px;
    }
    .login-logo {
      width: 100%;
      height: 100%;
      object-fit: contain;
      animation: 20000ms linear -221.503ms infinite normal none running rotate, 0s ease-in-out infinite normal none running pulse;
      filter: drop-shadow(0 0 15px rgba(52, 152, 219, 0.7));
    }
    
    /* লোগোর চারপাশের রিং অ্যানিমেশন */
    .login-logo-ring {
      position: absolute;
      top: -10px; left: -10px; right: -10px; bottom: -10px;
      border: 5px solid transparent;
      border-top-color: var(--secondary-color);
      border-radius: 50%;
      animation: spin 3s linear infinite;
      z-index: -1;
    }
    .login-logo-ring:nth-child(2) {
      border-top-color: var(--accent-color);
      animation-duration: 4s;
      animation-direction: reverse;
    }
    .login-logo-ring:nth-child(3) {
      border-top-color: var(--success-color);
      animation-duration: 5s;
    }
    
    /* অ্যানিমেশন কীফ্রেম */
    @keyframes rotate-logo { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

    /* --- RGB বর্ডারসহ লগইন ও রেজিস্ট্রেশন বক্স --- */
    .login-box, .registration-box {
      font-weight: 200;
      position: relative;
      width: 520px;
      padding: 4px;
      border-radius: 22px;
      box-shadow: 4px 7px 20px 1px rgb(0 0 0);
      animation: fadeIn 0.8s ease-in-out, slideUp 0.8s ease-in-out;
      overflow: hidden;
      background: #00000000;
      backdrop-filter: blur(15px);
    }
    /* ★★★ নতুন: রেজিস্ট্রেশন বক্স ডিফল্টভাবে লুকানো থাকবে ★★★ */
    .registration-box {
        display: none;
    }

    /* লগইন বক্সের RGB বর্ডার অ্যানিমেশন */
    .login-box::before, .registration-box::before {
      content: '';
      position: absolute;
      top: -60%;
      left: -50%;
      width: 200%;
      height: 260%;
      z-index: 1;
      background: conic-gradient(from 180deg at 50% 50%, #ff00d4, #0000ff, #00ffff, #00ff00, #ffff00, #ff8c00, #ff0000, #ff00d4);
      animation: rotate-rgb 3s linear infinite;
    }

    .login-box-inner {
    background: rgb(0 0 0);
    border-radius: 18px;
    padding: 1.5rem;
    position: relative;
    z-index: 2;
    text-align: center;
    }
    
    /* বিভিন্ন অ্যানিমেশন */
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    @keyframes slideUp { from { transform: translateY(50px); } to { transform: translateY(0); } }
    @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    @keyframes rotate-rgb { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    
    .login-box h2, .registration-box h2 {
      margin-top: 0;
      margin-bottom: 1.5rem;
      color: var(--text-color);
      font-weight: 600;
      font-size: 1.8rem;
      text-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    .input-group {
      margin-bottom: 1.5rem;
      position: relative;
    }
    
    .input-group input {
      width: 88%;
      padding: 15px 20px;
      border: 1.1px solid rgb(2 0 255);
      border-radius: 50px;
      background: rgba(0, 0, 0, 0.2);
      color: var(--text-color);
      font-size: 16px;
      transition: all 0.3s ease;
    }
    .input-group input:focus {
      outline: none;
      background: rgba(255, 255, 255, 0.15);
      border-left: 3px solid #ff0000;
      box-shadow: 3px 3px 10px rgb(255 0 0 / 88%);
    }
    
    /* লগইন ও রেজিস্ট্রেশন বাটনের উন্নত ডিজাইন */
    .action-btn {
      background: linear-gradient(135deg, var(--secondary-color) 0%, var(--primary-color) 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 50px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s ease;
      width: 100%;
      box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
      position: relative;
      overflow: hidden;
    }

    .action-btn:hover {
      transform: translateY(-5px) scale(1.02);
      box-shadow: 0 10px 25px rgba(223, 0, 0, 0.6);
    }
    .action-btn:active {
      transform: translateY(0) scale(1);
    }
    
    .error-message {
      color: var(--accent-color);
      margin-top: 1rem;
      font-size: 14px;
      height: 20px;
      text-shadow: 0 0 5px var(--accent-color);
    }
    
    /* --- ★★★ লগইন বক্সের ভাইব্রেশন অ্যানিমেশন ★★★ --- */
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      20%, 60% { transform: translateX(-5px); }
      40%, 80% { transform: translateX(5px); }
    }
    
    .shake-animation {
        animation: shake 0.5s ease-in-out;
    }
    
    /* ★★★ নতুন: ফর্ম পরিবর্তন করার লিঙ্কের জন্য স্টাইল ★★★ */
    .form-switcher {
        margin-top: 1.5rem;
        font-size: 14px;
        color: var(--text-color);
    }
    .form-switcher a {
        color: var(--secondary-color);
        text-decoration: none;
        font-weight: 600;
        cursor: pointer;
    }
    .form-switcher a:hover {
        text-decoration: underline;
    }


    /* --- মূল অ্যাপ্লিকেশন স্টাইল --- */
    #app {
      display: none;
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .dashboard-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 2rem;
      padding: 1rem;
      background: var(--card-bg);
      border-radius: 15px;
      border: 1px solid rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
      animation: fadeIn 1s ease-in-out;
    }
    
    .app-logo-container {
      position: relative;
      width: 100px;
      height: 100px;
      margin-bottom: 15px;
    }
    .app-logo {
      width: 100%;
      height: 100%;
      object-fit: contain;
      animation: 20000ms linear -221.503ms infinite normal none running rotate, 0s ease-in-out infinite normal none running pulse;
      filter: drop-shadow(0 0 15px rgba(52, 152, 219, 0.7));
    }
    .app-logo-ring {
      position: absolute;
      top: -5px; left: -5px; right: -5px; bottom: -5px;
      border: 3px solid transparent;
      border-top-color: var(--secondary-color);
      border-radius: 50%;
      animation: spin 3s linear infinite;
    }
    .app-logo-ring:nth-child(2) { border-top-color: var(--accent-color); animation-duration: 4s; animation-direction: reverse; }
    .app-logo-ring:nth-child(3) { border-top-color: var(--success-color); animation-duration: 5s; }

    @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    .dashboard-title {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text-color);
      text-align: center;
      text-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }

    .header-controls {
      display: flex;
      gap: 15px;
      align-items: center;
      margin-top: 15px;
    }
    
    /* --- সকল বাটনের জন্য একটি সাধারণ ক্লাস এবং উন্নত ডিজাইন --- */
    .pro-btn {
      color: white;
      border: none;
      padding: 10px 22px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      border: 1px solid rgba(255,255,255,0.1);
    }
    .pro-btn:hover {
      transform: translateY(-3px) scale(1.03);
      box-shadow: 0 7px 20px rgba(0,0,0,0.3);
    }
    .pro-btn:active {
      transform: translateY(0) scale(1);
    }
    /* ★★★ নতুন: নোটিফিকেশন বাটনের জন্য বিশেষ স্টাইল ★★★ */
    .pro-btn:disabled {
        background: #555;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }


    /* বিভিন্ন বাটনের জন্য রঙ */
    .logout-btn { background: linear-gradient(135deg, #e74c3c, #c0392b); }
    .background-btn { background: linear-gradient(135deg, var(--background-btn-color), #6c3483); }
    .notification-btn { background: linear-gradient(135deg, #f39c12, #d35400); } /* নতুন রঙ */
    .sort-lock-btn { background: linear-gradient(135deg, var(--sort-lock-color), #6c3483); } /* ★★★ নতুন ★★★ */
    .btn-on { background: linear-gradient(135deg, #2ecc71, #27ae60); }
    .btn-off { background: linear-gradient(135deg, #e74c3c, #c0392b); }
    .btn-warning { background: linear-gradient(135deg, #f39c12, #e67e22); }
    .btn-info { background: linear-gradient(135deg, #1abc9c, #16a085); }
    .timer-btn { background: linear-gradient(135deg, var(--info-color), #2980b9); }
    .modal-btn.cancel-btn { background: linear-gradient(135deg, #e74c3c, #c0392b); }
    .modal-btn.confirm-btn { background: linear-gradient(135deg, #2ecc71, #27ae60); }
    
    /* --- থিম টগল সুইচের নতুন ডিজাইন --- */
    .theme-toggle {
      position: relative;
      width: 70px;
      height: 34px;
      border-radius: 17px;
      cursor: pointer;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: inset 0 2px 5px rgba(0,0,0,0.3);
    }
    .theme-toggle input { display: none; }
    .theme-slider {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      transition: all 0.4s ease;
    }
    .theme-slider:before {
      content: "";
      position: absolute;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: white;
      top: 3px;
      left: 3px;
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .theme-toggle input:checked + .theme-slider:before {
      transform: translateX(36px);
      background: #2c3e50;
    }
    .theme-icon {
      position: absolute;
      font-size: 16px;
      top: 50%;
      transform: translateY(-50%);
      transition: opacity 0.3s ease;
    }
    .sun-icon { left: 9px; opacity: 1; }
    .moon-icon { right: 9px; opacity: 1; }
    .theme-toggle input:checked ~ .sun-icon { opacity: 0; }
    .theme-toggle input:not(:checked) ~ .moon-icon { opacity: 0; }

    /* --- ★★★ পরিবর্তিত: নেভিগেশন ট্যাবের জন্য নতুন গ্লাস ডিজাইন ও স্ক্রলবার ★★★ --- */
    .nav-tabs {
      display: flex;
      background: var(--nav-bg);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      overflow-x: auto; /* কন্টেন্ট বেশি হলে স্ক্রল করার অনুমতি দেয় */
      margin-bottom: 2rem;
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
      border: 1px solid rgba(255, 255, 255, 0.18);
      padding: 5px;
    }
    
    /* নতুন: উন্নত স্ক্রলবারের ডিজাইন (Webkit ব্রাউজার যেমন Chrome, Safari) */
    .nav-tabs::-webkit-scrollbar {
      height: 8px; /* স্ক্রলবারের উচ্চতা */
    }
    .nav-tabs::-webkit-scrollbar-track {
      background: rgba(0,0,0,0.2); /* স্ক্রলবারের ট্র্যাকের রঙ */
      border-radius: 10px;
    }
    .nav-tabs::-webkit-scrollbar-thumb {
      background: var(--secondary-color); /* স্ক্রলবারের থাম্ব (যেটি নড়ে) এর রঙ */
      border-radius: 10px;
    }
    .nav-tabs::-webkit-scrollbar-thumb:hover {
      background: #3cb0fd; /* হোভার করলে থাম্বের রঙ */
    }
    
    .nav-tab {
      flex: 1 0 auto;
      text-align: center;
      padding: 12px 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      border-radius: 10px;
      color: var(--text-color);
      white-space: nowrap; /* লেখাগুলোকে এক লাইনে রাখে */
      border: 2px solid transparent;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .nav-tab:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    
    .nav-tab.active {
      background: var(--secondary-color);
      box-shadow: 0 0 15px rgba(52, 152, 219, 0.5);
      color: white;
      transform: scale(1.05);
    }

    /* ★★★ নতুন: ট্যাব ড্র্যাগ করার সময় ভিজ্যুয়াল ফিডব্যাকের জন্য স্টাইল ★★★ */
    .sortable-ghost {
        opacity: 0.4;
        background-color: var(--secondary-color);
    }
    .nav-tabs.tabs-unlocked .nav-tab:hover {
        cursor: grab;
    }
    .nav-tabs.tabs-unlocked .nav-tab:active {
        cursor: grabbing;
    }
    
    /* --- ডিভাইস পেইজ অ্যানিমেশন --- */
    .device-page {
      display: none;
      animation: fadeIn 0.7s ease;
    }
    .device-page.active { display: block; }
    
    /* --- কার্ডের জন্য উন্নত ডিজাইন --- */
    .device-card, .energy-card, .chart-container, .log-container, .notes-container, .control-section, .advanced-graph-container, .automation-container {
        background: var(--card-bg);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        border: 1px solid rgba(255, 255, 255, 0.18);
        transition: all 0.4s ease;
        margin-bottom: 25px; /* ★★★ পরিবর্তিত: সেকশনগুলোর মধ্যে স্পেস যোগ করা হয়েছে ★★★ */
    }
    .device-card:hover, .energy-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5);
    }
    
    .device-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .card-header {
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }
    .card-value { font-size: 1.8rem; }
    .card-footer {
      display: flex;
      justify-content: space-around;
      margin-top: 15px;
    }
    .card-btn {
        padding: 8px 15px;
        font-size: 13px;
    }
    
    /* ★★★ নতুন: কার্ডের এডিট/ডিলিট আইকনের জন্য স্টাইল ★★★ */
    .card-title-container {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    .card-actions {
        display: flex;
        gap: 10px;
    }
    .card-actions i {
        cursor: pointer;
        opacity: 0.6;
        font-size: 0.9rem;
        transition: all 0.2s ease-in-out;
    }
    .card-actions i:hover {
        opacity: 1;
        transform: scale(1.15);
    }
    .fa-pencil-alt:hover {
        color: var(--secondary-color);
    }
    .fa-trash-alt:hover {
        color: var(--accent-color);
    }
    
    .device-status-summary {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 30px;
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
      border: 1px solid rgba(255, 255, 255, 0.18);
    }
    
    .status-count { font-size: 1.8rem; }

    /* --- সেকশন টাইটেল ডিজাইন --- */
    .section-title, .note-title, .control-section-title {
        font-size: 1.6rem;
        margin-bottom: 20px;
        padding-bottom: 10px;
        color: var(--secondary-color);
        border-bottom: 2px solid var(--secondary-color);
        text-shadow: 0 0 8px rgba(52, 152, 219, 0.5);
    }

    /* --- অ্যানালিটিক্স সেকশন --- */
    .analytics-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }
    
    /* --- এনার্জি মনিটরিং স্টাইল --- */
    .energy-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .energy-card {
        border-top: 4px solid var(--secondary-color);
    }

    /* --- ৩ডি টগল সুইচের উন্নত স্টাইল --- */
   .toggle-switch-container {
    display: flex;
    flex-direction: column;
    background: rgb(0 0 0 / 31%);
    padding: 20px;
    border-radius: 15px;
    border-left: 5px solid #ff00005c;
    transition: all 0.3s ease;
    box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.4);
    }
    .toggle-switch-container:hover {
        background: rgba(0,0,0,0.4);
        border-left-color: var(--secondary-color);
        transform: translateY(-5px);
        box-shadow: 0 8px 15px rgba(0,0,0,0.3), inset 0 2px 8px rgba(0,0,0,0.4);
    }

    .toggle-switch-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 25px;
    }

   .timer-status {
    font-size: 0.8rem; /* ফন্ট সাইজ সামঞ্জস্য করা হয়েছে */
    color: #aaeec4;
    text-shadow: 0 0 5px #106300;
    font-weight: 500;
    text-align: center;
    padding: 5px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 5px;
    min-height: 20px;
    }

    /* --- মোডাল বক্সের উন্নত ডিজাইন --- */
    .password-modal-container {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(10px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 3000;
      animation: fadeIn 0.4s ease-in-out;
    }
   .password-modal-box, .timer-modal-box, .scene-modal-box {
     background: rgb(30 28 28 / 58%);
     backdrop-filter: blur(15px);
     padding: 30px 40px;
     border-radius: 20px;
     width: 450px;
     box-shadow: 0px 0 16px 2px rgb(219 19 255);
     border: 3px solid rgb(169 20 20);
     text-align: center;
     border-top: 5px solid #3a2e70;
    animation: slideUp 0.5s cubic-bezier(0.165, 0.84, 0.44, 1);
    }
    .timer-modal-box {
      border-top-color: #b90000;
      width: 480px;
      }
    
    .password-input-group input {
      width: 92%;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(0,0,0,0.3);
      color: var(--text-color);
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .password-modal-buttons {
        gap: 20px;
    }
    .modal-btn {
        flex: 1;
        padding: 12px 20px;
    }
    
    /* --- অটোমেশন পেইজের স্টাইল --- */
    .automation-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 30px;
    }
    @media (min-width: 1200px) {
      .automation-grid {
        grid-template-columns: 1fr 1.5fr;
      }
    }
    .rule-builder-card {
        background: var(--card-bg);
        padding: 25px;
        border-radius: 15px;
        border: 1px solid rgba(255,255,255,0.1);
    }
    .rule-builder-form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .rule-condition-box, .rule-action-box {
        background: rgba(0,0,0,0.25);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 10px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    .rule-part {
      font-size: 1.5rem;
      font-weight: 700;
      padding-bottom: 10px;
      margin-bottom: 10px;
      border-bottom: 2px solid;
      text-shadow: 0 0 8px;
    }
    .rule-part.if-part {
      color: var(--success-color);
      border-bottom-color: var(--success-color);
    }
    .rule-part.then-part {
      color: var(--info-color);
      border-bottom-color: var(--info-color);
    }
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .form-group label {
      font-weight: 600;
      opacity: 0.9;
      font-size: 1.1rem;
    }
    .form-group select, .form-group input, .form-group textarea {
      padding: 12px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(0,0,0,0.3);
      color: var(--text-color);
      font-size: 1rem;
      width: 95%;
      font-family: 'Titillium Web', sans-serif;
    }
    .form-group select:focus, .form-group input:focus, .form-group textarea:focus {
        outline: none;
        border-color: var(--secondary-color);
        box-shadow: 0 0 10px rgba(52, 152, 219, 0.5);
    }
    .form-group textarea {
        resize: vertical;
        min-height: 80px;
    }
    .notification-toggle-group {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px;
        background: rgba(0,0,0,0.2);
        border-radius: 8px;
    }
    .rule-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
      max-height: 600px;
      overflow-y: auto;
      padding-right: 10px;
    }
    .rule-card {
      background: rgba(0,0,0,0.2);
      border-radius: 10px;
      padding: 15px;
      border-left: 5px solid var(--info-color);
      transition: all 0.3s ease;
    }
    .rule-card.disabled {
        border-left-color: var(--accent-color);
        opacity: 0.7;
    }
    .rule-card:hover {
      transform: translateX(5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    .rule-description {
      font-weight: 500;
      margin-bottom: 15px;
      line-height: 1.6;
    }
    .rule-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    .rule-btn { padding: 8px 15px; font-size: 14px; }
    .delete-btn { background: linear-gradient(135deg, #e74c3c, #c0392b); }
    .toggle-rule-btn.enabled { background: linear-gradient(135deg, #f39c12, #e67e22); }
    .toggle-rule-btn.disabled { background: linear-gradient(135deg, #2ecc71, #27ae60); }
    
    /* ★★★ পরিবর্তিত: লজিক গেট ইন্টারলক পেজের জন্য নতুন স্টাইল ★★★ */
    .logic-equation-builder {
        display: flex;
        align-items: stretch;
        gap: 20px;
        background: rgba(0,0,0,0.25);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 10px;
        padding: 25px;
    }
    .logic-column {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    .logic-inputs-column {
        flex: 3;
        gap: 25px; /* ইনপুট গ্রুপের মধ্যে স্পেস */
    }
    .logic-gate-column {
        flex: 1.5;
        justify-content: center;
        align-items: center;
        border-left: 1px dashed rgba(255,255,255,0.3);
        border-right: 1px dashed rgba(255,255,255,0.3);
        padding: 0 25px;
    }
    .logic-output-column {
        flex: 2;
        justify-content: center;
    }
    .logic-gate-column .gate-selector select {
        font-size: 1.5rem;
        padding: 15px;
        font-weight: 700;
        text-align: center;
        width: 100%;
    }
    .logic-gate-column .gate-selector label {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 10px;
        text-align: center;
        display: block;
    }
    @media (max-width: 992px) {
        .logic-equation-builder {
            flex-direction: column;
        }
        .logic-gate-column {
            border: none;
            border-top: 1px dashed rgba(255,255,255,0.3);
            border-bottom: 1px dashed rgba(255,255,255,0.3);
            padding: 25px 0;
            margin: 10px 0;
        }
    }

    /* --- ★★★ ইন্টেলিজেন্স ইনসাইটস স্টাইল ★★★ --- */
    .intelligence-section {
      margin-top: 30px;
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 20px;
      border-top: 4px solid var(--warning-color);
    }
    .intelligence-title {
        font-size: 1.4rem;
        margin-bottom: 15px;
        color: var(--warning-color);
        text-shadow: 0 0 8px rgba(243, 156, 18, 0.5);
    }
    #anomaly-alert {
        color: var(--text-color);
        font-size: 1rem;
        line-height: 1.6;
    }
    .alert-message {
        background: rgba(243, 156, 18, 0.2);
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid var(--warning-color);
    }
    /* ★★★ নতুন: অন-স্ক্রিন টোস্ট নোটিফিকেশন স্টাইল ★★★ */
    .toast-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 5000;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .toast-message {
      padding: 15px 20px;
      border-radius: 10px;
      color: white;
      font-weight: 600;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      gap: 10px;
      opacity: 0;
      transform: translateX(100%);
      animation: slideInToast 0.5s forwards, fadeOutToast 0.5s 4.5s forwards;
    }

    .toast-message.info { background: linear-gradient(135deg, var(--info-color), #12826a); }
    .toast-message.success { background: linear-gradient(135deg, var(--success-color), #208953); }
    .toast-message.error { background: linear-gradient(135deg, var(--accent-color), #a02d20); }

    @keyframes slideInToast {
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    @keyframes fadeOutToast {
      from {
        opacity: 1;
        transform: translateX(0);
      }
      to {
        opacity: 0;
        transform: translateX(100%);
      }
    }
    
    /* --- ★★★ পরিবর্তিত: অডিট লগ পেইজের নতুন স্টাইল ★★★ --- */
    .audit-log-container {
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
      border: 1px solid rgba(255, 255, 255, 0.18);
    }
    .audit-log-list {
        max-height: 70vh;
        overflow-y: auto;
        padding-right: 15px;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    .audit-log-item {
        background: rgba(0, 0, 0, 0.25);
        border-radius: 10px;
        padding: 20px;
        border-left: 6px solid var(--info-color);
        display: flex;
        flex-direction: column;
        gap: 10px;
        transition: all 0.3s ease;
    }
    .audit-log-item:hover {
        transform: translateX(5px);
        box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        background: rgba(0, 0, 0, 0.4);
    }
    /* সিস্টেম জেনারেটেড লগের জন্য আলাদা স্টাইল */
    .audit-log-item.system-log {
        border-left-color: var(--warning-color);
    }
    .audit-log-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .audit-log-user {
        font-weight: 700;
        color: var(--secondary-color);
        font-size: 1.1rem;
    }
    .audit-log-user-system {
        color: var(--warning-color);
    }
    .audit-log-timestamp {
        font-size: 0.9rem;
        opacity: 0.8;
    }
    .audit-log-action {
        font-size: 1rem;
        line-height: 1.6;
        color: var(--text-color);
    }
    
    /* ★★★ নতুন: সিস্টেম স্ট্যাটাস ড্যাশবোর্ডের জন্য স্টাইল ★★★ */
    .status-dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 25px;
    }
    .status-card {
      background: var(--card-bg);
      border-radius: 15px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
      text-align: center;
      border-top: 4px solid var(--info-color);
      transition: all 0.3s ease;
    }
    .status-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    }
    .status-card-title {
      font-size: 1.2rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--text-color);
    }
    .status-card-value {
      font-size: 1.6rem;
      font-weight: 700;
    }
    .status-indicator {
      width: 15px;
      height: 15px;
      border-radius: 50%;
      background-color: #7f8c8d; /* Grey default */
      box-shadow: 0 0 8px #7f8c8d;
    }
    .status-indicator.connected {
      background-color: var(--success-color);
      box-shadow: 0 0 10px var(--success-color);
    }
    .status-indicator.disconnected {
      background-color: var(--accent-color);
      box-shadow: 0 0 10px var(--accent-color);
    }
    .ram-progress-bar {
      width: 100%;
      height: 20px;
      background-color: rgba(0,0,0,0.3);
      border-radius: 10px;
      overflow: hidden;
    }
    .ram-progress-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--info-color), var(--success-color));
      border-radius: 10px;
      transition: width 0.5s ease;
    }

    /* ★★★ নতুন এবং পরিবর্তিত: দৃশ্য (Scenes) এর জন্য স্টাইল ★★★ */
    .scene-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: center;
    }
    
    /* ★★★ নতুন: Scene বাটন এবং ডিলিট আইকনের জন্য কন্টেইনার ★★★ */
    .scene-item-container {
        display: flex;
        align-items: center;
        gap: 8px;
        background: rgba(0,0,0,0.2);
        padding: 5px 10px;
        border-radius: 10px;
        transition: all 0.3s ease;
    }
    .scene-item-container:hover {
        background: rgba(0,0,0,0.4);
    }
    .scene-item-container .scene-btn {
        flex-grow: 1;
        background: linear-gradient(135deg, #8e44ad, #9b59b6);
        font-size: 1rem;
        margin: 0;
        box-shadow: none; /* কন্টেইনারে শ্যাডো থাকবে */
    }
    .scene-item-container .delete-scene-icon {
        color: var(--text-color);
        opacity: 0.6;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .scene-item-container .delete-scene-icon:hover {
        opacity: 1;
        color: var(--accent-color);
        transform: scale(1.2);
    }

    .create-scene-btn {
      background: linear-gradient(135deg, #16a085, #1abc9c);
    }
    .scene-modal-box {
      border-top-color: #8e44ad;
    }
    .scene-relay-list {
      max-height: 250px;
      overflow-y: auto;
      text-align: left;
      margin: 20px 0;
      background: rgba(0,0,0,0.2);
      padding: 15px;
      border-radius: 8px;
    }
    .scene-relay-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0 10px 15px; /* বাম দিকে একটু স্পেস যোগ করা হয়েছে */
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .scene-relay-item:last-child {
      border-bottom: none;
    }
    /* ★★★ নতুন: দৃশ্য মডালের জন্য ডিভাইস হেডার স্টাইল ★★★ */
    .scene-device-header {
        font-weight: 700;
        font-size: 1.1rem;
        color: var(--secondary-color);
        background: rgba(0,0,0,0.3);
        padding: 8px 15px;
        margin-top: 15px;
        border-radius: 5px;
        border-left: 3px solid var(--secondary-color);
    }
    .scene-device-header:first-of-type {
        margin-top: 0;
    }
    .scene-action-select {
      background: rgba(0,0,0,0.4);
      color: var(--text-color);
      border: 1px solid rgba(255,255,255,0.2);
      padding: 5px;
      border-radius: 5px;
    }

    .edit-relay-name-icon {
      margin-left: 10px;
      cursor: pointer;
      opacity: 0.6;
      transition: all 0.3s ease;
    }
    .edit-relay-name-icon:hover {
      opacity: 1;
      color: var(--secondary-color);
      transform: scale(1.2);
    }
    
    /* ★★★ নতুন: ডাইনামিক কন্ট্রোল প্যানেলের জন্য স্টাইল ★★★ */
    .add-new-btn-container {
      margin-top: 30px;
      padding: 20px;
      background: var(--card-bg);
      border-radius: 15px;
      text-align: center;
    }
    .add-relay-btn {
        margin-top: 15px;
        width: 100%;
        padding: 12px;
        font-size: 1rem;
        background: linear-gradient(135deg, #16a085, #1abc9c);
    }
    
    /* ★★★ নতুন: ডিলিট আইকনের জন্য স্টাইল ★★★ */
    .control-section-title {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .delete-icon {
        margin-left: 15px;
        cursor: pointer;
        opacity: 0.6;
        transition: all 0.3s ease;
        font-size: 1.2rem; /* আইকন বড় করা হয়েছে */
    }
    .delete-icon:hover {
        opacity: 1;
        color: var(--accent-color); /* ডিলিটের জন্য লাল রঙ */
        transform: scale(1.2);
    }

    /* ★★★ নতুন: কাস্টম পেজ এবং পেজ এডিটরের জন্য স্টাইল ★★★ */
    #add-new-page-btn {
        border: 2px dashed var(--secondary-color);
    }
    .nav-tab .page-actions {
        margin-left: 10px;
        display: inline-flex;
        gap: 8px;
    }
    .nav-tab .page-actions i {
        opacity: 0.7;
        transition: all 0.2s ease-in-out;
    }
    .nav-tab:hover .page-actions i {
        opacity: 1;
    }
    .nav-tab .page-actions i:hover {
        transform: scale(1.2);
        color: var(--warning-color);
    }
    .nav-tab .page-actions .fa-trash-alt:hover {
        color: var(--accent-color);
    }
    .page-editor-content {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    .page-editor-group h4 {
        color: var(--secondary-color);
        border-bottom: 1px solid var(--secondary-color);
        padding-bottom: 5px;
        margin-bottom: 10px;
    }
    .page-editor-group label {
        display: block;
        padding: 8px;
        border-radius: 5px;
        transition: background-color 0.2s;
    }
    .page-editor-group label:hover {
        background-color: rgba(255,255,255,0.1);
    }
    .page-editor-group input[type="checkbox"] {
        margin-right: 10px;
    }
    .dynamic-page-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
        gap: 25px;
    }
    .dynamic-page-grid > * {
      width: 100%; /* গ্রিডের আইটেমগুলো যেন সম্পূর্ণ জায়গা নেয় */
    }
    
    /* ★★★ নতুন: তাপমাত্রা পেজের জন্য স্টাইল ★★★ */
    .temperature-page-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        align-items: start;
    }
    .temperature-section {
        display: grid;
        grid-template-columns: 1.5fr 1fr;
        gap: 25px;
        align-items: center;
        background: var(--card-bg);
        padding: 20px;
        border-radius: 15px;
    }
    .gauge-container-pro {
        width: 100%;
        max-width: 350px;
        margin: 0 auto;
        position: relative;
    }
    .gauge-body {
        width: 100%;
        height: 0;
        padding-bottom: 100%;
        background: #f0f0f0;
        border-radius: 50%;
        border: 15px solid #ccc;
        box-shadow: inset 0 0 20px rgba(0,0,0,0.2), 0 5px 15px rgba(0,0,0,0.3);
        position: relative;
    }
    .light-theme .gauge-body {
        background: #ffffff;
        border-color: #e0e0e0;
    }
    .gauge-body::before {
        content: '';
        position: absolute;
        top: 5px; left: 5px; right: 5px; bottom: 5px;
        background: #fff;
        border-radius: 50%;
        z-index: 1;
    }
    .light-theme .gauge-body::before {
        background: #f8f9fa;
    }
    .gauge-color-arc {
        position: absolute;
        top: 10%; left: 10%; right: 10%; bottom: 10%;
        border-radius: 50%;
        z-index: 2;
    }
    .gauge-color-arc.celsius-arc {
         background: conic-gradient(from -135deg, #3498db 0 25%, #2ecc71 25% 50%, #f39c12 50% 75%, #e74c3c 75% 100%);
    }
    .gauge-color-arc.fahrenheit-arc {
        background: conic-gradient(from -135deg, #2ecc71 0 33%, #f1c40f 33% 50%, #e67e22 50% 67%, #e74c3c 67% 100%);
    }
    .gauge-dial {
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        z-index: 3;
    }
    .gauge-tick, .gauge-number {
        position: absolute;
        top: 50%;
        left: 50%;
        transform-origin: 0 0;
        color: #333;
    }
    .light-theme .gauge-tick, .light-theme .gauge-number {
        color: #444;
    }
    .gauge-tick {
        width: 2px;
        height: 10px;
        background: #555;
    }
    .gauge-tick.minor {
        width: 1px;
        height: 5px;
        background: #888;
    }
    .gauge-number {
        font-size: 0.9em;
        font-weight: 600;
    }
    .gauge-unit {
        position: absolute;
        bottom: 18%;
        left: 50%;
        transform: translateX(-50%);
        font-size: 2.5em;
        font-weight: 700;
        color: #333;
        z-index: 4;
    }
    .light-theme .gauge-unit {
        color: #2c3e50;
    }
    .gauge-needle {
        position: absolute;
        bottom: 50%;
        left: 50%;
        width: 4px;
        height: 40%;
        background: #333;
        border-radius: 2px;
        transform-origin: bottom center;
        z-index: 5;
        transition: transform 0.5s cubic-bezier(0.19, 1, 0.22, 1);
        box-shadow: 0 0 5px rgba(0,0,0,0.5);
    }
    .gauge-center-dot {
        position: absolute;
        top: 50%; left: 50%;
        width: 20px;
        height: 20px;
        background: #666;
        border-radius: 50%;
        transform: translate(-50%, -50%);
        border: 3px solid #333;
        z-index: 6;
    }
    .temperature-digital-displays {
        display: flex;
        flex-direction: column;
        gap: 25px;
    }
    .temperature-card {
        text-align: center;
        padding: 25px;
        border-top: 4px solid var(--info-color);
    }
    .temperature-card .energy-title {
        font-size: 1.3rem;
        margin-bottom: 15px;
    }
    .temperature-card .energy-value {
        font-size: 2.8rem;
        font-weight: 700;
    }
    .temperature-card.fahrenheit {
        border-top-color: var(--warning-color);
    }
    @media (max-width: 1200px) {
        .temperature-page-grid {
            grid-template-columns: 1fr;
        }
    }
    @media (max-width: 768px) {
        .temperature-section {
            grid-template-columns: 1fr;
        }
        .gauge-unit {
            font-size: 2em;
        }
    }


    /* মিডিয়া কোয়েরি */
    @media (max-width: 1024px) {
      .analytics-section, .energy-graphs, .dynamic-page-grid { grid-template-columns: 1fr; }
    }
    @media (max-width: 768px) {
      .login-box, .registration-box { width: 90%; padding: 4px; }
      .login-box-inner { padding: 1.5rem; }
      .nav-tabs { flex-direction: row; }
      .device-cards, .energy-metrics { grid-template-columns: 1fr 1fr; }
      .device-status-summary { grid-template-columns: 1fr 1fr; gap: 20px; }
      .dashboard-header { flex-direction: column; gap: 15px; align-items: center; }
      .header-controls { width: auto; flex-wrap: wrap; justify-content: center; }
      .password-modal-box, .timer-modal-box { 
        width: 70%; 
        padding: 17px; }
    }
    @media (max-width: 480px) {
      .device-cards, .energy-metrics, .toggle-switch-grid, .device-status-summary { grid-template-columns: 1fr; }
      .login-box h2, .registration-box h2 { font-size: 1.5rem; }
    }
      
    /* অন্যান্য স্টাইল */
    .login-footer {
        margin-top: 20px;
        font-size: 14px;
        opacity: 0.7;
        color: var(--text-color);
        animation: fadeIn 2s ease-in-out;
    }
    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    .card-title {
        font-size: 1rem;
        font-weight: 500;
        color: var(--text-color);
    }
    .card-status {
        padding: 4px 8px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 600;
        color: white;
    }
    .status-active {
        background: var(--success-color);
    }
    .status-inactive {
        background: var(--accent-color);
    }
    .status-warning {
        background: var(--warning-color);
    }
    .card-value {
        margin: 10px 0;
        text-align: center;
        color: var(--text-color);
    }
    .status-item {
        text-align: center;
    }
    .status-label {
        font-size: 0.9rem;
        opacity: 0.8;
        color: var(--text-color);
    }
    .log-list {
        max-height: 300px;
        overflow-y: auto;
    }
    .log-item {
        padding: 8px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        font-size: 0.9rem;
    }
    .log-time {
        color: var(--secondary-color);
        font-size: 0.8rem;
    }
    .log-message {
        margin-top: 3px;
    }
    .log-warning {
        color: var(--warning-color);
    }
    .log-error {
        color: var(--accent-color);
    }
    .log-success {
        color: var(--success-color);
    }
    .log-info {
        color: var(--secondary-color);
    }
    .energy-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 10px;
        color: var(--text-color);
        display: flex;
        align-items: center;
    }
    .energy-value {
        font-size: 1.8rem;
        font-weight: 700;
        margin: 10px 0;
        color: var(--text-color);
    }
    .energy-unit {
        font-size: 1rem;
        opacity: 0.8;
        margin-left: 5px;
    }
    .voltage-card {
        border-top-color: var(--voltage-color);
    }
    .current-card {
        border-top-color: var(--current-color);
    }
    .power-card {
        border-top-color: var(--power-color);
    }
    .energy-card-main {
        border-top-color: var(--energy-color);
    }
    .frequency-card {
        border-top-color: var(--info-color);
    }
    .power-factor-card {
        border-top-color: var(--warning-color);
    }
    .active-power-card {
        border-top-color: var(--success-color);
    }
    .reactive-power-card {
        border-top-color: var(--accent-color);
    }
    .units-card {
        border-top-color: var(--info-color);
    }
    .cost-card {
        border-top-color: var(--success-color);
    }
    .timestamp-card {
        border-top-color: var(--warning-color);
    }
    .energy-graphs {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
        gap: 20px;
        margin-top: 30px;
    }
    .graph-title {
        font-size: 1.2rem;
        margin-bottom: 15px;
        color: var(--text-color);
    }
    .time-selection {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    .time-btn {
        padding: 8px 15px;
        border: none;
        border-radius: 5px;
        background: var(--secondary-color);
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
    }
    .time-btn:hover {
        background: var(--primary-color);
        transform: translateY(-2px);
    }
    .time-btn.active {
        background: var(--success-color);
        box-shadow: 0 0 0 2px var(--light-color);
    }
    .metric-selection {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    .metric-card {
        background: var(--card-bg);
        border-radius: 8px;
        padding: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
    }
    .metric-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    .metric-card.selected {
        border-left-color: var(--secondary-color);
        background: rgba(52, 152, 219, 0.2);
    }
    .metric-title {
        font-weight: 600;
        margin-bottom: 5px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .metric-icon {
        font-size: 1.2rem;
    }
    .metric-description {
        font-size: 0.8rem;
        opacity: 0.8;
    }
    .graph-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    .graph-controls {
        display: flex;
        gap: 10px;
    }
    .graph-btn {
        padding: 5px 10px;
        border: none;
        border-radius: 4px;
        background: var(--secondary-color);
        color: white;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.3s ease;
    }
    .graph-btn:hover {
        background: var(--primary-color);
    }
    .no-data-message {
        text-align: center;
        padding: 20px;
        color: var(--text-color);
        opacity: 0.7;
    }
    .note-subtitle {
        font-size: 1.2rem;
        margin: 20px 0 10px;
        color: var(--secondary-color);
    }
    .note-paragraph {
        margin-bottom: 15px;
        line-height: 1.6;
        text-align: justify;
    }
    .note-letter {
        background: rgba(52, 152, 219, 0.2);
        border-left: 4px solid var(--secondary-color);
        padding: 15px;
        margin: 15px 0;
        border-radius: 0 5px 5px 0;
    }
    .note-letter-title {
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--secondary-color);
    }
    .note-letter-content {
        line-height: 1.5;
    }
    .note-images {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin: 25px 0;
    }
    .note-image {
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        transition: transform 0.3s ease;
        cursor: pointer;
    }
    .note-image:hover {
        transform: scale(1.02);
    }
    .note-image img {
        width: 100%;
        height: auto;
        display: block;
    }
    .note-image-caption {
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 8px;
        text-align: center;
        font-size: 0.9rem;
    }
    .image-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.9);
        z-index: 2000;
        overflow: auto;
        animation: fadeIn 0.3s;
    }
    .modal-content {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100%;
        padding: 20px;
    }
    .modal-image {
        max-width: 200%;
        max-height: 80vh;
        object-fit: contain;
        animation: zoomIn 0.3s;
    }
    .modal-caption {
        color: white;
        text-align: center;
        margin-top: 15px;
        font-size: 1.2rem;
    }
    .close-modal {
        position: absolute;
        top: 20px;
        right: 30px;
        color: white;
        font-size: 35px;
        font-weight: bold;
        cursor: pointer;
        transition: 0.3s;
    }
    .close-modal:hover {
        color: var(--secondary-color);
    }
    @keyframes zoomIn {
        from {
            transform: scale(0.8);
            opacity: 0;
        }
        to {
            transform: scale(1);
            opacity: 1;
        }
    }
    .toggle-switch-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        margin-bottom: 10px;
    }
    .toggle-switch-label {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-color);
        display: flex;
        align-items: center;
    }
    /* ★★★ পরিবর্তিত: তারিখ ও সময়ের জন্য স্টাইল ★★★ */
    .device-time-info {
        font-size: 0.8rem;
        opacity: 0.8;
        text-align: right;
    }
    .device-time-info span {
        display: block;
    }
    .device-time-info .fa-calendar-alt {
        color: var(--secondary-color);
        margin-right: 5px;
    }
    .device-time-info .fa-clock {
        color: var(--info-color);
        margin-right: 5px;
    }
    .toggle-switch-body {
        width: 100%;
        margin-bottom: 15px;
        min-height: 20px;
    }
    .toggle-switch-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
    }
    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 70px;
        height: 38px;
    }
    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #333;
        transition: .4s;
        border-radius: 38px;
        box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.5), 0 1px 1px rgba(255, 255, 255, 0.1);
    }
    .slider:before {
        position: absolute;
        content: "";
        height: 30px;
        width: 30px;
        left: 4px;
        bottom: 4px;
        background: linear-gradient(to bottom, #fdfdfd, #c1c1c1);
        transition: .4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        border-radius: 50%;
        box-shadow: 0 5px 10px rgba(0, 0, 0, 0.4), inset 0 1px 1px rgba(255, 255, 255, 0.7);
    }
    .slider:after {
        content: 'OFF';
        color: #aaa;
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 12px;
        font-weight: bold;
        transition: all 0.4s ease;
    }
    input:checked+.slider {
        background: linear-gradient(to right, #28a745, #2ecc71);
        box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.3);
    }
    input:focus+.slider {
        box-shadow: 0 0 2px var(--success-color);
    }
    input:checked+.slider:before {
        transform: translateX(32px);
    }
    input:checked+.slider:after {
        content: 'ON';
        color: white;
        left: 15px;
        right: auto;
    }
    input:active+.slider:before {
        transform: scale(0.9);
    }
    input:checked:active+.slider:before {
        transform: translateX(32px) scale(0.9);
    }
    .password-modal-box h3 {
        color: var(--text-color);
        font-size: 1.6rem;
        margin-top: 0;
        margin-bottom: 10px;
        font-weight: 600;
    }
    .password-modal-box p {
        color: var(--text-color);
        opacity: 0.8;
        margin-bottom: 25px;
    }
    .password-input-group {
        position: relative;
        margin-bottom: 20px;
    }
    .password-input-group input:focus {
        outline: none;
        border-color: var(--secondary-color);
        box-shadow: 0 0 15px rgba(52, 152, 219, 0.5);
    }
    .password-error-message {
        color: var(--accent-color);
        height: 20px;
        font-size: 0.9rem;
        margin-bottom: 10px;
    }
    .password-modal-buttons {
        display: flex;
        justify-content: space-between;
    }
    .timer-modal-box h3 {
        font-size: 1.8rem;
        color: var(--text-color);
        margin-bottom: 20px;
        text-align: center;
    }
    .timer-form {
        display: flex;
        flex-direction: column;
        gap: 18px;
        margin-bottom: 20px;
    }
    .timer-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(0, 0, 0, 0.15);
        padding: 10px 15px;
        border-radius: 8px;
    }
    .timer-row label {
        font-weight: 500;
        font-size: 1rem;
    }
    #timer-enabled-btn.enabled {
        background-color: var(--success-color);
    }
    #timer-enabled-btn.disabled {
        background-color: var(--accent-color);
    }
    .timer-time-input,
    .timer-select {
        background-color: rgba(0, 0, 0, 0.3);
        color: var(--text-color);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 5px;
        padding: 8px;
        font-size: 1rem;
        width: 180px;
    }
    .timer-note {
        font-size: 0.9rem;
        text-align: center;
        opacity: 0.8;
        margin-bottom: 15px;
    }
    .modal-btn {
        flex: .90;
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 5px 4px 6px 4px rgba(0, 0, 0, 0.3);
    }
  </style>
</head>
<body class="bg-0"> <!-- ডিফল্ট ব্যাকগ্রাউন্ড ক্লাস -->

<!-- লক স্ক্রিন -->
<div class="login-container" id="login-screen">
  <div class="login-particles" id="particles"></div>
  
  <div class="login-logo-container">
    <img src="Bisnu.png" class="login-logo" alt="BISNU IoT Logo">
    <div class="login-logo-ring"></div>
    <div class="login-logo-ring"></div>
    <div class="login-logo-ring"></div>
  </div>
  
  <!-- ★★★ পরিবর্তিত: লগইন বক্স ★★★ -->
  <div class="login-box" id="login-box">
    <div class="login-box-inner">
      <h2>BISNU IoT কন্ট্রোল প্যানেল</h2>
      <div class="input-group">
        <input type="email" id="email" placeholder="ইমেল লিখুন" autocomplete="email">
      </div>
      <div class="input-group">
        <input type="password" id="password" placeholder="পাসওয়ার্ড লিখুন" autocomplete="current-password">
      </div>
      <button class="action-btn" onclick="loginWithFirebase()">লগইন করুন</button>
      <div class="error-message" id="login-error"></div>
      <div class="form-switcher">
        আপনার কোনো একাউন্ট নেই? <a onclick="toggleForms()">রেজিস্টার করুন</a>
      </div>
    </div>
  </div>

  <!-- ★★★ নতুন: রেজিস্ট্রেশন বক্স ★★★ -->
  <div class="registration-box" id="registration-box">
    <div class="login-box-inner">
      <h2>নতুন একাউন্ট তৈরি করুন</h2>
      <div class="input-group">
        <input type="text" id="register-username" placeholder="ব্যবহারকারীর নাম" autocomplete="username">
      </div>
      <div class="input-group">
        <input type="email" id="register-email" placeholder="ইমেল লিখুন" autocomplete="email">
      </div>
      <div class="input-group">
        <input type="password" id="register-password" placeholder="পাসওয়ার্ড লিখুন" autocomplete="new-password">
      </div>
      <div class="input-group">
        <input type="password" id="confirm-password" placeholder="পাসওয়ার্ড নিশ্চিত করুন" autocomplete="new-password">
      </div>
      <button class="action-btn" onclick="registerWithFirebase()">রেজিস্টার করুন</button>
      <div class="error-message" id="register-error"></div>
      <div class="form-switcher">
        ইতিমধ্যে একাউন্ট আছে? <a onclick="toggleForms()">লগইন করুন</a>
      </div>
    </div>
  </div>

</div>

<!-- মূল অ্যাপ্লিকেশন -->
<div id="app">
  <header class="dashboard-header">
    <div class="app-logo-container">
      <img src="Bisnu.png" class="app-logo" alt="BISNU IoT Logo">
      <div class="app-logo-ring"></div>
      <div class="app-logo-ring"></div>
      <div class="app-logo-ring"></div>
    </div>
    
    <h1 class="dashboard-title">IoT ডিভাইস মনিটরিং সিস্টেম</h1>
    
    <div class="header-controls">
      <label class="theme-toggle">
        <input type="checkbox" id="theme-toggle">
        <span class="theme-slider"></span>
        <span class="theme-icon sun-icon">☀️</span>
        <span class="theme-icon moon-icon">🌙</span>
      </label>
      <!-- ★★★ নতুন: ট্যাব সাজানো লক/আনলক করার বাটন ★★★ -->
      <button id="toggle-sort-btn" class="pro-btn sort-lock-btn" onclick="toggleTabSorting()">
          <i class="fas fa-lock"></i> সাজানো লক করুন
      </button>
      <button id="notification-btn" class="pro-btn notification-btn" onclick="requestNotificationPermission()">🔔 নোটিফিকেশন চালু করুন</button>
      <button class="pro-btn background-btn" onclick="changeBackground()">🖼️ ব্যাকগ্রাউন্ড</button>
      <button class="pro-btn logout-btn" onclick="logout()">লগআউট</button>
    </div>
  </header>
  
  <!-- ★★★ পরিবর্তিত: নেভিগেশন বারে data-tab-id যোগ করা হয়েছে ★★★ -->
  <nav class="nav-tabs" id="nav-tabs-container">
    <div class="nav-tab active" onclick="showPage('page1')" data-tab-id="page1">ডিভাইস ১</div>
    <div class="nav-tab" onclick="showPage('page2')" data-tab-id="page2">ডিভাইস ২</div>
    <div class="nav-tab" onclick="showPage('page3')" data-tab-id="page3">ডিভাইস ৩</div>
    <div class="nav-tab" onclick="showPage('page4')" data-tab-id="page4">ডিভাইস ৪</div>
    <div class="nav-tab" onclick="showPage('page5')" data-tab-id="page5">এনার্জি মনিটর</div>
    <div class="nav-tab" onclick="showPage('page6')" data-tab-id="page6">এডভান্সড গ্রাফ</div>
    <div class="nav-tab" onclick="showPage('page7')" data-tab-id="page7">Diagram Note File</div>
    <div class="nav-tab" onclick="showPage('page8')" data-tab-id="page8">কন্ট্রোল প্যানেল</div>
    <div class="nav-tab" onclick="showPage('page9')" data-tab-id="page9">অটোমেশন ও অ্যালার্ট</div>
    <div class="nav-tab" onclick="showPage('page10')" data-tab-id="page10">📜 অডিট লগ</div>
    <div class="nav-tab" onclick="showPage('page11')" data-tab-id="page11">📊 সিস্টেম স্ট্যাটাস</div>
    <div class="nav-tab" onclick="showPage('page12')" data-tab-id="page12">🔐 লজিক গেট ইন্টারলক</div>
    <!-- ★★★ নতুন: তাপমাত্রা মনিটর পেজের জন্য ট্যাব ★★★ -->
    <div class="nav-tab" onclick="showPage('page13')" data-tab-id="page13">🌡️ তাপমাত্রা মনিটর</div>
    <div class="nav-tab" id="add-new-page-btn" onclick="openAddPageModal()" data-tab-id="add-new-page-btn">
        <i class="fas fa-plus"></i> নতুন পেজ
    </div>
  </nav>

  <!-- ডিভাইস ১ পেইজ -->
  <main id="page1" class="device-page active">
    <section class="device-status-summary" id="device1-summary">
      <div class="status-item">
        <div class="status-count" id="d1-active-count">0</div>
        <div class="status-label">এক্টিভ</div>
      </div>
      <div class="status-item">
        <div class="status-count" id="d1-inactive-count">0</div>
        <div class="status-label">ইনএক্টিভ</div>
      </div>
      <div class="status-item">
        <div class="status-count" id="d1-warning-count">0</div>
        <div class="status-label">সতর্কতা</div>
      </div>
      <div class="status-item">
        <div class="status-count" id="d1-total-count">0</div>
        <div class="status-label">মোট লোড</div>
      </div>
    </section>
    
    <section class="device-cards" id="device1-cards-container">
      <!-- ★★★ এই অংশটি এখন জাভাস্ক্রিপ্ট দ্বারা ডাইনামিকভাবে তৈরি হবে ★★★ -->
    </section>
    
    <!-- ★★★ নতুন: নতুন লোড যোগ করার বাটন ★★★ -->
    <div class="add-new-btn-container">
        <button class="pro-btn btn-info" onclick="addNewLoadToDevice('device1')" style="width: 100%; padding: 12px; font-size: 1rem;">
            <i class="fas fa-plus-circle"></i> নতুন লোড যোগ করুন
        </button>
    </div>

    <!-- এনালিটিক্স সেকশন -->
    <section class="analytics-section">
      <div class="chart-container">
        <h3 class="section-title">ডিভাইস ১ স্ট্যাটাস গ্রাফ</h3>
        <canvas id="device1-chart"></canvas>
      </div>
      
      <div class="log-container">
        <h3 class="section-title">ডিভাইস ১ লগ</h3>
        <div class="log-list" id="device1-logs">
          <!-- লগ আইটেমগুলো এখানে যোগ হবে -->
        </div>
      </div>
    </section>
  </main>

  <!-- ডিভাইস ২ পেইজ -->
  <main id="page2" class="device-page">
    <section class="device-status-summary" id="device2-summary">
      <div class="status-item">
        <div class="status-count" id="d2-active-count">0</div>
        <div class="status-label">এক্টিভ</div>
      </div>
      <div class="status-item">
        <div class="status-count" id="d2-inactive-count">0</div>
        <div class="status-label">ইনএক্টিভ</div>
      </div>
      <div class="status-item">
        <div class="status-count" id="d2-warning-count">0</div>
        <div class="status-label">সতর্কতা</div>
      </div>
      <div class="status-item">
        <div class="status-count" id="d2-total-count">0</div>
        <div class="status-label">মোট লোড</div>
      </div>
    </section>
    
    <section class="device-cards" id="device2-cards-container">
      <!-- ★★★ এই অংশটি এখন জাভাস্ক্রিপ্ট দ্বারা ডাইনামিকভাবে তৈরি হবে ★★★ -->
    </section>

    <!-- ★★★ নতুন: নতুন লোড যোগ করার বাটন ★★★ -->
    <div class="add-new-btn-container">
        <button class="pro-btn btn-info" onclick="addNewLoadToDevice('device2')" style="width: 100%; padding: 12px; font-size: 1rem;">
            <i class="fas fa-plus-circle"></i> নতুন লোড যোগ করুন
        </button>
    </div>

    <!-- এনালিটিক্স সেকশন -->
    <section class="analytics-section">
      <div class="chart-container">
        <h3 class="section-title">ডিভাইস ২ স্ট্যাটাস গ্রাফ</h3>
        <canvas id="device2-chart"></canvas>
      </div>
      
      <div class="log-container">
        <h3 class="section-title">ডিভাইস ২ লগ</h3>
        <div class="log-list" id="device2-logs">
          <!-- লগ আইটেমগুলো এখানে যোগ হবে -->
        </div>
      </div>
    </section>
  </main>

  <!-- ডিভাইস ৩ পেইজ -->
  <main id="page3" class="device-page">
    <section class="device-status-summary" id="device3-summary">
      <div class="status-item">
        <div class="status-count" id="d3-active-count">0</div>
        <div class="status-label">এক্টিভ</div>
      </div>
      <div class="status-item">
        <div class="status-count" id="d3-inactive-count">0</div>
        <div class="status-label">ইনএক্টিভ</div>
      </div>
      <div class="status-item">
        <div class="status-count" id="d3-warning-count">0</div>
        <div class="status-label">সতর্কতা</div>
      </div>
      <div class="status-item">
        <div class="status-count" id="d3-total-count">0</div>
        <div class="status-label">মোট লোড</div>
      </div>
    </section>
    
    <section class="device-cards" id="device3-cards-container">
       <!-- ★★★ এই অংশটি এখন জাভাস্ক্রিপ্ট দ্বারা ডাইনামিকভাবে তৈরি হবে ★★★ -->
    </section>

    <!-- ★★★ নতুন: নতুন লোড যোগ করার বাটন ★★★ -->
    <div class="add-new-btn-container">
        <button class="pro-btn btn-info" onclick="addNewLoadToDevice('device3')" style="width: 100%; padding: 12px; font-size: 1rem;">
            <i class="fas fa-plus-circle"></i> নতুন লোড যোগ করুন
        </button>
    </div>

    <!-- এনালিটিক্স সেকশন -->
    <section class="analytics-section">
      <div class="chart-container">
        <h3 class="section-title">ডিভাইস ৩ স্ট্যাটাস গ্রাফ</h3>
        <canvas id="device3-chart"></canvas>
      </div>
      
      <div class="log-container">
        <h3 class="section-title">ডিভাইস ৩ লগ</h3>
        <div class="log-list" id="device3-logs">
          <!-- লগ আইটেমগুলো এখানে যোগ হবে -->
        </div>
      </div>
    </section>
  </main>
  
  <!-- ডিভাইস ৪ পেইজ -->
  <main id="page4" class="device-page">
    <section class="device-status-summary" id="device4-summary">
      <div class="status-item">
        <div class="status-count" id="d4-active-count">0</div>
        <div class="status-label">এক্টিভ</div>
      </div>
      <div class="status-item">
        <div class="status-count" id="d4-inactive-count">0</div>
        <div class="status-label">ইনএক্টিভ</div>
      </div>
      <div class="status-item">
        <div class="status-count" id="d4-warning-count">0</div>
        <div class="status-label">সতর্কতা</div>
      </div>
      <div class="status-item">
        <div class="status-count" id="d4-total-count">0</div>
        <div class="status-label">মোট লোড</div>
      </div>
    </section>
    
    <section class="device-cards" id="device4-cards-container">
       <!-- ★★★ এই অংশটি এখন জাভাস্ক্রিপ্ট দ্বারা ডাইনামিকভাবে তৈরি হবে ★★★ -->
    </section>

    <!-- ★★★ নতুন: নতুন লোড যোগ করার বাটন ★★★ -->
    <div class="add-new-btn-container">
        <button class="pro-btn btn-info" onclick="addNewLoadToDevice('device4')" style="width: 100%; padding: 12px; font-size: 1rem;">
            <i class="fas fa-plus-circle"></i> নতুন লোড যোগ করুন
        </button>
    </div>

    <!-- এনালিটিক্স সেকশন -->
    <section class="analytics-section">
      <div class="chart-container">
        <h3 class="section-title">ডিভাইস ৪ স্ট্যাটাস গ্রাফ</h3>
        <canvas id="device4-chart"></canvas>
      </div>
      
      <div class="log-container">
        <h3 class="section-title">ডিভাইস ৪ লগ</h3>
        <div class="log-list" id="device4-logs">
          <!-- লগ আইটেমগুলো এখানে যোগ হবে -->
        </div>
      </div>
    </section>
  </main>
  
  <!-- এনার্জি মনিটরিং পেইজ -->
  <main id="page5" class="device-page">
    <section class="energy-metrics">
      <div class="energy-card voltage-card">
        <div class="energy-title">⚡ ভোল্টেজ</div>
        <div class="energy-value" id="voltage-value">-- <span class="energy-unit">V</span></div>
      </div>

      <div class="energy-card current-card">
        <div class="energy-title">🔌 কারেন্ট</div>
        <div class="energy-value" id="current-value">-- <span class="energy-unit">A</span></div>
      </div>

      <div class="energy-card power-card">
        <div class="energy-title">💡 পাওয়ার</div>
        <div class="energy-value" id="power-value">-- <span class="energy-unit">W</span></div>
      </div>

      <div class="energy-card energy-card-main">
        <div class="energy-title">🔋 এনার্জি</div>
        <div class="energy-value" id="energy-value">-- <span class="energy-unit">kWh</span></div>
      </div>

      <div class="energy-card frequency-card">
        <div class="energy-title">⏱️ ফ্রিকোয়েন্সি</div>
        <div class="energy-value" id="frequency-value">-- <span class="energy-unit">Hz</span></div>
      </div>

      <div class="energy-card power-factor-card">
        <div class="energy-title">📊 পাওয়ার ফ্যাক্টর</div>
        <div class="energy-value" id="power-factor-value">-- <span class="energy-unit"></span></div>
      </div>

      <div class="energy-card active-power-card">
        <div class="energy-title">🔆 অ্যাক্টিভ পাওয়ার</div>
        <div class="energy-value" id="active-power-value">-- <span class="energy-unit">W</span></div>
      </div>

      <div class="energy-card reactive-power-card">
        <div class="energy-title">🌀 রিঅ্যাক্টিভ পাওয়ার</div>
        <div class="energy-value" id="reactive-power-value">-- <span class="energy-unit">VAR</span></div>
      </div>

      <div class="energy-card units-card">
        <div class="energy-title">✔️ ব্যবহৃত ইউনিট</div>
        <div class="energy-value" id="units-value">-- <span class="energy-unit">Units</span></div>
      </div>

      <div class="energy-card cost-card">
        <div class="energy-title">💰 দৈনিক খরচ</div>
        <div class="energy-value" id="daily-cost-value">-- <span class="energy-unit">BDT</span></div>
      </div>

      <div class="energy-card timestamp-card">
        <div class="energy-title">🕒 টাইমস্ট্যাম্প</div>
        <div class="energy-value" id="timestamp-value" style="font-size: 1.2rem; font-weight: 500;">--</div>
      </div>
    </section>
    
    <section class="intelligence-section">
      <h3 class="intelligence-title">🧠 ইন্টেলিজেন্স ইনসাইটস</h3>
      <div id="anomaly-alert">
        <p>সিস্টেম স্বাভাবিকভাবে চলছে। কোনো অস্বাভাবিকতা শনাক্ত হয়নি।</p>
      </div>
    </section>

    <section class="energy-graphs">
      <div class="graph-container">
        <h3 class="graph-title">ভোল্টেজ ট্রেন্ড</h3>
        <canvas id="voltage-chart"></canvas>
      </div>
      <div class="graph-container">
        <h3 class="graph-title">কারেন্ট ট্রেন্ড</h3>
        <canvas id="current-chart"></canvas>
      </div>
      <div class="graph-container">
        <h3 class="graph-title">পাওয়ার ট্রেন্ড</h3>
        <canvas id="power-chart"></canvas>
      </div>
      <div class="graph-container">
        <h3 class="graph-title">এনার্জি কনজাম্পশন</h3>
        <canvas id="energy-chart"></canvas>
      </div>
    </section>
  </main>

  <!-- এডভান্সড এনার্জি মনিটরিং পেইজ -->
  <main id="page6" class="device-page">
    <div class="time-selection">
      <button class="time-btn active" onclick="changeTimeRange(30)">৩০ মিনিট</button>
      <button class="time-btn" onclick="changeTimeRange(60)">১ ঘন্টা</button>
      <button class="time-btn" onclick="changeTimeRange(180)">৩ ঘন্টা</button>
      <button class="time-btn" onclick="changeTimeRange(360)">৬ ঘন্টা</button>
      <button class="time-btn" onclick="changeTimeRange(720)">১২ ঘন্টা</button>
    </div>

    <div class="metric-selection">
      <div class="metric-card selected" onclick="selectMetric('voltage')">
        <div class="metric-title"><span class="metric-icon">⚡</span> ভোল্টেজ</div>
        <div class="metric-description">ভোল্টেজের পরিবর্তন পর্যবেক্ষণ করুন</div>
      </div>
      <div class="metric-card" onclick="selectMetric('current')">
        <div class="metric-title"><span class="metric-icon">🔌</span> কারেন্ট</div>
        <div class="metric-description">কারেন্টের প্রবাহ বিশ্লেষণ করুন</div>
      </div>
      <div class="metric-card" onclick="selectMetric('power')">
        <div class="metric-title"><span class="metric-icon">💡</span> পাওয়ার</div>
        <div class="metric-description">পাওয়ার ব্যবহারের ট্রেন্ড দেখুন</div>
      </div>
      <div class="metric-card" onclick="selectMetric('energy')">
        <div class="metric-title"><span class="metric-icon">🔋</span> এনার্জি</div>
        <div class="metric-description">এনার্জি খরচের হিসাব দেখুন</div>
      </div>
      <div class="metric-card" onclick="selectMetric('frequency')">
        <div class="metric-title"><span class="metric-icon">⏱️</span> ফ্রিকোয়েন্সি</div>
        <div class="metric-description">ফ্রিকোয়েন্সির স্থিতিশীলতা পরীক্ষা করুন</div>
      </div>
      <div class="metric-card" onclick="selectMetric('powerFactor')">
        <div class="metric-title"><span class="metric-icon">📊</span> পাওয়ার ফ্যাক্টর</div>
        <div class="metric-description">পাওয়ার ফ্যাক্টরের মান বিশ্লেষণ করুন</div>
      </div>
      <div class="metric-card" onclick="selectMetric('activePower')">
        <div class="metric-title"><span class="metric-icon">🔆</span> অ্যাক্টিভ পাওয়ার</div>
        <div class="metric-description">রিয়েল পাওয়ার ব্যবহার দেখুন</div>
      </div>
      <div class="metric-card" onclick="selectMetric('reactivePower')">
        <div class="metric-title"><span class="metric-icon">🌀</span> রিঅ্যাক্টিভ পাওয়ার</div>
        <div class="metric-description">রিঅ্যাক্টিভ পাওয়ার ট্রেন্ড</div>
      </div>
    </div>

    <section class="advanced-graph-container">
      <div class="graph-header">
        <h3 class="graph-title" id="advanced-graph-title">ভোল্টেজ ট্রেন্ড (৩০ মিনিট)</h3>
        <div class="graph-controls">
          <button class="graph-btn" onclick="downloadGraphData()">ডাটা ডাউনলোড</button>
          <button class="graph-btn" onclick="printGraph()">প্রিন্ট</button>
        </div>
      </div>
      <canvas id="advanced-energy-chart"></canvas>
      <div class="no-data-message" id="no-data-message" style="display: none;">
        নির্বাচিত সময় রেঞ্জে কোনো ডাটা পাওয়া যায়নি
      </div>
    </section>
  </main>
  
  <!-- Diagram Note File পেইজ -->
  <main id="page7" class="device-page">
    <section class="notes-container">
      <h2 class="note-title">Diagram Note File</h2>
      
      <p class="note-paragraph">
        এই পৃষ্ঠাটি আমাদের প্রকল্পের জন্য গুরুত্বপূর্ণ নোট এবং ডকুমেন্টেশন সংরক্ষণ করতে ব্যবহৃত হবে।
         এখানে আপনি প্রকল্পের বিভিন্ন ডায়াগ্রাম, নোট এবং গুরুত্বপূর্ণ তথ্য পাবেন যা প্রকল্পের উন্নয়ন এবং রক্ষণাবেক্ষণের জন্য প্রয়োজনীয়।
      </p>
      
      <div class="note-letter">
        <div class="note-letter-title">গুরুত্বপূর্ণ নোট #1</div>
        <div class="note-letter-content">
          প্রকল্পের সার্কিট ডায়াগ্রামটি নিচে দেওয়া হয়েছে। দয়া করে নিশ্চিত করুন যে সমস্ত সংযোগ সঠিকভাবে করা হয়েছে এবং প্রতিটি কম্পোনেন্ট সঠিকভাবে স্থাপন করা হয়েছে।
           সার্কিট ডায়াগ্রামে কোন পরিবর্তন প্রয়োজন হলে দয়া করে টিম লিডারকে জানান।
        </div>
      </div>
      
      <div class="note-images">
        <div class="note-image" onclick="openImageModal('electrical-single-line-diagram-4.jpg', 'প্রকল্পের সার্কিট ডায়াগ্রাম')">
          <img src="electrical-single-line-diagram-4.jpg" alt="সার্কিট ডায়াগ্রাম">
          <div class="note-image-caption">প্রকল্পের সার্কিট ডায়াগ্রাম</div>
        </div>

        <div class="note-image" onclick="openImageModal('6005990.jpg', 'সিস্টেম ফ্লো চার্ট')">
          <img src="6005990.jpg" alt="ফ্লো চার্ট">
          <div class="note-image-caption">সিস্টেম ফ্লো চার্ট</div>
        </div>
      </div>
      
      <h3 class="note-subtitle">প্রকল্পের মূল বৈশিষ্ট্য</h3>
      <p class="note-paragraph">
        1. রিয়েল-টাইম ডিভাইস মনিটরিং<br>
        2. এনার্জি কনজাম্পশন ট্র্যাকিং<br>
        3. রিমোট কন্ট্রোল সক্ষমতা<br>
        4. ডেটা ভিজুয়ালাইজেশন<br>
        5. মাল্টি-ডিভাইস সাপোর্ট
      </p>
      
      <div class="note-letter">
        <div class="note-letter-title">গুরুত্বপূর্ণ নোট #2</div>
        <div class="note-letter-content">
          সিস্টেম আপডেটের সময় নিচের সতর্কতাগুলো মেনে চলুন:<br>
          - আপডেট করার আগে ব্যাকআপ নিন<br>
          - প্রোডাকশন সিস্টেমে সরাসরি আপডেট করবেন না<br>
          - পরিবর্তন করার আগে টিমের সাথে আলোচনা করুন<br>
          - সমস্ত পরিবর্তন ডকুমেন্ট করুন
        </div>
      </div>
      
      <h3 class="note-subtitle">সিস্টেম আর্কিটেকচার</h3>
      <p class="note-paragraph">
        আমাদের সিস্টেমটি তিনটি মূল অংশ নিয়ে গঠিত:<br>
        1. IoT ডিভাইস - ডাটা কালেকশন এবং একচুয়েশন<br>
        2. ক্লাউড সার্ভার - ডাটা প্রসেসিং এবং স্টোরেজ<br>
        3. ওয়েব ইন্টারফেস - ইউজার ইন্টারঅ্যাকশন
      </p>
      
      <div class="note-images">
        <div class="note-image" onclick="openImageModal('https://i.ibb.co/5KJZ0Lm/system-architecture.jpg', 'সিস্টেম আর্কিটেকচার ডায়াগ্রাম')">
          <img src="https://i.ibb.co/5KJZ0Lm/system-architecture.jpg" alt="সিস্টেম আর্কিটেকচার">
          <div class="note-image-caption">সিস্টেম আর্কিটেকচার ডায়াগ্রাম</div>
        </div>
      </div>
      
      <h3 class="note-subtitle">ভবিষ্যতের উন্নয়ন পরিকল্পনা</h3>
      <p class="note-paragraph">
        - মোবাইল অ্যাপ্লিকেশন সংযোজন<br>
        - AI-ভিত্তিক এনার্জি অপ্টিমাইজেশন<br>
        - মাল্টি-ইউজার সাপোর্ট<br>
        - অ্যাডভান্সড রিপোর্টিং সিস্টেম<br>
        - থার্ড-পার্টি ইন্টিগ্রেশন
      </p>
    </section>
  </main>

  <!-- ★★★ পরিবর্তিত: কন্ট্রোল প্যানেল পেইজ (এখন ডাইনামিক) ★★★ -->
  <main id="page8" class="device-page">
    
    <!-- দৃশ্য (Scenes) সেকশনটি উপরে রাখা হয়েছে -->
    <section class="control-section" id="page-component-scenes">
        <h2 class="control-section-title">দৃশ্য (Scenes)</h2>
        <div class="scene-buttons" id="scene-buttons-container">
            <!-- ★★★ নতুন: দৃশ্য বাটন এবং ডিলিট আইকন এখানে যুক্ত হবে ★★★ -->
            <button class="pro-btn create-scene-btn" onclick="openSceneModal()"><i class="fas fa-plus"></i> নতুন দৃশ্য তৈরি করুন</button>
        </div>
    </section>

    <!-- ডাইনামিক ডিভাইস কন্ট্রোলগুলো এখানে যুক্ত হবে -->
    <div id="control-panel-container">
        <!-- জাভাস্ক্রিপ্ট এই অংশটি Firebase ডেটা দিয়ে পূরণ করবে -->
    </div>

    <!-- নতুন ডিভাইস যোগ করার বাটন -->
    <div class="add-new-btn-container">
        <button class="pro-btn btn-info" onclick="addNewDevice()" style="width: 100%; padding: 15px; font-size: 1.2rem;">
            <i class="fas fa-plus-circle"></i> নতুন ডিভাইস যোগ করুন
        </button>
    </div>

  </main>


<!-- ★★★ পরিবর্তিত: অটোমেশন ও অ্যালার্ট পেইজ ★★★ -->
<main id="page9" class="device-page">
    <div class="automation-grid">
      <div class="automation-container">
        <h2 class="section-title">নতুন অটোমেশন বা অ্যালার্ট তৈরি করুন</h2>
        <div class="rule-builder-card">
            <form class="rule-builder-form" onsubmit="saveAutomationRule(event)">
                <div class="form-group">
                    <label for="rule-name">রুলের নাম</label>
                    <input type="text" id="rule-name" placeholder="যেমন: সন্ধ্যায় লাইট অন" required>
                </div>
                
                <!-- IF / ট্রিগার বক্স -->
                <div class="rule-condition-box">
                    <div class="rule-part if-part">IF (যদি)</div>
                    <div class="form-group">
                        <label for="trigger-source">ট্রিগারের উৎস</label>
                        <select id="trigger-source" onchange="updateTriggerOptions()">
                            <option value="energy">এনার্জি মনিটর</option>
                            <option value="time">সময়</option>
                            <option value="device">অন্য ডিভাইস</option>
                        </select>
                    </div>
                    <div id="trigger-options-container">
                        <!-- অপশনগুলো জাভাস্ক্রিপ্ট দিয়ে তৈরি হবে -->
                    </div>
                </div>

                <!-- THEN / অ্যাকশন বক্স -->
                <div class="rule-action-box">
                    <div class="rule-part then-part">THEN (তবে)</div>
                    <div class="form-group">
                        <label for="action-device">ডিভাইস</label>
                        <select id="action-device">
                            <!-- ★★★ অপশনগুলো এখন ডাইনামিকভাবে তৈরি হবে ★★★ -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="action-relay">রিলে/লোড</label>
                        <select id="action-relay">
                            <!-- ★★★ অপশনগুলো এখন ডাইনামিকভাবে তৈরি হবে ★★★ -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="action-state">অ্যাকশন</label>
                        <select id="action-state">
                            <option value="true">ON করুন</option>
                            <option value="false">OFF করুন</option>
                        </select>
                    </div>
                </div>

                <!-- নোটিফিকেশন অপশন -->
                <div class="notification-toggle-group">
                    <input type="checkbox" id="send-notification-checkbox" style="width: auto;">
                    <label for="send-notification-checkbox">এর সাথে একটি নোটিফিকেশন পাঠান</label>
                </div>
                <div class="form-group" id="notification-message-group" style="display: none;">
                    <label for="notification-message">নোটিফিকেশন বার্তা</label>
                    <textarea id="notification-message" placeholder="আপনার কাস্টম বার্তা এখানে লিখুন..."></textarea>
                </div>
                
                <button type="submit" class="pro-btn btn-on" style="margin-top: 15px;">💾 রুল সংরক্ষণ করুন</button>
            </form>
        </div>
      </div>
      <div class="automation-container">
        <h2 class="section-title">সক্রিয় অটোমেশন ও অ্যালার্ট সমূহ</h2>
        <div class="rule-list" id="automation-rule-list">
          <p>কোনো অটোমেশন রুল এখনো তৈরি করা হয়নি।</p>
        </div>
      </div>
    </div>
</main>

<!-- ★★★ পরিবর্তিত: অডিট লগ পেইজ ★★★ -->
<main id="page10" class="device-page">
    <section class="audit-log-container" id="page-component-audit-log">
        <h2 class="section-title">সম্পূর্ণ কার্যকলাপের লগ</h2>
        <div class="audit-log-list" id="audit-log-list">
            <p>কোনো কার্যকলাপের লগ পাওয়া যায়নি...</p>
        </div>
    </section>
</main>

<!-- ★★★ নতুন: সিস্টেম স্ট্যাটাস পেইজ ★★★ -->
<main id="page11" class="device-page">
    <section class="status-dashboard" id="page-component-system-status">
        <h2 class="section-title">সিস্টেম ডায়াগনস্টিক্স ড্যাশবোর্ড</h2>
        <div class="status-dashboard-grid">
            <div class="status-card">
                <div class="status-card-title"><i class="fas fa-wifi"></i> WiFi কানেকশন</div>
                <div class="status-card-value" id="status-wifi">অজানা</div>
                <div class="status-indicator" id="indicator-wifi"></div>
            </div>
            <div class="status-card">
                <div class="status-card-title"><i class="fas fa-cloud"></i> Firebase কানেকশন</div>
                <div class="status-card-value" id="status-firebase">অজানা</div>
                <div class="status-indicator" id="indicator-firebase"></div>
            </div>
            <div class="status-card">
                <div class="status-card-title"><i class="fas fa-microchip"></i> Mega কানেকশন</div>
                <div class="status-card-value" id="status-mega">অজানা</div>
                <div class="status-indicator" id="indicator-mega"></div>
            </div>
            <div class="status-card">
                <div class="status-card-title"><i class="fas fa-power-off"></i> সিস্টেম আপটাইম</div>
                <div class="status-card-value" id="status-uptime">--</div>
            </div>
            <div class="status-card">
                <div class="status-card-title"><i class="fas fa-sd-card"></i> SD কার্ড স্ট্যাটাস</div>
                <div class="status-card-value" id="status-sd-card">অজানা</div>
                <div class="status-indicator" id="indicator-sd-card"></div>
            </div>
            <div class="status-card">
                <div class="status-card-title"><i class="fas fa-memory"></i> র‍্যাম ব্যবহার</div>
                <div class="status-card-value" id="status-ram-usage">--%</div>
                <div class="ram-progress-bar">
                    <div class="ram-progress-fill" id="ram-progress-fill"></div>
                </div>
            </div>
        </div>
    </section>
</main>

<!-- ★★★ নতুন: লজিক গেট ইন্টারলক পেজ ★★★ -->
<main id="page12" class="device-page">
    <div class="automation-grid">
      <div class="automation-container">
        <h2 class="section-title">নতুন লজিক গেট রুল তৈরি করুন</h2>
        <div class="rule-builder-card">
            <form class="rule-builder-form" onsubmit="saveLogicGateRule(event)">
                <div class="form-group">
                    <label for="logic-rule-name">রুলের নাম</label>
                    <input type="text" id="logic-rule-name" placeholder="যেমন: পাম্প সেফটি ইন্টারলক" required>
                </div>
                
                <div class="logic-equation-builder">
                    <!-- INPUTS COLUMN -->
                    <div class="logic-column logic-inputs-column">
                         <div class="rule-part if-part">ইনপুট</div>
                         <!-- Input A -->
                         <div class="form-group">
                             <label for="logic-input-device-a">ইনপুট A ডিভাইস</label>
                             <select id="logic-input-device-a"></select>
                             <label for="logic-input-relay-a">ইনপুট A রিলে</label>
                             <select id="logic-input-relay-a"></select>
                         </div>
                         <!-- Input B -->
                         <div class="form-group">
                             <label for="logic-input-device-b">ইনপুট B ডিভাইস</label>
                             <select id="logic-input-device-b"></select>
                             <label for="logic-input-relay-b">ইনপুট B রিলে</label>
                             <select id="logic-input-relay-b"></select>
                         </div>
                    </div>
            
                    <!-- GATE COLUMN -->
                    <div class="logic-column logic-gate-column">
                         <div class="form-group gate-selector">
                            <label for="logic-gate-type">লজিক গেট</label>
                            <select id="logic-gate-type">
                                <option value="AND">AND</option>
                                <option value="OR">OR</option>
                                <option value="NAND">NAND</option>
                                <option value="NOR">NOR</option>
                                <option value="XOR">XOR</option>
                                <option value="XNOR">XNOR</option>
                            </select>
                        </div>
                    </div>
            
                    <!-- OUTPUT COLUMN -->
                    <div class="logic-column logic-output-column">
                        <div class="rule-part then-part">আউটপুট</div>
                        <div class="form-group">
                            <label for="logic-output-device">আউটপুট ডিভাইস</label>
                            <select id="logic-output-device"></select>
                            <label for="logic-output-relay">আউটপুট রিলে</label>
                            <select id="logic-output-relay"></select>
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="pro-btn btn-on" style="margin-top: 15px;">💾 রুল সংরক্ষণ করুন</button>
            </form>
        </div>
      </div>
      <div class="automation-container">
        <h2 class="section-title">সক্রিয় ইন্টারলক রুল সমূহ</h2>
        <div class="rule-list" id="logic-gate-rule-list">
          <p>কোনো ইন্টারলক রুল এখনো তৈরি করা হয়নি।</p>
        </div>
      </div>
    </div>
</main>

<!-- ★★★ নতুন: তাপমাত্রা মনিটর পেজ ★★★ -->
<main id="page13" class="device-page">
    <div class="temperature-page-grid">
        <!-- প্রথম গজ: সেলসিয়াস -->
        <div class="temperature-section">
            <div class="gauge-container-pro">
                <div class="gauge-body">
                    <div class="gauge-color-arc celsius-arc"></div>
                    <div class="gauge-dial" id="gauge-dial-celsius"></div>
                    <div class="gauge-unit">°C</div>
                    <div class="gauge-needle" id="gauge-needle-celsius"></div>
                    <div class="gauge-center-dot"></div>
                </div>
            </div>
            <div class="temperature-digital-displays">
                <h3 class="section-title" style="margin-bottom: 5px; text-align:center;">সেলসিয়াস</h3>
                <div class="energy-card temperature-card">
                    <div class="energy-title">🌡️ সেলসিয়াস</div>
                    <div class="energy-value" id="temp-celsius-digital-1">--<span class="energy-unit">°C</span></div>
                </div>
                <div class="energy-card temperature-card fahrenheit">
                    <div class="energy-title">🔥 ফারেনহাইট</div>
                    <div class="energy-value" id="temp-fahrenheit-digital-1">--<span class="energy-unit">°F</span></div>
                </div>
            </div>
        </div>

        <!-- দ্বিতীয় গজ: ফারেনহাইট -->
        <div class="temperature-section">
            <div class="gauge-container-pro">
                <div class="gauge-body">
                    <div class="gauge-color-arc fahrenheit-arc"></div>
                    <div class="gauge-dial" id="gauge-dial-fahrenheit"></div>
                    <div class="gauge-unit">°F</div>
                    <div class="gauge-needle" id="gauge-needle-fahrenheit"></div>
                    <div class="gauge-center-dot"></div>
                </div>
            </div>
            <div class="temperature-digital-displays">
                <h3 class="section-title" style="margin-bottom: 5px; text-align:center;">ফারেনহাইট</h3>
                <div class="energy-card temperature-card">
                    <div class="energy-title">🌡️ সেলসিয়াস</div>
                    <div class="energy-value" id="temp-celsius-digital-2">--<span class="energy-unit">°C</span></div>
                </div>
                <div class="energy-card temperature-card fahrenheit">
                    <div class="energy-title">🔥 ফারেনহাইট</div>
                    <div class="energy-value" id="temp-fahrenheit-digital-2">--<span class="energy-unit">°F</span></div>
                </div>
            </div>
        </div>
    </div>
</main>


<!-- ★★★ নতুন: ডাইনামিক বা কাস্টম পেজগুলোর জন্য কন্টেইনার ★★★ -->
<div id="dynamic-pages-container">
    <!-- নতুন তৈরি করা পেজগুলো এখানে জাভাস্ক্রিপ্ট দিয়ে যুক্ত হবে -->
</div>


</div>

<!-- টোস্ট নোটিফিকেশন কন্টেইনার -->
<div class="toast-container" id="toast-container"></div>


<!-- ইমেজ ভিউয়ার মোডাল -->
<div id="imageModal" class="image-modal">
  <span class="close-modal" onclick="closeImageModal()">&times;</span>
  <div class="modal-content">
    <img id="modalImage" class="modal-image" src="" alt="">
    <div id="modalCaption" class="modal-caption"></div>
  </div>
</div>

<!-- রিলে পাসওয়ার্ড ভেরিফিকেশন মোডাল -->
<div id="relayPasswordModal" class="password-modal-container">
  <div class="password-modal-box">
    <h3>অপারেশন নিশ্চিত করুন</h3>
    <p>এই রিলেটি অপারেট করতে দয়া করে পাসওয়ার্ড দিন।</p>
    <div class="password-input-group">
      <input type="password" id="relayPasswordInput" placeholder="অপারেটিং পাসওয়ার্ড" autocomplete="off">
    </div>
    <div class="password-error-message" id="relayPasswordError"></div>
    <div class="password-modal-buttons">
      <button class="pro-btn modal-btn cancel-btn" onclick="cancelRelayOperation()">বাতিল</button>
      <button class="pro-btn modal-btn confirm-btn" onclick="verifyAndOperateRelay()">নিশ্চিত করুন</button>
    </div>
  </div>
</div>

<!-- ★★★ নতুন: সাধারণ অ্যাকশন পাসওয়ার্ড মোডাল ★★★ -->
<div id="actionPasswordModal" class="password-modal-container">
  <div class="password-modal-box">
    <h3 id="action-modal-title">অ্যাকশন নিশ্চিত করুন</h3>
    <p id="action-modal-description">এই কাজটি সম্পন্ন করতে আপনার অপারেটিং পাসওয়ার্ড দিন।</p>
    <div class="password-input-group">
      <input type="password" id="actionPasswordInput" placeholder="অপারেটিং পাসওয়ার্ড" autocomplete="off">
    </div>
    <div class="password-error-message" id="actionPasswordError"></div>
    <div class="password-modal-buttons">
      <button class="pro-btn modal-btn cancel-btn" onclick="cancelAction()">বাতিল</button>
      <button class="pro-btn modal-btn confirm-btn" onclick="verifyAndExecuteAction()">নিশ্চিত করুন</button>
    </div>
  </div>
</div>


<!-- টাইমার সেটিং মোডাল -->
<div id="timerModal" class="password-modal-container">
  <div class="timer-modal-box">
    <h3 id="timer-modal-title">টাইমার সেটিংস</h3>
    <div class="timer-form">
      <div class="timer-row">
        <label>টাইমার স্ট্যাটাস</label>
        <button id="timer-enabled-btn" class="modal-btn disabled" onclick="toggleTimerEnabled()">নিষ্ক্রিয়</button>
      </div>
      <div class="timer-row">
        <label for="timer-online-time">অনলাইন হওয়ার সময়</label>
        <input type="time" id="timer-online-time" class="timer-time-input" step="1">
      </div>
      <div class="timer-row">
        <label for="timer-offline-time">অফলাইন হওয়ার সময়</label>
        <input type="time" id="timer-offline-time" class="timer-time-input" step="1">
      </div>
      <div class="timer-row" style="display:none;"> <!-- এই অংশটি এখন আর দরকার নেই -->
        <label for="timer-relay-select">কোন রিলে কন্ট্রোল হবে?</label>
        <select id="timer-relay-select" class="timer-select">
            <!-- অপশনগুলো ডাইনামিকভাবে জেনারেট হতে পারে -->
        </select>
      </div>
    </div>
    <p class="timer-note">পরিবর্তনগুলো সংরক্ষণ করতে আপনার অপারেটিং পাসওয়ার্ড প্রয়োজন হবে।</p>
    <div class="password-input-group">
      <input type="password" id="timerPasswordInput" placeholder="অপারেটিং পাসওয়ার্ড" autocomplete="off">
    </div>
    <div class="password-error-message" id="timerPasswordError"></div>
    <div class="password-modal-buttons">
      <button class="pro-btn modal-btn cancel-btn" onclick="closeTimerModal()">বাতিল</button>
      <button class="pro-btn modal-btn confirm-btn" onclick="saveTimerSettings()">সংরক্ষণ করুন</button>
    </div>
  </div>
</div>

<!-- ★★★ নতুন: দৃশ্য (Scene) তৈরির মোডাল ★★★ -->
<div id="sceneModal" class="password-modal-container">
  <div class="scene-modal-box">
    <h3>নতুন দৃশ্য তৈরি করুন</h3>
    <div class="form-group" style="text-align: left;">
        <label for="scene-name">দৃশ্যের নাম</label>
        <input type="text" id="scene-name" placeholder="যেমন: গুড নাইট" style="width: 100%;">
    </div>
    <div class="scene-relay-list" id="scene-relay-list-container">
        <!-- রিলে তালিকা এখানে যুক্ত হবে -->
    </div>
    <div class="password-error-message" id="scene-error-message"></div>
    <div class="password-modal-buttons">
      <button class="pro-btn modal-btn cancel-btn" onclick="closeSceneModal()">বাতিল</button>
      <button class="pro-btn modal-btn confirm-btn" onclick="saveScene()">সংরক্ষণ করুন</button>
    </div>
  </div>
</div>

<!-- ★★★ পরিবর্তিত: নতুন পেজ তৈরির মোডাল ★★★ -->
<div id="addPageModal" class="password-modal-container">
  <div class="password-modal-box">
    <h3>নতুন কাস্টম পেজ তৈরি করুন</h3>
    <p>আপনার নতুন ড্যাশবোর্ড পেজের জন্য একটি নাম এবং অপারেটিং পাসওয়ার্ড দিন।</p>
    <div class="form-group" style="text-align: left; margin-bottom: 1.5rem;">
        <label for="new-page-name">পেজের নাম</label>
        <input type="text" id="new-page-name" placeholder="যেমন: আমার কন্ট্রোল রুম" style="width: 100%;">
    </div>
    <div class="password-input-group">
      <input type="password" id="addPagePasswordInput" placeholder="অপারেটিং পাসওয়ার্ড" autocomplete="off" style="width: 100%;">
    </div>
    <div class="password-error-message" id="add-page-error"></div>
    <div class="password-modal-buttons">
      <button class="pro-btn modal-btn cancel-btn" onclick="closeAddPageModal()">বাতিল</button>
      <button class="pro-btn modal-btn confirm-btn" onclick="saveNewPage()">সংরক্ষণ করুন</button>
    </div>
  </div>
</div>


<!-- ★★★ নতুন: পেজ এডিটর মোডাল ★★★ -->
<div id="pageEditorModal" class="password-modal-container">
  <div class="scene-modal-box" style="width: 80%; max-width: 900px; border-top-color: var(--info-color);">
    <h3 id="page-editor-title">পেজ কন্টেন্ট এডিট করুন</h3>
    <div id="page-editor-content" style="max-height: 60vh; overflow-y: auto; text-align: left; padding: 15px;">
        <!-- Component selection checkboxes will be generated here by JS -->
    </div>
    <div class="password-modal-buttons" style="margin-top: 20px;">
      <button class="pro-btn modal-btn cancel-btn" onclick="closePageEditorModal()">বাতিল</button>
      <button class="pro-btn modal-btn confirm-btn" onclick="savePageComponents()">পেজ সংরক্ষণ করুন</button>
    </div>
  </div>
</div>



<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-messaging-compat.js"></script>


<script>
// Firebase কনফিগারেশন
const firebaseConfig = {
  apiKey: "AIzaSyATDfnefdyPAzBNKZY4VM5ja8K2-63PC-U",
  authDomain: "home-server-346b6.firebaseapp.com",
  databaseURL: "https://home-server-346b6-default-rtdb.firebaseio.com",
  projectId: "home-server-346b6",
  storageBucket: "home-server-346b6.firebasestorage.app",
  messagingSenderId: "531234227336",
  appId: "1:531234227336:web:f57f700dd6baaed4358b3d",
  measurementId: "G-QDWVP34FSX"
};

// Firebase ইনিশিয়ালাইজ করুন
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const auth = firebase.auth();
const messaging = firebase.messaging();


// রিলে অপারেশনের জন্য পাসওয়ার্ড (লগইনের জন্য ব্যবহৃত হবে না)
const correctOperatingPassword = "000@";

// ★★★ নতুন: অডিট লগ ইভেন্ট তৈরি করার ফাংশন ★★★
// actor প্যারামিটারটি সিস্টেম জেনারেটেড লগের জন্য ব্যবহার করা হবে
function logAuditEvent(action, actor = null) {
    const user = auth.currentUser;
    // ব্যবহারকারী যদি লগইন করা থাকে অথবা actor যদি সিস্টেম হয়, তবেই লগ তৈরি হবে
    if (user || actor) {
        const userEmail = actor ? actor : user.email; // যদি actor থাকে, সেটি ব্যবহার করবে, নাহলে ব্যবহারকারীর ইমেল
        
        const logEntry = {
            user: userEmail,
            action: action,
            timestamp: firebase.database.ServerValue.TIMESTAMP // সার্ভারের সঠিক সময় ব্যবহার করা হচ্ছে
        };
        
        // 'auditLog' নোডে নতুন লগ পুশ করা হচ্ছে
        database.ref('auditLog').push(logEntry);
    }
}

// ★★★ নতুন: লগইন এবং রেজিস্ট্রেশন বক্স টগল করার ফাংশন ★★★
function toggleForms() {
    const loginBox = document.getElementById('login-box');
    const registrationBox = document.getElementById('registration-box');
    const loginError = document.getElementById('login-error');
    const registerError = document.getElementById('register-error');

    // কোনো ত্রুটি থাকলে তা মুছে ফেলা হবে
    loginError.innerText = '';
    registerError.innerText = '';

    if (loginBox.style.display === 'none') {
        loginBox.style.display = 'block';
        registrationBox.style.display = 'none';
    } else {
        loginBox.style.display = 'none';
        registrationBox.style.display = 'block';
    }
}


// ★★★ পরিবর্তিত: Firebase ব্যবহার করে সুরক্ষিত লগইন ফাংশন ★★★
function loginWithFirebase() {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    const errorDiv = document.getElementById("login-error");
    const loginBox = document.getElementById("login-box");

    if (!email || !password) {
        errorDiv.innerText = "❌ দয়া করে ইমেল এবং পাসওয়ার্ড দিন।";
        loginBox.classList.add('shake-animation');
        setTimeout(() => {
            loginBox.classList.remove('shake-animation');
        }, 500);
        return;
    }
    
    errorDiv.innerText = "";

    auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
            console.log("লগইন সফল:", userCredential.user.email);
            
            logAuditEvent("সিস্টেমে সফলভাবে লগইন করেছেন।");

            const loginContainer = document.getElementById("login-screen");
            const appContainer = document.getElementById("app");

            loginContainer.style.animation = "fadeOut 0.5s ease forwards";
            setTimeout(() => {
                loginContainer.style.display = "none";
                appContainer.style.display = "block";
                appContainer.style.animation = "fadeIn 0.5s ease forwards";
                
                setupFirebaseListeners();
                initializeCharts();
                initProGauges(); // ★★★ নতুন: তাপমাত্রা গজ শুরু করা
                loadThemePreference();
                loadBackgroundPreference();
                initEnergyCharts();
                initAdvancedEnergyChart();
                setInterval(updateAllTimerDisplays, 1000);
                setInterval(updateAllDateTimeDisplays, 1000);
                updateTriggerOptions();
                initializeNotifications();

            }, 500);
        })
        .catch((error) => {
            console.error("লগইন ত্রুটি:", error.code, error.message);
            // ★★★ নতুন: ব্যবহারকারী ব্লক থাকলে নির্দিষ্ট বার্তা দেখানো হবে ★★★
            if (error.code === 'auth/user-disabled') {
                errorDiv.innerText = "❌ আপনার একাউন্টটি ব্লক করা হয়েছে।";
            } else {
                errorDiv.innerText = "❌ ইমেল বা পাসওয়ার্ড সঠিক নয়।";
            }
            loginBox.classList.add('shake-animation');
            setTimeout(() => {
                loginBox.classList.remove('shake-animation');
            }, 500);
        });
}

// ★★★ নতুন: Firebase ব্যবহার করে রেজিস্ট্রেশন ফাংশন ★★★
function registerWithFirebase() {
    const username = document.getElementById("register-username").value;
    const email = document.getElementById("register-email").value;
    const password = document.getElementById("register-password").value;
    const confirmPassword = document.getElementById("confirm-password").value;
    const errorDiv = document.getElementById("register-error");
    const registrationBox = document.getElementById("registration-box");

    // ভ্যালিডেশন
    if (!username || !email || !password || !confirmPassword) {
        errorDiv.innerText = "❌ অনুগ্রহ করে সবকটি ফিল্ড পূরণ করুন।";
        registrationBox.classList.add('shake-animation');
        setTimeout(() => registrationBox.classList.remove('shake-animation'), 500);
        return;
    }
    if (password !== confirmPassword) {
        errorDiv.innerText = "❌ পাসওয়ার্ড দুটি মেলেনি। আবার চেষ্টা করুন।";
        registrationBox.classList.add('shake-animation');
        setTimeout(() => registrationBox.classList.remove('shake-animation'), 500);
        return;
    }
    if (password.length < 6) {
        errorDiv.innerText = "❌ পাসওয়ার্ড অন্তত ৬ অক্ষরের হতে হবে।";
        registrationBox.classList.add('shake-animation');
        setTimeout(() => registrationBox.classList.remove('shake-animation'), 500);
        return;
    }
    errorDiv.innerText = "";

    // Firebase Authentication এ নতুন ব্যবহারকারী তৈরি করা
    auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
            const user = userCredential.user;
            console.log("রেজিস্ট্রেশন সফল:", user.email);

            // ব্যবহারকারীর প্রোফাইলে নাম যোগ করা (ঐচ্ছিক)
            user.updateProfile({
                displayName: username
            });
            
            // রিয়েলটাইম ডেটাবেজে ব্যবহারকারীর তথ্য সংরক্ষণ করা (ঐচ্ছিক)
            database.ref('users/' + user.uid).set({
                username: username,
                email: email,
                createdAt: firebase.database.ServerValue.TIMESTAMP
            });

            showToast('রেজিস্ট্রেশন সফল হয়েছে! এখন লগইন করুন।', 'success');
            toggleForms(); // রেজিস্ট্রেশন সফল হলে লগইন ফর্মে ফিরে যাবে
        })
        .catch((error) => {
            console.error("রেজিস্ট্রেশন ত্রুটি:", error.message);
            if (error.code === 'auth/email-already-in-use') {
                errorDiv.innerText = "❌ এই ইমেলটি 이미 ব্যবহৃত হচ্ছে।";
            } else if (error.code === 'auth/weak-password') {
                errorDiv.innerText = "❌ পাসওয়ার্ডটি যথেষ্ট শক্তিশালী নয়।";
            } else {
                errorDiv.innerText = "❌ রেজিস্ট্রেশনে একটি সমস্যা হয়েছে।";
            }
            registrationBox.classList.add('shake-animation');
            setTimeout(() => registrationBox.classList.remove('shake-animation'), 500);
        });
}


// Firebase ব্যবহার করে সুরক্ষিত লগআউট ফাংশন
function logout() {
    // ★★★ পরিবর্তিত: লগআউট করার আগে অডিট লগে এন্ট্রি যোগ করা হচ্ছে ★★★
    logAuditEvent("সিস্টেম থেকে লগআউট করেছেন।");
    
    auth.signOut().then(() => {
        const appContainer = document.getElementById("app");
        const loginContainer = document.getElementById("login-screen");

        appContainer.style.animation = "fadeOut 0.5s ease forwards";
        setTimeout(() => {
            window.location.reload(); 
        }, 500);
    }).catch((error) => {
        console.error("লগআউট করার সময় ত্রুটি:", error);
    });
}

// --- বাকি জাভাস্ক্রিপ্ট কোড ---

  // চার্ট ইনস্ট্যান্স স্টোর করার অবজেক্ট
  const deviceCharts = {};
  let energyCharts = {};
  let advancedEnergyChart = null;
  
  let selectedMetric = 'voltage';
  let selectedTimeRange = 30; // মিনিট
  let historicalData = {};
  
  // রিলে অপারেশন কনটেক্সট সংরক্ষণের জন্য ভেরিয়েবল
  let relayOperationContext = null;
  // টাইমার অপারেশন কনটেক্সট এবং ডেটা সংরক্ষণের জন্য ভেরিয়েবল
  let timerOperationContext = null;
  let allTimersData = {};
  
  // ব্যাকগ্রাউন্ড ম্যানেজমেন্টের জন্য ভেরিয়েবল
  let currentBackgroundIndex = 0;
  const totalBackgrounds = 11; // ১০টি ইমেজ + ১টি অ্যানিমেটেড গ্রেডিয়েন্ট
  
  // অটোমেশন রুল ও ডেটা সংরক্ষণের জন্য ভেরিয়েবল
  let currentEnergyData = {};
  let currentDeviceStates = {};
  let automationRules = {};
  let logicGateRules = {}; // ★★★ নতুন
  let relayNames = {};
  let currentPageToEdit = null;

  // ★★★ নতুন: অ্যাকশন কনফার্মেশন এবং ট্যাব সাজানোর জন্য ভেরিয়েবল ★★★
  let actionToConfirmCallback = null;
  let tabSortable = null;
  let isSortingLocked = true;


  // ইমেজ মোডাল ফাংশন
  function openImageModal(imageSrc, caption) {
    const modal = document.getElementById('imageModal');
    const modalImg = document.getElementById('modalImage');
    const modalCaption = document.getElementById('modalCaption');
    
    modal.style.display = "flex";
    modalImg.src = imageSrc;
    modalCaption.innerHTML = caption;
    
    document.addEventListener('keydown', function(event) {
      if (event.key === "Escape") {
        closeImageModal();
      }
    });
  }

  function closeImageModal() {
    document.getElementById('imageModal').style.display = "none";
    document.removeEventListener('keydown', function(event) {
      if (event.key === "Escape") {
        closeImageModal();
      }
    });
  }

  window.onclick = function(event) {
    const modal = document.getElementById('imageModal');
    if (event.target === modal) {
      closeImageModal();
    }
  }

  // পার্টিকল এনিমেশন তৈরি
  function createParticles() {
    const particlesContainer = document.getElementById('particles');
    if(particlesContainer.children.length > 0) return;
    const particleCount = 30;
    
    for (let i = 0; i < particleCount; i++) {
      const particle = document.createElement('div');
      particle.classList.add('particle');
      
      const size = Math.random() * 10 + 5;
      particle.style.width = `${size}px`;
      particle.style.height = `${size}px`;
      particle.style.left = `${Math.random() * 100}%`;
      particle.style.top = `${Math.random() * 100}%`;
      particle.style.animationDelay = `${Math.random() * 15}s`;
      particle.style.animationDuration = `${Math.random() * 10 + 10}s`;
      particle.style.opacity = Math.random() * 0.5 + 0.1;
      
      particlesContainer.appendChild(particle);
    }
  }

  // পেইজ পরিবর্তন ফাংশন
  function showPage(pageId) {
    document.querySelectorAll('.nav-tabs .nav-tab').forEach(tab => {
      tab.classList.remove('active');
    });
    
    const activeTab = document.querySelector(`.nav-tab[data-tab-id*="${pageId.replace('custom_page_','') }"]`);
    if(activeTab) {
        activeTab.classList.add('active');
    }
    
    document.querySelectorAll('.device-page').forEach(page => {
      page.classList.remove('active');
    });
    
    const activePage = document.getElementById(pageId);
    if(activePage){
        activePage.classList.add('active');
    }

    if(pageId === 'page6' && advancedEnergyChart) {
      updateAdvancedChart();
    }
  }
  
  function controlRelay(device, relay, element) {
    const state = element.checked;
    console.log(`Controlling ${device}/${relay} to ${state}`);
    
    database.ref('devices/' + device).update({
        [relay]: state
    });

    const relayCustomName = (relayNames[device] && relayNames[device][relay]) ? relayNames[device][relay] : relay;
    const logMessage = `${device} এর ${relayCustomName} ${state ? 'চালু' : 'বন্ধ'} করা হয়েছে`;
    addLogEntry(device, logMessage, state ? 'success' : 'error');

    const auditActionText = `ডিভাইস ${device.replace('device', '')}-এর '${relayCustomName}' ${state ? 'চালু' : 'বন্ধ'} করেছেন।`;
    logAuditEvent(auditActionText);
  }

  function controlDevice(device, load, state) {
    const stateText = state === 1 ? 'চালু' : (state === 2 ? 'সতর্কতা মোডে' : 'বন্ধ');
    const logMessage = `${device} এর ${load} ${stateText} করা হয়েছে`;
    
    database.ref('devices/' + device).update({
      [load]: state
    });
    
    addLogEntry(device, logMessage, state === 1 ? 'success' : state === 2 ? 'warning' : 'error');
    
    const auditActionText = `ডিভাইস ${device.replace('device', '')}-এর '${load}' ${stateText} সেট করেছেন।`;
    logAuditEvent(auditActionText);
  }

  function addLogEntry(device, message, type) {
    const logIdMap = {
      'device1': 'device1-logs',
      'device2': 'device2-logs',
      'device3': 'device3-logs',
      'device4': 'device4-logs',
    };
    const logElementId = logIdMap[device];
    if (!logElementId) return;

    const logElement = document.getElementById(logElementId);
    if (!logElement) return;

    const timestamp = new Date().toLocaleString('bn-BD');
    const logClass = `log-${type}`;
    
    const logItem = document.createElement('div');
    logItem.className = 'log-item';
    logItem.innerHTML = `
      <div class="log-time">${timestamp}</div>
      <div class="log-message ${logClass}">${message}</div>
    `;
    
    logElement.insertBefore(logItem, logElement.firstChild);
    
    if(logElement.children.length > 50) {
      logElement.removeChild(logElement.lastChild);
    }
  }

  function initializeCharts() {
    for(let i = 1; i <= 4; i++) {
      const ctx = document.getElementById(`device${i}-chart`).getContext('2d');
      if (deviceCharts[`device${i}`]) {
          deviceCharts[`device${i}`].destroy();
      }
      deviceCharts[`device${i}`] = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['এক্টিভ', 'সতর্কতা', 'ইনএক্টিভ'],
          datasets: [{
            data: [0, 0, 16],
            backgroundColor: [ 'rgba(46, 204, 113, 0.8)', 'rgba(243, 156, 18, 0.8)', 'rgba(231, 76, 60, 0.8)' ],
            borderColor: 'rgba(255, 255, 255, 0.1)',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
            }
          }
        }
      });
    }
  }
  
  // ★★★ পরিবর্তিত: সম্পূর্ণ নতুন ফাংশন যা ডিভাইস পেজ ১-৪ ডাইনামিকভাবে তৈরি করবে ★★★
  function updateStaticDevicePages() {
      const allDevicesData = currentDeviceStates || {};

      for (let i = 1; i <= 4; i++) {
          const deviceId = `device${i}`;
          const container = document.getElementById(`${deviceId}-cards-container`);
          if (!container) continue;

          container.innerHTML = ''; // পূর্বের কন্টেন্ট মুছে ফেলা হচ্ছে

          const deviceData = allDevicesData[deviceId];
          
          let activeCount = 0, inactiveCount = 0, warningCount = 0;
          let totalLoads = 0;

          if (!deviceData) {
              container.innerHTML = '<p style="text-align: center; opacity: 0.7;">এই ডিভাইসের জন্য কোনো লোড পাওয়া যায়নি।</p>';
          } else {
              const loadKeys = Object.keys(deviceData)
                  .filter(key => key.startsWith('Load'))
                  .sort((a, b) => parseInt(a.replace('Load', '')) - parseInt(b.replace('Load', '')));
              
              totalLoads = loadKeys.length;

              loadKeys.forEach(loadId => {
                  const state = deviceData[loadId];
                  const customName = (relayNames[deviceId] && relayNames[deviceId][loadId]) 
                      ? relayNames[deviceId][loadId] 
                      : `লোড ${loadId.replace('Load', '')}`;

                  let statusText = 'ইনএক্টিভ';
                  let statusClass = 'status-inactive';
                  let valueText = 'OFF';

                  if (state === true || state === 1) {
                      statusText = 'এক্টিভ';
                      statusClass = 'status-active';
                      valueText = 'ON';
                      activeCount++;
                  } else if (state === 2) {
                      statusText = 'সতর্কতা';
                      statusClass = 'status-warning';
                      valueText = 'WARNING';
                      warningCount++;
                  } else {
                      inactiveCount++;
                  }
                  
                  const cardHTML = `
                      <div class="device-card">
                          <div class="card-header">
                              <div class="card-title-container">
                                  <span class="card-title">${customName}</span>
                                  <div class="card-actions">
                                      <i class="fas fa-pencil-alt" title="নাম পরিবর্তন করুন" onclick="editRelayName('${deviceId}', '${loadId}')"></i>
                                      <i class="fas fa-trash-alt" title="এই লোডটি মুছুন" onclick="deleteRelay('${deviceId}', '${loadId}')"></i>
                                  </div>
                              </div>
                              <span class="card-status ${statusClass}">${statusText}</span>
                          </div>
                          <div class="card-value" id="${deviceId}-${loadId}">${valueText}</div>
                          <div class="card-footer">
                              <button class="pro-btn card-btn btn-on" onclick="controlDevice('${deviceId}', '${loadId}', 1)">ON</button>
                              <button class="pro-btn card-btn btn-warning" onclick="controlDevice('${deviceId}', '${loadId}', 2)">WARN</button>
                              <button class="pro-btn card-btn btn-off" onclick="controlDevice('${deviceId}', '${loadId}', 0)">OFF</button>
                          </div>
                      </div>
                  `;
                  container.innerHTML += cardHTML;
              });
          }
          
          // সামারি এবং চার্ট আপডেট করা
          const activeEl = document.getElementById(`d${i}-active-count`);
          if (activeEl) activeEl.textContent = activeCount;
          
          const inactiveEl = document.getElementById(`d${i}-inactive-count`);
          if (inactiveEl) inactiveEl.textContent = inactiveCount;

          const warningEl = document.getElementById(`d${i}-warning-count`);
          if (warningEl) warningEl.textContent = warningCount;
          
          const totalEl = document.getElementById(`d${i}-total-count`);
          if (totalEl) totalEl.textContent = totalLoads;
          
          if (deviceCharts[deviceId]) {
              deviceCharts[deviceId].data.datasets[0].data = [activeCount, warningCount, inactiveCount];
              deviceCharts[deviceId].update();
          }
      }
  }


  function toggleTheme() {
    const body = document.body;
    const themeToggle = document.getElementById('theme-toggle');
    
    if(themeToggle.checked) {
        body.classList.add('light-theme');
        localStorage.setItem('theme', 'light');
        Chart.defaults.color = '#2c3e50';
        Chart.defaults.borderColor = 'rgba(0, 0, 0, 0.1)';
    } else {
        body.classList.remove('light-theme');
        localStorage.setItem('theme', 'dark');
        Chart.defaults.color = '#FFFFFF';
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';
    }

    const allCharts = [...Object.values(deviceCharts), ...Object.values(energyCharts), advancedEnergyChart];
    allCharts.forEach(chart => {
        if(chart) chart.update();
    });
  }

  function loadThemePreference() {
    const savedTheme = localStorage.getItem('theme') || 'dark';
    const themeToggle = document.getElementById('theme-toggle');
    
    if(savedTheme === 'light') {
        document.body.classList.add('light-theme');
        themeToggle.checked = true;
        Chart.defaults.color = '#2c3e50';
        Chart.defaults.borderColor = 'rgba(0, 0, 0, 0.1)';
    } else {
        document.body.classList.remove('light-theme');
        themeToggle.checked = false;
        Chart.defaults.color = '#FFFFFF';
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';
    }
    
    themeToggle.addEventListener('change', toggleTheme);
  }
  
  function changeBackground() {
    currentBackgroundIndex = (currentBackgroundIndex + 1) % totalBackgrounds;
    applyBackground(currentBackgroundIndex);
    localStorage.setItem('backgroundIndex', currentBackgroundIndex);
  }

  function applyBackground(index) {
    const body = document.body;
    for (let i = 0; i < totalBackgrounds; i++) {
      body.classList.remove(`bg-${i}`);
    }
    body.classList.add(`bg-${index}`);
    currentBackgroundIndex = index;
  }

  function loadBackgroundPreference() {
    const savedIndex = localStorage.getItem('backgroundIndex');
    const indexToApply = savedIndex ? parseInt(savedIndex, 10) : 0;
    applyBackground(indexToApply);
  }

  function initEnergyCharts() {
    const chartsToInit = {
        'voltageChart': 'voltage-chart',
        'currentChart': 'current-chart',
        'powerChart': 'power-chart',
        'energyChart': 'energy-chart'
    };
    Object.keys(chartsToInit).forEach(chartKey => {
        if (energyCharts[chartKey]) {
            energyCharts[chartKey].destroy();
        }
    });

    const voltageCtx = document.getElementById('voltage-chart').getContext('2d');
    energyCharts.voltageChart = new Chart(voltageCtx, {
      type: 'line', data: { labels: Array(12).fill(''), datasets: [{ label: 'ভোল্টেজ (V)', data: [], borderColor: 'rgba(230, 126, 34, 1)', backgroundColor: 'rgba(230, 126, 34, 0.2)', borderWidth: 2, tension: 0.4, fill: true }] }, options: getChartOptions()
    });
    const currentCtx = document.getElementById('current-chart').getContext('2d');
    energyCharts.currentChart = new Chart(currentCtx, {
      type: 'line', data: { labels: Array(12).fill(''), datasets: [{ label: 'কারেন্ট (A)', data: [], borderColor: 'rgba(26, 188, 156, 1)', backgroundColor: 'rgba(26, 188, 156, 0.2)', borderWidth: 2, tension: 0.4, fill: true }] }, options: getChartOptions()
    });
    const powerCtx = document.getElementById('power-chart').getContext('2d');
    energyCharts.powerChart = new Chart(powerCtx, {
      type: 'line', data: { labels: Array(12).fill(''), datasets: [{ label: 'পাওয়ার (W)', data: [], borderColor: 'rgba(52, 152, 219, 1)', backgroundColor: 'rgba(52, 152, 219, 0.2)', borderWidth: 2, tension: 0.4, fill: true }] }, options: getChartOptions()
    });
    const energyCtx = document.getElementById('energy-chart').getContext('2d');
    energyCharts.energyChart = new Chart(energyCtx, {
      type: 'bar', data: { labels: ['সকাল', 'দুপুর', 'বিকাল', 'রাত'], datasets: [{ label: 'এনার্জি (kWh)', data: [0, 0, 0, 0], backgroundColor: 'rgba(155, 89, 182, 0.7)', borderColor: 'rgba(155, 89, 182, 1)', borderWidth: 1 }] }, options: getChartOptions()
    });
  }

  function getChartOptions() {
    return {
        responsive: true,
    };
  }
  
  // ★★★ নতুন: তাপমাত্রা গজ তৈরি এবং আপডেট করার ফাংশন ★★★
  function initProGauges() {
      // সেলসিয়াস গজ তৈরি
      createGaugeScale('gauge-dial-celsius', -10, 50, 10, 5);
      // ফারেনহাইট গজ তৈরি
      createGaugeScale('gauge-dial-fahrenheit', 20, 140, 10, 5);
  }

  function createGaugeScale(dialId, min, max, majorStep, minorSteps) {
      const dial = document.getElementById(dialId);
      if (!dial) return;
      dial.innerHTML = '';
      const range = max - min;
      const totalAngle = 270; 
      const startAngle = -135; 

      for (let i = min; i <= max; i += (majorStep / minorSteps)) {
          const angle = startAngle + ((i - min) / range) * totalAngle;
          const isMajorTick = (i - min) % majorStep === 0;

          const tick = document.createElement('div');
          tick.className = isMajorTick ? 'gauge-tick' : 'gauge-tick minor';
          const radius = 45; // %
          tick.style.transform = `rotate(${angle}deg) translate(${radius}%)`;
          dial.appendChild(tick);

          if (isMajorTick) {
              const number = document.createElement('div');
              number.className = 'gauge-number';
              number.textContent = i;
              const numberRadius = 38; // %
              const numberAngleRad = (angle - 90) * (Math.PI / 180);
              const x = numberRadius * Math.cos(numberAngleRad);
              const y = numberRadius * Math.sin(numberAngleRad);
              number.style.transform = `translate(${x}%, ${y}%)`;
              dial.appendChild(number);
          }
      }
  }

  function updateProGauge(needleId, value, min, max) {
      const needle = document.getElementById(needleId);
      if (!needle) return;

      const range = max - min;
      const totalAngle = 270;
      const startAngle = -135;

      let sanitizedValue = value;
      if (sanitizedValue < min) sanitizedValue = min;
      if (sanitizedValue > max) sanitizedValue = max;

      const angle = startAngle + ((sanitizedValue - min) / range) * totalAngle;
      needle.style.transform = `rotate(${angle}deg)`;
  }
  
  function updateTemperatureData(tempData) {
      if (!tempData) return;

      const celsius = typeof tempData.celsius === 'number' ? tempData.celsius : 0;
      const fahrenheit = typeof tempData.fahrenheit === 'number' ? tempData.fahrenheit : (celsius * 9/5) + 32;

      // ডিজিটাল ডিসপ্লে আপডেট
      document.getElementById('temp-celsius-digital-1').innerHTML = `${celsius.toFixed(1)}<span class="energy-unit">°C</span>`;
      document.getElementById('temp-fahrenheit-digital-1').innerHTML = `${fahrenheit.toFixed(1)}<span class="energy-unit">°F</span>`;
      document.getElementById('temp-celsius-digital-2').innerHTML = `${celsius.toFixed(1)}<span class="energy-unit">°C</span>`;
      document.getElementById('temp-fahrenheit-digital-2').innerHTML = `${fahrenheit.toFixed(1)}<span class="energy-unit">°F</span>`;


      // অ্যানালগ গজ আপডেট
      updateProGauge('gauge-needle-celsius', celsius, -10, 50);
      updateProGauge('gauge-needle-fahrenheit', fahrenheit, 20, 140);
  }

  function updateEnergyData(data) {
    currentEnergyData = data;

    document.getElementById('voltage-value').innerHTML = data.voltage ? data.voltage.toFixed(2) + ' <span class="energy-unit">V</span>' : '-- V';
    document.getElementById('current-value').innerHTML = data.current ? data.current.toFixed(2) + ' <span class="energy-unit">A</span>' : '-- A';
    document.getElementById('power-value').innerHTML = data.power ? data.power.toFixed(2) + ' <span class="energy-unit">W</span>' : '-- W';
    document.getElementById('energy-value').innerHTML = data.energy ? data.energy.toFixed(2) + ' <span class="energy-unit">kWh</span>' : '-- kWh';
    document.getElementById('frequency-value').innerHTML = data.frequency ? data.frequency.toFixed(2) + ' <span class="energy-unit">Hz</span>' : '-- Hz';
    document.getElementById('power-factor-value').innerHTML = data.powerFactor ? data.powerFactor.toFixed(2) : '--';
    document.getElementById('active-power-value').innerHTML = data.activePower ? data.activePower.toFixed(2) + ' <span class="energy-unit">W</span>' : '-- W';
    document.getElementById('reactive-power-value').innerHTML = data.reactivePower ? data.reactivePower.toFixed(2) + ' <span class="energy-unit">VAR</span>' : '-- VAR';
    document.getElementById('units-value').innerHTML = data.units ? data.units.toFixed(2) + ' <span class="energy-unit">Units</span>' : '-- Units';
    document.getElementById('daily-cost-value').innerHTML = data.dailyCost ? data.dailyCost.toFixed(2) + ' <span class="energy-unit">BDT</span>' : '-- BDT';
    
    if (data.timestamp) {
      const timestampInMs = data.timestamp.toString().length === 10 ? data.timestamp * 1000 : data.timestamp;
      const date = new Date(timestampInMs);
      document.getElementById('timestamp-value').textContent = date.toLocaleString('bn-BD', {
        year: 'numeric', month: 'short', day: 'numeric',
        hour: '2-digit', minute: '2-digit'
      });
    } else {
      document.getElementById('timestamp-value').textContent = '--';
    }

    updateEnergyChartData(energyCharts.voltageChart, data.voltage);
    updateEnergyChartData(energyCharts.currentChart, data.current);
    updateEnergyChartData(energyCharts.powerChart, data.power);
    
    if(data.energy) {
      const hours = new Date().getHours();
      let period = (hours >= 6 && hours < 12) ? 0 : (hours >= 12 && hours < 16) ? 1 : (hours >= 16 && hours < 20) ? 2 : 3;
      energyCharts.energyChart.data.datasets[0].data[period] = data.energy;
      energyCharts.energyChart.update();
    }

    const timestamp = new Date().getTime();
    if(!historicalData[timestamp]) {
      historicalData[timestamp] = data;
      const cutoffTime = timestamp - (selectedTimeRange * 60 * 1000 * 2);
      Object.keys(historicalData).forEach(key => {
        if(parseInt(key) < cutoffTime) delete historicalData[key];
      });
      if(document.getElementById('page6').classList.contains('active')) {
          updateAdvancedChart();
      }
    }
    
    checkForAnomalies(data.power);
    checkAutomationRules('energy', data);
  }

  function updateEnergyChartData(chart, newValue) {
    if(!newValue || !chart) return;
    chart.data.labels.push('');
    if(chart.data.labels.length > 12) chart.data.labels.shift();
    chart.data.datasets[0].data.push(newValue);
    if(chart.data.datasets[0].data.length > 12) chart.data.datasets[0].data.shift();
    chart.update();
  }
  
  function promptForRelayPassword(device, relay, element) {
    const currentState = !element.checked;
    element.checked = currentState; 
    relayOperationContext = { device, relay, element, targetState: !currentState };
    document.getElementById('relayPasswordModal').style.display = 'flex';
    document.getElementById('relayPasswordInput').focus();
    document.getElementById('relayPasswordError').innerText = '';
  }

  function verifyAndOperateRelay() {
    const inputPassword = document.getElementById('relayPasswordInput').value;
    if (inputPassword === correctOperatingPassword) {
      if (relayOperationContext) {
        const { device, relay, element, targetState } = relayOperationContext;
        element.checked = targetState;
        controlRelay(device, relay, element);
        closeRelayModal();
      }
    } else {
      const errorEl = document.getElementById('relayPasswordError');
      errorEl.innerText = '❌ ভুল পাসওয়ার্ড!';
      const modalBox = document.querySelector('#relayPasswordModal .password-modal-box');
      modalBox.style.animation = 'shake 0.5s ease-in-out';
      setTimeout(() => { modalBox.style.animation = ''; }, 500);
    }
    document.getElementById('relayPasswordInput').value = '';
  }

  function cancelRelayOperation() {
    closeRelayModal();
  }

  function closeRelayModal() {
    document.getElementById('relayPasswordModal').style.display = 'none';
    document.getElementById('relayPasswordInput').value = '';
    relayOperationContext = null;
  }
  
  // ★★★ নতুন: সাধারণ অ্যাকশন পাসওয়ার্ড ফাংশন ★★★
  function promptForActionPassword(title, description, callback) {
      document.getElementById('action-modal-title').textContent = title;
      document.getElementById('action-modal-description').textContent = description;
      actionToConfirmCallback = callback;
      document.getElementById('actionPasswordModal').style.display = 'flex';
      document.getElementById('actionPasswordInput').focus();
      document.getElementById('actionPasswordError').textContent = '';
  }

  function verifyAndExecuteAction() {
      const inputPassword = document.getElementById('actionPasswordInput').value;
      if (inputPassword === correctOperatingPassword) {
          if (typeof actionToConfirmCallback === 'function') {
              actionToConfirmCallback();
          }
          cancelAction(); // Close modal on success
      } else {
          const errorEl = document.getElementById('actionPasswordError');
          errorEl.textContent = '❌ ভুল অপারেটিং পাসওয়ার্ড!';
          const modalBox = document.querySelector('#actionPasswordModal .password-modal-box');
          modalBox.classList.add('shake-animation');
          setTimeout(() => { modalBox.classList.remove('shake-animation'); }, 500);
      }
      document.getElementById('actionPasswordInput').value = '';
  }

  function cancelAction() {
      document.getElementById('actionPasswordModal').style.display = 'none';
      document.getElementById('actionPasswordInput').value = '';
      actionToConfirmCallback = null;
  }


  function updateAllTimerDisplays() {
      for (const timerKey in allTimersData) {
          const timerData = allTimersData[timerKey];
          const statusElement = document.getElementById(`timer-status-${timerData.device}-${timerData.relay}`);
          if (statusElement) {
              if (timerData.enabled) {
                  const countdown = calculateCountdown(timerData.online, timerData.offline);
                  statusElement.innerHTML = `টাইমার সক্রিয়। ${countdown.nextState} ${countdown.timeLeft} পর।`;
              } else {
                  statusElement.textContent = 'টাইমার নিষ্ক্রিয় আছে।';
              }
          }
      }
  }
  
  function calculateCountdown(onlineTimeStr, offlineTimeStr) {
      const now = new Date();
      const onlineTime = new Date(now.toDateString() + ' ' + onlineTimeStr);
      const offlineTime = new Date(now.toDateString() + ' ' + offlineTimeStr);

      let nextEvent, nextState;

      if (onlineTime < offlineTime) {
          if (now >= onlineTime && now < offlineTime) {
              nextEvent = offlineTime;
              nextState = 'অফ হবে';
          } else {
              nextEvent = now < onlineTime ? onlineTime : new Date(onlineTime.getTime() + 24 * 60 * 60 * 1000);
              nextState = 'অন হবে';
          }
      } else {
          if (now >= offlineTime && now < onlineTime) {
              nextEvent = onlineTime;
              nextState = 'অন হবে';
          } else {
              nextEvent = now < offlineTime ? offlineTime : new Date(offlineTime.getTime() + 24 * 60 * 60 * 1000);
              nextState = 'অফ হবে';
          }
      }

      const diff = nextEvent - now;
      const hours = Math.floor(diff / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((diff % (1000 * 60)) / 1000);

      return {
          timeLeft: `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`,
          nextState: nextState
      };
  }

    function openTimerModal(deviceId, relayId) {
        const timerKey = `${deviceId}-${relayId}`;
        timerOperationContext = timerKey;
        const timerData = allTimersData[timerKey] || {};
        
        const customName = (relayNames[deviceId] && relayNames[deviceId][relayId]) ? relayNames[deviceId][relayId] : `${deviceId} - ${relayId}`;
        document.getElementById('timer-modal-title').textContent = `${customName} - টাইমার সেটিংস`;
        
        document.getElementById('timer-online-time').value = timerData.online || '00:00:00';
        document.getElementById('timer-offline-time').value = timerData.offline || '00:00:00';
        
        const enabledBtn = document.getElementById('timer-enabled-btn');
        updateEnabledButton(enabledBtn, !!timerData.enabled);

        document.getElementById('timerModal').style.display = 'flex';
    }


  function updateEnabledButton(btn, isEnabled) {
      btn.textContent = isEnabled ? 'সক্রিয়' : 'নিষ্ক্রিয়';
      btn.classList.toggle('enabled', isEnabled);
      btn.classList.toggle('disabled', !isEnabled);
  }

  function toggleTimerEnabled() {
      const btn = document.getElementById('timer-enabled-btn');
      const isCurrentlyEnabled = btn.classList.contains('enabled');
      updateEnabledButton(btn, !isCurrentlyEnabled);
  }

  function closeTimerModal() {
      document.getElementById('timerModal').style.display = 'none';
      document.getElementById('timerPasswordInput').value = '';
      document.getElementById('timerPasswordError').textContent = '';
      timerOperationContext = null;
  }
  
  function saveTimerSettings() {
      const password = document.getElementById('timerPasswordInput').value;
      if (password !== correctOperatingPassword) {
          const errorEl = document.getElementById('timerPasswordError');
          errorEl.textContent = '❌ ভুল অপারেটিং পাসওয়ার্ড!';
          const modalBox = document.querySelector('#timerModal .timer-modal-box');
          modalBox.style.animation = 'shake 0.5s ease-in-out';
          setTimeout(() => { modalBox.style.animation = ''; }, 500);
          return;
      }
      
      if (timerOperationContext) {
          const [deviceId, relayId] = timerOperationContext.split('-');
          const isEnabled = document.getElementById('timer-enabled-btn').classList.contains('enabled');
          const onlineTime = document.getElementById('timer-online-time').value;
          const offlineTime = document.getElementById('timer-offline-time').value;
          
          const updates = {
              enabled: isEnabled,
              online: onlineTime,
              offline: offlineTime,
              device: deviceId,
              relay: relayId
          };
          
          database.ref('timers/' + timerOperationContext).set(updates)
              .then(() => {
                  console.log('Timer settings saved successfully!');
                  
                  const auditActionText = `'${timerOperationContext}' এর জন্য টাইমার সেটিংস পরিবর্তন করেছেন। স্ট্যাটাস: ${isEnabled ? 'সক্রিয়' : 'নিষ্ক্রিয়'}, অন-টাইম: ${onlineTime}, অফ-টাইম: ${offlineTime}।`;
                  logAuditEvent(auditActionText);
                  
                  closeTimerModal();
              })
              .catch(error => {
                  console.error('Error saving timer settings: ', error);
                  document.getElementById('timerPasswordError').textContent = 'ত্রুটি: সংরক্ষণ করা যায়নি।';
              });
      }
  }

  function initAdvancedEnergyChart() {
    const ctx = document.getElementById('advanced-energy-chart').getContext('2d');
    if (advancedEnergyChart) {
        advancedEnergyChart.destroy();
    }
    advancedEnergyChart = new Chart(ctx, {
      type: 'line', data: { labels: [], datasets: [{ label: 'ভোল্টেজ (V)', data: [], borderColor: 'rgba(230, 126, 34, 1)', backgroundColor: 'rgba(230, 126, 34, 0.2)', borderWidth: 2, tension: 0.4, fill: true }] },
      options: getChartOptions()
    });
  }

  function changeTimeRange(minutes) {
    selectedTimeRange = minutes;
    document.querySelectorAll('.time-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    updateAdvancedChart();
  }

  function selectMetric(metric) {
    selectedMetric = metric;
    document.querySelectorAll('.metric-card').forEach(card => card.classList.remove('selected'));
    event.target.closest('.metric-card').classList.add('selected');
    updateAdvancedChart();
  }

  function getMetricName(metric) {
    const names = { 'voltage': 'ভোল্টেজ', 'current': 'কারেন্ট', 'power': 'পাওয়ার', 'energy': 'এনার্জি', 'frequency': 'ফ্রিকোয়েন্সি', 'powerFactor': 'পাওয়ার ফ্যাক্টর', 'activePower': 'অ্যাক্টিভ পাওয়ার', 'reactivePower': 'রিঅ্যাক্টিভ পাওয়ার' };
    return names[metric] || metric;
  }

  function getTimeRangeText(minutes) {
    if(minutes < 60) return `${minutes} মিনিট`;
    return `${Math.floor(minutes/60)} ঘন্টা`;
  }

  function updateAdvancedChart() {
    if(!advancedEnergyChart) return;
    const now = new Date().getTime();
    const cutoffTime = now - (selectedTimeRange * 60 * 1000);
    const timestamps = Object.keys(historicalData).filter(ts => parseInt(ts) >= cutoffTime).sort();
    
    const labels = timestamps.map(ts => new Date(parseInt(ts)).toLocaleTimeString('bn-BD'));
    const data = timestamps.map(ts => historicalData[ts][selectedMetric]);
    
    document.getElementById('advanced-graph-title').textContent = `${getMetricName(selectedMetric)} ট্রেন্ড (${getTimeRangeText(selectedTimeRange)})`;
    advancedEnergyChart.data.labels = labels;
    advancedEnergyChart.data.datasets[0].data = data;
    advancedEnergyChart.data.datasets[0].label = `${getMetricName(selectedMetric)} (${getUnit(selectedMetric)})`;
    advancedEnergyChart.update();
    
    document.getElementById('no-data-message').style.display = data.length === 0 ? 'block' : 'none';
  }

  function getUnit(metric) {
    const units = { 'voltage': 'V', 'current': 'A', 'power': 'W', 'energy': 'kWh', 'frequency': 'Hz', 'powerFactor': '', 'activePower': 'W', 'reactivePower': 'VAR' };
    return units[metric] || '';
  }

  function downloadGraphData() {
    const timestamps = Object.keys(historicalData).sort();
    let csvContent = "data:text/csv;charset=utf-8,সময়,ভোল্টেজ (V),কারেন্ট (A),পাওয়ার (W),এনার্জি (kWh),ফ্রিকোয়েন্সি (Hz),পাওয়ার ফ্যাক্টর,অ্যাক্টিভ পাওয়ার (W),রিঅ্যাক্টিভ পাওয়ার (VAR)\n";
    
    timestamps.forEach(ts => {
      const data = historicalData[ts];
      const row = [ new Date(parseInt(ts)).toLocaleString(), data.voltage || '', data.current || '', data.power || '', data.energy || '', data.frequency || '', data.powerFactor || '', data.activePower || '', data.reactivePower || '' ];
      csvContent += row.join(",") + "\n";
    });
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `energy_data_${new Date().toLocaleDateString()}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  function printGraph() {
    const canvas = document.getElementById('advanced-energy-chart');
    const win = window.open('', 'Print Chart');
    win.document.write(`<html><head><title>Print Chart</title></head><body><h1>${document.getElementById('advanced-graph-title').textContent}</h1><img src="${canvas.toDataURL()}"/></body></html>`);
    win.document.close();
    win.focus();
    setTimeout(() => { win.print(); win.close(); }, 500);
  }
  
  function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast-message ${type}`;
    
    let icon = 'ℹ️';
    if (type === 'success') icon = '✅';
    if (type === 'error') icon = '❌';

    toast.innerHTML = `${icon} ${message}`;
    container.appendChild(toast);
    
    setTimeout(() => {
      toast.remove();
    }, 5000);
  }

  function displayNotification(title, body) {
      if ('Notification' in window && Notification.permission === 'granted') {
          navigator.serviceWorker.ready.then(registration => {
              registration.showNotification(title, {
                  body: body,
                  icon: 'Bisnu.png',
                  badge: 'Bisnu.png'
              });
          });
      }
  }

  function initializeNotifications() {
      messaging.onMessage((payload) => {
          console.log('Message received. ', payload);
          showToast(payload.notification.body, 'info');
      });
  }

  async function requestNotificationPermission() {
      const notificationBtn = document.getElementById('notification-btn');
      try {
          await messaging.requestPermission();
          console.log('নোটিফিকেশনের অনুমতি দেওয়া হয়েছে।');
          const token = await messaging.getToken();
          console.log('FCM Token:', token);
          
          const user = auth.currentUser;
          if (user) {
              database.ref(`fcmTokens/${user.uid}`).set({ token: token });
              showToast('নোটিফিকেশন সফলভাবে চালু হয়েছে!', 'success');
              notificationBtn.textContent = '✅ নোটিফিকেশন চালু আছে';
              notificationBtn.disabled = true;
          }
      } catch (err) {
          console.error('নোটিফিকেশনের অনুমতি পেতে ব্যর্থ: ', err);
          showToast('নোটিফিকেশনের অনুমতি দেওয়া হয়নি।', 'error');
      }
  }

  function checkForAnomalies(power) {
    const alertDiv = document.getElementById('anomaly-alert');
    const powerThreshold = 5000;

    if (power > powerThreshold) {
      const message = `অস্বাভাবিকভাবে উচ্চ পাওয়ার (${power.toFixed(0)} W) ব্যবহার শনাক্ত হয়েছে।`;
      alertDiv.innerHTML = `<div class="alert-message"><strong>সতর্কতা!</strong> ${message}</div>`;
      triggerNotification("উচ্চ পাওয়ার ব্যবহার!", message);
    } else {
      alertDiv.innerHTML = `<p>সিস্টেম স্বাভাবিকভাবে চলছে। কোনো অস্বাভাবিকতা শনাক্ত হয়নি।</p>`;
    }
  }
  
  function populateRelayDropdown(deviceSelectId, relaySelectId) {
      const deviceSelect = document.getElementById(deviceSelectId);
      const relaySelect = document.getElementById(relaySelectId);
      
      if (!deviceSelect || !relaySelect) return;

      const selectedDeviceId = deviceSelect.value;
      const currentRelayValue = relaySelect.value;
      relaySelect.innerHTML = '';

      if (selectedDeviceId && currentDeviceStates[selectedDeviceId]) {
          const relays = Object.keys(currentDeviceStates[selectedDeviceId])
              .filter(key => key.startsWith('relay'))
              .sort((a, b) => parseInt(a.replace('relay', '')) - parseInt(b.replace('relay', '')));

          relays.forEach(relayId => {
              const customName = (relayNames[selectedDeviceId] && relayNames[selectedDeviceId][relayId]) 
                                 ? relayNames[selectedDeviceId][relayId] 
                                 : relayId.replace('relay', 'রিলে ');
              const option = document.createElement('option');
              option.value = relayId;
              option.textContent = customName;
              relaySelect.appendChild(option);
          });
          
          if (relays.includes(currentRelayValue)) {
              relaySelect.value = currentRelayValue;
          }
      }
  }

  function updateAutomationFormOptions() {
    const devices = currentDeviceStates ? Object.keys(currentDeviceStates).sort((a, b) => parseInt(a.replace('device', '')) - parseInt(b.replace('device', ''))) : [];
    const actionDeviceSelect = document.getElementById('action-device');

    if (!actionDeviceSelect) return;

    const currentActionDevice = actionDeviceSelect.value;
    actionDeviceSelect.innerHTML = '';
    devices.forEach(deviceId => {
        const option = document.createElement('option');
        option.value = deviceId;
        option.textContent = deviceId.replace('device', 'ডিভাইস ');
        actionDeviceSelect.appendChild(option);
    });

    if (devices.includes(currentActionDevice)) {
        actionDeviceSelect.value = currentActionDevice;
    }

    populateRelayDropdown('action-device', 'action-relay');
    
    updateTriggerOptions();
  }


  function updateTriggerOptions() {
    const source = document.getElementById('trigger-source').value;
    const container = document.getElementById('trigger-options-container');
    const devices = currentDeviceStates ? Object.keys(currentDeviceStates).sort((a, b) => parseInt(a.replace('device', '')) - parseInt(b.replace('device', ''))) : [];
    let html = '';

    if (source === 'energy') {
      html = `
        <div class="form-group">
          <label for="trigger-metric">ম্যাট্রিক</label>
          <select id="trigger-metric">
            <option value="power">পাওয়ার (W)</option>
            <option value="voltage">ভোল্টেজ (V)</option>
            <option value="current">কারেন্ট (A)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="trigger-condition">শর্ত</label>
          <select id="trigger-condition">
            <option value=">">এর বেশি হলে</option>
            <option value="<">এর কম হলে</option>
            <option value="==">এর সমান হলে</option>
          </select>
        </div>
        <div class="form-group">
          <label for="trigger-value">মান</label>
          <input type="number" id="trigger-value" placeholder="যেমন: 2000" required>
        </div>
      `;
    } else if (source === 'time') {
      html = `
        <div class="form-group">
          <label for="trigger-value">নির্দিষ্ট সময়</label>
          <input type="time" id="trigger-value" required>
        </div>
      `;
    } else if (source === 'device') {
      html = `
        <div class="form-group">
          <label for="trigger-device">ডিভাইস</label>
          <select id="trigger-device" onchange="populateRelayDropdown('trigger-device', 'trigger-relay')">
            ${devices.map(id => `<option value="${id}">${id.replace('device', 'ডিভাইস ')}</option>`).join('')}
          </select>
        </div>
        <div class="form-group">
          <label for="trigger-relay">রিলে/লোড</label>
          <select id="trigger-relay">
          </select>
        </div>
        <div class="form-group">
          <label for="trigger-condition">অবস্থা</label>
          <select id="trigger-condition">
            <option value="true">ON হলে</option>
            <option value="false">OFF হলে</option>
          </select>
        </div>
      `;
    }
    container.innerHTML = html;
    
    if (source === 'device' && devices.length > 0) {
        populateRelayDropdown('trigger-device', 'trigger-relay');
    }
  }

  
  document.getElementById('send-notification-checkbox').addEventListener('change', function() {
    document.getElementById('notification-message-group').style.display = this.checked ? 'flex' : 'none';
  });

  // ★★★ পরিবর্তিত: পাসওয়ার্ড প্রোটেকশন যোগ করা হয়েছে ★★★
  function saveAutomationRule(event) {
    event.preventDefault();
    const ruleName = document.getElementById('rule-name').value;
    if (!ruleName) {
        showToast("রুলের একটি নাম দিন।", "error");
        return;
    }

    promptForActionPassword(
        'রুল সংরক্ষণ করুন',
        `আপনি কি সত্যিই '${ruleName}' রুলটি সংরক্ষণ করতে চান?`,
        () => {
            const sendNotification = document.getElementById('send-notification-checkbox').checked;

            const rule = {
              name: ruleName,
              triggerSource: document.getElementById('trigger-source').value,
              actionDevice: document.getElementById('action-device').value,
              actionRelay: document.getElementById('action-relay').value,
              actionState: document.getElementById('action-state').value === 'true',
              sendNotification: sendNotification,
              notificationMessage: sendNotification ? document.getElementById('notification-message').value : '',
              isEnabled: true,
              lastFired: 0 
            };

            if (rule.triggerSource === 'energy') {
              rule.triggerMetric = document.getElementById('trigger-metric').value;
              rule.triggerCondition = document.getElementById('trigger-condition').value;
              rule.triggerValue = parseFloat(document.getElementById('trigger-value').value);
            } else if (rule.triggerSource === 'time') {
              rule.triggerValue = document.getElementById('trigger-value').value;
            } else if (rule.triggerSource === 'device') {
              rule.triggerDevice = document.getElementById('trigger-device').value;
              rule.triggerRelay = document.getElementById('trigger-relay').value;
              rule.triggerState = document.getElementById('trigger-condition').value === 'true';
            }

            database.ref('automationRules').push(rule)
              .then(() => {
                showToast('অটোমেশন রুল সফলভাবে সংরক্ষিত হয়েছে!', 'success');
                logAuditEvent(`নতুন অটোমেশন রুল '${rule.name}' তৈরি করেছেন।`);
                document.querySelector('.rule-builder-form').reset();
                document.getElementById('notification-message-group').style.display = 'none';
              })
              .catch(error => {
                showToast("রুল সংরক্ষণ করতে সমস্যা হয়েছে।", "error");
                console.error("রুল সংরক্ষণ করতে সমস্যা হয়েছে: ", error);
              });
        }
    );
  }
  
  function toggleRule(ruleId) {
    const rule = automationRules[ruleId];
    const newState = !rule.isEnabled;
    database.ref(`automationRules/${ruleId}/isEnabled`).set(newState).then(() => {
        logAuditEvent(`'${rule.name}' রুলটি ${newState ? 'সক্রিয়' : 'নিষ্ক্রিয়'} করেছেন।`);
    });
  }

  function deleteRule(ruleId) {
    const ruleName = automationRules[ruleId].name;
    promptForActionPassword(
      'রুল মুছুন',
      `আপনি কি সত্যিই "${ruleName}" রুলটি মুছে ফেলতে চান?`,
      () => {
        database.ref(`automationRules/${ruleId}`).remove().then(() => {
            logAuditEvent(`'${ruleName}' রুলটি মুছে ফেলেছেন।`);
        });
      }
    );
  }
  
  function triggerNotification(title, body) {
      showToast(body, 'info');
      displayNotification(title, body);
  }

  function checkAutomationRules(source, data) {
    const now = new Date();
    const currentTime = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
    const nowTimestamp = now.getTime();
    
    for (const ruleId in automationRules) {
      const rule = automationRules[ruleId];
      if (!rule.isEnabled) continue;

      if (nowTimestamp - (rule.lastFired || 0) < 30000) continue;

      let triggerMet = false;

      if (source === 'energy' && rule.triggerSource === 'energy') {
        const value = data[rule.triggerMetric];
        if (rule.triggerCondition === '>' && value > rule.triggerValue) triggerMet = true;
        if (rule.triggerCondition === '<' && value < rule.triggerValue) triggerMet = true;
        if (rule.triggerCondition === '==' && value == rule.triggerValue) triggerMet = true;
      }
      
      if (source === 'time' && rule.triggerSource === 'time' && rule.triggerValue === currentTime) {
        triggerMet = true;
      }

      if (source === 'device' && rule.triggerSource === 'device') {
        if (data.deviceId === rule.triggerDevice) {
           const deviceCurrentState = data.states[rule.triggerRelay];
           if (deviceCurrentState === rule.triggerState) {
             triggerMet = true;
           }
        }
      }

      if (triggerMet) {
        console.log(`অটোমেশন রুল "${rule.name}" কার্যকর হচ্ছে...`);
        database.ref(`devices/${rule.actionDevice}`).update({
          [rule.actionRelay]: rule.actionState 
        });

        if (rule.sendNotification && rule.notificationMessage) {
            triggerNotification(`"${rule.name}" কার্যকর হয়েছে`, rule.notificationMessage);
        }
        
        database.ref(`automationRules/${ruleId}/lastFired`).set(nowTimestamp);
        
        const logMessage = `অটোমেশন "${rule.name}" অনুযায়ী ${rule.actionDevice} এর ${rule.actionRelay} ${rule.actionState ? 'ON' : 'OFF'} করা হয়েছে।`;
        addLogEntry(rule.actionDevice.replace('device','device'), logMessage, 'info');
        
        logAuditEvent(logMessage, "সিস্টেম অটোমেশন");
      }
    }
  }
  setInterval(() => checkAutomationRules('time', {}), 60000);
  
  function editRelayName(deviceId, relayId) {
      const currentName = (relayNames[deviceId] && relayNames[deviceId][relayId]) ? relayNames[deviceId][relayId] : relayId;
      const newName = prompt(`'${currentName}' এর জন্য নতুন নাম দিন:`, currentName);

      if (newName && newName.trim() !== "") {
          database.ref(`device_metadata/${deviceId}/relay_names/${relayId}`).set(newName)
              .then(() => {
                  showToast("রিলের নাম সফলভাবে পরিবর্তন হয়েছে!", "success");
                  logAuditEvent(`'${currentName}' রিলের নাম পরিবর্তন করে '${newName}' রেখেছেন।`);
              })
              .catch(error => {
                  showToast("নাম পরিবর্তন করতে সমস্যা হয়েছে।", "error");
                  console.error(error);
              });
      }
  }
  
  // ★★★ পরিবর্তিত: পাসওয়ার্ড ভেরিফিকেশন যোগ করা হয়েছে ★★★
  function executeScene(sceneId, actions, sceneName) {
    promptForActionPassword(
      `'${sceneName}' দৃশ্যটি চালান`,
      `আপনি কি সত্যিই "${sceneName}" দৃশ্যটি কার্যকর করতে চান?`,
      () => {
        const updates = {};
        if (Array.isArray(actions)) {
            actions.forEach(action => {
                const path = `devices/${action.device}/${action.relay}`;
                updates[path] = action.state;
            });
        } else {
            console.warn("Executing a scene with a deprecated format. Please re-save it.");
            for(const path in actions) {
                updates[path] = actions[path];
            }
        }

        if (Object.keys(updates).length === 0) {
            showToast("এই দৃশ্যে কোনো অ্যাকশন সেট করা নেই।", "warning");
            return;
        }

        database.ref().update(updates)
          .then(() => {
              showToast(`"${sceneName}" দৃশ্য সফলভাবে কার্যকর হয়েছে।`, 'success');
              logAuditEvent(`"${sceneName}" দৃশ্যটি কার্যকর করেছেন।`);
          })
          .catch(error => {
              showToast("দৃশ্য কার্যকর করতে সমস্যা হয়েছে।", "error");
              console.error("Scene execution failed:", error);
          });
      }
    );
  }

  function openSceneModal() {
      const listContainer = document.getElementById('scene-relay-list-container');
      let htmlContent = '';

      const sortedDeviceIds = Object.keys(currentDeviceStates).sort((a, b) => 
          parseInt(a.replace('device', '')) - parseInt(b.replace('device', ''))
      );

      sortedDeviceIds.forEach(deviceId => {
          htmlContent += `<div class="scene-device-header">${deviceId.replace('device', 'ডিভাইস ')}</div>`;

          const relays = Object.keys(currentDeviceStates[deviceId])
              .filter(key => key.startsWith('relay'))
              .sort((a, b) => parseInt(a.replace('relay', '')) - parseInt(b.replace('relay', '')));
          
          relays.forEach(relayId => {
              const relayCustomName = (relayNames[deviceId]?.[relayId]) || relayId.replace('relay', 'রিলে ');
              
              htmlContent += `
                  <div class="scene-relay-item">
                      <span>${relayCustomName}</span>
                      <select class="scene-action-select" data-device="${deviceId}" data-relay="${relayId}">
                          <option value="ignore">কোনো পরিবর্তন নয়</option>
                          <option value="true">ON করুন</option>
                          <option value="false">OFF করুন</option>
                      </select>
                  </div>
              `;
          });
      });
      
      listContainer.innerHTML = htmlContent;

      document.getElementById('sceneModal').style.display = 'flex';
  }


  function closeSceneModal() {
    document.getElementById('sceneModal').style.display = 'none';
    document.getElementById('scene-name').value = '';
    document.getElementById('scene-error-message').textContent = '';
  }

  async function saveScene() {
    const saveButton = document.querySelector('#sceneModal .confirm-btn');
    const errorEl = document.getElementById('scene-error-message');
    const originalButtonText = "সংরক্ষণ করুন";
    
    errorEl.textContent = '';
    saveButton.disabled = true;
    saveButton.textContent = 'সংরক্ষণ করা হচ্ছে...';

    try {
        const sceneName = document.getElementById('scene-name').value;
        if (!sceneName || sceneName.trim() === '') {
            throw new Error('দৃশ্যের একটি নাম দিন।');
        }

        const actions = [];
        const selects = document.querySelectorAll('.scene-action-select');
        selects.forEach(select => {
            if (select.value !== 'ignore') {
                const device = select.dataset.device;
                const relay = select.dataset.relay;
                if (device && relay) {
                    actions.push({
                        device: device,
                        relay: relay,
                        state: select.value === 'true'
                    });
                }
            }
        });

        if (actions.length === 0) {
            throw new Error('অন্তত একটি রিলের জন্য অ্যাকশন নির্বাচন করুন।');
        }

        const newScene = {
            name: sceneName,
            actions: actions
        };

        await database.ref('scenes').push(newScene);

        showToast('নতুন দৃশ্য সফলভাবে তৈরি হয়েছে!', 'success');
        logAuditEvent(`নতুন দৃশ্য '${sceneName}' তৈরি করেছেন।`);
        closeSceneModal();

    } catch (error) {
        console.error("Error saving scene:", error);
        showToast('দৃশ্য তৈরি করতে সমস্যা হয়েছে।', 'error');
        errorEl.textContent = `ত্রুটি: ${error.message}`;
    } finally {
        saveButton.disabled = false;
        saveButton.textContent = originalButtonText;
    }
  }

  // ★★★ পরিবর্তিত: পাসওয়ার্ড ভেরিফিকেশন যোগ করা হয়েছে ★★★
  function deleteScene(sceneId, sceneName) {
      promptForActionPassword(
        'দৃশ্য মুছুন',
        `আপনি কি "${sceneName}" দৃশ্যটি স্থায়ীভাবে মুছে ফেলতে চান?`,
        () => {
            database.ref(`scenes/${sceneId}`).remove()
                .then(() => {
                    showToast(`'${sceneName}' দৃশ্যটি সফলভাবে মুছে ফেলা হয়েছে।`, 'success');
                    logAuditEvent(`দৃশ্য '${sceneName}' মুছে ফেলেছেন।`);
                })
                .catch(error => {
                    showToast("দৃশ্যটি মুছতে সমস্যা হয়েছে।", "error");
                    console.error("Delete scene error:", error);
                });
        }
      );
  }

  // ★★★ নতুন: তারিখ ও সময় আপডেট করার ফাংশন ★★★
  function updateAllDateTimeDisplays() {
      const now = new Date();
      // তারিখ ফরম্যাট: DD-MM-YYYY
      const dateOptions = { day: '2-digit', month: '2-digit', year: 'numeric' };
      const formattedDate = now.toLocaleDateString('en-GB', dateOptions).replace(/\//g, '-');
      // সময় ফরম্যাট: HH:MM:SS (24-ঘন্টা)
      const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
      const formattedTime = now.toLocaleTimeString('en-GB', timeOptions);

      // DOM থেকে সমস্ত তারিখ ও সময়ের এলিমেন্ট কোয়েরি করা
      const dateElements = document.querySelectorAll('[id^="date-"]');
      const timeElements = document.querySelectorAll('[id^="time-"]');

      // প্রতিটি এলিমেন্টের কন্টেন্ট আপডেট করা
      dateElements.forEach(el => {
          el.innerHTML = `<i class="fas fa-calendar-alt"></i> ${formattedDate}`;
      });
      timeElements.forEach(el => {
          el.innerHTML = `<i class="fas fa-clock"></i> ${formattedTime}`;
      });
  }


  // ★★★ পরিবর্তিত: renderControlPanel ফাংশনে তারিখ ও সময় যুক্ত করা হয়েছে ★★★
  function renderControlPanel(devicesData, currentRelayNames) {
      const container = document.getElementById('control-panel-container');
      if (!container) return;
      container.innerHTML = '';

      const sortedDeviceIds = Object.keys(devicesData).sort((a, b) => {
          return parseInt(a.replace('device', '')) - parseInt(b.replace('device', ''));
      });

      for (const deviceId of sortedDeviceIds) {
          const deviceRelays = devicesData[deviceId];
          const deviceSection = document.createElement('section');
          deviceSection.className = 'control-section';

          let sectionHTML = `
              <h2 class="control-section-title">
                  <span>${deviceId.replace('device', 'ডিভাইস ')} কন্ট্রোল</span>
                  <i class="fas fa-trash-alt delete-icon" onclick="deleteDevice('${deviceId}')" title="এই ডিভাইসটি মুছুন"></i>
              </h2>
              <div class="toggle-switch-grid">
          `;

          const sortedRelayIds = Object.keys(deviceRelays)
              .filter(key => key.startsWith('relay'))
              .sort((a, b) => parseInt(a.replace('relay', '')) - parseInt(b.replace('relay', '')));

          for (const relayId of sortedRelayIds) {
              const relayState = deviceRelays[relayId];
              const customName = (currentRelayNames[deviceId] && currentRelayNames[deviceId][relayId]) 
                  ? currentRelayNames[deviceId][relayId] 
                  : relayId.replace('relay', 'রিলে ');
              
              const timerStatusId = `timer-status-${deviceId}-${relayId}`;
              
              sectionHTML += `
                  <div class="toggle-switch-container">
                      <div class="toggle-switch-header">
                          <span class="toggle-switch-label" id="label-${deviceId}-${relayId}">
                              ${customName} 
                              <i class="fas fa-pencil-alt edit-relay-name-icon" onclick="editRelayName('${deviceId}', '${relayId}')" title="নাম পরিবর্তন করুন"></i>
                              <i class="fas fa-trash-alt delete-icon" onclick="deleteRelay('${deviceId}', '${relayId}')" title="এই রিলেটি মুছুন"></i>
                          </span>
                          <!-- ★★★ নতুন: তারিখ এবং সময় প্রদর্শনের জন্য div ★★★ -->
                          <div class="device-time-info">
                            <span id="date-${deviceId}-${relayId}"><i class="fas fa-calendar-alt"></i> --/--/----</span>
                            <span id="time-${deviceId}-${relayId}"><i class="fas fa-clock"></i> --:--:--</span>
                          </div>
                      </div>
                      <div class="toggle-switch-body">
                          <div class="timer-status" id="${timerStatusId}">টাইমার স্ট্যাটাস লোড হচ্ছে...</div>
                      </div>
                      <div class="toggle-switch-footer">
                          <button class="pro-btn timer-btn" onclick="openTimerModal('${deviceId}', '${relayId}')">⏲️ টাইমার</button>
                          <label class="toggle-switch">
                              <input type="checkbox" id="toggle-${deviceId}-${relayId}" onchange="promptForRelayPassword('${deviceId}', '${relayId}', this)" ${relayState ? 'checked' : ''}>
                              <span class="slider"></span>
                          </label>
                      </div>
                  </div>
              `;
          }

          sectionHTML += `
              </div>
              <button class="pro-btn add-relay-btn" onclick="addNewRelay('${deviceId}')">
                  <i class="fas fa-plus"></i> এই ডিভাইসে নতুন রিলে যোগ করুন
              </button>
          `;
          
          deviceSection.innerHTML = sectionHTML;
          container.appendChild(deviceSection);
      }
      updateAllTimerDisplays();
      updateAllDateTimeDisplays(); // ★★★ নতুন: প্যানেল রেন্ডারের পর সময় আপডেট
  }
  
  // ★★★ পরিবর্তিত: পাসওয়ার্ড ভেরিফিকেশন যোগ করা হয়েছে ★★★
  function deleteDevice(deviceId) {
    promptForActionPassword(
      'ডিভাইস মুছুন',
      `আপনি কি সত্যিই '${deviceId}' এবং এর সমস্ত রিলে মুছে ফেলতে চান? এই কাজটি ফিরিয়ে আনা যাবে না!`,
      () => {
        const updates = {};
        updates[`/devices/${deviceId}`] = null;
        updates[`/device_metadata/${deviceId}`] = null;

        database.ref('timers').orderByKey().startAt(deviceId).endAt(deviceId + '\uf8ff').once('value', snapshot => {
            const timersToDelete = snapshot.val();
            if (timersToDelete) {
                for (const timerKey in timersToDelete) {
                    updates[`/timers/${timerKey}`] = null;
                }
            }

            database.ref().update(updates)
                .then(() => {
                    showToast(`'${deviceId}' ডিভাইসটি সফলভাবে মুছে ফেলা হয়েছে।`, 'success');
                    logAuditEvent(`ডিভাইস '${deviceId}' এবং এর সমস্ত ডেটা মুছে ফেলেছেন।`);
                })
                .catch(error => {
                    showToast("ডিভাইসটি মুছতে সমস্যা হয়েছে।", "error");
                    console.error("Delete device error:", error);
                });
        });
      }
    );
  }

  // ★★★ পরিবর্তিত: পাসওয়ার্ড ভেরিফিকেশন যোগ করা হয়েছে ★★★
  function deleteRelay(deviceId, relayId) {
      const customName = (relayNames[deviceId] && relayNames[deviceId][relayId]) ? relayNames[deviceId][relayId] : relayId;
      promptForActionPassword(
        'রিলে/লোড মুছুন',
        `আপনি কি সত্যিই '${customName}' (${relayId}) রিলে/লোডটি '${deviceId}' থেকে মুছে ফেলতে চান?`,
        () => {
            const updates = {};
            updates[`/devices/${deviceId}/${relayId}`] = null;
            updates[`/device_metadata/${deviceId}/relay_names/${relayId}`] = null;
            updates[`/timers/${deviceId}-${relayId}`] = null;

            database.ref().update(updates)
                .then(() => {
                    showToast(`'${customName}' সফলভাবে মুছে ফেলা হয়েছে।`, 'success');
                    logAuditEvent(`'${deviceId}' থেকে '${customName}' মুছে ফেলেছেন।`);
                })
                .catch(error => {
                    showToast("মুছতে সমস্যা হয়েছে।", "error");
                    console.error("Delete relay/load error:", error);
                });
        }
      );
  }

  // ★★★ পরিবর্তিত: পাসওয়ার্ড প্রোটেকশন যোগ করা হয়েছে ★★★
  function addNewDevice() {
      const newDeviceName = prompt("নতুন ডিভাইসের নাম দিন (যেমন: device5):");
      if (newDeviceName && newDeviceName.trim() !== "") {
          const deviceId = newDeviceName.trim();
          if (currentDeviceStates[deviceId]) {
              alert("এই নামের ডিভাইস আগে থেকেই আছে!");
              return;
          }

          promptForActionPassword(
              'নতুন ডিভাইস যোগ করুন',
              `আপনি কি '${deviceId}' নামে নতুন ডিভাইস যোগ করতে চান?`,
              () => {
                  const updates = {};
                  updates[`/devices/${deviceId}/relay1`] = false;
                  updates[`/device_metadata/${deviceId}/relay_names/relay1`] = "রিলে ১";
                  
                  updates[`/devices/${deviceId}/Load1`] = 0;
                  updates[`/device_metadata/${deviceId}/relay_names/Load1`] = "লোড ১";

                  database.ref().update(updates)
                      .then(() => {
                          showToast(`ডিভাইস '${deviceId}' সফলভাবে যোগ করা হয়েছে।`, 'success');
                          logAuditEvent(`নতুন ডিভাইস '${deviceId}' যোগ করেছেন।`);
                      })
                      .catch(error => {
                          showToast("ডিভাইস যোগ করতে সমস্যা হয়েছে।", "error");
                          console.error(error);
                      });
              }
          );
      }
  }

  // ★★★ পরিবর্তিত: পাসওয়ার্ড প্রোটেকশন যোগ করা হয়েছে ★★★
  function addNewRelay(deviceId) {
      promptForActionPassword(
          'নতুন রিলে যোগ করুন',
          `আপনি কি '${deviceId}' ডিভাইসে একটি নতুন রিলে যোগ করতে চান?`,
          () => {
              const deviceData = currentDeviceStates[deviceId] || {};
              let maxRelayNum = 0;
              Object.keys(deviceData).forEach(key => {
                  if (key.startsWith('relay')) {
                      const num = parseInt(key.replace('relay', ''));
                      if (num > maxRelayNum) {
                          maxRelayNum = num;
                      }
                  }
              });
              const newRelayId = `relay${maxRelayNum + 1}`;
              const newRelayName = `রিলে ${maxRelayNum + 1}`;

              const updates = {};
              updates[`/devices/${deviceId}/${newRelayId}`] = false;
              updates[`/device_metadata/${deviceId}/relay_names/${newRelayId}`] = newRelayName;

              database.ref().update(updates)
                  .then(() => {
                      showToast(`'${deviceId}'-এ '${newRelayName}' যোগ করা হয়েছে।`, 'success');
                      logAuditEvent(`'${deviceId}' ডিভাইসে নতুন রিলে '${newRelayName}' যোগ করেছেন।`);
                  })
                  .catch(error => {
                      showToast("রিলে যোগ করতে সমস্যা হয়েছে।", "error");
                      console.error(error);
                  });
          }
      );
  }
  
  // ★★★ পরিবর্তিত: পাসওয়ার্ড প্রোটেকশন যোগ করা হয়েছে ★★★
  function addNewLoadToDevice(deviceId) {
    promptForActionPassword(
        'নতুন লোড যোগ করুন',
        `আপনি কি '${deviceId}' ডিভাইসে একটি নতুন লোড যোগ করতে চান?`,
        () => {
            const deviceData = currentDeviceStates[deviceId] || {};
            let maxLoadNum = 0;
            Object.keys(deviceData).forEach(key => {
                if (key.startsWith('Load')) {
                    const num = parseInt(key.replace('Load', ''));
                    if (!isNaN(num) && num > maxLoadNum) {
                        maxLoadNum = num;
                    }
                }
            });
            const newLoadNum = maxLoadNum + 1;
            const newLoadId = `Load${newLoadNum}`;
            const newLoadName = `লোড ${newLoadNum}`;

            const updates = {};
            updates[`/devices/${deviceId}/${newLoadId}`] = 0; // Default state: 0 (Inactive/OFF)
            updates[`/device_metadata/${deviceId}/relay_names/${newLoadId}`] = newLoadName;

            database.ref().update(updates)
                .then(() => {
                    showToast(`'${deviceId}'-এ '${newLoadName}' যোগ করা হয়েছে।`, 'success');
                    logAuditEvent(`'${deviceId}' ডিভাইসে নতুন লোড '${newLoadName}' যোগ করেছেন।`);
                })
                .catch(error => {
                    showToast("লোড যোগ করতে সমস্যা হয়েছে।", "error");
                    console.error("Error adding new load:", error);
                });
        }
    );
  }

  // ★★★ নতুন: ট্যাব সাজানো লক/আনলক করার ফাংশন ★★★
  function toggleTabSorting() {
      isSortingLocked = !isSortingLocked;
      const btn = document.getElementById('toggle-sort-btn');
      const icon = btn.querySelector('i');
      const container = document.getElementById('nav-tabs-container');

      if (isSortingLocked) {
          icon.className = 'fas fa-lock';
          btn.childNodes[1].nodeValue = ' সাজানো লক করুন';
          container.classList.remove('tabs-unlocked');
          showToast('ট্যাব সাজানো লক করা হয়েছে।', 'info');
      } else {
          icon.className = 'fas fa-lock-open';
          btn.childNodes[1].nodeValue = ' সাজানো আনলক করুন';
          container.classList.add('tabs-unlocked');
          showToast('ট্যাব সাজানো আনলক করা হয়েছে। এখন আপনি ট্যাব সরাতে পারবেন।', 'success');
      }

      if (tabSortable) {
          tabSortable.option('disabled', isSortingLocked);
      }
  }

  // ★★★ নতুন: ট্যাব সাজানোর ফাংশন ★★★
  function initTabSorting() {
    if (tabSortable) {
        tabSortable.destroy();
    }
    const container = document.getElementById('nav-tabs-container');
    tabSortable = new Sortable(container, {
        animation: 150,
        ghostClass: 'sortable-ghost',
        disabled: isSortingLocked, // ডিফল্ট অবস্থা অনুযায়ী সেট করা
        onEnd: saveTabOrder,
    });
  }

  function saveTabOrder() {
      const container = document.getElementById('nav-tabs-container');
      const order = Array.from(container.children)
          .map(tab => tab.dataset.tabId)
          .filter(id => id); 
      
      const user = auth.currentUser;
      if (user && order.length > 0) {
          database.ref(`ui_settings/${user.uid}/tabOrder`).set(order);
      }
  }

  function loadAndApplyTabOrder() {
      const user = auth.currentUser;
      if (!user) {
          initTabSorting();
          return;
      };

      database.ref(`ui_settings/${user.uid}/tabOrder`).once('value', snapshot => {
          const order = snapshot.val();
          if (order && Array.isArray(order)) {
              const container = document.getElementById('nav-tabs-container');
              const tabs = {};
              Array.from(container.children).forEach(tab => {
                  if (tab.dataset.tabId) {
                      tabs[tab.dataset.tabId] = tab;
                  }
              });

              order.forEach(tabId => {
                  if (tabs[tabId]) {
                      container.appendChild(tabs[tabId]);
                      delete tabs[tabId];
                  }
              });
              
              for (const tabId in tabs) {
                  container.appendChild(tabs[tabId]);
              }
          }
          initTabSorting();
      });
  }


  function setupFirebaseListeners() {
    database.ref('device_metadata').on('value', snapshot => {
        const metadata = snapshot.val() || {};
        relayNames = {};
        for (const deviceId in metadata) {
            if (metadata[deviceId].relay_names) {
                relayNames[deviceId] = metadata[deviceId].relay_names;
            }
        }
        if (currentDeviceStates && Object.keys(currentDeviceStates).length > 0) {
            renderControlPanel(currentDeviceStates, relayNames);
            updateStaticDevicePages(); 
            updateAutomationFormOptions();
            populateLogicGateRelaySelectors();
        }
    });

    database.ref('devices').on('value', snapshot => {
        const allDevicesData = snapshot.val();
        if (allDevicesData) {
            const oldDeviceStates = JSON.parse(JSON.stringify(currentDeviceStates));
            currentDeviceStates = allDevicesData;
            
            renderControlPanel(allDevicesData, relayNames);
            updateStaticDevicePages(); 
            updateAutomationFormOptions();
            populateLogicGateRelaySelectors(); 
            evaluateLogicGateRules(allDevicesData);
            
            for (const deviceId in allDevicesData) {
                if (JSON.stringify(oldDeviceStates[deviceId]) !== JSON.stringify(allDevicesData[deviceId])) {
                    checkAutomationRules('device', {
                        deviceId: deviceId,
                        states: allDevicesData[deviceId]
                    });
                }
            }

        } else {
            currentDeviceStates = {};
            renderControlPanel({}, relayNames);
            updateStaticDevicePages(); 
            updateAutomationFormOptions();
            populateLogicGateRelaySelectors();
        }
    });

    database.ref('energymonitoring').on('value', snapshot => {
        const data = snapshot.val();
        if (data) updateEnergyData(data);
    });
    
    // ★★★ নতুন: তাপমাত্রা ডেটার জন্য ফায়ারবেস লিসেনার ★★★
    database.ref('devices/device1/Temperature1').on('value', snapshot => {
        const tempData = snapshot.val();
        if (tempData) {
            updateTemperatureData(tempData);
        }
    });


    database.ref('energyHistory').limitToLast(1000).on('value', snapshot => {
        const data = snapshot.val();
        if (data) {
            historicalData = data;
            if (document.getElementById('page6').classList.contains('active')) {
                updateAdvancedChart();
            }
        }
    });

    database.ref('timers').on('value', snapshot => {
        allTimersData = snapshot.val() || {};
        updateAllTimerDisplays();
    });

    database.ref('automationRules').on('value', snapshot => {
      automationRules = snapshot.val() || {};
      const listContainer = document.getElementById('automation-rule-list');
      listContainer.innerHTML = '';
      if (Object.keys(automationRules).length === 0) {
        listContainer.innerHTML = '<p>কোনো অটোমেশন বা অ্যালার্ট রুল এখনো তৈরি করা হয়নি।</p>';
        return;
      }
      for (const ruleId in automationRules) {
        const rule = automationRules[ruleId];
        const card = document.createElement('div');
        card.className = `rule-card ${rule.isEnabled ? '' : 'disabled'}`;
        
        let description = `<strong>${rule.name}:</strong> `;
        if (rule.triggerSource === 'energy') { 
            description += `যদি <strong>${rule.triggerMetric}</strong> এর মান <strong>${rule.triggerCondition} ${rule.triggerValue}</strong> হয়, `; 
        } else if (rule.triggerSource === 'time') { 
            description += `যদি সময় <strong>${rule.triggerValue}</strong> হয়, `; 
        } else if (rule.triggerSource === 'device') { 
            const triggerDeviceName = rule.triggerDevice.replace('device', 'ডিভাইস ');
            const triggerRelayName = (relayNames[rule.triggerDevice] && relayNames[rule.triggerDevice][rule.triggerRelay]) ? relayNames[rule.triggerDevice][rule.triggerRelay] : rule.triggerRelay;
            description += `যদি <strong>${triggerDeviceName}</strong> এর <strong>'${triggerRelayName}'</strong> <strong>${rule.triggerState ? 'ON' : 'OFF'}</strong> হয়, `; 
        }
        
        const actionDeviceName = rule.actionDevice.replace('device', 'ডিভাইস ');
        const actionRelayName = (relayNames[rule.actionDevice] && relayNames[rule.actionDevice][rule.actionRelay]) ? relayNames[rule.actionDevice][rule.actionRelay] : rule.actionRelay;
        description += `তবে <strong>${actionDeviceName}</strong> এর <strong>'${actionRelayName}'</strong> কে <strong>${rule.actionState ? 'ON' : 'OFF'}</strong> করুন।`;
        
        if (rule.sendNotification) { description += ` এবং একটি নোটিফিকেশন পাঠান।`; }
        
        card.innerHTML = `<div class="rule-description">${description}</div><div class="rule-actions"><button class="pro-btn rule-btn toggle-rule-btn ${rule.isEnabled ? 'enabled' : 'disabled'}" onclick="toggleRule('${ruleId}')">${rule.isEnabled ? 'নিষ্ক্রিয় করুন' : 'সক্রিয় করুন'}</button><button class="pro-btn rule-btn delete-btn" onclick="deleteRule('${ruleId}')">ডিলিট</button></div>`;
        listContainer.appendChild(card);
      }
    });

    database.ref('logicGateRules').on('value', snapshot => {
        logicGateRules = snapshot.val() || {};
        renderLogicGateRules();
    });

    loadAuditLog();

    database.ref('system_status/device1').on('value', snapshot => {
        const data = snapshot.val();
        if (data) {
            document.getElementById('status-wifi').textContent = data.wifi ? 'কানেক্টেড' : 'ডিসকানেক্টেড';
            document.getElementById('indicator-wifi').className = `status-indicator ${data.wifi ? 'connected' : 'disconnected'}`;
            document.getElementById('status-firebase').textContent = data.firebase ? 'কানেক্টেড' : 'ডিসকানেক্টেড';
            document.getElementById('indicator-firebase').className = `status-indicator ${data.firebase ? 'connected' : 'disconnected'}`;
            document.getElementById('status-mega').textContent = data.mega ? 'কানেক্টেড' : 'ডিসকানেক্টেড';
            document.getElementById('indicator-mega').className = `status-indicator ${data.mega ? 'connected' : 'disconnected'}`;
            document.getElementById('status-sd-card').textContent = data.sd_card ? 'উপস্থিত' : 'অনুপস্থিত';
            document.getElementById('indicator-sd-card').className = `status-indicator ${data.sd_card ? 'connected' : 'disconnected'}`;
            document.getElementById('status-uptime').textContent = data.uptime || '--';
            const ramUsage = data.ram_usage || 0;
            document.getElementById('status-ram-usage').textContent = `${ramUsage}%`;
            document.getElementById('ram-progress-fill').style.width = `${ramUsage}%`;
        }
    });

    database.ref('scenes').on('value', snapshot => {
        const scenes = snapshot.val() || {};
        const container = document.getElementById('scene-buttons-container');
        container.innerHTML = '<button class="pro-btn create-scene-btn" onclick="openSceneModal()"><i class="fas fa-plus"></i> নতুন দৃশ্য তৈরি করুন</button>';
        
        for (const sceneId in scenes) {
            const scene = scenes[sceneId];
            const sceneItemContainer = document.createElement('div');
            sceneItemContainer.className = 'scene-item-container';
            
            sceneItemContainer.innerHTML = `
                <button class="pro-btn scene-btn" onclick="executeScene('${sceneId}', JSON.parse(decodeURIComponent('${encodeURIComponent(JSON.stringify(scene.actions))}')) , '${scene.name}')">
                    ${scene.name}
                </button>
                <i class="fas fa-trash-alt delete-scene-icon" title="এই দৃশ্যটি মুছুন" onclick="deleteScene('${sceneId}', '${scene.name}')"></i>
            `;
            container.insertBefore(sceneItemContainer, container.querySelector('.create-scene-btn'));
        }
    });

    // ★★★ পরিবর্তিত: ট্যাব সাজানোর ফাংশন কল করা হচ্ছে ★★★
    database.ref('custom_pages').on('value', snapshot => {
        const pagesData = snapshot.val() || {};
        renderCustomPagesFromFirebase(pagesData);
        loadAndApplyTabOrder(); 
    });
}
  function loadAuditLog() {
    const logListContainer = document.getElementById('audit-log-list');
    const userLogRef = database.ref('auditLog').limitToLast(100);
    const deviceLogRef = database.ref('deviceActivityLog').limitToLast(100);

    let allLogs = [];
    let userLogsLoaded = false;
    let deviceLogsLoaded = false;

    const renderLogs = () => {
        if (!userLogsLoaded || !deviceLogsLoaded) return;
        allLogs.sort((a, b) => b.timestamp - a.timestamp);
        logListContainer.innerHTML = '';
        if (allLogs.length === 0) {
            logListContainer.innerHTML = '<p>কোনো কার্যকলাপের লগ পাওয়া যায়নি...</p>';
            return;
        }
        allLogs.forEach(log => {
            const isSystem = log.user === 'সিস্টেম অটোমেশন' || log.source === 'device' || log.user === 'সিস্টেম (লজিক গেট)';
            const logItem = document.createElement('div');
            logItem.className = `audit-log-item ${isSystem ? 'system-log' : ''}`;
            const date = new Date(log.timestamp);
            const formattedTime = date.toLocaleString('bn-BD', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const userDisplay = log.source === 'device' ? 'ডিভাইস অ্যাক্টিভিটি' : log.user;
            const actionDisplay = log.source === 'device' ? log.message : log.action;
            logItem.innerHTML = `<div class="audit-log-header"><span class="audit-log-user ${isSystem ? 'audit-log-user-system' : ''}"><i class="fas ${isSystem ? 'fa-cogs' : 'fa-user'}"></i> ${userDisplay}</span><span class="audit-log-timestamp">🕒 ${formattedTime}</span></div><div class="audit-log-action">${actionDisplay}</div>`;
            logListContainer.appendChild(logItem);
        });
    };

    userLogRef.on('value', snapshot => {
        const userLogs = snapshot.val() || {};
        const parsedUserLogs = Object.values(userLogs).map(log => ({ ...log, source: 'user' }));
        allLogs = allLogs.filter(log => log.source !== 'user').concat(parsedUserLogs);
        userLogsLoaded = true;
        renderLogs();
    });

    deviceLogRef.on('value', snapshot => {
        const deviceLogs = snapshot.val() || {};
        const parsedDeviceLogs = Object.values(deviceLogs).map(log => ({ ...log, source: 'device' }));
        allLogs = allLogs.filter(log => log.source !== 'device').concat(parsedDeviceLogs);
        deviceLogsLoaded = true;
        renderLogs();
    });
  }

    function openAddPageModal() {
        document.getElementById('addPageModal').style.display = 'flex';
        document.getElementById('new-page-name').focus();
    }

    // ★★★ পরিবর্তিত: পাসওয়ার্ড ফিল্ড পরিষ্কার করার জন্য আপডেট করা হয়েছে ★★★
    function closeAddPageModal() {
        document.getElementById('addPageModal').style.display = 'none';
        document.getElementById('new-page-name').value = '';
        document.getElementById('addPagePasswordInput').value = ''; // পাসওয়ার্ড ফিল্ড পরিষ্কার করুন
        document.getElementById('add-page-error').textContent = '';
    }

    // ★★★ পরিবর্তিত: নতুন পেজ তৈরির জন্য পাসওয়ার্ড ভেরিফিকেশন ★★★
    function saveNewPage() {
        const pageName = document.getElementById('new-page-name').value.trim();
        const password = document.getElementById('addPagePasswordInput').value;
        const errorEl = document.getElementById('add-page-error');
        const modalBox = document.querySelector('#addPageModal .password-modal-box');

        if (!pageName || !password) {
            errorEl.textContent = 'দয়া করে পেজের নাম এবং পাসওয়ার্ড দিন।';
            return;
        }

        if (password === correctOperatingPassword) {
            // পাসওয়ার্ড সঠিক হলে
            const newPageData = {
                name: pageName,
                components: []
            };

            const newPageRef = database.ref('custom_pages').push(newPageData);
            logAuditEvent(`একটি নতুন কাস্টম পেজ '${pageName}' তৈরি করেছেন।`);
            closeAddPageModal(); // বর্তমান মোডাল বন্ধ করুন
            openPageEditorModal(newPageRef.key, pageName, new Event('click')); // এডিটর মোডাল খুলুন
        } else {
            // পাসওয়ার্ড ভুল হলে
            errorEl.textContent = '❌ ভুল অপারেটিং পাসওয়ার্ড!';
            modalBox.classList.add('shake-animation');
            setTimeout(() => { modalBox.classList.remove('shake-animation'); }, 500);
            document.getElementById('addPagePasswordInput').value = ''; // পাসওয়ার্ড ফিল্ড খালি করুন
        }
    }
    
    function openPageEditorModal(pageId, pageName, event) {
        if(event) event.stopPropagation();
        currentPageToEdit = pageId;
        document.getElementById('page-editor-title').textContent = `'${pageName}' পেজটি এডিট করুন`;

        database.ref(`custom_pages/${pageId}/components`).once('value', snapshot => {
            const currentComponents = snapshot.val() || [];
            const editorContent = document.getElementById('page-editor-content');
            editorContent.innerHTML = generateComponentSelectorHTML(currentComponents);
            document.getElementById('pageEditorModal').style.display = 'flex';
        });
    }

    function closePageEditorModal() {
        document.getElementById('pageEditorModal').style.display = 'none';
        currentPageToEdit = null;
    }
    
    // ★★★ পরিবর্তিত: পেইজ এডিটরে নতুন অপশন যোগ করা হয়েছে ★★★
    function generateComponentSelectorHTML(currentComponents = []) {
        let html = '';
        const isChecked = (comp) => currentComponents.some(c => JSON.stringify(c) === JSON.stringify(comp));

        // ডিভাইস উপাদান
        for (let i = 1; i <= 4; i++) {
            const deviceId = `device${i}`;
            const compCards = { type: 'device_cards', deviceId: deviceId };
            const compSummary = { type: 'device_summary', deviceId: deviceId };
            const compChart = { type: 'device_chart', deviceId: deviceId };
            const compLog = { type: 'device_log', deviceId: deviceId };
            html += `<div class="page-editor-group">
                        <h4>ডিভাইস ${i} এর উপাদান</h4>
                        <label><input type="checkbox" data-component='${JSON.stringify(compCards)}' ${isChecked(compCards) ? 'checked' : ''}> ১৬টি কন্ট্রোল কার্ড</label>
                        <label><input type="checkbox" data-component='${JSON.stringify(compSummary)}' ${isChecked(compSummary) ? 'checked' : ''}> স্ট্যাটাস সামারি</label>
                        <label><input type="checkbox" data-component='${JSON.stringify(compChart)}' ${isChecked(compChart) ? 'checked' : ''}> স্ট্যাটাস গ্রাফ</label>
                        <label><input type="checkbox" data-component='${JSON.stringify(compLog)}' ${isChecked(compLog) ? 'checked' : ''}> লগস</label>
                    </div>`;
        }
        
        // এনার্জি মনিটর উপাদান
        const compEnergyMetrics = { type: 'energy_metrics' };
        const compEnergyGraphs = { type: 'energy_graphs' };
        const compAdvancedGraph = { type: 'advanced_graph' };
        html += `<div class="page-editor-group">
                    <h4>এনার্জি মনিটর</h4>
                    <label><input type="checkbox" data-component='${JSON.stringify(compEnergyMetrics)}' ${isChecked(compEnergyMetrics) ? 'checked' : ''}> এনার্জি মেট্রিক্স কার্ড</label>
                    <label><input type="checkbox" data-component='${JSON.stringify(compEnergyGraphs)}' ${isChecked(compEnergyGraphs) ? 'checked' : ''}> এনার্জি ট্রেন্ড গ্রাফ</label>
                    <label><input type="checkbox" data-component='${JSON.stringify(compAdvancedGraph)}' ${isChecked(compAdvancedGraph) ? 'checked' : ''}> এডভান্সড গ্রাফ</label>
                 </div>`;
        
        // অন্যান্য উপাদান
        const compControlPanel = { type: 'control_panel' };
        const compScenes = { type: 'scenes' };
        const compSystemStatus = { type: 'system_status' };
        const compAuditLog = { type: 'audit_log' };
        html += `<div class="page-editor-group">
                    <h4>অন্যান্য</h4>
                    <label><input type="checkbox" data-component='${JSON.stringify(compControlPanel)}' ${isChecked(compControlPanel) ? 'checked' : ''}> কন্ট্রোল প্যানেল</label>
                    <label><input type="checkbox" data-component='${JSON.stringify(compScenes)}' ${isChecked(compScenes) ? 'checked' : ''}> দৃশ্য (Scene) বাটন</label>
                    <label><input type="checkbox" data-component='${JSON.stringify(compSystemStatus)}' ${isChecked(compSystemStatus) ? 'checked' : ''}> সিস্টেম স্ট্যাটাস</label>
                    <label><input type="checkbox" data-component='${JSON.stringify(compAuditLog)}' ${isChecked(compAuditLog) ? 'checked' : ''}> অ্যাক্টিভিটি লগ</label>
                 </div>`;

        return html;
    }

    
    function savePageComponents() {
        if (!currentPageToEdit) return;

        const selectedComponents = [];
        document.querySelectorAll('#pageEditorModal input[type="checkbox"]:checked').forEach(checkbox => {
            selectedComponents.push(JSON.parse(checkbox.dataset.component));
        });

        database.ref(`custom_pages/${currentPageToEdit}/components`).set(selectedComponents)
            .then(() => {
                showToast('পেজ সফলভাবে আপডেট হয়েছে!', 'success');
                logAuditEvent(`কাস্টম পেজ '${document.getElementById('page-editor-title').textContent}' আপডেট করেছেন।`);
                closePageEditorModal();
            })
            .catch(err => {
                showToast('পেজ আপডেট করতে সমস্যা হয়েছে।', 'error');
                console.error("Page update error:", err);
            });
    }

    // ★★★ পরিবর্তিত: পাসওয়ার্ড ভেরিফিকেশন যোগ করা হয়েছে ★★★
    function deleteCustomPage(pageId, pageName, event) {
        event.stopPropagation();
        promptForActionPassword(
          'পেজ মুছুন',
          `আপনি কি সত্যিই '${pageName}' পেজটি মুছে ফেলতে চান?`,
          () => {
              database.ref(`custom_pages/${pageId}`).remove()
                  .then(() => {
                      showToast(`'${pageName}' পেজটি মুছে ফেলা হয়েছে।`, 'success');
                      logAuditEvent(`কাস্টম পেজ '${pageName}' মুছে ফেলেছেন।`);
                      showPage('page1'); 
                  })
                  .catch(err => console.error("Page delete error:", err));
          }
        );
    }

    function renderCustomPagesFromFirebase(pagesData) {
        const navContainer = document.getElementById('nav-tabs-container');
        const pagesContainer = document.getElementById('dynamic-pages-container');
        
        document.querySelectorAll('.custom-page-tab, .custom-page').forEach(el => el.remove());
        
        for (const pageId in pagesData) {
            const page = pagesData[pageId];
            
            const navTab = document.createElement('div');
            navTab.className = 'nav-tab custom-page-tab';
            navTab.setAttribute('onclick', `showPage('custom_page_${pageId}')`);
            navTab.dataset.tabId = `custom_page_${pageId}`; // ★★★ নতুন: data-tab-id যোগ করা হয়েছে
            navTab.innerHTML = `
                <span>${page.name}</span>
                <span class="page-actions">
                    <i class="fas fa-pencil-alt" onclick="openPageEditorModal('${pageId}', '${page.name}', event)"></i>
                    <i class="fas fa-trash-alt" onclick="deleteCustomPage('${pageId}', '${page.name}', event)"></i>
                </span>
            `;
            navContainer.insertBefore(navTab, document.getElementById('add-new-page-btn'));

            const pageContainer = document.createElement('main');
            pageContainer.id = `custom_page_${pageId}`;
            pageContainer.className = 'device-page custom-page';
            
            renderDynamicPageContent(pageContainer, page.components || []);
            pagesContainer.appendChild(pageContainer);
        }
    }
    
    // ★★★ পরিবর্তিত: নতুন কম্পোনেন্ট রেন্ডার করার জন্য কেস যুক্ত করা হয়েছে ★★★
    function renderDynamicPageContent(container, components) {
        container.innerHTML = `<div class="dynamic-page-grid"></div>`;
        const grid = container.querySelector('.dynamic-page-grid');

        components.forEach(comp => {
            let elementToClone;
            switch(comp.type) {
                case 'device_cards':
                    elementToClone = document.querySelector(`#page${comp.deviceId.replace('device','')} .device-cards`);
                    break;
                case 'device_summary':
                    elementToClone = document.getElementById(`${comp.deviceId}-summary`);
                    break;
                case 'device_chart':
                    elementToClone = document.querySelector(`#page${comp.deviceId.replace('device','')} .chart-container`);
                    break;
                case 'device_log':
                    elementToClone = document.querySelector(`#page${comp.deviceId.replace('device','')} .log-container`);
                    break;
                case 'energy_metrics':
                    elementToClone = document.querySelector('#page5 .energy-metrics');
                    break;
                case 'energy_graphs':
                    elementToClone = document.querySelector('#page5 .energy-graphs');
                    break;
                case 'advanced_graph':
                    elementToClone = document.getElementById('page6');
                    break;
                case 'control_panel':
                     elementToClone = document.getElementById('page8');
                    break;
                case 'scenes':
                    elementToClone = document.getElementById('page-component-scenes');
                    break;
                case 'system_status':
                    elementToClone = document.getElementById('page-component-system-status');
                    break;
                case 'audit_log':
                    elementToClone = document.getElementById('page-component-audit-log');
                    break;
            }

            if (elementToClone) {
                const clonedNode = elementToClone.cloneNode(true);
                
                clonedNode.querySelectorAll('canvas').forEach(canvas => {
                    const originalId = canvas.id;
                    const newId = `clone_${originalId}_${container.id}`;
                    canvas.id = newId;
                });

                grid.appendChild(clonedNode);
            }
        });
    }


    // ★★★ নতুন ফাংশনগুলো: লজিক গেট ইন্টারলকিং এর জন্য ★★★

    function populateLogicGateRelaySelectors() {
        const selectors = [
            { device: 'logic-input-device-a', relay: 'logic-input-relay-a' },
            { device: 'logic-input-device-b', relay: 'logic-input-relay-b' },
            { device: 'logic-output-device', relay: 'logic-output-relay' }
        ];

        const sortedDeviceIds = Object.keys(currentDeviceStates).sort((a, b) => parseInt(a.replace('device', '')) - parseInt(b.replace('device', '')));

        selectors.forEach(sel => {
            const deviceSelect = document.getElementById(sel.device);
            const currentDevice = deviceSelect.value;
            deviceSelect.innerHTML = sortedDeviceIds.map(id => `<option value="${id}">${id.replace('device', 'ডিভাইস ')}</option>`).join('');
            if (sortedDeviceIds.includes(currentDevice)) deviceSelect.value = currentDevice;
            
            deviceSelect.onchange = () => {
                const relaySelect = document.getElementById(sel.relay);
                const selectedDeviceId = deviceSelect.value;
                const currentRelay = relaySelect.value;
                relaySelect.innerHTML = '';

                if (currentDeviceStates[selectedDeviceId]) {
                    const relays = Object.keys(currentDeviceStates[selectedDeviceId])
                        .filter(key => key.startsWith('relay'))
                        .sort((a, b) => parseInt(a.replace('relay', '')) - parseInt(b.replace('relay', '')));

                    relays.forEach(relayId => {
                        const customName = (relayNames[selectedDeviceId]?.[relayId]) || relayId;
                        relaySelect.innerHTML += `<option value="${relayId}">${customName}</option>`;
                    });
                    if (relays.includes(currentRelay)) relaySelect.value = currentRelay;
                }
            };
            deviceSelect.dispatchEvent(new Event('change'));
        });
    }
    
    function saveLogicGateRule(event) {
        event.preventDefault();
        const ruleName = document.getElementById('logic-rule-name').value;
        const inputADevice = document.getElementById('logic-input-device-a').value;
        const inputARelay = document.getElementById('logic-input-relay-a').value;
        const inputBDevice = document.getElementById('logic-input-device-b').value;
        const inputBRelay = document.getElementById('logic-input-relay-b').value;
        const gateType = document.getElementById('logic-gate-type').value;
        const outputDevice = document.getElementById('logic-output-device').value;
        const outputRelay = document.getElementById('logic-output-relay').value;
        
        if (!ruleName || !inputARelay || !inputBRelay || !outputRelay) {
            showToast("অনুগ্রহ করে সমস্ত ফিল্ড পূরণ করুন।", "error");
            return;
        }

        if ( (outputDevice === inputADevice && outputRelay === inputARelay) || (outputDevice === inputBDevice && outputRelay === inputBRelay) ) {
            showToast("আউটপুট রিলে ইনপুট রিলের সমান হতে পারে না।", "error");
            return;
        }

        const rule = {
            name: ruleName,
            inputA: { device: inputADevice, relay: inputARelay },
            inputB: { device: inputBDevice, relay: inputBRelay },
            gate: gateType,
            output: { device: outputDevice, relay: outputRelay },
            isEnabled: true
        };

        promptForActionPassword('রুল সংরক্ষণ করুন', `আপনি কি "${ruleName}" রুলটি সংরক্ষণ করতে চান?`, () => {
            database.ref('logicGateRules').push(rule)
            .then(() => {
                showToast('লজিক গেট রুল সফলভাবে সংরক্ষিত হয়েছে!', 'success');
                logAuditEvent(`নতুন লজিক গেট রুল '${rule.name}' তৈরি করেছেন।`);
                event.target.reset();
                populateLogicGateRelaySelectors();
            })
            .catch(error => showToast("রুল সংরক্ষণ করতে সমস্যা হয়েছে।", "error"));
        });
    }

    function renderLogicGateRules() {
        const listContainer = document.getElementById('logic-gate-rule-list');
        listContainer.innerHTML = '';
        if (Object.keys(logicGateRules).length === 0) {
            listContainer.innerHTML = '<p>কোনো ইন্টারলক রুল এখনো তৈরি করা হয়নি।</p>';
            return;
        }

        for (const ruleId in logicGateRules) {
            const rule = logicGateRules[ruleId];
            const getRelayName = (device, relay) => (relayNames[device]?.[relay]) || relay;
            
            const description = `<strong>${rule.name}:</strong> <strong>${getRelayName(rule.output.device, rule.output.relay)}</strong> = (<strong>${getRelayName(rule.inputA.device, rule.inputA.relay)}</strong> ${rule.gate} <strong>${getRelayName(rule.inputB.device, rule.inputB.relay)}</strong>)`;

            const card = document.createElement('div');
            card.className = `rule-card ${rule.isEnabled ? '' : 'disabled'}`;
            card.innerHTML = `<div class="rule-description">${description}</div><div class="rule-actions"><button class="pro-btn rule-btn toggle-rule-btn ${rule.isEnabled ? 'enabled' : 'disabled'}" onclick="toggleLogicGateRule('${ruleId}')">${rule.isEnabled ? 'নিষ্ক্রিয় করুন' : 'সক্রিয় করুন'}</button><button class="pro-btn rule-btn delete-btn" onclick="deleteLogicGateRule('${ruleId}')">ডিলিট</button></div>`;
            listContainer.appendChild(card);
        }
    }

    function toggleLogicGateRule(ruleId) {
        const newState = !logicGateRules[ruleId].isEnabled;
        database.ref(`logicGateRules/${ruleId}/isEnabled`).set(newState);
        logAuditEvent(`লজিক গেট রুল '${logicGateRules[ruleId].name}' ${newState ? 'সক্রিয়' : 'নিষ্ক্রিয়'} করেছেন।`);
    }

    function deleteLogicGateRule(ruleId) {
        const ruleName = logicGateRules[ruleId].name;
        promptForActionPassword('লজিক গেট রুল মুছুন', `আপনি কি "${ruleName}" রুলটি মুছে ফেলতে চান?`, () => {
            database.ref(`logicGateRules/${ruleId}`).remove()
            .then(() => logAuditEvent(`লজিক গেট রুল '${ruleName}' মুছে ফেলেছেন।`));
        });
    }

    function evaluateLogicGateRules(currentStates) {
        const updates = {};
        for (const ruleId in logicGateRules) {
            const rule = logicGateRules[ruleId];
            if (!rule.isEnabled) continue;

            const stateA = !!currentStates[rule.inputA.device]?.[rule.inputA.relay];
            const stateB = !!currentStates[rule.inputB.device]?.[rule.inputB.relay];
            const currentStateOut = !!currentStates[rule.output.device]?.[rule.output.relay];
            
            let result;
            switch(rule.gate) {
                case 'AND': result = stateA && stateB; break;
                case 'OR':  result = stateA || stateB; break;
                case 'NAND':result = !(stateA && stateB); break;
                case 'NOR': result = !(stateA || stateB); break;
                case 'XOR': result = stateA !== stateB; break;
                case 'XNOR':result = stateA === stateB; break;
                default: continue;
            }
            
            if (result !== currentStateOut) {
                const path = `devices/${rule.output.device}/${rule.output.relay}`;
                updates[path] = result;
                logAuditEvent(`লজিক গেট '${rule.name}' অনুযায়ী '${rule.output.device}/${rule.output.relay}' কে ${result ? 'ON' : 'OFF'} করা হয়েছে।`, "সিস্টেম (লজিক গেট)");
            }
        }
        
        if (Object.keys(updates).length > 0) {
            database.ref().update(updates);
        }
    }


  function handleLoginKeyPress(event) {
    if (event.key === "Enter") {
        const activeForm = document.getElementById('login-box').style.display;
        if (activeForm !== 'none') {
            loginWithFirebase();
        } else {
            registerWithFirebase();
        }
    }
  }
  document.getElementById("email").addEventListener("keypress", handleLoginKeyPress);
  document.getElementById("password").addEventListener("keypress", handleLoginKeyPress);
  document.getElementById("register-username").addEventListener("keypress", handleLoginKeyPress);
  document.getElementById("register-email").addEventListener("keypress", handleLoginKeyPress);
  document.getElementById("register-password").addEventListener("keypress", handleLoginKeyPress);
  document.getElementById("confirm-password").addEventListener("keypress", handleLoginKeyPress);
  
  document.getElementById("relayPasswordInput").addEventListener("keypress", function(event) {
    if (event.key === "Enter") verifyAndOperateRelay();
  });
  document.getElementById("timerPasswordInput").addEventListener("keypress", function(event) {
    if (event.key === "Enter") saveTimerSettings();
  });
  // ★★★ নতুন: সাধারণ অ্যাকশন মোডালের জন্য Enter কী প্রেস হ্যান্ডলার ★★★
  document.getElementById("actionPasswordInput").addEventListener("keypress", function(event) {
      if (event.key === "Enter") verifyAndExecuteAction();
  });
   // ★★★ নতুন: নতুন পেজ মোডালের জন্য Enter কী প্রেস হ্যান্ডলার ★★★
  document.getElementById("addPagePasswordInput").addEventListener("keypress", function(event) {
      if (event.key === "Enter") saveNewPage();
  });


  document.getElementById('action-device').addEventListener('change', () => {
      populateRelayDropdown('action-device', 'action-relay');
  });

  window.onload = function() {
    createParticles();
  };
</script>
</body>
</html>
